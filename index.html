<!DOCTYPE html>  
<html lang="ar" dir="rtl">  
<head>  
  <meta charset="UTF-8" />  
  <title>منصة FINO - حاسبة التمويل الذكية</title>  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />  
  <meta name="description" content="منصة ذكية تحسب لك التمويل وتُرشّح البنك الأنسب بناءً على راتبك ونوع التمويل والتزاماتك" />  
  <meta name="theme-color" content="#3b82f6" />  
  <meta name="apple-mobile-web-app-capable" content="yes" />  
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />  
  <meta name="apple-mobile-web-app-title" content="FINO" />  
  <link rel="manifest" href="manifest.json" />  
  <link rel="apple-touch-icon" href="icons/icon-192x192.png" />  
  <link rel="stylesheet" href="fino_advanced_features.css" />  
  <!-- مكتبة الخطوط العربية العصرية -->  
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@200;300;400;500;700;800;900&display=swap" rel="stylesheet">  
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">  
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">  
  <link href="https://fonts.googleapis.com/css2?family=Changa:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">  
  <link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@400;500;600;700&display=swap" rel="stylesheet">  
  <link href="https://fonts.googleapis.com/css2?family=Readex+Pro:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">  
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">  
  <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">  
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">  
  <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">  
  <style>  
    * { box-sizing: border-box; }
    
    /* ========== زر التنفيذ الثابت في صفحات المسؤول ========== */
    .admin-execute-btn {
      position: fixed !important;
      bottom: 20px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%) !important;
      color: #ffffff !important;
      border: none !important;
      padding: 15px 40px !important;
      border-radius: 50px !important;
      font-size: 16px !important;
      font-weight: 700 !important;
      cursor: pointer !important;
      box-shadow: 0 4px 15px rgba(20, 184, 166, 0.4) !important;
      z-index: 9999 !important;
      display: none !important;
      animation: pulse-execute 2s infinite !important;
    }
    .admin-execute-btn:hover {
      background: linear-gradient(135deg, #0d9488 0%, #0a7e71 100%) !important;
      transform: translateX(-50%) scale(1.05) !important;
    }
    .admin-execute-btn.show {
      display: flex !important;
      align-items: center !important;
      gap: 8px !important;
    }
    @keyframes pulse-execute {
      0%, 100% { box-shadow: 0 4px 15px rgba(20, 184, 166, 0.4); }
      50% { box-shadow: 0 4px 25px rgba(20, 184, 166, 0.6); }
    }
    
    /* ========== تنسيق بطاقات الأسئلة في لوحة التحكم ========== */
    .question-item {
      background: #ffffff !important;
      background-color: #ffffff !important;
      border: 3px solid #1e3a5f !important;
      border-radius: 12px !important;
      padding: 15px 18px !important;
      margin-bottom: 12px !important;
      display: flex !important;
      align-items: center !important;
      gap: 12px !important;
      transition: all 0.2s ease !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    }
    .question-item:hover {
      box-shadow: 0 6px 16px rgba(0,0,0,0.2) !important;
    }
    .question-item.question-hidden {
      opacity: 0.6 !important;
      background: #f1f5f9 !important;
    }
    .question-drag-handle {
      cursor: grab !important;
      color: #1e3a5f !important;
      font-size: 16px !important;
      font-weight: bold !important;
    }
    .question-text {
      flex: 1 !important;
      color: #000000 !important;
      -webkit-text-fill-color: #000000 !important;
      font-size: 16px !important;
      font-weight: 800 !important;
      text-align: right !important;
      line-height: 1.8 !important;
      text-shadow: none !important;
      background: transparent !important;
    }
    .question-item * {
      color: #000000 !important;
      -webkit-text-fill-color: #000000 !important;
    }
    .question-item .question-btn {
      color: #374151 !important;
      -webkit-text-fill-color: #374151 !important;
    }
    .question-actions {
      display: flex !important;
      gap: 6px !important;
      flex-wrap: wrap !important;
    }
    .question-btn {
      padding: 6px 12px !important;
      border-radius: 8px !important;
      font-size: 12px !important;
      cursor: pointer !important;
      border: 1px solid #e2e8f0 !important;
      background: #f8fafc !important;
      color: #374151 !important;
      transition: all 0.2s ease !important;
    }
    .question-btn:hover {
      background: #e2e8f0 !important;
    }
    .question-btn-edit {
      background: #fef3c7 !important;
      border-color: #fcd34d !important;
      color: #92400e !important;
    }
    .question-btn-edit:hover {
      background: #fde68a !important;
    }
    .question-btn-hide {
      background: #fee2e2 !important;
      border-color: #fca5a5 !important;
      color: #991b1b !important;
    }
    .question-btn-hide:hover {
      background: #fecaca !important;
    }
    
    /* ========== تصميم عصري شفاف مثل المنصة المرجعية ========== */
    /* إخفاء جميع الإطارات والتركيز */
    *, *:focus, *:active {
      outline: none !important;
      -webkit-tap-highlight-color: transparent !important;
    }
    
    /* البطاقة الشفافة الرئيسية */
    body.has-global-bg .card,
    body.has-global-bg #questionCard,
    body.has-global-bg #resultCard,
    body.has-global-bg #ratingSection,
    body.has-global-bg .question-card {
      background: rgba(255, 255, 255, 0.08) !important;
      backdrop-filter: blur(12px) !important;
      -webkit-backdrop-filter: blur(12px) !important;
      border: 1px solid rgba(255, 255, 255, 0.15) !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important;
      border-radius: 20px !important;
    }
    
    /* النصوص بيضاء */
    body.has-global-bg .card h2,
    body.has-global-bg .card h3,
    body.has-global-bg .card label,
    body.has-global-bg .card p,
    body.has-global-bg .card span,
    body.has-global-bg #questionCard h2,
    body.has-global-bg #questionCard label,
    body.has-global-bg #questionCard p,
    body.has-global-bg .question-title {
      color: #ffffff !important;
    }
    
    /* حقول الإدخال شفافة */
    body.has-global-bg .card input[type="text"],
    body.has-global-bg .card input[type="number"],
    body.has-global-bg .card select,
    body.has-global-bg #questionCard input,
    body.has-global-bg #questionCard select {
      background: rgba(255, 255, 255, 0.12) !important;
      border: 1px solid rgba(255, 255, 255, 0.25) !important;
      color: #ffffff !important;
      border-radius: 12px !important;
    }
    body.has-global-bg .card input::placeholder {
      color: rgba(255, 255, 255, 0.5) !important;
    }
    
    /* أزرار الخيارات شفافة */
    body.has-global-bg .option-btn,
    body.has-global-bg button[onclick*="selectOption"],
    body.has-global-bg .choice-btn {
      background: rgba(255, 255, 255, 0.08) !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      color: #ffffff !important;
      border-radius: 12px !important;
      transition: all 0.3s ease !important;
    }
    body.has-global-bg .option-btn:hover,
    body.has-global-bg button[onclick*="selectOption"]:hover {
      background: rgba(255, 255, 255, 0.15) !important;
      border-color: rgba(255, 255, 255, 0.4) !important;
      transform: translateY(-2px) !important;
    }
    body.has-global-bg .option-btn.selected {
      background: rgba(59, 130, 246, 0.4) !important;
      border-color: #60a5fa !important;
    }
    
    /* زر التالي برتقالي */
    body.has-global-bg #nextButton {
      background: linear-gradient(135deg, #ec4899 0%, #db2777 100%) !important;
      color: #ffffff !important;
      border: none !important;
      border-radius: 30px !important;
      padding: 14px 50px !important;
      font-weight: 700 !important;
      font-size: 16px !important;
      box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4) !important;
    }
    
    /* شريط التقدم */
    body.has-global-bg .progress-bar {
      background: rgba(255, 255, 255, 0.15) !important;
      border-radius: 10px !important;
    }
    body.has-global-bg .progress-fill {
      background: linear-gradient(90deg, #ec4899, #f472b6) !important;
      border-radius: 10px !important;
    }  
      
    /* متغيرات CSS للتحكم الشامل */  
    :root {  
      /* الخطوط */  
      --font-main: 'Tajawal', sans-serif;  
      --font-title: 'Cairo', sans-serif;  
      --font-accent: 'Readex Pro', sans-serif;  
        
      /* الألوان الرئيسية */  
      --color-primary: #6366f1;  
      --color-primary-dark: #4f46e5;  
      --color-primary-light: #818cf8;  
      --color-secondary: #ec4899;  
      --color-secondary-dark: #db2777;  
      --color-secondary-light: #f472b6;  
      --color-accent: #14b8a6;  
      --color-accent-dark: #0d9488;  
        
      /* ألوان الخلفيات */  
      --bg-dark: #0f0f1e;  
      --bg-medium: #1a1a3e;  
      --bg-light: #6366f1;  
      --bg-card: rgba(255, 255, 255, 0.98);  
      --bg-card-glass: rgba(255, 255, 255, 0.1);  
        
      /* ألوان النصوص */  
      --text-dark: #111827;  
      --text-medium: #374151;  
      --text-light: #6b7280;  
      --text-white: #ffffff;  
        
      /* ألوان الصفحات المخصصة */  
      --splash-bg-1: #0f0f1e;  
      --splash-bg-2: #1a1a3e;  
      --splash-bg-3: #6366f1;  
      --landing-bg-1: #0f0f1e;  
      --landing-bg-2: #1a1a3e;  
      --landing-bg-3: #4f46e5;  
      --landing-bg-4: #6366f1;  
      --result-bg-1: #0f0f1e;  
      --result-bg-2: #1a1a3e;  
        
      /* تأثيرات */  
      --shadow-soft: 0 10px 40px rgba(99, 102, 241, 0.2);  
      --shadow-strong: 0 20px 60px rgba(99, 102, 241, 0.3);  
      --shadow-glow: 0 0 30px rgba(99, 102, 241, 0.5);  
      --border-radius-sm: 12px;  
      --border-radius-md: 20px;  
      --border-radius-lg: 30px;  
      --border-radius-xl: 40px;  
    }  
      
    /* توافق الآيفون - Safe Area */  
    @supports (padding: max(0px)) {  
      .page, .card {  
        padding-left: max(16px, env(safe-area-inset-left));  
        padding-right: max(16px, env(safe-area-inset-right));  
        padding-bottom: max(20px, env(safe-area-inset-bottom));  
      }  
        
      #splashScreen {  
        padding-top: env(safe-area-inset-top);  
        padding-bottom: env(safe-area-inset-bottom);  
      }  
        
      .fixed-bottom-btn, .admin-tools-btn {  
        bottom: max(20px, env(safe-area-inset-bottom));  
      }  
    }  
      
    /* الخلفية المتحركة */  
    body {  
      font-family: var(--font-main), system-ui, -apple-system, BlinkMacSystemFont, sans-serif;  
      background: var(--main-bg, linear-gradient(135deg, #0f0f1e 0%, #1a1a3e 25%, #2d2d5f 50%, #4f46e5 100%));  
      background-size: 400% 400%;  
      animation: gradientBG 20s ease infinite;  
      transition: background 0.5s ease;  
      margin: 0;  
      text-align: center;  
      font-size: 20px;  
      direction: rtl;  
      color: #111827;  
      min-height: 100vh;  
    }  
      
    /* الخلفية العامة التي يضعها المسؤول - تغطي كامل الصفحة */  
    body.has-global-bg {  
      background: var(--global-bg-image) !important;  
      background-image: var(--global-bg-image) !important;  
      background-color: transparent !important;  
      background-size: cover !important;  
      background-position: center center !important;  
      background-repeat: no-repeat !important;  
      background-attachment: fixed !important;  
      animation: none !important;  
      min-height: 100vh !important;  
      width: 100vw !important;  
      margin: 0 !important;  
      padding: 0 !important;  
      overflow-x: hidden !important;  
    }
    
    /* إزالة الخلفية الزرقاء عندما يضع المسؤول خلفية */
    body.has-global-bg,
    body.has-global-bg *:not(input):not(select):not(button):not(.primary):not(#nextButton):not(#mainButton) {
      background-color: transparent !important;
    }  
      
    /* إزالة أي فراغات أو حدود من الصفحة */  
    html {  
      margin: 0 !important;  
      padding: 0 !important;  
      overflow-x: hidden !important;  
    }  
      
    body.has-global-bg::before {  
      content: '';  
      position: fixed;  
      top: 0;  
      left: 0;  
      right: 0;  
      bottom: 0;  
      width: 100vw;  
      height: 100vh;  
      background-image: inherit;  
      background-size: cover;  
      background-position: center center;  
      background-repeat: no-repeat;  
      z-index: -1;  
    }  
      
    @keyframes gradientBG {  
      0% { background-position: 0% 50%; }  
      50% { background-position: 100% 50%; }  
      100% { background-position: 0% 50%; }  
    }  
      
    /* الجزيئات المتحركة */  
    #particles {  
      position: fixed;  
      top: 0;  
      left: 0;  
      width: 100%;  
      height: 100%;  
      pointer-events: none;  
      z-index: 0;  
      overflow: hidden;  
    }  
    .particle {  
      position: absolute;  
      width: 4px;  
      height: 4px;  
      background: rgba(255,255,255,0.3);  
      border-radius: 50%;  
      animation: float 20s infinite;  
    }  
    @keyframes float {  
      0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }  
      10% { opacity: 1; }  
      90% { opacity: 1; }  
      100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }  
    }  
      
    /* شاشة البداية - تصميم عصري مبتكر */  
    #splashScreen {  
      position: fixed;  
      top: 0;  
      left: 0;  
      width: 100%;  
      height: 100%;  
      background: linear-gradient(135deg, var(--splash-bg-1), var(--splash-bg-2), var(--splash-bg-3));  
      background-size: 300% 300%;  
      animation: splashGradientNew 4s ease infinite;  
      display: flex;  
      flex-direction: column;  
      align-items: center;  
      justify-content: center;  
      z-index: 9999;  
      overflow: hidden;  
    }  
    @keyframes splashGradientNew {  
      0% { background-position: 0% 50%; }  
      50% { background-position: 100% 50%; }  
      100% { background-position: 0% 50%; }  
    }  
    #splashScreen.hidden {  
      opacity: 0;  
      visibility: hidden;  
      pointer-events: none;  
      transition: opacity 1s cubic-bezier(0.4, 0, 0.2, 1), visibility 1s;  
    }  
      
    /* الأشكال الهندسية المتحركة */  
    .splash-bg-shapes {  
      position: absolute;  
      width: 100%;  
      height: 100%;  
      overflow: hidden;  
    }  
    .splash-shape {  
      position: absolute;  
      border-radius: 50%;  
      filter: blur(60px);  
      opacity: 0.4;  
      animation: shapeFloat 8s ease-in-out infinite;  
    }  
    .splash-shape-1 {  
      width: 300px;  
      height: 300px;  
      background: linear-gradient(135deg, #f59e0b, #fbbf24);  
      top: -100px;  
      right: -100px;  
      animation-delay: 0s;  
    }  
    .splash-shape-2 {  
      width: 250px;  
      height: 250px;  
      background: linear-gradient(135deg, #10b981, #34d399);  
      bottom: -80px;  
      left: -80px;  
      animation-delay: 1s;  
    }  
    .splash-shape-3 {  
      width: 200px;  
      height: 200px;  
      background: linear-gradient(135deg, #8b5cf6, #a78bfa);  
      top: 50%;  
      left: 10%;  
      animation-delay: 2s;  
    }  
    .splash-shape-4 {  
      width: 150px;  
      height: 150px;  
      background: linear-gradient(135deg, #ec4899, #f472b6);  
      top: 20%;  
      right: 20%;  
      animation-delay: 3s;  
    }  
    .splash-shape-5 {  
      width: 180px;  
      height: 180px;  
      background: linear-gradient(135deg, #06b6d4, #22d3ee);  
      bottom: 20%;  
      right: 10%;  
      animation-delay: 4s;  
    }  
    @keyframes shapeFloat {  
      0%, 100% { transform: translate(0, 0) scale(1); }  
      25% { transform: translate(30px, -30px) scale(1.1); }  
      50% { transform: translate(-20px, 20px) scale(0.9); }  
      75% { transform: translate(20px, 30px) scale(1.05); }  
    }  
      
    /* الخطوط المتحركة */  
    .splash-lines {  
      position: absolute;  
      width: 100%;  
      height: 100%;  
      overflow: hidden;  
    }  
    .splash-line {  
      position: absolute;  
      width: 2px;  
      height: 100%;  
      background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.3), transparent);  
      animation: lineMove 3s ease-in-out infinite;  
    }  
    .splash-line:nth-child(1) { left: 20%; animation-delay: 0s; }  
    .splash-line:nth-child(2) { left: 50%; animation-delay: 1s; }  
    .splash-line:nth-child(3) { left: 80%; animation-delay: 2s; }  
    @keyframes lineMove {  
      0%, 100% { transform: translateY(-100%); opacity: 0; }  
      50% { transform: translateY(100%); opacity: 1; }  
    }  
      
    /* المحتوى الرئيسي */  
    .splash-content {  
      position: relative;  
      z-index: 10;  
      display: flex;  
      flex-direction: column;  
      align-items: center;  
      text-align: center;  
    }  
      
    /* حاوية الشعار */  
    .splash-logo-container {  
      position: relative;  
      width: 160px;  
      height: 160px;  
      margin-bottom: 30px;  
    }  
    .splash-logo-ring {  
      position: absolute;  
      border-radius: 50%;  
      border: 2px solid rgba(255,255,255,0.2);  
    }  
    .splash-ring-1 {  
      width: 100%;  
      height: 100%;  
      top: 0;  
      left: 0;  
      animation: ringRotate 4s linear infinite;  
    }  
    .splash-ring-2 {  
      width: 130px;  
      height: 130px;  
      top: 15px;  
      left: 15px;  
      border-color: rgba(245,158,11,0.4);  
      animation: ringRotate 3s linear infinite reverse;  
    }  
    .splash-ring-3 {  
      width: 100px;  
      height: 100px;  
      top: 30px;  
      left: 30px;  
      border-color: rgba(16,185,129,0.4);  
      animation: ringRotate 2s linear infinite;  
    }  
    @keyframes ringRotate {  
      0% { transform: rotate(0deg); }  
      100% { transform: rotate(360deg); }  
    }  
      
    /* الشعار الرئيسي */  
    .splash-main-logo {  
      position: absolute;  
      top: 50%;  
      left: 50%;  
      transform: translate(-50%, -50%);  
      display: flex;  
      flex-direction: column;  
      align-items: center;  
      animation: logoEntrance 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;  
    }  
    .logo-text {  
      font-family: var(--font-title);  
      font-size: 36px;  
      font-weight: 900;  
      color: #fff;  
      text-shadow: 0 4px 20px rgba(0,0,0,0.3);  
      letter-spacing: 3px;  
    }  
    .logo-icon {  
      font-size: 28px;  
      margin-top: 5px;  
      animation: iconBounce 1.5s ease-in-out infinite;  
    }  
    @keyframes logoEntrance {  
      0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); opacity: 0; }  
      100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }  
    }  
    @keyframes iconBounce {  
      0%, 100% { transform: translateY(0); }  
      50% { transform: translateY(-10px); }  
    }  
      
    /* العنوان */  
    .splash-title-container {  
      margin-bottom: 30px;  
    }  
    .splash-title {  
      font-family: var(--font-title);  
      font-size: 32px;  
      font-weight: 800;  
      color: #fff;  
      margin: 0;  
      text-shadow: 0 4px 20px rgba(0,0,0,0.3);  
      animation: titleSlide 0.8s ease-out 0.3s both;  
    }  
    .splash-subtitle {  
      font-family: var(--font-main);  
      font-size: 16px;  
      color: rgba(255,255,255,0.9);  
      margin: 10px 0 0;  
      animation: titleSlide 0.8s ease-out 0.5s both;  
    }  
    @keyframes titleSlide {  
      0% { transform: translateY(30px); opacity: 0; }  
      100% { transform: translateY(0); opacity: 1; }  
    }  
      
    /* الأيقونات المتحركة */  
    .splash-icons {  
      position: absolute;  
      width: 300px;  
      height: 300px;  
      pointer-events: none;  
    }  
    .splash-icon {  
      position: absolute;  
      font-size: 28px;  
      top: 50%;  
      left: 50%;  
      animation: iconFloat 3s ease-in-out infinite;  
      animation-delay: var(--delay);  
      opacity: 0;  
    }  
    @keyframes iconFloat {  
      0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }  
      20% { transform: translate(calc(-50% + var(--x)), calc(-50% + var(--y))) scale(1); opacity: 1; }  
      80% { transform: translate(calc(-50% + var(--x) * 1.2), calc(-50% + var(--y) * 1.2)) scale(1); opacity: 1; }  
      100% { transform: translate(calc(-50% + var(--x) * 1.5), calc(-50% + var(--y) * 1.5)) scale(0); opacity: 0; }  
    }  
      
    /* شريط التحميل العصري - تصميم محسّن */  
    .splash-loader-modern {  
      width: 280px;  
      margin-bottom: 20px;  
      display: flex;  
      flex-direction: column;  
      align-items: center;  
    }  
    .loader-track {  
      width: 100%;  
      height: 8px;  
      background: rgba(255,255,255,0.15);  
      border-radius: 20px;  
      overflow: hidden;  
      position: relative;  
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);  
    }  
    .loader-fill {  
      width: 0%;  
      height: 100%;  
      background: linear-gradient(90deg, #f59e0b, #fbbf24, #f59e0b, #fbbf24);  
      background-size: 300% 100%;  
      border-radius: 20px;  
      animation: loaderFill 3s ease-in-out forwards, loaderShimmer 1.5s linear infinite;  
      box-shadow: 0 0 15px rgba(245,158,11,0.6);  
    }  
    .loader-glow {  
      position: absolute;  
      top: -8px;  
      right: 0;  
      width: 40px;  
      height: 24px;  
      background: radial-gradient(circle, rgba(245,158,11,0.9), transparent);  
      border-radius: 50%;  
      animation: loaderGlow 3s ease-in-out forwards;  
      filter: blur(2px);  
    }  
    .loader-percentage {  
      font-family: var(--font-main);  
      font-size: 14px;  
      color: rgba(255,255,255,0.9);  
      margin-top: 10px;  
      font-weight: 600;  
    }  
    @keyframes loaderFill {  
      0% { width: 0%; }  
      20% { width: 20%; }  
      40% { width: 45%; }  
      60% { width: 65%; }  
      80% { width: 85%; }  
      100% { width: 100%; }  
    }  
    @keyframes loaderShimmer {  
      0% { background-position: 300% 0; }  
      100% { background-position: -300% 0; }  
    }  
    @keyframes loaderGlow {  
      0% { right: 100%; opacity: 0; }  
      10% { opacity: 1; }  
      90% { opacity: 1; }  
      100% { right: 0%; opacity: 0; }  
    }  
      
    .loader-dots {  
      display: flex;  
      justify-content: center;  
      gap: 8px;  
      margin-top: 15px;  
    }  
    .loader-dots span {  
      width: 8px;  
      height: 8px;  
      background: rgba(255,255,255,0.5);  
      border-radius: 50%;  
      animation: dotPulse 1.2s ease-in-out infinite;  
    }  
    .loader-dots span:nth-child(2) { animation-delay: 0.2s; }  
    .loader-dots span:nth-child(3) { animation-delay: 0.4s; }  
    @keyframes dotPulse {  
      0%, 100% { transform: scale(1); opacity: 0.5; }  
      50% { transform: scale(1.5); opacity: 1; }  
    }  
      
    .splash-loading-text {  
      font-family: var(--font-main);  
      font-size: 14px;  
      color: rgba(255,255,255,0.8);  
      margin: 0;  
      animation: textPulse 1.5s ease-in-out infinite;  
    }  
    @keyframes textPulse {  
      0%, 100% { opacity: 0.6; }  
      50% { opacity: 1; }  
    }  
      
    /* حاوية الجوال */  
    .splash-phone-container {  
      position: relative;  
      margin-bottom: 30px;  
    }  
      
    /* شكل الجوال آيفون برو ماكس */  
    .splash-phone {  
      width: 140px;  
      height: 280px;  
      background: linear-gradient(145deg, #3a3a3a, #1a1a1a);  
      border-radius: 35px;  
      position: relative;  
      box-shadow:   
        0 30px 60px rgba(0,0,0,0.6),  
        0 0 0 2px #5a5a5a,  
        inset 0 0 0 2px #2a2a2a,  
        0 0 100px rgba(59,130,246,0.3);  
      animation: phoneEntrance 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards, phoneFloat 3s ease-in-out 1.2s infinite;  
      overflow: hidden;  
      transform-style: preserve-3d;  
      perspective: 1000px;  
    }  
    @keyframes phoneEntrance {  
      0% {   
        transform: scale(0) rotateY(180deg) rotateX(45deg) translateY(100px);  
        opacity: 0;  
        filter: blur(20px);  
      }  
      40% {  
        transform: scale(1.2) rotateY(-30deg) rotateX(-10deg) translateY(-30px);  
        opacity: 1;  
        filter: blur(0);  
      }  
      70% {  
        transform: scale(0.95) rotateY(15deg) rotateX(5deg) translateY(10px);  
      }  
      100% {   
        transform: scale(1) rotateY(0deg) rotateX(0deg) translateY(0);  
        opacity: 1;  
      }  
    }  
    @keyframes phoneFloat {  
      0%, 100% {   
        transform: translateY(0) rotateZ(-2deg) rotateX(0deg);  
        box-shadow: 0 30px 60px rgba(0,0,0,0.6), 0 0 100px rgba(59,130,246,0.3);  
      }  
      25% {  
        transform: translateY(-15px) rotateZ(3deg) rotateX(5deg);  
        box-shadow: 0 45px 80px rgba(0,0,0,0.5), 0 0 120px rgba(59,130,246,0.4);  
      }  
      50% {   
        transform: translateY(-8px) rotateZ(-3deg) rotateX(-3deg);  
        box-shadow: 0 35px 70px rgba(0,0,0,0.55), 0 0 110px rgba(59,130,246,0.35);  
      }  
      75% {  
        transform: translateY(-20px) rotateZ(2deg) rotateX(3deg);  
        box-shadow: 0 50px 90px rgba(0,0,0,0.45), 0 0 130px rgba(59,130,246,0.45);  
      }  
    }  
      
    /* النوتش */  
    .phone-notch {  
      width: 50px;  
      height: 18px;  
      background: #1a1a1a;  
      border-radius: 0 0 12px 12px;  
      position: absolute;  
      top: 0;  
      left: 50%;  
      transform: translateX(-50%);  
      z-index: 2;  
    }  
      
    /* شاشة الجوال */  
    .phone-screen {  
      position: absolute;  
      top: 8px;  
      left: 8px;  
      right: 8px;  
      bottom: 8px;  
      background: linear-gradient(180deg, #3b82f6, #1e40af);  
      border-radius: 18px;  
      display: flex;  
      flex-direction: column;  
      align-items: center;  
      justify-content: center;  
      overflow: hidden;  
    }  
    .phone-logo {  
      font-size: 28px;  
      font-weight: 900;  
      color: #fff;  
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);  
      animation: logoGlow 1.5s ease-in-out infinite;  
    }  
    @keyframes logoGlow {  
      0%, 100% { text-shadow: 0 2px 10px rgba(255,255,255,0.3); }  
      50% { text-shadow: 0 2px 20px rgba(255,255,255,0.8), 0 0 30px rgba(59,130,246,0.5); }  
    }  
    .phone-tagline {  
      font-size: 8px;  
      color: rgba(255,255,255,0.9);  
      margin-top: 5px;  
    }  
      
    /* زر الجوال */  
    .phone-button {  
      width: 35px;  
      height: 4px;  
      background: #4a4a4a;  
      border-radius: 2px;  
      position: absolute;  
      bottom: 8px;  
      left: 50%;  
      transform: translateX(-50%);  
    }  
      
    /* جزيئات المال المتطايرة */  
    .money-particles {  
      position: absolute;  
      width: 300px;  
      height: 350px;  
      top: 50%;  
      left: 50%;  
      transform: translate(-50%, -50%);  
      pointer-events: none;  
    }  
    .money {  
      position: absolute;  
      font-size: 35px;  
      top: 60%;  
      left: 50%;  
      animation: moneyExplode 2.5s ease-out infinite;  
      animation-delay: var(--delay);  
      opacity: 0;  
      filter: drop-shadow(0 5px 15px rgba(0,0,0,0.4));  
    }  
    @keyframes moneyExplode {  
      0% {   
        transform: translate(-50%, 0) scale(0) rotate(0deg);  
        opacity: 0;  
      }  
      15% {  
        opacity: 1;  
        transform: translate(calc(-50% + var(--x) * 0.3), -30px) scale(1.2) rotate(20deg);  
      }  
      40% {  
        opacity: 1;  
        transform: translate(calc(-50% + var(--x)), -120px) scale(1) rotate(180deg);  
      }  
      70% {  
        opacity: 0.8;  
        transform: translate(calc(-50% + var(--x) * 1.5), -200px) scale(0.8) rotate(360deg);  
      }  
      100% {   
        transform: translate(calc(-50% + var(--x) * 2), -280px) scale(0.3) rotate(540deg);  
        opacity: 0;  
      }  
    }  
    /* إضافة تأثير التوهج للمال */  
    .money::after {  
      content: '';  
      position: absolute;  
      width: 100%;  
      height: 100%;  
      background: radial-gradient(circle, rgba(251,191,36,0.4) 0%, transparent 70%);  
      border-radius: 50%;  
      animation: moneyGlow 1s ease-in-out infinite;  
    }  
    @keyframes moneyGlow {  
      0%, 100% { transform: scale(1); opacity: 0.5; }  
      50% { transform: scale(1.5); opacity: 0.8; }  
    }  
      
    .splash-text {  
      color: rgba(255,255,255,0.9);  
      font-size: 16px;  
      margin-top: 10px;  
      animation: textPulse 1.5s ease-in-out infinite;  
    }  
    @keyframes textPulse {  
      0%, 100% { opacity: 0.7; }  
      50% { opacity: 1; }  
    }  
    .splash-loader {  
      width: 200px;  
      height: 4px;  
      background: rgba(255,255,255,0.2);  
      border-radius: 4px;  
      margin-top: 20px;  
      overflow: hidden;  
    }  
    .splash-loader-bar {  
      width: 0%;  
      height: 100%;  
      background: linear-gradient(90deg, #f59e0b, #fbbf24, #f59e0b);  
      background-size: 200% 100%;  
      border-radius: 4px;  
      animation: loading 2.5s ease-in-out forwards, shimmer 1s linear infinite;  
    }  
    @keyframes loading {  
      0% { width: 0%; }  
      100% { width: 100%; }  
    }  
    @keyframes shimmer {  
      0% { background-position: 200% 0; }  
      100% { background-position: -200% 0; }  
    }  
    @keyframes pulse {  
      0%, 100% { transform: scale(1); }  
      50% { transform: scale(1.05); }  
    }  
      
    /* الترحيب حسب الوقت */  
    .time-greeting {  
      font-size: 16px;  
      color: rgba(255,255,255,0.9);  
      margin-bottom: 5px;  
    }  
      
    header {  
      background: transparent;  
      color: #fff;  
      padding: 14px 10px;  
      position: relative;  
      z-index: 10;  
    }  
    header h1 {  
      margin: 0;  
      font-size: 28px;  
      font-weight: 900;  
      letter-spacing: 0.03em;  
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);  
    }  
    header p {  
      margin: 4px 0 0;  
      font-size: 16px;  
      opacity: 0.95;  
    }  
    .top-bar {  
      display: flex;  
      justify-content: flex-start;  
      align-items: center;  
      max-width: 900px;  
      margin: 0 auto;  
    }  
  
    .page-container {  
      max-width: 900px;  
      margin: 16px auto 32px;  
      padding: 0 10px;  
    }  
    .card {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 35px;
      padding: 40px 30px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      margin-bottom: 20px;
      text-align: center;
      width: 100%;
      border: 1px solid rgba(255, 255, 255, 0.4);
      position: relative;  
      z-index: 1;
      color: #1e293b;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.3);
    }
    .card h2, .card h3, .card h4, .card p, .card label, .card span {
      color: #1e293b;
    }  
      
    /* عند وجود خلفية عامة - جعل البطاقات شفافة أكثر */  
body.has-global-bg .card {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
      
    /* إخفاء البطاقات عند الطلب */  
    body.hide-cards .card {  
      background: transparent !important;  
      box-shadow: none !important;  
      border: none !important;  
      backdrop-filter: none !important;  
    }  
  
    button, .btn {  
      border-radius: 999px;  
      border: none;  
      padding: 14px 22px;  
      font-size: 19px;  
      cursor: pointer;  
      display: inline-flex;  
      align-items: center;  
      justify-content: center;  
      gap: 10px;  
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, opacity .12s ease;  
    }  
    button.primary, .btn.primary {  
      background: linear-gradient(135deg, #ec4899, #db2777);  
      color: #ffffff;  
      box-shadow: 0 8px 20px rgba(236, 72, 153, 0.4);  
      font-weight: 700;  
    }  
    button.primary:hover, .btn.primary:hover {  
      transform: translateY(-2px);  
      box-shadow: 0 12px 28px rgba(236, 72, 153, 0.5);  
      background: linear-gradient(135deg, #f472b6, #ec4899);  
    }  
    button.secondary, .btn.secondary {  
      background: #e0f2fe;  
      color: #1d4ed8;  
    }  
    button.secondary:hover, .btn.secondary:hover {  
      background: #dbeafe;  
    }  
    button.small, .btn.small {  
      padding: 12px 20px;  
      font-size: 18px;  
    }  
  
    input, select, textarea {  
      width: 100%;  
      padding: 11px 12px;  
      margin: 8px 0 2px;  
      font-size: 18px;  
      border-radius: 12px;  
      border: 1px solid #d1d5db;  
      text-align: right;  
      background: #ffffff;  
      color: #1e293b;  
    }  
    input::placeholder {
      color: #9ca3af;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
      background: #ffffff;
    }
    
    /* إزالة الإطارات الصفراء المتقطعة من جميع الأزرار */
    button:focus, a:focus, .landing-start-btn:focus, .secondary-btn:focus {
      outline: none !important;
      box-shadow: none !important;
    }
    button, a, .landing-start-btn, .secondary-btn {
      outline: none !important;
    }  
    label {  
      display: block;  
      text-align: right;  
      font-size: 17px;  
      margin-top: 8px;  
      font-weight: 700;  
      color: #374151;  
    }  
      
    /* تنسيق خاص لملصقات الأسئلة في الحاسبة - شفاف مع خط أبيض */
    #question label {
      background: transparent !important;
      color: #ffffff !important;
      font-size: 24px !important;
      font-weight: 800 !important;
      text-shadow: 0 2px 10px rgba(0,0,0,0.5) !important;
      padding: 10px 0 !important;
      margin-bottom: 15px !important;
      display: block !important;
      text-align: center !important;
      border: none !important;
      box-shadow: none !important;
    }
  
    .fade-in {  
      animation: fadeInMove .3s ease-out forwards;  
      opacity: 0;  
      transform: translateY(10px);  
    }  
    @keyframes fadeInMove {  
      to { opacity: 1; transform: translateY(0); }  
    }  
  
    .page { display: none !important; }  
    .page.active { display: block !important; }  
    .page.active.landing-modern { display: flex !important; }  
  
    .welcome-title {  
      font-size: 23px;  
      margin-bottom: 6px;  
      color: #111827;  
    }  
    .welcome-sub {  
      font-size: 15px;  
      color: #6b7280;  
      margin-bottom: 18px;  
    }  
  
    .steps-badge {  
      font-size: 14px;  
      color: #6b7280;  
      margin-bottom: 6px;  
      text-align: right;  
    }  
  
    .result-header {  
      display: flex;  
      justify-content: space-between;  
      gap: 8px;  
      align-items: center;  
      flex-wrap: wrap;  
      margin-bottom: 6px;  
    }  
    .client-chip {  
      background: #e0f2fe;  
      color: #1d4ed8;  
      border-radius: 999px;  
      padding: 6px 14px;  
      font-size: 14px;  
      border: 1px solid #bfdbfe;  
    }  
    .badge-mode {  
      background: #eff6ff;  
      color: #1d4ed8;  
      border-radius: 999px;  
      padding: 4px 10px;  
      font-size: 12px;  
      display: inline-block;  
    }  
    .badge-duration {  
      background: #e0f2fe;  
      color: #1e3a8a;  
      border-radius: 999px;  
      padding: 4px 10px;  
      font-size: 12px;  
      display: inline-block;  
      margin-top: 3px;  
    }  
  
    .bank-card {  
      display: flex;  
      align-items: center;  
      gap: 16px;  
      padding: 20px 22px;  
      border-radius: 25px;  
      background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);  
      border: 2px solid #c4b5fd;  
      margin: 15px 0 20px;  
      text-align: right;  
      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.15);  
      transition: transform 0.3s ease;
    }
    .bank-card:hover {
      transform: scale(1.02);
    }  
    .bank-logo {  
      width: 56px;  
      height: 56px;  
      border-radius: 16px;  
      background: #ffffff;  
      display: flex;  
      align-items: center;  
      justify-content: center;  
      overflow: hidden;  
      flex-shrink: 0;  
      border: 2px solid #bfdbfe;  
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);  
    }  
    .bank-logo img {  
      max-width: 100%;  
      max-height: 100%;  
      object-fit: contain;  
    }  
    .bank-text-main {  
      font-size: 18px;  
      font-weight: 800;  
      color: #1e40af;  
      margin-bottom: 4px;  
    }  
    .bank-text-sub {  
      font-size: 14px;  
      color: #3b82f6;  
      line-height: 1.6;  
      font-weight: 500;  
    }  
  
    /* ====== تحسين شكل النتيجة - تصميم عصري ====== */  
    .result-main-block {  
      background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 50%, #ecfeff 100%);  
      border-radius: 24px;  
      padding: 20px 18px;  
      margin-top: 8px;  
      text-align: right;  
      border: 2px solid #bae6fd;  
      box-shadow: 0 8px 32px rgba(14, 165, 233, 0.15);  
    }  
    .result-main-title {  
      font-size: 18px;  
      color: #0369a1;  
      margin-bottom: 6px;  
      display:flex;  
      align-items:center;  
      gap:10px;  
      font-weight: 800;  
      letter-spacing: 0.3px;  
    }  
    .result-amount-main {  
      font-size: 42px;  
      font-weight: 900;  
      background: linear-gradient(135deg, #0369a1, #0ea5e9);  
      -webkit-background-clip: text;  
      -webkit-text-fill-color: transparent;  
      background-clip: text;  
      margin: 8px 0 12px;  
      letter-spacing: 0.5px;  
      line-height: 1.1;  
      text-shadow: 0 2px 4px rgba(0,0,0,0.05);  
    }  
    .result-amount-sub {  
      font-size: 15px;  
      color: #0284c7;  
      margin: 4px 0;  
      line-height: 1.7;  
      font-weight: 500;  
    }  
    .result-amount-small {  
      font-size: 14px;  
      color: #334155;  
      margin-top: 4px;  
      line-height: 1.7;  
      font-weight: 500;  
    }  
      
    /* بطاقة الترحيب العصرية */  
    .result-greeting-card {  
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);  
      border-radius: 20px;  
      padding: 16px 20px;  
      margin-bottom: 16px;  
      border: 2px solid #fcd34d;  
      text-align: right;  
    }  
    .result-greeting-emoji {  
      font-size: 32px;  
      margin-bottom: 8px;  
    }  
    .result-greeting-text {  
      font-size: 20px;  
      font-weight: 800;  
      color: #92400e;  
      line-height: 1.6;  
    }  
    .result-greeting-sub {  
      font-size: 15px;  
      color: #b45309;  
      margin-top: 6px;  
      font-weight: 500;  
    }  
      
    /* بطاقة التقاعد */  
    .retirement-card {  
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);  
      border-radius: 20px;  
      padding: 16px 18px;  
      margin: 12px 0;  
      border: 2px solid #6ee7b7;  
      text-align: right;  
    }  
    .retirement-title {  
      font-size: 16px;  
      font-weight: 800;  
      color: #047857;  
      margin-bottom: 10px;  
      display: flex;  
      align-items: center;  
      gap: 8px;  
    }  
    .retirement-row {  
      display: flex;  
      justify-content: space-between;  
      align-items: center;  
      padding: 8px 0;  
      border-bottom: 1px dashed #a7f3d0;  
      font-size: 14px;  
      color: #065f46;  
    }  
    .retirement-row:last-child { border-bottom: none; }  
    .retirement-value {  
      font-weight: 800;  
      color: #047857;  
      font-size: 16px;  
    }  
  
    .support-panel {  
      margin-top: 10px;  
      border-radius: 16px;  
      padding: 10px 12px;  
      background: #f8fafc;  
      border: 1px solid #e5e7eb;  
    }  
    .support-title {  
      font-size: 13px;  
      font-weight: 900;  
      color: #0f766e;  
      display:flex;  
      align-items:center;  
      gap:8px;  
      margin-bottom: 6px;  
    }  
    .support-row {  
      font-size: 13px;  
      color: #0f172a;  
      display:flex;  
      justify-content: space-between;  
      gap: 10px;  
      padding: 4px 0;  
      border-bottom: 1px dashed #e5e7eb;  
    }  
    .support-row:last-child{ border-bottom:none; }  
    .support-badge {  
      display:inline-flex;  
      align-items:center;  
      gap:6px;  
      padding: 4px 10px;  
      border-radius: 999px;  
      font-size: 12px;  
      background:#ecfeff;  
      color:#155e75;  
      border: 1px solid #a5f3fc;  
      margin-top: 6px;  
    }  
  
    .dual-main-grid {  
      display: grid;  
      grid-template-columns: repeat(auto-fit,minmax(180px,1fr));  
      gap: 8px;  
      margin-top: 10px;  
    }  
    .dual-box {  
      background: #eff6ff;  
      border-radius: 14px;  
      padding: 8px 10px;  
      font-size: 13px;  
      text-align: right;  
      border: 1px solid #dbeafe;  
    }  
    .dual-box-title {  
      font-size: 12px;  
      color: #1d4ed8;  
      margin-bottom: 2px;  
      font-weight: 900;  
    }  
    .dual-box-amount {  
      font-size: 18px;  
      font-weight: 900;  
      color: #1e3a8a;  
    }  
  
    .result-section-title {  
      text-align: right;  
      font-size: 18px;  
      font-weight: 800;  
      margin: 16px 0 10px;  
      color: #0f172a;  
      display: flex;  
      align-items: center;  
      gap: 8px;  
    }  
    .result-section-box {  
      border-radius: 20px;  
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);  
      border: 2px solid #e2e8f0;  
      padding: 14px 16px;  
      text-align: right;  
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);  
    }  
  
    /* الأقساط بخط أوضح */  
    .instalment-row {  
      font-size: 16px;  
      padding: 10px 0;  
      border-bottom: 1px dashed #cbd5e1;  
      text-align: right;  
      color: #1e293b;  
      line-height: 1.7;  
      font-weight: 600;  
    }  
    .instalment-row strong { font-weight: 800; color:#0369a1; font-size: 17px; }  
    .instalment-row:last-child { border-bottom: none; }  
  
    .alert-error {  
      color: #b91c1c;  
      background: #fef2f2;  
      border-radius: 12px;  
      padding: 8px 10px;  
      font-size: 14px;  
      margin: 6px 0;  
      text-align: right;  
      border: 1px solid #fecaca;  
      line-height: 1.55;  
    }  
  
    .notice-soft {  
      color:#9f1239;  
      background:#fff1f2;  
      border:1px solid #fecdd3;  
      border-radius: 14px;  
      padding: 10px 12px;  
      font-size: 13px;  
      text-align:right;  
      line-height: 1.6;  
      margin-top: 8px;  
    }  
  
    /* VAT small */  
    .vat-small {  
      font-size: 11px;  
      color: #6b7280;  
      font-weight: 600;  
      margin-top: 2px;  
    }  
  
    .admin-grid {  
      display: grid;  
      grid-template-columns: repeat(auto-fit,minmax(180px,1fr));  
      gap: 8px 12px;  
      margin-top: 6px;  
      text-align: right;  
    }  
    .admin-table {  
      width: 100%;  
      border-collapse: collapse;  
      margin-top: 10px;  
    }  
    .admin-table th, .admin-table td {  
      border: 1px solid #e5e7eb;  
      padding: 5px 6px;  
      font-size: 12px;  
      text-align: center;  
      vertical-align: top;  
    }  
    .admin-table th {  
      background: #f3f4f6;  
      color: #374151;  
    }  
  
    footer {  
      font-size: 13px;  
      color: rgba(255,255,255,0.8);  
      margin-top: 10px;  
      padding: 12px 12px;  
      position: relative;  
      background: transparent;  
      border-top: none;  
      z-index: 1;  
    }  
  
    .footer-inner {  
      max-width: 900px;  
      margin: 0 auto;  
      display: flex;  
      align-items: center;  
      justify-content: space-between;  
      gap: 8px;  
      flex-wrap: wrap;  
    }  
  
    #adminIcon {  
      border-radius: 999px;  
      background: #e5e7eb;  
      padding: 6px 12px;  
      font-size: 14px;  
      display: inline-flex;  
      align-items: center;  
      gap: 6px;  
      cursor: pointer;  
      color: #111827;  
    }  
    #adminIcon:hover { background: #d1d5db; }  
  
    /* أيقونة أدوات المسؤول - أسفل اليمين - بسيطة جداً */  
    #miniAdminTools {  
      display:flex;  
      align-items:center;  
      justify-content:center;  
      cursor:pointer;  
      padding: 2px;  
      border-radius: 50%;  
      border: none;  
      background: transparent;  
      opacity: 0.03;  
      transition: all 0.3s ease;  
      color: rgba(100, 100, 100, 0.1);  
      font-size: 4px;  
      user-select:none;  
      position: fixed;  
      bottom: 5px;  
      right: 5px;  
      left: auto;  
      z-index: 99999;  
      width: 8px;  
      height: 8px;  
      -webkit-tap-highlight-color: transparent;  
      touch-action: manipulation;  
      box-shadow: none;  
    }  
    #miniAdminTools:hover, #miniAdminTools:active {   
      background: transparent;  
      opacity: 0.15;  
      transform: scale(1.2);  
      box-shadow: none;  
    }  
  
    /* بطاقة معاينة نتيجة العميل للصورة */  
    .client-preview {  
      background:#ffffff;  
      border: 1px solid #e5e7eb;  
      border-radius: 16px;  
      padding: 12px 12px;  
      text-align:right;  
      line-height:1.7;  
      font-size:14px;  
      color:#111827;  
    }  
    .client-preview .h {  
      font-weight: 900;  
      color:#1e3a8a;  
      font-size:16px;  
      margin-bottom:6px;  
    }  
    .client-preview .k {  
      color:#374151;  
      font-weight: 800;  
    }  
    .client-preview .v {  
      color:#0f172a;  
      font-weight: 900;  
    }  
    .client-preview .hr {  
      height:1px;background:#e5e7eb;margin:10px 0;  
    }  
  
    /* ====== (إضافة) شريط صغير للهجري ====== */  
    .hijri-chip{  
      display:inline-flex;  
      align-items:center;  
      gap:6px;  
      padding: 3px 10px;  
      border-radius: 999px;  
      font-size: 11px;  
      background:#eff6ff;  
      color:#1d4ed8;  
      border: 1px solid #dbeafe;  
      margin-right:6px;  
      font-weight:800;  
      white-space:nowrap;  
    }  
      
    /* ===== الصفحة الرئيسية العصرية ===== */  
    .landing-modern {  
      position: relative;  
      min-height: 100vh;  
      display: flex;  
      align-items: center;  
      justify-content: center;  
      padding: 20px;  
    }  
      
    /* تأثيرات الخلفية */  
    .landing-bg-effects {  
      position: absolute;  
      top: 0;  
      left: 0;  
      width: 100%;  
      height: 100%;  
      overflow: hidden;  
      pointer-events: none;  
    }  
    .landing-orb {  
      position: absolute;  
      border-radius: 50%;  
      filter: blur(80px);  
      opacity: 0;  
      animation: none;  
      display: none;  
    }  
    .landing-orb-1 {  
      width: 400px;  
      height: 400px;  
      background: linear-gradient(135deg, var(--color-secondary), var(--color-secondary-light));  
      top: -150px;  
      right: -150px;  
    }  
    .landing-orb-2 {  
      width: 350px;  
      height: 350px;  
      background: linear-gradient(135deg, var(--color-accent), #34d399);  
      bottom: -100px;  
      left: -100px;  
      animation-delay: 2s;  
    }  
    .landing-orb-3 {  
      width: 250px;  
      height: 250px;  
      background: linear-gradient(135deg, #8b5cf6, #a78bfa);  
      top: 40%;  
      left: 50%;  
      transform: translateX(-50%);  
      animation-delay: 4s;  
    }  
    @keyframes orbFloat {  
      0%, 100% { transform: translate(0, 0) scale(1); }  
      33% { transform: translate(30px, -30px) scale(1.1); }  
      66% { transform: translate(-20px, 20px) scale(0.95); }  
    }  
      
    .landing-grid {  
      position: absolute;  
      width: 100%;  
      height: 100%;  
      background-image:   
        linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),  
        linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);  
      background-size: 50px 50px;  
      animation: gridMove 20s linear infinite;  
    }  
    @keyframes gridMove {  
      0% { transform: translate(0, 0); }  
      100% { transform: translate(50px, 50px); }  
    }  
      
    /* البطاقة الرئيسية - شفافة تماماً */  
    .landing-card {  
      position: relative;  
      z-index: 10;  
      background: transparent !important;  
      backdrop-filter: none !important;  
      -webkit-backdrop-filter: none !important;  
      border-radius: 0 !important;  
      padding: 35px 25px;  
      max-width: 420px;  
      width: 100%;  
      box-shadow: none !important;  
      border: none !important;  
      animation: cardEntrance 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;  
    }  
    @keyframes cardEntrance {  
      0% { transform: translateY(50px) scale(0.9); opacity: 0; }  
      100% { transform: translateY(0) scale(1); opacity: 1; }  
    }  
      
    /* الشريط العلوي */  
    .landing-header {  
      display: flex;  
      justify-content: space-between;  
      align-items: center;  
      margin-bottom: 25px;  
    }  
    .time-greeting-modern {  
      display: flex;  
      align-items: center;  
      gap: 8px;  
      background: transparent;  
      padding: 8px 15px;  
      border-radius: 25px;  
      border: none;  
    }  
    .greeting-icon {  
      font-size: 18px;  
    }  
    .greeting-text {  
      font-family: var(--font-main);  
      font-size: 13px;  
      font-weight: 600;  
      color: #ffffff;  
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);  
    }  
    .landing-badge {  
      background: linear-gradient(135deg, var(--color-secondary), var(--color-secondary-dark));  
      color: #fff;  
      padding: 6px 12px;  
      border-radius: 20px;  
      font-size: 11px;  
      font-weight: 700;  
      display: flex;  
      align-items: center;  
      gap: 5px;  
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);  
    }  
      
    /* قسم الشعار */  
    .landing-logo-section {  
      text-align: center;  
      margin-bottom: 25px;  
    }  
    .landing-logo {  
      position: relative;  
      display: none;  
      margin-bottom: 15px;  
    }  
    .logo-main {  
      font-family: var(--font-title);  
      font-size: 52px;  
      font-weight: 900;  
      color: #ffffff;  
      letter-spacing: 4px;  
      position: relative;  
      z-index: 1;  
      text-shadow: 3px 3px 6px rgba(0,0,0,0.5);  
    }  
    .logo-glow {  
      position: absolute;  
      top: 50%;  
      left: 50%;  
      transform: translate(-50%, -50%);  
      width: 120px;  
      height: 60px;  
      background: radial-gradient(circle, rgba(59,130,246,0.3), transparent);  
      filter: blur(20px);  
      animation: logoGlowPulse 2s ease-in-out infinite;  
    }  
    @keyframes logoGlowPulse {  
      0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }  
      50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.2); }  
    }  
    .landing-title {  
      font-family: var(--font-title);  
      font-size: 24px;  
      font-weight: 800;  
      color: #ffffff;  
      margin: 0 0 8px;  
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);  
    }  
    .landing-subtitle {  
      font-family: var(--font-main);  
      font-size: 14px;  
      color: #ffffff;  
      margin: 0;  
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);  
    }  
      
    /* المميزات */  
    .landing-features {  
      display: flex;  
      justify-content: center;  
      gap: 15px;  
      margin-bottom: 25px;  
      flex-wrap: wrap;  
    }  
    .feature-item {  
      display: flex;  
      flex-direction: column;  
      align-items: center;  
      gap: 5px;  
      padding: 12px 15px;  
      background: transparent;  
      border-radius: 16px;  
      border: none;  
      box-shadow: none;  
      transition: transform 0.3s ease, box-shadow 0.3s ease;  
    }  
    .feature-item:hover {  
      transform: translateY(-3px);  
      box-shadow: none;  
    }  
    .feature-icon {  
      font-size: 22px;  
    }  
    .feature-text {  
      font-family: var(--font-main);  
      font-size: 11px;  
      font-weight: 600;  
      color: #ffffff;  
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);  
    }  
      
    /* زر البدء - تصميم جديد بدون خلفية */  
    .landing-start-btn {  
      position: relative;  
      width: 100%;  
      padding: 15px 30px;  
      background: transparent;  
      border: 3px solid var(--color-secondary);  
      border-radius: 50px;  
      color: var(--color-secondary);  
      font-family: var(--font-title);  
      font-size: 22px;  
      font-weight: 900;  
      cursor: pointer;  
      display: flex;  
      align-items: center;  
      justify-content: center;  
      gap: 15px;  
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);  
      overflow: hidden;  
      margin-top: 10px;  
      text-transform: uppercase;  
      letter-spacing: 1px;  
    }  
    .landing-start-btn:hover {  
      background: var(--color-secondary);  
      color: #fff;  
      transform: scale(1.05);  
      box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);  
    }  
    .landing-start-btn:active {  
      transform: scale(0.95);  
    }  
    .landing-start-btn .btn-icon {  
      transition: transform 0.4s ease;  
    }  
    .landing-start-btn:hover .btn-icon {  
      transform: translateX(-10px) rotate(-20deg);  
    }  
    .btn-text {  
      position: relative;  
      z-index: 1;  
    }  
    .btn-icon {  
      font-size: 24px;  
      position: relative;  
      z-index: 1;  
      animation: rocketBounce 1s ease-in-out infinite;  
    }  
    @keyframes rocketBounce {  
      0%, 100% { transform: translateY(0); }  
      50% { transform: translateY(-5px); }  
    }  
    .btn-shine {  
      position: absolute;  
      top: 0;  
      left: -100%;  
      width: 100%;  
      height: 100%;  
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);  
      animation: btnShine 3s ease-in-out infinite;  
    }  
    @keyframes btnShine {  
      0% { left: -100%; }  
      50%, 100% { left: 100%; }  
    }  
      
    /* الأزرار الثانوية */  
    .landing-secondary-btns {  
      margin-top: 15px;  
      display: flex;  
      justify-content: center;  
      gap: 10px;  
      flex-wrap: wrap;  
    }  
    .secondary-btn {  
      background: rgba(255,255,255,0.2);  
      border: 2px solid rgba(255,255,255,0.5);  
      border-radius: 15px;  
      padding: 12px 20px;  
      font-family: var(--font-main);  
      font-size: 13px;  
      font-weight: 600;  
      color: #ffffff;  
      cursor: pointer;  
      display: flex;  
      align-items: center;  
      gap: 8px;  
      transition: all 0.3s ease;  
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);  
      backdrop-filter: blur(5px);  
    }  
    .secondary-btn:hover {  
      background: rgba(255,255,255,0.3);  
      transform: translateY(-2px);  
    }  
      
    /* الملاحظة */  
    .landing-note {  
      font-family: var(--font-main);  
      font-size: 12px;  
      color: #ffffff;  
      margin: 15px 0 0;  
      text-align: center;  
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);  
    }  
      
    /* قسم التقييمات */  
    .landing-ratings {  
      margin-top: 20px;  
      padding: 15px;  
      background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05));  
      border-radius: 16px;  
      border: 1px solid rgba(16,185,129,0.2);  
    }  
      
    /* قسم التطمين */  
    .landing-trust {  
      margin-top: 15px;  
    }  
    .trust-btn {  
      width: 100%;  
      background: linear-gradient(135deg, var(--color-accent), var(--color-accent-dark));  
      border: none;  
      border-radius: 15px;  
      padding: 14px 20px;  
      color: #fff;  
      font-family: var(--font-main);  
      font-size: 14px;  
      font-weight: 700;  
      cursor: pointer;  
      display: flex;  
      align-items: center;  
      justify-content: center;  
      gap: 10px;  
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);  
      transition: all 0.3s ease;  
    }  
    .trust-btn:hover {  
      transform: translateY(-2px);  
      box-shadow: 0 12px 35px rgba(16, 185, 129, 0.4);  
    }  
    .trust-icon {  
      font-size: 20px;  
      animation: starPulse 1.5s ease-in-out infinite;  
    }  
    @keyframes starPulse {  
      0%, 100% { transform: scale(1); }  
      50% { transform: scale(1.2); }  
    }  
      
    /* شعارات البنوك */  
    .landing-banks {  
      display: none;  
      margin-top: 25px;  
      padding-top: 20px;  
      border-top: 1px solid rgba(255,255,255,0.2);  
    }  
    .banks-title {  
      font-family: var(--font-main);  
      font-size: 12px;  
      color: #ffffff;  
      margin: 0 0 15px;  
      text-align: center;  
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);  
    }  
    .banks-logos {  
      display: flex;  
      justify-content: center;  
      align-items: center;  
      gap: 15px;  
      flex-wrap: wrap;  
    }  
    .banks-logos img {  
      height: 30px;  
      width: auto;  
      opacity: 0.7;  
      filter: grayscale(30%);  
      transition: all 0.3s ease;  
    }  
    .banks-logos img:hover {  
      opacity: 1;  
      filter: grayscale(0%);  
      transform: scale(1.1);  
    }  
    /* توافق الآيفون والأجهزة المحمولة */  
    @media screen and (max-width: 428px) {  
      /* آيفون 14 Pro Max وأصغر */  
      body {  
        font-size: 16px;  
      }  
        
      .card {  
        margin: 10px;  
        padding: 15px;  
        border-radius: 20px;  
      }  
        
      h2 {  
        font-size: 20px;  
      }  
        
      .btn, button {  
        padding: 12px 20px;  
        font-size: 15px;  
      }  
        
      select, input {  
        font-size: 16px; /* منع التكبير التلقائي على iOS */  
        padding: 12px;  
      }  
        
      /* شاشة البداية */  
      .splash-logo {  
        font-size: 48px !important;  
      }  
        
      .splash-tagline {  
        font-size: 14px !important;  
      }  
        
      /* الصفحة الرئيسية */  
      .modern-landing-card {  
        padding: 20px 15px;  
      }  
        
      .modern-logo {  
        font-size: 36px;  
      }  
        
      .feature-icons {  
        gap: 15px;  
      }  
        
      .feature-icon {  
        width: 50px;  
        height: 50px;  
        font-size: 20px;  
      }  
        
      /* صفحة النتيجة */  
      .result-card {  
        padding: 15px;  
      }  
        
      .result-value {  
        font-size: 24px;  
      }  
    }  
      
    @media screen and (max-width: 375px) {  
      /* آيفون SE وأصغر */  
      body {  
        font-size: 15px;  
      }  
        
      .card {  
        margin: 8px;  
        padding: 12px;  
      }  
        
      h2 {  
        font-size: 18px;  
      }  
        
      .splash-logo {  
        font-size: 40px !important;  
      }  
        
      .modern-logo {  
        font-size: 32px;  
      }  
    }  
      
    /* تحسينات اللمس للآيفون */  
    @media (hover: none) and (pointer: coarse) {  
      .btn, button, select, input, .clickable {  
        -webkit-tap-highlight-color: transparent;  
        touch-action: manipulation;  
      }  
        
      /* تأثير الضغط */  
      .btn:active, button:active {  
        transform: scale(0.98);  
        opacity: 0.9;  
      }  
    }  
      
    /* منع التحديد على iOS */  
    * {  
      -webkit-user-select: none;  
      user-select: none;  
    }  
      
    input, textarea {  
      -webkit-user-select: text;  
      user-select: text;  
    }  
      
    /* تحسين التمرير */  
    .page, .card, .modal-content {  
      -webkit-overflow-scrolling: touch;  
    }
    
    /* ========== تصميم شفاف إجباري - يتجاوز جميع التنسيقات ========== */
    #calculatorPage .card,
    #calculatorPage > .card,
    .page .card,
    div.card,
    .card,
    [class*="card"] {
      background: transparent !important;
      background-color: transparent !important;
      backdrop-filter: none !important;
      -webkit-backdrop-filter: none !important;
      border: none !important;
      box-shadow: none !important;
      outline: none !important;
    }
    
    /* إزالة الخلفية من جميع العناصر داخل الحاسبة */
    #calculatorPage,
    #calculatorPage * {
      background-color: transparent !important;
    }
    
    /* استثناء حقول الإدخال والأزرار */
    #calculatorPage input,
    #calculatorPage select,
    #calculatorPage button {
      background: rgba(255, 255, 255, 0.15) !important;
    }
    
    /* زر التالي برتقالي */
    #nextButton, #mainButton, .primary {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
    }
    
    /* النصوص داكنة في البطاقات البيضاء */
    #calculatorPage .card h2,
    #calculatorPage .card label,
    #calculatorPage .card p,
    .page .card h2,
    .page .card label,
    .page .card p {
      color: #1e293b !important;
    }
    
    /* استثناء: النصوص في البطاقات الشفافة على الخلفية الزرقاء */
    body:not(.has-white-bg) #questionCard > h2,
    body:not(.has-white-bg) #questionCard > label,
    body:not(.has-white-bg) #questionCard > p,
    body:not(.has-white-bg) .question-title {
      color: #ffffff !important;
    }
    
    /* استثناء: بطاقات البنوك يجب أن تكون بنص داكن */
    #entitiesContainer div[style*="background:linear-gradient(135deg, #f8fafc"] div,
    #entitiesContainer div[style*="background:linear-gradient(135deg, #f8fafc"] span {
      color: inherit !important;
    }
    
    /* حقول الإدخال بيضاء مع نص داكن */
    #calculatorPage input[type="text"],
    #calculatorPage input[type="number"],
    #calculatorPage select,
    .page .card input,
    .page .card select {
      background: #ffffff !important;
      border: 1px solid #d1d5db !important;
      color: #1e293b !important;
      border-radius: 12px !important;
    }
    
    #calculatorPage input::placeholder {
      color: #9ca3af !important;
    }
    
    /* زر التالي برتقالي */
    #nextButton, #mainButton {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
      color: #ffffff !important;
      border: none !important;
      border-radius: 30px !important;
      font-weight: 700 !important;
      box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4) !important;
    }
    
    /* شريط التقدم */
    .steps-badge {
      background: rgba(255, 255, 255, 0.1) !important;
      color: #ffffff !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
    }
    
    /* إصلاح لون النص في بطاقات اختيار البنوك */
    #entitiesContainer > div[style*="background:#fff"],
    #entitiesContainer > div[style*="background:#fff"] * {
      color: #1e293b !important;
    }
    #entitiesContainer > div[style*="background:#fff"] small {
      color: #64748b !important;
    }
  </style>  
</head>  
<body>  
  
<!-- سكريبت تشغيل شاشة البداية فوراً -->  
<script>  
(function() {  
  'use strict';  
    
  // الانتظار حتى يكون DOM جاهزاً  
  function startSplash() {  
    console.log('[SplashDirect] Starting...');  
      
    var splash = document.getElementById('splashScreen');  
    var loaderFill = document.getElementById('splashLoaderFill');  
    var percentageEl = document.getElementById('splashPercentage');  
    var loadingTextEl = document.getElementById('splashLoadingText');  
      
    if (!splash || !loaderFill || !percentageEl) {  
      console.log('[SplashDirect] Elements not ready, retrying in 100ms...');  
      setTimeout(startSplash, 100);  
      return;  
    }  
      
    console.log('[SplashDirect] Elements found, starting animation...');  
      
    // التأكد من ظهور شاشة البداية  
    splash.style.display = 'flex';  
    splash.style.opacity = '1';  
      
    // إعادة تعيين شريط التحميل  
    loaderFill.style.width = '0%';  
    loaderFill.style.animation = 'none';  
    void loaderFill.offsetWidth; // force reflow  
    loaderFill.style.animation = 'loaderFill 3s ease-in-out forwards, loaderShimmer 1.5s linear infinite';  
      
    // تحديث النسبة المئوية  
    var messages = [  
      'جاري تحميل المنصة...',  
      'تجهيز الحاسبة...',  
      'تحميل بيانات البنوك...',  
      'جاهز للانطلاق! 🚀'  
    ];  
    var percent = 0;  
      
    var timer = setInterval(function() {  
      percent++;  
      percentageEl.textContent = percent + '%';  
        
      if (loadingTextEl) {  
        if (percent < 30) loadingTextEl.textContent = messages[0];  
        else if (percent < 60) loadingTextEl.textContent = messages[1];  
        else if (percent < 90) loadingTextEl.textContent = messages[2];  
        else loadingTextEl.textContent = messages[3];  
      }  
        
      if (percent >= 100) {  
        clearInterval(timer);  
        console.log('[SplashDirect] Progress complete');  
          
        // إخفاء شاشة البداية  
        setTimeout(function() {  
          splash.style.transition = 'opacity 0.5s ease-out';  
          splash.style.opacity = '0';  
          setTimeout(function() {  
            splash.style.display = 'none';  
            console.log('[SplashDirect] Hidden');  
          }, 500);  
        }, 300);  
      }  
    }, 30); // 30ms * 100 = 3 ثواني  
  }  
    
  // تشغيل فوري  
  if (document.readyState === 'loading') {  
    document.addEventListener('DOMContentLoaded', startSplash);  
  } else {  
    setTimeout(startSplash, 50);  
  }  
    
  // Fallback: إخفاء إجباري بعد 5 ثواني  
  setTimeout(function() {  
    var splash = document.getElementById('splashScreen');  
    if (splash && splash.style.display !== 'none') {  
      console.log('[SplashDirect] Emergency fallback');  
      splash.style.opacity = '0';  
      setTimeout(function() { splash.style.display = 'none'; }, 300);  
    }  
  }, 5000);  
})();  
</script>  
  
<!-- شاشة البداية - تصميم عصري مبتكر -->  
<div id="splashScreen">  
  <!-- خلفية متحركة مع أشكال هندسية -->  
  <div class="splash-bg-shapes">  
    <div class="splash-shape splash-shape-1"></div>  
    <div class="splash-shape splash-shape-2"></div>  
    <div class="splash-shape splash-shape-3"></div>  
    <div class="splash-shape splash-shape-4"></div>  
    <div class="splash-shape splash-shape-5"></div>  
  </div>  
    
  <!-- خطوط متحركة -->  
  <div class="splash-lines">  
    <div class="splash-line"></div>  
    <div class="splash-line"></div>  
    <div class="splash-line"></div>  
  </div>  
    
  <!-- المحتوى الرئيسي -->  
  <div class="splash-content">  
    <!-- الشعار المتحرك -->  
    <div class="splash-logo-container">  
      <div class="splash-logo-ring splash-ring-1"></div>  
      <div class="splash-logo-ring splash-ring-2"></div>  
      <div class="splash-logo-ring splash-ring-3"></div>  
      <div class="splash-main-logo" id="splashMainLogo">  
        <span class="logo-text">FINO</span>  
        <span class="logo-icon">🚀</span>  
      </div>  
    </div>  
      
    <!-- العنوان -->  
    <div class="splash-title-container">  
      <h1 class="splash-title" id="splashTitle">منصة FINO</h1>  
      <p class="splash-subtitle" id="splashSubtitle">حاسبة التمويل الذكية</p>  
    </div>  
      
    <!-- أيقونات متحركة -->  
    <div class="splash-icons">  
      <span class="splash-icon" style="--delay:0s;--x:-80px;--y:-60px;">💰</span>  
      <span class="splash-icon" style="--delay:0.2s;--x:90px;--y:-40px;">🏦</span>  
      <span class="splash-icon" style="--delay:0.4s;--x:-100px;--y:30px;">💳</span>  
      <span class="splash-icon" style="--delay:0.6s;--x:70px;--y:50px;">💵</span>  
      <span class="splash-icon" style="--delay:0.8s;--x:-50px;--y:-80px;">🎯</span>  
      <span class="splash-icon" style="--delay:1s;--x:60px;--y:-70px;">✨</span>  
      <span class="splash-icon" style="--delay:1.2s;--x:-70px;--y:70px;">📈</span>  
      <span class="splash-icon" style="--delay:1.4s;--x:80px;--y:80px;">🔥</span>  
    </div>  
      
    <!-- شريط التحميل العصري -->  
    <div class="splash-loader-modern">  
      <div class="loader-track">  
        <div class="loader-fill" id="splashLoaderFill"></div>  
        <div class="loader-glow"></div>  
      </div>  
      <div class="loader-percentage" id="splashPercentage">0%</div>  
    </div>  
      
    <p class="splash-loading-text" id="splashLoadingText">جاري تحميل المنصة...</p>  
  </div>  
</div>  
  
<!-- الجزيئات المتحركة -->  
<div id="particles"></div>  
  
<header>  
  <div class="top-bar">  
    <div style="text-align:right">  
      <h1>منصة FINO</h1>  
      <p>منصة ذكية تحسب لك التمويل وتُرشّح البنك الأنسب بناءً على راتبك ونوع التمويل والتزاماتك خلال ثوانٍ، بدون حيرة ولا تعب</p>  
    </div>  
  </div>  
</header>  
  
<div class="page-container">  
  
  <!-- بانر تثبيت التطبيق PWA -->  
  <div id="pwaInstallBanner" style="display:none; background:linear-gradient(135deg,#3b82f6,#1d4ed8); color:#fff; padding:12px 15px; border-radius:16px; margin-bottom:12px; text-align:center;">  
    <div style="font-size:15px; font-weight:700; margin-bottom:8px;">📱 أضف المنصة لشاشتك الرئيسية</div>  
    <div style="font-size:13px; opacity:0.9; margin-bottom:10px;">استخدم المنصة كتطبيق بدون الحاجة للمتصفح</div>  
    <div style="display:flex; gap:8px; justify-content:center;">  
      <button onclick="installPWA()" style="background:#fff; color:#1d4ed8; border:none; padding:8px 20px; border-radius:20px; font-size:14px; font-weight:700; cursor:pointer;">تثبيت التطبيق</button>  
      <button onclick="dismissInstallPrompt()" style="background:rgba(255,255,255,0.2); color:#fff; border:none; padding:8px 15px; border-radius:20px; font-size:13px; cursor:pointer;">لاحقاً</button>  
    </div>  
  </div>  
  
  <!-- ويدجت الطقس -->  
  <div id="weatherWidget" style="display:none;"></div>  
  
  <!-- صفحة الترحيب - تصميم عصري مبتكر -->  
  <div id="landingPage" class="page active landing-modern" style="background-size:cover; background-position:center; background-repeat:no-repeat;">  
    <!-- خلفية متحركة -->  
    <div class="landing-bg-effects">  
      <div class="landing-orb landing-orb-1"></div>  
      <div class="landing-orb landing-orb-2"></div>  
      <div class="landing-orb landing-orb-3"></div>  
      <div class="landing-grid"></div>  
    </div>  
      
    <!-- البطاقة الرئيسية -->  
    <div class="landing-card fade-in" id="landingCard">  
      <!-- الشريط العلوي -->  
      <div class="landing-header">  
        <div class="time-greeting-modern" id="timeGreeting">  
          <span class="greeting-icon">🌅</span>  
          <span class="greeting-text">صباح الخير</span>  
        </div>  
        <div class="landing-badge" id="bestBadge">  
          <span>✨</span> <span id="bestBadgeText">الأفضل في المملكة</span>  
        </div>  
      </div>  
        
      <!-- الشعار والعنوان -->  
      <div class="landing-logo-section">  
        <div class="landing-logo" id="landingLogo" onclick="handleLogoClick()">  
          <span class="logo-main">FINO</span>  
          <span class="logo-glow"></span>  
        </div>  
        <h1 class="landing-title" id="platformTitle">منصة التمويل الذكية</h1>  
        <p class="landing-subtitle">احسب تمويلك واختر البنك الأنسب لك</p>  
      </div>  
        
      <!-- المميزات -->  
      <div class="landing-features" id="featuresContainer">  
        <div class="feature-item">  
          <span class="feature-icon">🏦</span>  
          <span class="feature-text" id="feature1Text">مقارنة البنوك</span>  
        </div>  
        <div class="feature-item">  
          <span class="feature-icon">📊</span>  
          <span class="feature-text" id="feature2Text">حساب دقيق</span>  
        </div>  
        <div class="feature-item">  
          <span class="feature-icon">⚡</span>  
          <span class="feature-text" id="feature3Text">نتيجة فورية</span>  
        </div>  
      </div>  
        
      <!-- زر البدء -->  
      <button class="landing-start-btn" onclick="startClientFlow()">  
        <span class="btn-text">ابدأ بأسم الله</span>  
          
        <span class="btn-shine"></span>  
      </button>  
        
      <!-- الأزرار الثانوية -->  
      <div class="landing-secondary-btns">  
        <button class="secondary-btn" onclick="showPage('earlySettlement')" id="earlySettlementBtn">  
          <span>💰</span> حاسبة السداد المبكر  
        </button>  
      </div>  
        
      <!-- ملاحظة -->  
      <p class="landing-note">  
        📱 النتيجة مصممة لتصويرها وحفظها كصورة  
      </p>  
        
      <!-- قسم التقييمات -->  
      <div id="homeRatings" class="landing-ratings" style="display:none;"></div>  
        
      <!-- قسم التطمين -->  
      <div id="trustSection" class="landing-trust" style="display:none;">  
        <button onclick="showTrustRatings()" class="trust-btn">  
          <span class="trust-icon">⭐</span>  
          <span>شوف تقييمات العملاء لتطمن</span>  
        </button>  
      </div>  
        
      <!-- شعارات البنوك -->  
      <div class="landing-banks" id="landingBanks">  
        <p class="banks-title">بنوك وشركات التمويل المدعومة</p>  
        <div class="banks-logos" id="banksLogosContainer"></div>  
      </div>  
    </div>  
  </div>  
  
  <!-- صفحة الحاسبة -->  
  <div id="calculatorPage" class="page">  
    <div class="card" style="background: transparent !important; border: none !important;">  
      <div class="steps-badge">  
        أسئلة بسيطة خطوة بخطوة للوصول لأدق حسبة ممكنة 👌  
      </div>  
      <div id="question"></div>  
      <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap;">  
        <button id="nextButton" class="primary small" style="display:none;" onclick="nextQuestion()">التالي</button>  
        <button id="mainButton" class="primary small" onclick="handleStartOrReset()">ابدأ الحسبة</button>  
      </div>  
      <div id="resetButtonContainer" style="margin-top:8px; display:none; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">  
        <button id="backButton" onclick="goBack()" style="background:linear-gradient(135deg,#64748b,#475569);color:#fff;border:none;padding:6px 14px;font-size:11px;border-radius:16px;cursor:pointer;box-shadow:0 3px 10px rgba(71,85,105,0.25);transition:all 0.2s ease;opacity:0.85;display:none;" onmouseover="this.style.opacity='1';this.style.transform='translateY(-1px)'" onmouseout="this.style.opacity='0.85';this.style.transform='translateY(0)'">⬅️ رجوع للخلف</button>  
        <button onclick="resetCalc()" style="background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;border:none;padding:6px 14px;font-size:11px;border-radius:16px;cursor:pointer;box-shadow:0 3px 10px rgba(99,102,241,0.25);transition:all 0.2s ease;opacity:0.85;" onmouseover="this.style.opacity='1';this.style.transform='translateY(-1px)'" onmouseout="this.style.opacity='0.85';this.style.transform='translateY(0)'">🔄 إعادة الحسبة</button>  
      </div>  
    </div>  
  </div>  
  
  <!-- صفحة النتيجة -->  
  <div id="resultPage" class="page">  
    <div class="card fade-in" id="resultCard" style="background: rgba(255, 255, 255, 0.08) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important;">  
      <!-- تعبئة من الجافاسكربت -->  
    </div>  
  
    <!-- (تم إزالة زر "النتيجة للعميل" من هنا حسب طلبك، وصار ▫️ تحت الفوتر) -->  
  
    <div style="margin-top:10px; display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap;">  
      <button class="secondary small" onclick="backToLanding()">🏠 رجوع للرئيسية</button>  
      <div style="display:flex; gap:8px; flex-wrap:wrap;">  
        <button class="secondary small" onclick="saveResultAsImage()">📸 حفظ النتيجة كصورة</button>  
        <button class="secondary small" onclick="shareResultOnWhatsApp()">📲 مشاركة واتساب</button>  
        <button class="primary small" onclick="resetCalc(); showPage('calculator');">🔁 إعادة حسبة جديدة</button>  
      </div>  
    </div>  
  </div>  
  
    <!-- قسم التقييم -->  
    <div id="ratingSection" class="card fade-in" style="margin-top:12px; display:none; background: rgba(255, 255, 255, 0.08) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important;">  
      <h3 style="margin:0 0 8px; font-size:16px; color:#111827; text-align:right;">⭐ قيّم تجربتك</h3>  
      <p style="font-size:13px; color:#6b7280; text-align:right; margin-bottom:10px;">رأيك يهمنا! كيف كانت تجربتك مع منصة FINO؟</p>  
      <div id="ratingStars" style="display:flex; justify-content:center; gap:8px; margin-bottom:10px;">  
        <span class="rating-star" onclick="setRating(1)" style="font-size:28px; cursor:pointer;">☆</span>  
        <span class="rating-star" onclick="setRating(2)" style="font-size:28px; cursor:pointer;">☆</span>  
        <span class="rating-star" onclick="setRating(3)" style="font-size:28px; cursor:pointer;">☆</span>  
        <span class="rating-star" onclick="setRating(4)" style="font-size:28px; cursor:pointer;">☆</span>  
        <span class="rating-star" onclick="setRating(5)" style="font-size:28px; cursor:pointer;">☆</span>  
      </div>  
      <textarea id="ratingComment" placeholder="اكتب ملاحظاتك هنا (اختياري)..." style="width:100%; height:60px; border-radius:10px; border:1px solid #d1d5db; padding:8px; font-size:14px; resize:none;"></textarea>  
      <button onclick="submitRating()" style="margin-top:8px; background:linear-gradient(135deg,#10b981,#059669); color:#fff; border:none; padding:8px 20px; border-radius:20px; font-size:14px; cursor:pointer;">إرسال التقييم</button>  
      <div id="ratingSuccess" style="display:none; margin-top:8px; color:#059669; font-size:13px;">✅ شكراً لك على تقييمك!</div>  
    </div>  
  
    <!-- قسم التسويق -->  
    <div id="marketingSection" class="card fade-in" style="margin-top:12px; background:linear-gradient(135deg,#fef3c7,#fde68a); border:2px solid #f59e0b;">  
      <div style="text-align:center;">  
        <div style="font-size:24px; margin-bottom:6px;">🚀</div>  
        <h3 style="margin:0 0 6px; font-size:17px; color:#92400e;">ننجز تمويلك بأسرع وقت!</h3>  
        <p style="font-size:14px; color:#78350f; margin-bottom:10px;">تواصل معنا الحين وخلنا نساعدك في إتمام تمويلك بدون تعقيدات ⚡️</p>  
        <a href="https://wa.me/966506214458" target="_blank" style="display:inline-block; background:linear-gradient(135deg,#25d366,#128c7e); color:#fff; padding:10px 24px; border-radius:25px; font-size:15px; font-weight:bold; text-decoration:none;">📲 تواصل عبر الواتساب</a>  
      </div>  
    </div>  
  
    <!-- زر إبرام عقد -->  
    <div id="contractSection" class="card fade-in" style="margin-top:12px; display:none;">  
      <a id="contractLink" href="#" target="_blank" style="display:block; background:linear-gradient(135deg,#3b82f6,#1d4ed8); color:#fff; padding:12px 20px; border-radius:12px; font-size:16px; font-weight:bold; text-decoration:none; text-align:center;">📝 إبرام عقد تحويل إلكتروني</a>  
    </div>  
  </div>  
  
  <!-- صفحة "قريباً" للمنتجات غير المفعّلة -->  
  <div id="comingSoonPage" class="page">  
    <div class="card fade-in">  
      <h2 id="comingSoonTitle" style="margin-top:0; font-size:19px; color:#111827;">المنتج غير مفعّل حالياً</h2>  
      <p id="comingSoonText" style="font-size:14px; color:#6b7280;">  
        حالياً لا يوجد احتساب لهذا المنتج عبر هذه الحاسبة.<br>  
        سيتم التحديث وإضافة الخدمة في الأسابيع القادمة إن شاء الله 🙏  
      </p>  
      <div style="margin-top:12px;">  
        <button class="secondary small" onclick="backToFinanceType()"> 🔙 رجوع لاختيار نوع التمويل</button>  
      </div>  
    </div>  
  </div>  
  
  <!-- صفحة دخول المسؤول -->  
  <div id="adminLoginPage" class="page">  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">دخول المشرف</h2>  
      <p style="font-size:13px; color:#b91c1c; text-align:right;">  
        ⚠️ هذا القسم مخصص للمشرفين المرخص لهم فقط.<br>  
        أي محاولة دخول ببيانات غير صحيحة قد تعتبر استخداماً غير مصرح به.  
      </p>  
      <label for="adminPin">رمز الدخول</label>  
      <input id="adminPin" type="password" placeholder="أدخل رمز المشرف" />  
      <div style="margin-top:12px;">  
        <button class="primary small" onclick="handleAdminLogin()">دخول</button>  
        <button class="secondary small" onclick="backToLanding()">إلغاء</button>  
      </div>  
      <div id="adminLoginError" class="alert-error" style="display:none; margin-top:8px;">  
        الرمز غير صحيح، حاول مرة أخرى.  
      </div>  
    </div>  
  </div>  
  
  <!-- لوحة المسؤول (Hub) -->  
  <div id="adminHubPage" class="page">  
    <div class="card fade-in" style="background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border:none;">  
      <h2 style="margin-top:0; font-size:22px; color:#f8fafc; text-align:center;">🔧 لوحة التحكم المتقدمة</h2>  
      <p style="font-size:13px; color:#94a3b8; text-align:center; margin-bottom:20px;">  
        مرحباً بك في لوحة التحكم - اختر القسم المطلوب  
      </p>  
        
      <!-- إحصائيات الزوار -->  
      <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; margin-bottom:20px;">  
        <div style="background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); padding:15px; border-radius:12px; text-align:center;">  
          <div style="font-size:28px; font-weight:900; color:#fff;" id="visitorTotal">0</div>  
          <div style="font-size:11px; color:#bfdbfe;">إجمالي الزوار</div>  
        </div>  
        <div style="background:linear-gradient(135deg, #10b981 0%, #047857 100%); padding:15px; border-radius:12px; text-align:center;">  
          <div style="font-size:28px; font-weight:900; color:#fff;" id="visitorToday">0</div>  
          <div style="font-size:11px; color:#a7f3d0;">اليوم</div>  
        </div>  
        <div style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding:15px; border-radius:12px; text-align:center;">  
          <div style="font-size:28px; font-weight:900; color:#fff;" id="visitorWeek">0</div>  
          <div style="font-size:11px; color:#fde68a;">هذا الأسبوع</div>  
        </div>  
        <div style="background:linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); padding:15px; border-radius:12px; text-align:center;">  
          <div style="font-size:28px; font-weight:900; color:#fff;" id="visitorMonth">0</div>  
          <div style="font-size:11px; color:#ddd6fe;">هذا الشهر</div>  
        </div>  
      </div>  
        
      <!-- قسم البنوك والمنتجات -->  
      <div style="margin-bottom:15px;">  
        <div style="font-size:12px; color:#94a3b8; margin-bottom:8px; padding-right:5px;">🏦 البنوك والمنتجات</div>  
        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px;">  
          <button onclick="showPage('admin')" style="background:linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); color:#fff; border:none; padding:12px; border-radius:10px; font-size:13px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:20px;">🏦</span>  
            <span>تعديل النسب</span>  
          </button>  
          <button onclick="showPage('adminProducts')" style="background:linear-gradient(135deg, #0891b2 0%, #0e7490 100%); color:#fff; border:none; padding:12px; border-radius:10px; font-size:13px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:20px;">📦</span>  
            <span>إدارة المنتجات</span>  
          </button>  
          <button onclick="showPage('adminQuestions')" style="background:linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%); color:#fff; border:none; padding:12px; border-radius:10px; font-size:13px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:20px;">❓</span>  
            <span>إدارة الأسئلة</span>  
          </button>  
        </div>  
      </div>  
        
      <!-- قسم الإحصائيات والسجلات -->  
      <div style="margin-bottom:15px;">  
        <div style="font-size:12px; color:#94a3b8; margin-bottom:8px; padding-right:5px;">📊 الإحصائيات والسجلات</div>  
        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px;">  
          <button onclick="showPage('adminArchive')" style="background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.2); padding:12px; border-radius:10px; font-size:13px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:20px;">🗂️</span>  
            <span>سجل النتائج</span>  
          </button>  
          <button onclick="showPage('adminVisitors')" style="background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.2); padding:12px; border-radius:10px; font-size:13px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:20px;">👥</span>  
            <span>تتبع الزوار</span>  
          </button>  
          <button onclick="showPage('adminClientResults')" style="background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.2); padding:12px; border-radius:10px; font-size:13px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:20px;">📊</span>  
            <span>نتائج العشوائية</span>  
          </button>  
        </div>  
      </div>  
        
      <!-- قسم التسويق والإعلانات -->  
      <div style="margin-bottom:15px;">  
        <div style="font-size:12px; color:#94a3b8; margin-bottom:8px; padding-right:5px;">📢 التسويق والإعلانات</div>  
        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px;">  
          <button onclick="showPage('adminRatings')" style="background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.2); padding:10px; border-radius:10px; font-size:12px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:18px;">⭐</span>  
            <span>التقييمات</span>  
          </button>  
          <button onclick="showPage('adminOffers')" style="background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.2); padding:10px; border-radius:10px; font-size:12px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:18px;">🎁</span>  
            <span>العروض</span>  
          </button>  
          <button onclick="showPage('adminAds')" style="background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.2); padding:10px; border-radius:10px; font-size:12px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:18px;">📰</span>  
            <span>الإعلانات</span>  
          </button>  
          <button onclick="showPage('adminMarketing')" style="background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.2); padding:10px; border-radius:10px; font-size:12px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:18px;">📢</span>  
            <span>التسويق</span>  
          </button>  
        </div>  
      </div>  
        
      <!-- قسم تخصيص النتيجة -->  
      <div style="margin-bottom:15px;">  
        <div style="font-size:12px; color:#94a3b8; margin-bottom:8px; padding-right:5px;">📝 تخصيص النتيجة</div>  
        <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px;">  
          <button onclick="showPage('adminResultSettings')" style="background:linear-gradient(135deg, #f97316 0%, #ea580c 100%); color:#fff; border:none; padding:12px; border-radius:10px; font-size:13px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:20px;">📊</span>  
            <span>تخصيص النتيجة</span>  
          </button>  
          <button onclick="showPage('adminResultTexts')" style="background:linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color:#fff; border:none; padding:12px; border-radius:10px; font-size:13px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:20px;">✏️</span>  
            <span>صيغ النتيجة</span>  
          </button>  
        </div>  
      </div>  
        
      <!-- قسم إدارة الجهات -->  
      <div style="margin-bottom:15px;">  
        <div style="font-size:12px; color:#94a3b8; margin-bottom:8px; padding-right:5px;">🏢 إدارة الجهات والشركات</div>  
        <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px;">  
          <button onclick="showPage('adminJobTypes')" style="background:linear-gradient(135deg, #f43f5e 0%, #e11d48 100%); color:#fff; border:none; padding:12px; border-radius:10px; font-size:13px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:20px;">💼</span>  
            <span>أنواع الوظائف</span>  
          </button>  
          <button onclick="showPage('adminEmployers')" style="background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color:#fff; border:none; padding:12px; border-radius:10px; font-size:13px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:20px;">🏢</span>  
            <span>جهات الوظيفة</span>  
          </button>  
          <button onclick="showPage('adminFinanceEntities')" style="background:linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color:#fff; border:none; padding:12px; border-radius:10px; font-size:13px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:20px;">🏦</span>  
            <span>جهات التمويل</span>  
          </button>  
        </div>  
      </div>  
        
      <!-- قسم الإعدادات -->  
      <div style="margin-bottom:15px;">  
        <div style="font-size:12px; color:#94a3b8; margin-bottom:8px; padding-right:5px;">⚙️ الإعدادات والتخصيص</div>  
        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px;">  
          <button onclick="showPage('adminThemes')" style="background:linear-gradient(135deg, #ec4899 0%, #be185d 100%); color:#fff; border:none; padding:12px; border-radius:10px; font-size:13px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:20px;">🎨</span>  
            <span>الثيمات</span>  
          </button>  
          <button onclick="showPage('adminTexts')" style="background:linear-gradient(135deg, #14b8a6 0%, #0d9488 100%); color:#fff; border:none; padding:12px; border-radius:10px; font-size:13px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:20px;">✏️</span>  
            <span>محرر النصوص</span>  
          </button>  
          <button onclick="showPage('adminSettings')" style="background:linear-gradient(135deg, #64748b 0%, #475569 100%); color:#fff; border:none; padding:12px; border-radius:10px; font-size:13px; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:4px;">  
            <span style="font-size:20px;">⚙️</span>  
            <span>الإعدادات</span>  
          </button>  
        </div>  
      </div>  
        
      <!-- زر تطبيق جميع التغييرات -->
      <div style="margin-top:25px; padding:15px; background:linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius:12px; text-align:center;">
        <p style="font-size:12px; color:#d1fae5; margin:0 0 10px 0;">اضغط لتطبيق جميع التعديلات وإعادة تحميل البيانات</p>
        <button onclick="applyAllChanges()" style="background:#fff; color:#059669; border:none; padding:14px 40px; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.2);">
          ✅ تطبيق التغييرات
        </button>
      </div>
      
      <div style="margin-top:20px; text-align:center;">  
        <button onclick="backToLanding()" style="background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color:#fff; border:none; padding:12px 30px; border-radius:10px; font-size:14px; cursor:pointer;">  
          🏠 رجوع للرئيسية  
        </button>  
      </div>  
    </div>  
  </div>  
  
  <!-- لوحة المسؤول (تعديل النسب) -->  
  <div id="adminPage" class="page">  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">لوحة إعدادات البنوك</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        من هنا تضيف وتعدّل شرائح الرواتب ونسب هامش الربح لكل بنك / شركة تمويل ونوع تمويل.  
        هذه البيانات تستخدم في خيار <strong>ترشيح بنك مناسب تلقائياً</strong>.  
      </p>  
  
      <form id="adminForm" onsubmit="saveBankConfig(event)">  
        <div class="admin-grid">  
          <div>  
            <label>اسم البنك / شركة التمويل</label>  
            <select id="adminBankName">  
              <option value="">اختر...</option>  
              <!-- البنوك المحلية -->  
              <optgroup label="البنوك المحلية">  
                <option>البنك الأهلي السعودي</option>  
                <option>مصرف الراجحي</option>  
                <option>بنك الرياض</option>  
                <option>البنك السعودي الأول</option>  
                <option>البنك العربي الوطني</option>  
                <option>مصرف الإنماء</option>  
                <option>البنك السعودي الفرنسي</option>  
                <option>البنك السعودي للاستثمار</option>  
                <option>بنك البلاد</option>  
                <option>بنك الجزيرة</option>  
                <option>بنك الخليج الدولي</option>  
              </optgroup>  
              <!-- البنوك الرقمية -->  
              <optgroup label="البنوك الرقمية">  
                <option>بنك STC</option>  
                <option>بنك D360</option>  
                <option>بنك فيجن</option>  
              </optgroup>  
              <!-- فروع البنوك الأجنبية -->  
              <optgroup label="فروع البنوك الأجنبية">  
                <option>بنك الإمارات دبي الوطني</option>  
                <option>بنك المشرق</option>  
                <option>بنك البحرين الوطني</option>  
                <option>البنك الأول (FAB)</option>  
                <option>بنك HSBC</option>  
                <option>بنك Citibank</option>  
              </optgroup>  
              <!-- شركات التمويل العقاري -->  
              <optgroup label="شركات التمويل العقاري">  
                <option>أملاك العالمية للتمويل</option>  
                <option>شركة دار التمليك</option>  
                <option>شركة سهل للتمويل</option>  
                <option>شركة مسار النمو للتمويل</option>  
                <option>شركة عبداللطيف جميل للتمويل العقاري</option>  
                <option>شركة بداية للتمويل</option>  
                <option>الشركة السعودية لإعادة التمويل العقاري</option>  
              </optgroup>  
              <!-- شركات التمويل الاستهلاكي والإيجار -->  
              <optgroup label="شركات التمويل الاستهلاكي">  
                <option>شركة النايفات للتمويل</option>  
                <option>شركة ينال للتمويل</option>  
                <option>شركة اليسر للإجارة والتمويل</option>  
                <option>شركة آجل للخدمات التمويلية</option>  
                <option>الشركة الوطنية للتمويل</option>  
                <option>شركة المرابحة المرنة للتمويل</option>  
                <option>شركة كرناف للتمويل</option>  
                <option>شركة الجاسرية للتمويل</option>  
                <option>شركة متاجر للتمويل</option>  
                <option>شركة تسهيل للتمويل</option>  
                <option>شركة السعودي الفرنسي للتأجير التمويلي</option>  
                <option>شركة الأولى للتمويل</option>  
                <option>شركة الجبر للتمويل</option>  
                <option>شركة موني للتمويل</option>  
                <option>شركة كوارا للتمويل</option>  
                <option>شركة إمكان للتمويل</option>  
                <option>شركة الأمثل للتمويل</option>  
                <option>شركة دويتشه الخليج للتمويل</option>  
                <option>شركة الراجحي للتمويل</option>  
                <option>شركة الأهلي للتمويل</option>  
                <option>شركة التسهيلات المالية</option>  
                <option>شركة رسن للتمويل</option>  
                <option>شركة لندو للتمويل</option>  
              </optgroup>  
              <!-- شركات التقنية المالية -->  
              <optgroup label="شركات التقنية المالية">  
                <option>شركة تمارا للتمويل</option>  
                <option>شركة تابي للتمويل</option>  
                <option>شركة سلفة للتمويل</option>  
                <option>شركة فندينق سوق للتمويل</option>  
                <option>شركة منافع للتمويل</option>  
                <option>شركة سبوتي للتمويل</option>  
                <option>شركة بوست باي للتمويل</option>  
                <option>شركة قسطها للتمويل</option>  
              </optgroup>  
              <option value="بنك آخر">بنك / شركة أخرى</option>  
            </select>  
          </div>  
          <div>  
            <label>نوع التمويل</label>  
            <select id="adminFinanceType">  
              <option value="personal">تمويل شخصي / تأجيري</option>  
              <option value="consumer">تمويل استهلاكي</option>  
              <option value="mortgage">تمويل عقاري</option>  
              <option value="buyoutPersonal">شراء مديونية تمويل شخصي</option>  
              <option value="buyoutMortgage">شراء مديونية تمويل عقاري</option>  
            </select>  
          </div>  
          <div>  
            <label>نوع الدعم (للعقاري)</label>  
            <select id="adminSupportedType">  
              <option value="الكل">الكل</option>  
              <option value="مدعوم">مدعوم</option>  
              <option value="غير مدعوم">غير مدعوم</option>  
            </select>  
          </div>  
          <div>  
            <label>من راتب (ريال)</label>  
            <input id="adminMinSalary" type="number" min="0" />  
          </div>  
          <div>  
            <label>إلى راتب (ريال)</label>  
            <input id="adminMaxSalary" type="number" min="0" />  
          </div>  
          <div>  
            <label>نسبة هامش الربح (%)</label>  
            <input id="adminMargin" type="number" min="0" step="0.01" />  
          </div>  
  
          <div>  
            <label>نوع الوظيفة (اختياري)</label>  
            <select id="adminJobType">  
              <option value="">الكل</option>  
              <!-- سيتم تحديثها ديناميكياً -->  
            </select>  
          </div>  
          <div>  
            <label>من شهر (المدة)</label>  
            <input id="adminMinMonths" type="number" min="1" />  
          </div>  
          <div>  
            <label>إلى شهر (المدة)</label>  
            <input id="adminMaxMonths" type="number" min="1" />  
          </div>  
          <div>  
            <label>تفاصيل المنتج (اختياري)</label>  
            <select id="adminProductDetail">  
              <option value="">الكل</option>  
              <option>وحدة جاهزة من السوق</option>  
              <option>بناء ذاتي</option>  
              <option>مشاريع الخارطة</option>  
              <option>تحت الانشاء (بيت تملكه عظم)</option>  
              <option>ارض وقرض (ارض وبناء ذاتي)</option>  
              <option>ارض (سكنية)</option>  
              <option>رهن</option>  
            </select>  
          </div>  
          <div>  
            <label>اعتزاز (للعسكري المدعوم)</label>  
            <select id="adminEtezaaz">  
              <option value="">بدون</option>  
              <option value="نعم">اعتزاز</option>  
            </select>  
          </div>
          <div>  
            <label>القسط المرن المخفض <span style="color:#059669; font-size:10px;">(للعقاري المدعوم)</span></label>  
            <select id="adminFlexibleInstallment" onchange="toggleFlexibleMinAmount()">  
              <option value="">غير مفعل</option>  
              <option value="نعم">مفعل - يدعم القسط المرن</option>  
            </select>  
          </div>
          <div id="flexibleMinAmountDiv" style="display:none;">  
            <label>الحد الأدنى للقسط المرن (ريال)</label>  
            <select id="adminFlexibleMinAmount">  
              <option value="400">400 ريال</option>  
              <option value="500">500 ريال</option>  
              <option value="600">600 ريال</option>  
              <option value="700">700 ريال</option>  
              <option value="800">800 ريال</option>  
              <option value="900">900 ريال</option>  
              <option value="1000">1,000 ريال</option>  
              <option value="1500">1,500 ريال</option>  
              <option value="2000">2,000 ريال</option>  
            </select>  
          </div>  
          <div>  
            <label>احتساب العمر</label>  
            <select id="adminAgeCalcType">  
              <option value="hijri">هجري (افتراضي)</option>  
              <option value="gregorian">ميلادي</option>  
            </select>  
          </div>  
          <div>  
            <label>العمر الأقصى (سنة)</label>  
            <input id="adminMaxAge" type="number" min="50" max="80" placeholder="60" />  
          </div>  
          <div style="grid-column:1/-1;">  
            <label>ملاحظة للعميل (اختياري) <span style="color:#6b7280; font-size:11px;">تظهر في صفحة النتيجة</span></label>  
            <input id="adminBankNote" type="text" placeholder="مثال: عرض نهاية العام - نسبة مميزة حتى 31 ديسمبر" />  
          </div>  
          <div>  
            <label>تاريخ انتهاء النسبة (اختياري) <span style="color:#6b7280; font-size:11px;">للتنبيه</span></label>  
            <select id="adminRateExpiry" style="width:100%;">  
              <option value="">بدون تاريخ انتهاء</option>  
              <option value="7">بعد 7 أيام</option>  
              <option value="14">بعد 14 يوم</option>  
              <option value="30">بعد 30 يوم (شهر)</option>  
              <option value="60">بعد 60 يوم (شهرين)</option>  
              <option value="90">بعد 90 يوم (3 أشهر)</option>  
              <option value="custom">تاريخ مخصص...</option>  
            </select>  
            <input id="adminRateExpiryCustom" type="date" style="display:none; width:100%; margin-top:5px;" />  
          </div>  
        </div>  
        <input type="hidden" id="adminEditIndex" value="" />  
        <div style="text-align:left; margin-top:10px;">  
          <button type="submit" class="primary small">💾 حفظ</button>  
          <button type="button" class="secondary small" onclick="clearAdminForm()">مسح النموذج</button>  
        </div>  
      </form>  
  
      <table class="admin-table" id="adminTable">  
        <thead>  
          <tr>  
            <th>البنك / الشركة</th>  
            <th>التمويل</th>  
            <th>الدعم</th>  
            <th>من راتب</th>  
            <th>إلى راتب</th>  
            <th>المدة (من)</th>  
            <th>المدة (إلى)</th>  
            <th>نوع الوظيفة</th>  
            <th>تفاصيل المنتج</th>  
            <th>اعتزاز</th>  
            <th>قسط مرن</th>  
            <th>النسبة %</th>  
            <th>احتساب العمر</th>  
            <th>العمر الأقصى</th>  
            <th>ملاحظة</th>  
            <th>تحكم</th>  
          </tr>  
        </thead>  
        <tbody></tbody>  
      </table>  
  
      <div style="margin-top:8px; font-size:11px; color:#9ca3af; text-align:right;">  
        ملاحظة: شعارات البنوك تُجلب تلقائياً بالاعتماد على اسم البنك.  
        ضع ملفات الصور في مجلد <code>img</code> بنفس الأسماء المشار إليها في الكود.  
      </div>  
  
      <!-- قسم تعديلات النسب حسب وضع العميل -->  
      <div style="margin-top:20px; padding:15px; background:linear-gradient(135deg, #fef3c7, #fde68a); border-radius:12px; border-right:4px solid #f59e0b;">  
        <h3 style="margin:0 0 10px 0; font-size:17px; color:#92400e;">⚙️ تعديلات النسب حسب وضع العميل</h3>  
        <p style="font-size:12px; color:#78350f; margin-bottom:15px;">  
          أضف تعديلات على النسبة الأساسية حسب وضع العميل (مثل: الدعم المقدم، الالتزام الشخصي، إلخ)  
        </p>  
          
        <form id="rateAdjustmentForm" onsubmit="saveRateAdjustment(event)">  
          <div class="admin-grid">  
            <div>  
              <label>جهة التمويل</label>  
              <select id="adjBankName" required>  
                <option value="">اختر الجهة...</option>  
                <option value="الكل">جميع الجهات</option>  
              </select>  
            </div>  
            <div>  
              <label>نوع التمويل</label>  
              <select id="adjFinanceType">  
                <option value="الكل">جميع الأنواع</option>  
                <option value="personal">تمويل شخصي</option>  
                <option value="mortgage">تمويل عقاري</option>  
                <option value="buyoutPersonal">شراء مديونية شخصي</option>  
                <option value="buyoutMortgage">شراء مديونية عقاري</option>  
              </select>  
            </div>  
            <div>  
              <label>نوع التعديل</label>  
              <select id="adjType" required onchange="updateAdjustmentOptions()">  
                <option value="">اختر نوع التعديل...</option>  
                <option value="supportAdvance">الدعم المقدم</option>  
                <option value="personalLoan">التزام شخصي قائم</option>  
                <option value="mortgageLoan">التزام عقاري قائم</option>  
                <option value="creditCard">بطاقة ائتمانية</option>  
                <option value="newCustomer">عميل جديد</option>  
                <option value="salaryTransfer">تحويل راتب</option>  
                <option value="noSalaryTransfer">بدون تحويل راتب</option>  
                <option value="custom">تعديل مخصص</option>  
              </select>  
            </div>  
            <div>  
              <label>اسم التعديل (للعرض)</label>  
              <input id="adjName" type="text" placeholder="مثال: الدعم المقدم" />  
            </div>  
            <div>  
              <label>التعديل على النسبة (نقطة)</label>  
              <input id="adjValue" type="number" step="0.01" placeholder="مثال: 0.50 أو -0.25" required />  
              <small style="color:#78350f;">موجب = زيادة، سالب = خصم</small>  
            </div>  
            <div>  
              <label>تاريخ البداية (اختياري)</label>  
              <input id="adjStartDate" type="date" />  
            </div>  
            <div>  
              <label>تاريخ النهاية (اختياري)</label>  
              <input id="adjEndDate" type="date" />  
            </div>  
            <div>  
              <label>ملاحظة للعميل</label>  
              <input id="adjNote" type="text" placeholder="تظهر في صفحة النتيجة" />  
            </div>
            <div style="grid-column: span 2;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input id="adjIncludeEtezaaz" type="checkbox" style="width: 18px; height: 18px;" />
                <span>تطبيق هذا التعديل على نسب اعتزاز أيضاً</span>
              </label>
              <small style="color:#78350f; display: block; margin-top: 4px;">بشكل افتراضي، نسب اعتزاز ثابتة ولا تُطبق عليها التعديلات التراكمية</small>
            </div>  
          </div>  
          <input type="hidden" id="adjEditIndex" value="" />  
          <div style="text-align:left; margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">  
            <button type="submit" class="primary small">💾 حفظ التعديل</button>  
            <button type="button" class="secondary small" onclick="clearAdjustmentForm()">مسح النموذج</button>  
          </div>  
        </form>  
          
        <h4 style="font-size:14px; margin:20px 0 10px 0; color:#92400e;">📋 تعديلات النسب المحفوظة:</h4>  
        <table class="admin-table" id="rateAdjustmentsTable">  
          <thead>  
            <tr>  
              <th>الجهة</th>  
              <th>التمويل</th>  
              <th>نوع التعديل</th>  
              <th>الاسم</th>  
              <th>التعديل</th>  
              <th>من تاريخ</th>  
              <th>إلى تاريخ</th>  
              <th>ملاحظة</th>  
              <th>تحكم</th>  
            </tr>  
          </thead>  
          <tbody id="rateAdjustmentsBody"></tbody>  
        </table>  
      </div>  
  
      <div style="margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">  
        <button class="primary" onclick="executeAllAdminChanges()" style="padding:12px 30px; font-size:16px;">✅ تنفيذ التغييرات</button>
        <button class="secondary small" onclick="showPage('adminHub')">🔙 رجوع للوحة المسؤول</button>  
      </div>  
    </div>  
  </div>  
  
  <!-- (إضافة) إدارة منتجات التمويل -->  
  <div id="adminProductsPage" class="page">  
    <!-- قسم إضافة جهة تمويلية جديدة -->  
    <div class="card fade-in" style="margin-bottom:15px; border-right:4px solid #f59e0b;">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">🏦 إضافة جهة تمويلية جديدة</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        أضف بنك أو شركة تمويل جديدة وستظهر فوراً في قائمة "تعديل النسب" وفي الحاسبة.  
      </p>  
      <form id="addBankForm" onsubmit="addNewBank(event)">  
        <div class="admin-grid">  
          <div>  
            <label>اسم الجهة (البنك/الشركة)</label>  
            <input id="newBankName" type="text" placeholder="مثال: شركة تسهيل" required />  
          </div>  
          <div>  
            <label>نوع الجهة</label>  
            <select id="newBankType">  
              <option value="بنك">بنك</option>  
              <option value="شركة تمويل">شركة تمويل</option>  
            </select>  
          </div>  
          <div>  
            <label>رابط الشعار (اختياري)</label>  
            <input id="newBankLogo" type="text" placeholder="https://example.com/logo.png" />  
          </div>  
          <div>  
            <label>ملاحظة (اختياري)</label>  
            <input id="newBankNote" type="text" placeholder="مثال: عرض نهاية العام" />  
          </div>  
        </div>  
        <div style="text-align:left; margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">  
          <button type="submit" class="primary small">➕ إضافة الجهة</button>  
        </div>  
      </form>  
        
      <h3 style="font-size:16px; margin-top:20px; color:#374151;">الجهات التمويلية الحالية:</h3>  
      <table class="admin-table" id="banksListTable">  
        <thead>  
          <tr>  
            <th>الجهة</th>  
            <th>النوع</th>  
            <th>ملاحظة</th>  
            <th>تحكم</th>  
          </tr>  
        </thead>  
        <tbody id="banksListBody"></tbody>  
      </table>  
    </div>  
  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">إدارة منتجات التمويل</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        من هنا تتحكم بالمنتجات التي تظهر للعميل في "نوع التمويل": تفعيل/إيقاف + رسالة اعتذار + إضافة منتج جديد.  
      </p>  
  
      <form id="adminProductsForm" onsubmit="saveFinanceProduct(event)">  
        <div class="admin-grid">  
          <div style="grid-column:1/-1;">  
            <label>جهة التمويل (البنك/الشركة) <span style="color:#ef4444;">*</span></label>  
            <select id="fpFinanceEntity" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px;">  
              <option value="">اختر جهة التمويل...</option>  
              <option value="الكل" style="background:#dcfce7; font-weight:bold;">✅ الكل (جميع جهات التمويل)</option>  
              <option value="البنك الأهلي السعودي">البنك الأهلي السعودي</option>  
              <option value="مصرف الراجحي">مصرف الراجحي</option>  
              <option value="بنك الرياض">بنك الرياض</option>  
              <option value="بنك ساب">بنك ساب</option>  
              <option value="البنك العربي الوطني">البنك العربي الوطني</option>  
              <option value="مصرف الإنماء">مصرف الإنماء</option>  
              <option value="البنك السعودي الفرنسي">البنك السعودي الفرنسي</option>  
              <option value="البنك السعودي للاستثمار">البنك السعودي للاستثمار</option>  
              <option value="بنك البلاد">بنك البلاد</option>  
              <option value="بنك الجزيرة">بنك الجزيرة</option>  
              <option value="شركة تسهيل">شركة تسهيل</option>  
              <option value="شركة نايفات">شركة نايفات</option>  
              <option value="شركة اليسر">شركة اليسر</option>  
              <option value="جهة جديدة">➕ إضافة جهة جديدة</option>  
            </select>  
            <input type="text" id="fpNewEntityName" placeholder="اسم الجهة الجديدة..." style="display:none; width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px; margin-top:8px;">  
          </div>  
            
          <div style="grid-column:1/-1;">  
            <label>اسم المنتج (يظهر للعميل) <span style="color:#ef4444;">*</span></label>  
            <input id="fpName" type="text" placeholder="مثال: تمويل الأسطول" />  
          </div>  
  
          <div>  
            <label>الحالة</label>  
            <select id="fpEnabled">  
              <option value="true">مفعّل</option>  
              <option value="false">غير مفعّل</option>  
            </select>  
          </div>  
  
          <div style="grid-column:1/-1;">  
            <label>رسالة عند عدم التفعيل (اختياري)</label>  
            <input id="fpMessage" type="text" placeholder="مثال: نعتذر منك، هذا المنتج غير متاح حالياً." />  
          </div>  
            
          <div>  
            <label>نسبة الاستقطاع من الراتب (%) <span style="color:#6b7280; font-size:11px;">❓</span></label>  
            <input id="fpDeductionRate" type="number" min="0" max="100" step="1" placeholder="مثال: 33" />  
          </div>  
            
          <div style="grid-column:1/-1;">  
            <label>أسئلة إضافية للمنتج (اختياري)</label>  
            <div id="fpCustomQuestionsContainer" style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:10px; margin-top:5px;">  
              <div id="fpCustomQuestionsList"></div>  
              <button type="button" class="secondary small" onclick="addCustomQuestionField()" style="margin-top:8px;">➕ إضافة سؤال</button>  
            </div>  
          </div>  
        </div>  
  
        <input type="hidden" id="fpEditIndex" value="" />  
  
        <div style="text-align:left; margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">  
          <button type="submit" class="primary small">💾 حفظ المنتج</button>  
          <button type="button" class="secondary small" onclick="clearFinanceProductForm()">مسح</button>  
        </div>  
      </form>  
  
      <table class="admin-table" id="financeProductsTable">  
        <thead>  
          <tr>  
            <th>جهة التمويل</th>  
            <th>اسم المنتج</th>  
            <th>الحالة</th>  
            <th>نسبة الاستقطاع</th>  
            <th>أسئلة إضافية</th>  
            <th>تحكم</th>  
          </tr>  
        </thead>  
        <tbody></tbody>  
      </table>  
  
      <div style="margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">  
        <button class="primary" onclick="executeAllAdminChanges()" style="padding:12px 30px; font-size:16px;">✅ تنفيذ التغييرات</button>
        <button class="secondary small" onclick="showPage('adminHub')">🔙 رجوع للوحة المسؤول</button>  
      </div>  
    </div>  
  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">إعدادات (تقديرية) للتمويل الممتد</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        ملاحظة: "راتب التقاعد" يحتاج راتب أساسي فعلي، وبما أنك لا تريد سؤال العميل عنه، تم إضافة إعداد "معامل" تقديري لتحويل الراتب الصافي إلى (بديل للراتب الأساسي) داخل الحسبة الممتدة فقط.  
      </p>  
      <div class="admin-grid">  
        <div>  
          <label>معامل تقديري (الأساسي = الصافي × المعامل)</label>  
          <input id="retBasicMultiplier" type="number" step="0.01" min="0" />  
        </div>  
        <div style="display:flex; align-items:flex-end; justify-content:flex-end; gap:8px;">  
          <button class="primary small" onclick="saveRetirementSettings()">💾 حفظ</button>  
          <button class="secondary small" onclick="loadRetirementSettingsToUI()">إعادة تحميل</button>  
        </div>  
      </div>  
      <div style="margin-top:8px; font-size:12px; color:#6b7280; text-align:right;">  
        الافتراضي = 1.00 (يعني نستخدم الصافي كبديل للأساسي) — وتقدر تغيره حسب خبرتك.  
      </div>  
    </div>  
  </div>  
  
  <!-- سجل نتائج العملاء -->  
  <div id="adminArchivePage" class="page">  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">سجل نتائج العملاء</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        ابحث برقم الجوال أو السجل المدني. يظهر "النتيجة الحقيقة" + "النتيجة المرسلة للعميل" إن وُجدت.  
      </p>  
  
      <div class="admin-grid">  
        <div style="grid-column:1/-1;">  
          <label>بحث (جوال / سجل مدني)</label>  
          <input id="archiveSearch" type="text" placeholder="اكتب رقم الجوال أو السجل المدني..." oninput="renderArchiveTable()" />  
        </div>  
      </div>  
  
      <table class="admin-table" id="archiveTable">  
        <thead>  
          <tr>  
            <th>المفتاح (جوال/سجل)</th>  
            <th>اسم العميل</th>  
            <th>نوع التمويل</th>  
            <th>تاريخ/وقت</th>  
            <th>البنك المرشح</th>  
            <th>ممتد</th>  
            <th>تحكم</th>  
          </tr>  
        </thead>  
        <tbody></tbody>  
      </table>  
  
      <div style="margin-top:12px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">  
        <button class="primary" onclick="executeAllAdminChanges()" style="padding:12px 30px; font-size:16px;">✅ تنفيذ التغييرات</button>
        <button class="secondary small" onclick="showPage('adminHub')">🔙 رجوع للوحة المسؤول</button>  
      </div>  
    </div>  
  </div>  
  
  <!-- صفحة حاسبة السداد المبكر -->  
  <div id="earlySettlementPage" class="page">  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:22px; color:#111827;">💰 حاسبة السداد المبكر</h2>  
      <p style="font-size:14px; color:#6b7280; text-align:right;">  
        احسب مبلغ السداد المبكر لتمويلك حسب نظام ساما (البنك المركزي السعودي)  
      </p>  
        
      <div class="admin-grid" style="margin-top:15px;">  
        <div>  
          <label>نوع التمويل</label>  
          <select id="esFinanceType">  
            <option value="personal">تمويل شخصي / استهلاكي</option>  
            <option value="mortgage">تمويل عقاري</option>  
          </select>  
        </div>  
        <div>  
          <label>مبلغ التمويل الأصلي (ريال)</label>  
          <input id="esOriginalAmount" type="number" min="0" placeholder="مثال: 500000">  
        </div>  
        <div>  
          <label>مدة التمويل الكلية (شهر)</label>  
          <input id="esTotalMonths" type="number" min="1" placeholder="مثال: 60">  
        </div>  
        <div>  
          <label>عدد الأقساط المسددة</label>  
          <input id="esPaidMonths" type="number" min="0" placeholder="مثال: 24">  
        </div>  
        <div>  
          <label>نسبة الربح السنوية (%)</label>  
          <input id="esAnnualRate" type="number" step="0.01" min="0" placeholder="مثال: 5.5">  
        </div>  
      </div>  
        
      <div style="margin-top:15px;">  
        <button class="primary" onclick="calculateEarlySettlement()">📊 احسب السداد المبكر</button>  
      </div>  
        
      <div id="esResult" style="display:none; margin-top:20px; padding:15px; background:linear-gradient(135deg,#ecfdf5,#d1fae5); border-radius:15px; text-align:right;">  
        <!-- النتيجة تظهر هنا -->  
      </div>  
        
      <!-- تنبيهات قانونية مهمة -->
      <div style="margin-top:15px; padding:15px; background:linear-gradient(135deg, #fef3c7, #fde68a); border-radius:12px; border:2px solid #f59e0b; text-align:right;">
        <h4 style="margin:0 0 10px; font-size:14px; color:#92400e;">📜 تنبيهات قانونية مهمة</h4>
        
        <div style="margin-bottom:12px; padding:10px; background:#fff; border-radius:8px; font-size:13px;">
          <strong style="color:#1e40af;">🏠 التمويل العقاري:</strong>
          <ul style="margin:8px 0 0 0; padding-right:20px; color:#374151;">
            <li>طريقة الحساب: <strong>أصل التمويل + أرباح سنتين + أرباح 3 أشهر (رسوم إدارية)</strong></li>
            <li>بعض جهات التمويل تشترط عدم السداد خلال أول 24 شهر كفترة حظر</li>
            <li>قد تختلف الطريقة إذا وُجد شرط جزائي مختلف في العقد</li>
          </ul>
        </div>
        
        <div style="margin-bottom:12px; padding:10px; background:#fff; border-radius:8px; font-size:13px;">
          <strong style="color:#059669;">💳 التمويل الشخصي:</strong>
          <ul style="margin:8px 0 0 0; padding-right:20px; color:#374151;">
            <li>طريقة الحساب: <strong>أصل المبلغ + أرباح 3 أشهر</strong></li>
            <li>بعض جهات التمويل تضيف رسوم تسوية بنسبة معينة</li>
          </ul>
        </div>
        
        <div style="padding:10px; background:#fef2f2; border-radius:8px; font-size:12px; color:#991b1b;">
          <strong>⚠️ تنبيه مهم:</strong> هذه الطريقة هي المعتمدة من البنك المركزي السعودي (ساما)، إلا إذا اشترطت جهة التمويل طريقة أخرى في العقد. <strong>يُرجى مراجعة عقد التمويل للتأكد.</strong>
        </div>
      </div>
        
      <!-- تنبيه شرط السنتين للعقاري -->  
      <div id="earlySettlementWarningBox" style="margin-top:10px; padding:12px; background:#fef2f2; border-radius:10px; border:1px solid #fca5a5; text-align:right; font-size:13px;">  
        <strong>⚠️ تنبيه للتمويل العقاري:</strong>  
        <span id="earlySettlementWarningText">أكثر جهات التمويل يشترطون انتهاء سنتين من الأقساط للسماح بالسداد المبكر. راجع العقد.</span>  
        <div style="margin-top:8px; font-size:12px; color:#991b1b;">  
          <strong>📊 طريقة الحساب للعقاري:</strong> <span id="earlySettlementFormulaText">أصل التمويل + أرباح سنتين + أرباح 3 أشهر (رسوم إدارية)</span>  
        </div>  
      </div>  
        
      <div style="margin-top:15px;">  
        <button class="secondary small" onclick="showPage('landing')">🏠 رجوع للرئيسية</button>  
      </div>  
    </div>  
  </div>  
  
  <!-- صفحة إدارة التقييمات -->  
  <div id="adminRatingsPage" class="page">  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">⭐ إدارة تقييمات العملاء</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        هنا تقدر تشوف تقييمات العملاء وتنشرها في الصفحة الرئيسية.  
      </p>  
        
      <!-- إعدادات التقييمات -->  
      <div style="background:#f3f4f6; border-radius:12px; padding:15px; margin:15px 0;">  
        <h4 style="margin:0 0 10px; font-size:14px; color:#374151;">⚙️ إعدادات التقييمات</h4>  
          
        <div style="display:flex; flex-direction:column; gap:10px;">  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="showRatingsOnHome" onchange="saveRatingsSettings()">  
            <span>عرض التقييمات في الصفحة الرئيسية ("شوف تقييمات العملا لتطمن")</span>  
          </label>  
            
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="showRatingRequest" onchange="saveRatingsSettings()">  
            <span>عرض طلب التقييم بعد النتيجة</span>  
          </label>  
            
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="showTrustSection" onchange="saveRatingsSettings()">  
            <span>عرض قسم "شوف تقييمات العملا لتطمن" مع الأيقونة</span>  
          </label>  
        </div>  
      </div>  
        
      <!-- إحصائيات التقييمات -->  
      <div id="ratingsStats" style="background:#dbeafe; border-radius:12px; padding:15px; margin:15px 0;">  
        <h4 style="margin:0 0 10px; font-size:14px; color:#1e40af;">📊 إحصائيات التقييمات</h4>  
        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; text-align:center;">  
          <div>  
            <div style="font-size:24px; font-weight:bold; color:#1e40af;" id="totalRatingsCount">0</div>  
            <div style="font-size:12px; color:#6b7280;">إجمالي التقييمات</div>  
          </div>  
          <div>  
            <div style="font-size:24px; font-weight:bold; color:#059669;" id="publishedRatingsCount">0</div>  
            <div style="font-size:12px; color:#6b7280;">منشورة</div>  
          </div>  
          <div>  
            <div style="font-size:24px; font-weight:bold; color:#f59e0b;" id="avgRating">0</div>  
            <div style="font-size:12px; color:#6b7280;">متوسط التقييم</div>  
          </div>  
        </div>  
      </div>  
        
      <table class="admin-table" id="ratingsTable">  
        <thead>  
          <tr>  
            <th>الاسم</th>  
            <th>التقييم</th>  
            <th>الملاحظة</th>  
            <th>التاريخ</th>  
            <th>منشور</th>  
            <th>تحكم</th>  
          </tr>  
        </thead>  
        <tbody></tbody>  
      </table>  
        
      <div style="margin-top:15px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">  
        <button class="primary" onclick="executeAllAdminChanges()" style="padding:12px 30px; font-size:16px;">✅ تنفيذ التغييرات</button>
        <button class="secondary small" onclick="showPage('adminHub')">🔙 رجوع للوحة المسؤول</button>  
      </div>  
    </div>  
  </div>  
  
  <!-- صفحة إدارة العروض الخاصة -->  
  <div id="adminOffersPage" class="page">  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">🎁 إدارة العروض الخاصة</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        أضف عروض خاصة تظهر للعميل وقت النتيجة حسب نوع التمويل أو المبلغ.  
      </p>  
        
      <form id="offerForm" onsubmit="saveOffer(event)" style="margin-top:15px;">  
        <input type="hidden" id="offerEditIndex" value="">  
        <div class="admin-grid">  
          <div>  
            <label>عنوان العرض</label>  
            <input id="offerTitle" type="text" placeholder="مثال: عرض خاص للعسكريين">  
          </div>  
          <div>  
            <label>نص العرض</label>  
            <textarea id="offerText" rows="2" placeholder="مثال: يا فلان ولايهمك مالك الا نسدد عنك..."></textarea>  
          </div>  
          <div>  
            <label>نوع التمويل المستهدف</label>  
            <select id="offerTargetType">  
              <option value="">الكل</option>  
              <option>تمويل شخصي</option>  
              <option>تمويل عقاري</option>  
              <option>شراء مديونية</option>  
              <option>تمويل التأجيري</option>  
              <option>تمويل استهلاكي</option>  
            </select>  
          </div>  
          <div>  
            <label>نوع الوظيفة المستهدفة</label>  
            <select id="offerTargetJobType">  
              <option value="">الكل</option>  
              <option value="حكومي">حكومي</option>  
              <option value="عسكري">عسكري</option>  
              <option value="قطاع خاص">قطاع خاص</option>  
              <option value="متقاعد">متقاعد</option>  
            </select>  
          </div>  
          <div>  
            <label>البنك المرتبط بالعرض</label>  
            <select id="offerLinkedBank">  
              <option value="">الكل</option>  
              <option>البنك الأهلي السعودي</option>  
              <option>مصرف الراجحي</option>  
              <option>بنك الرياض</option>  
              <option>بنك ساب</option>  
              <option>البنك العربي الوطني</option>  
              <option>مصرف الإنماء</option>  
              <option>البنك السعودي الفرنسي</option>  
              <option>بنك البلاد</option>  
              <option>بنك الجزيرة</option>  
            </select>  
          </div>  
          <div>  
            <label>الحد الأدنى للمبلغ (ريال)</label>  
            <input id="offerMinAmount" type="number" min="0" placeholder="0">  
          </div>  
          <div>  
            <label>الحد الأقصى للمبلغ (ريال)</label>  
            <input id="offerMaxAmount" type="number" min="0" placeholder="999999999">  
          </div>  
          <div>  
            <label>نسبة الربح الخاصة بالعرض (%)</label>  
            <input id="offerSpecialRate" type="number" step="0.01" min="0" max="30" placeholder="اختياري">  
          </div>  
          <div>  
            <label>رابط العرض (URL)</label>  
            <input id="offerLink" type="text" placeholder="https://example.com/offer">  
          </div>  
          <div>  
            <label>الحالة</label>  
            <select id="offerEnabled">  
              <option value="true">مفعّل</option>  
              <option value="false">موقف</option>  
            </select>  
          </div>  
          <div>  
            <label>جهة العمل المستهدفة</label>  
            <select id="offerTargetEmployer">  
              <option value="">الكل</option>  
              <option value="أرامكو">أرامكو</option>  
              <option value="سابك">سابك</option>  
              <option value="ستك">ستك</option>  
              <option value="الاتصالات السعودية">الاتصالات السعودية</option>  
              <option value="موبايلي">موبايلي</option>  
              <option value="زين">زين</option>  
              <option value="الكهرباء السعودية">الكهرباء السعودية</option>  
              <option value="الخطوط السعودية">الخطوط السعودية</option>  
              <option value="وزارة الصحة">وزارة الصحة</option>  
              <option value="وزارة التعليم">وزارة التعليم</option>  
              <option value="وزارة الدفاع">وزارة الدفاع</option>  
              <option value="وزارة الداخلية">وزارة الداخلية</option>  
              <option value="الحرس الوطني">الحرس الوطني</option>  
              <option value="الأمن العام">الأمن العام</option>  
              <option value="الجوازات">الجوازات</option>  
              <option value="الدفاع المدني">الدفاع المدني</option>  
              <option value="أخرى">أخرى</option>  
            </select>  
          </div>  
          <div>  
            <label>جهة عمل مخصصة (اختياري)</label>  
            <input id="offerCustomEmployer" type="text" placeholder="اكتب اسم جهة العمل">  
          </div>  
          <div>  
            <label>تاريخ بداية العرض</label>  
            <input id="offerStartDate" type="date">  
          </div>  
          <div>  
            <label>تاريخ انتهاء العرض</label>  
            <input id="offerEndDate" type="date">  
          </div>  
          <div>  
            <label>ملاحظات العرض</label>  
            <textarea id="offerNotes" rows="2" placeholder="ملاحظات تظهر للعميل..."></textarea>  
          </div>  
          <div>  
            <label>عرض التنبيه عند اقتراب الانتهاء</label>  
            <select id="offerShowExpiry">  
              <option value="true">نعم - عرض "باقي X يوم"</option>  
              <option value="false">لا</option>  
            </select>  
          </div>  
        </div>  
        <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">  
          <button type="submit" class="primary small">💾 حفظ العرض</button>  
          <button type="button" class="secondary small" onclick="clearOfferForm()">إلغاء</button>  
        </div>  
      </form>  
        
      <table class="admin-table" id="offersTable" style="margin-top:15px; font-size:12px;">  
        <thead>  
          <tr>  
            <th>العنوان</th>  
            <th>النص</th>  
            <th>التمويل</th>  
            <th>الوظيفة</th>  
            <th>البنك</th>  
            <th>الحالة</th>  
            <th>تحكم</th>  
          </tr>  
        </thead>  
        <tbody></tbody>  
      </table>  
        
      <div style="margin-top:15px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">  
        <button class="primary" onclick="executeAllAdminChanges()" style="padding:12px 30px; font-size:16px;">✅ تنفيذ التغييرات</button>
        <button class="secondary small" onclick="showPage('adminHub')">🔙 رجوع للوحة المسؤول</button>  
      </div>  
    </div>  
  </div>  
  
  <!-- صفحة إعدادات التسويق -->  
  <div id="adminMarketingPage" class="page">  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">📢 إعدادات التسويق</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        تحكم بقسم التسويق وزر إبرام العقد في صفحة النتيجة.  
      </p>  
        
      <div class="admin-grid" style="margin-top:15px;">  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="showMarketingSection" onchange="saveMarketingSettings()" checked>  
            <span>عرض قسم التسويق "ننجز تمويلك"</span>  
          </label>  
        </div>  
        <div>  
          <label>عنوان قسم التسويق</label>  
          <input id="marketingTitle" type="text" value="ننجز تمويلك بأسرع وقت!">  
        </div>  
        <div>  
          <label>نص قسم التسويق</label>  
          <textarea id="marketingText" rows="2">تواصل معنا الحين وخلنا نساعدك في إتمام تمويلك بدون تعقيدات ⚡️</textarea>  
        </div>  
        <div>  
          <label>رقم الواتساب</label>  
          <input id="marketingWhatsapp" type="text" value="966506214458">  
        </div>  
      </div>  
        
      <hr style="margin:20px 0; border:none; border-top:1px dashed #e5e7eb;">  
        
      <div class="admin-grid">  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="showContractButton" onchange="saveMarketingSettings()">  
            <span>عرض زر "إبرام عقد"</span>  
          </label>  
        </div>  
        <div>  
          <label>نص زر العقد</label>  
          <input id="contractButtonText" type="text" value="📝 إبرام عقد تحويل إلكتروني">  
        </div>  
        <div>  
          <label>رابط العقد</label>  
          <input id="contractLink" type="url" placeholder="https://example.com/contract">  
        </div>  
      </div>  
        
      <hr style="margin:20px 0; border:none; border-top:1px dashed #e5e7eb;">  
        
      <h4 style="margin:0 0 10px; font-size:15px; color:#7c3aed;">🔗 رابط مخصص في النتيجة</h4>  
      <div class="admin-grid">  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="showCustomResultLink" onchange="saveMarketingSettings()">  
            <span>عرض رابط مخصص في صفحة النتيجة</span>  
          </label>  
        </div>  
        <div>  
          <label>نص الرابط</label>  
          <input id="customResultLinkText" type="text" placeholder="مثال: اضغط هنا للمزيد">  
        </div>  
        <div>  
          <label>رابط URL</label>  
          <input id="customResultLinkUrl" type="url" placeholder="https://example.com">  
        </div>  
        <div>  
          <label>لون الزر</label>  
          <input id="customResultLinkColor" type="color" value="#7c3aed">  
        </div>  
      </div>  
        
      <hr style="margin:20px 0; border:none; border-top:1px dashed #e5e7eb;">  
        
      <div>  
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
          <input type="checkbox" id="showRatingSection" onchange="saveMarketingSettings()" checked>  
          <span>عرض قسم التقييم للعملاء</span>  
        </label>  
      </div>  
        
      <div style="margin-top:15px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">  
        <button class="primary" onclick="executeAllAdminChanges()" style="padding:12px 30px; font-size:16px;">✅ تنفيذ التغييرات</button>
        <button class="primary small" onclick="saveMarketingSettings()">💾 حفظ الإعدادات</button>  
        <button class="secondary small" onclick="showPage('adminHub')">🔙 رجوع</button>  
      </div>  
    </div>  
  </div>  
  
  <!-- صفحة إدارة الأسئلة -->  
  <div id="adminQuestionsPage" class="page">  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">❓ إدارة الأسئلة</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        يمكنك تعديل نصوص الأسئلة وإخفائها وحذفها. اسحب السؤال لتغيير ترتيبه.  
      </p>  
        
      <!-- الأسئلة الأساسية -->  
      <div id="questionsList" class="question-list" style="margin-top:15px;"></div>  
        
      <!-- قسم التحكم في تفعيل/إيقاف الأسئلة لكل منتج -->
      <div style="margin-top:20px; padding:15px; background:#dbeafe; border-radius:12px; border:1px solid #60a5fa;">
        <h4 style="margin:0 0 12px; font-size:15px; color:#1e40af;">⚙️ التحكم في تفعيل/إيقاف الأسئلة</h4>
        <p style="font-size:12px; color:#64748b; margin-bottom:15px;">
          يمكنك تفعيل أو إيقاف أي سؤال لكافة المنتجات أو لمنتجات محددة فقط.
        </p>
        <div id="questionSettingsContainer" style="display:grid; gap:15px;"></div>
        <button onclick="saveAllQuestionSettings()" style="margin-top:15px; background:#22c55e; color:#fff; border:none; padding:12px 30px; border-radius:8px; font-size:14px; font-weight:bold; cursor:pointer;">
          ✅ حفظ إعدادات الأسئلة
        </button>
      </div>
      
      <!-- قسم إضافة سؤال مخصص لمنتج محدد -->
      <div style="margin-top:20px; padding:15px; background:#f0fdf4; border-radius:12px; border:1px solid #86efac;">
        <h4 style="margin:0 0 12px; font-size:15px; color:#166534;">➕ إضافة سؤال مخصص لمنتج</h4>  
        <div style="display:grid; gap:10px;">  
          <div>  
            <label style="font-size:12px; color:#374151;">نص السؤال:</label>  
            <input type="text" id="newProductQuestionText" placeholder="أدخل نص السؤال" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:13px;">  
          </div>  
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">  
            <div>  
              <label style="font-size:12px; color:#374151;">نوع السؤال:</label>  
              <select id="newProductQuestionType" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:13px;" onchange="toggleProductQuestionOptions()">  
                <option value="text">نص</option>  
                <option value="number">رقم</option>  
                <option value="select">قائمة منسدلة</option>  
              </select>  
            </div>  
            <div>  
              <label style="font-size:12px; color:#374151;">يظهر لمنتج:</label>  
              <select id="newProductQuestionProduct" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:13px;">  
                <option value="all">جميع المنتجات</option>  
                <!-- سيتم تحميل المنتجات ديناميكياً -->  
              </select>  
            </div>  
          </div>  
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">  
            <div>  
              <label style="font-size:12px; color:#374151;">🎯 المستهدف (جهة التمويل):</label>  
              <select id="newProductQuestionTarget" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:13px;">  
                <option value="all">جميع الجهات</option>  
                <!-- سيتم تحميل الجهات ديناميكياً -->  
              </select>  
            </div>  
            <div>  
              <label style="font-size:12px; color:#374151;">👁️ إظهار/إخفاء:</label>  
              <select id="newProductQuestionVisibility" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:13px;">  
                <option value="show">ظاهر</option>  
                <option value="hide">مخفي</option>  
              </select>  
            </div>  
          </div>  
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">  
            <div>  
              <label style="font-size:12px; color:#374151;">👷 نوع الوظيفة:</label>  
              <select id="newProductQuestionJobType" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:13px;">  
                <option value="all">جميع الوظائف</option>  
                <option value="حكومي">حكومي</option>  
                <option value="عسكري">عسكري</option>  
                <option value="قطاع خاص">قطاع خاص</option>  
                <option value="متقاعد">متقاعد</option>  
                <option value="صاحب عمل حر">صاحب عمل حر</option>  
              </select>  
            </div>  
            <div>  
              <label style="font-size:12px; color:#374151;">📌 إظهار الإجابة في النتيجة:</label>  
              <select id="newProductQuestionShowInResult" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:13px;">  
                <option value="yes">نعم</option>  
                <option value="no">لا</option>  
              </select>  
            </div>  
          </div>  
          <div id="productQuestionOptionsDiv" style="display:none;">  
            <label style="font-size:12px; color:#374151;">الخيارات (مفصولة بفاصلة):</label>  
            <input type="text" id="newProductQuestionOptions" placeholder="خيار 1, خيار 2, خيار 3" style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:13px;">  
          </div>  
          <button onclick="addProductQuestion()" style="background:#16a34a; color:#fff; border:none; padding:10px; border-radius:8px; font-size:14px; cursor:pointer;">➕ إضافة السؤال</button>  
        </div>  
      </div>  
        
      <!-- قائمة الأسئلة المخصصة للمنتجات -->  
      <div style="margin-top:15px; padding:15px; background:#fef3c7; border-radius:12px; border:1px solid #fcd34d;">  
        <h4 style="margin:0 0 10px; font-size:15px; color:#92400e;">📝 الأسئلة المخصصة للمنتجات</h4>  
        <div id="productQuestionsList"></div>  
      </div>  
        
      <div style="margin-top:15px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">  
        <button class="primary" onclick="executeAllAdminChanges()" style="padding:12px 30px; font-size:16px;">✅ تنفيذ التغييرات</button>
        <button class="secondary small" onclick="showPage('adminHub')">🔙 رجوع للوحة المسؤول</button>  
      </div>  
    </div>  
  </div>  
  
  <!-- صفحة تتبع الزوار -->  
  <div id="adminVisitorsPage" class="page">  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">👥 تتبع الزوار</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        عرض تفاصيل زيارات الموقع.  
      </p>  
      <div class="visitor-stats" style="margin:15px 0;">  
        <div class="visitor-stat-card">  
          <div class="visitor-stat-number" id="visitorTotalPage">0</div>  
          <div class="visitor-stat-label">إجمالي الزوار</div>  
        </div>  
        <div class="visitor-stat-card">  
          <div class="visitor-stat-number" id="visitorTodayPage">0</div>  
          <div class="visitor-stat-label">اليوم</div>  
        </div>  
        <div class="visitor-stat-card">  
          <div class="visitor-stat-number" id="visitorWeekPage">0</div>  
          <div class="visitor-stat-label">هذا الأسبوع</div>  
        </div>  
        <div class="visitor-stat-card">  
          <div class="visitor-stat-number" id="visitorMonthPage">0</div>  
          <div class="visitor-stat-label">هذا الشهر</div>  
        </div>  
      </div>  
      <table class="admin-table" id="visitorsTable">  
        <thead>  
          <tr>  
            <th>التاريخ</th>  
            <th>الوقت</th>  
            <th>المصدر</th>  
            <th>الشاشة</th>  
          </tr>  
        </thead>  
        <tbody></tbody>  
      </table>  
      <div style="margin-top:15px; display:flex; gap:8px; justify-content:flex-end;">  
        <button class="secondary small" onclick="clearVisitors()">🗑️ مسح السجل</button>  
        <button class="secondary small" onclick="showPage('adminHub')">🔙 رجوع</button>  
      </div>  
    </div>  
  </div>  
  
  <!-- صفحة نتائج العشوائية للعملاء -->  
  <div id="adminClientResultsPage" class="page">  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">📊 نتائج العشوائية للعملاء</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        عرض نتائج الحسبات التي أجراها العملاء (بدون حفظ بيانات شخصية).  
      </p>  
      <table class="admin-table" id="clientResultsTable">  
        <thead>  
          <tr>  
            <th>التاريخ</th>  
            <th>الاسم</th>  
            <th>نوع التمويل</th>  
            <th>المبلغ</th>  
            <th>البنك</th>  
            <th>الراتب</th>  
          </tr>  
        </thead>  
        <tbody></tbody>  
      </table>  
      <div style="margin-top:15px; display:flex; gap:8px; justify-content:flex-end;">  
        <button class="secondary small" onclick="clearClientResults()">🗑️ مسح السجل</button>  
        <button class="secondary small" onclick="showPage('adminHub')">🔙 رجوع</button>  
      </div>  
    </div>  
  </div>  
  
  <!-- صفحة الإعلانات المستهدفة -->  
  <div id="adminAdsPage" class="page">  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">📰 الإعلانات المستهدفة</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        أضف إعلانات تظهر للعميل حسب الراتب أو المبلغ أو نوع التمويل أو البنك.  
      </p>  
      <form id="adForm" onsubmit="saveAd(event)" style="margin-top:15px;">  
        <input type="hidden" id="adEditIndex" value="">  
        <div class="admin-grid">  
          <div>  
            <label>عنوان الإعلان</label>  
            <input id="adTitle" type="text" placeholder="مثال: عرض خاص للرواتب العالية">  
          </div>  
          <div>  
            <label>نص الإعلان</label>  
            <textarea id="adText" rows="2" placeholder="نص الإعلان..."></textarea>  
          </div>  
          <div>  
            <label>نوع الاستهداف</label>  
            <select id="adTargetType">  
              <option value="salary">حسب الراتب</option>  
              <option value="amount">حسب المبلغ</option>  
            </select>  
          </div>  
          <div>  
            <label>الحد الأدنى</label>  
            <input id="adTargetMin" type="number" min="0" placeholder="0">  
          </div>  
          <div>  
            <label>الحد الأقصى</label>  
            <input id="adTargetMax" type="number" min="0" placeholder="999999">  
          </div>  
          <div>  
            <label>نوع التمويل (اختياري)</label>  
            <select id="adFinanceType">  
              <option value="">الكل</option>  
              <option>تمويل شخصي</option>  
              <option>تمويل عقاري</option>  
              <option>تمويل التأجيري</option>  
            </select>  
          </div>  
          <div>  
            <label>البنك (اختياري)</label>  
            <input id="adBank" type="text" placeholder="اسم البنك">  
          </div>  
          <div>  
            <label>رابط (اختياري)</label>  
            <input id="adLink" type="url" placeholder="https://...">  
          </div>  
          <div>  
            <label>نص الرابط</label>  
            <input id="adLinkText" type="text" placeholder="تواصل معنا">  
          </div>  
          <div>  
            <label>رسالة مخصصة (اختياري)</label>  
            <input id="adCustomMessage" type="text" placeholder="مثال: ماشاء الله يحتاج لك سفرية!">  
            <div style="font-size:11px; color:#6b7280;">استخدم {name} لاسم العميل و {amount} للمبلغ</div>  
          </div>  
          <div>  
            <label>نوع الرسالة</label>  
            <select id="adMessageType">  
              <option value="text">نص فقط</option>  
              <option value="link">رابط</option>  
              <option value="video">فيديو</option>  
            </select>  
          </div>  
          <div>  
            <label>رابط الفيديو (إن وجد)</label>  
            <input id="adVideoUrl" type="url" placeholder="https://youtube.com/...">  
          </div>  
          <div>  
            <label>الحالة</label>  
            <select id="adEnabled">  
              <option value="true">مفعّل</option>  
              <option value="false">موقف</option>  
            </select>  
          </div>  
        </div>  
        <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">  
          <button type="submit" class="primary small">💾 حفظ الإعلان</button>  
          <button type="button" class="secondary small" onclick="clearAdForm()">إلغاء</button>  
        </div>  
      </form>  
      <table class="admin-table" id="adsTable" style="margin-top:15px;">  
        <thead>  
          <tr>  
            <th>العنوان</th>  
            <th>الاستهداف</th>  
            <th>الحدود</th>  
            <th>الحالة</th>  
            <th>تحكم</th>  
          </tr>  
        </thead>  
        <tbody></tbody>  
      </table>  
      <div style="margin-top:15px;">  
        <button class="secondary small" onclick="showPage('adminHub')">🔙 رجوع</button>  
      </div>  
    </div>  
  </div>  
  
  <!-- صفحة الثيمات والخلفيات -->  
  <div id="adminThemesPage" class="page">  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">🎨 الثيمات والخلفيات</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        اختر الثيم والخلفية المتحركة للمنصة.  
      </p>  
        
      <!-- التصاميم الجاهزة المتكاملة -->  
      <div style="margin-top:15px; padding:20px; background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius:16px; border:2px solid #f59e0b;">  
        <label style="font-weight:700; color:#92400e; font-size:16px;">🎨 التصاميم الجاهزة المتكاملة</label>  
        <p style="font-size:12px; color:#78350f; margin:5px 0 15px;">اختر تصميم جاهز يشمل الألوان والخطوط والأنماط - يمكنك التعديل لاحقاً</p>  
        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:12px;">  
          <div onclick="applyFullDesign('modern')" style="cursor:pointer; padding:15px; border-radius:16px; background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%); color:#fff; text-align:center; box-shadow:0 8px 25px rgba(59,130,246,0.3); transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">  
            <div style="font-size:28px; margin-bottom:8px;">🚀</div>  
            <div style="font-weight:700;">عصري</div>  
            <div style="font-size:10px; opacity:0.8;">أزرق + تجوال</div>  
          </div>  
          <div onclick="applyFullDesign('elegant')" style="cursor:pointer; padding:15px; border-radius:16px; background:linear-gradient(135deg,#8b5cf6 0%,#6d28d9 100%); color:#fff; text-align:center; box-shadow:0 8px 25px rgba(139,92,246,0.3); transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">  
            <div style="font-size:28px; margin-bottom:8px;">💎</div>  
            <div style="font-weight:700;">أنيق</div>  
            <div style="font-size:10px; opacity:0.8;">بنفسجي + القاهرة</div>  
          </div>  
          <div onclick="applyFullDesign('nature')" style="cursor:pointer; padding:15px; border-radius:16px; background:linear-gradient(135deg,#10b981 0%,#047857 100%); color:#fff; text-align:center; box-shadow:0 8px 25px rgba(16,185,129,0.3); transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">  
            <div style="font-size:28px; margin-bottom:8px;">🌿</div>  
            <div style="font-weight:700;">طبيعي</div>  
            <div style="font-size:10px; opacity:0.8;">أخضر + المراعي</div>  
          </div>  
          <div onclick="applyFullDesign('luxury')" style="cursor:pointer; padding:15px; border-radius:16px; background:linear-gradient(135deg,#f59e0b 0%,#b45309 100%); color:#fff; text-align:center; box-shadow:0 8px 25px rgba(245,158,11,0.3); transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">  
            <div style="font-size:28px; margin-bottom:8px;">👑</div>  
            <div style="font-weight:700;">فاخر</div>  
            <div style="font-size:10px; opacity:0.8;">ذهبي + شانجا</div>  
          </div>  
          <div onclick="applyFullDesign('dark')" style="cursor:pointer; padding:15px; border-radius:16px; background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%); color:#fff; text-align:center; box-shadow:0 8px 25px rgba(30,41,59,0.3); transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">  
            <div style="font-size:28px; margin-bottom:8px;">🌙</div>  
            <div style="font-weight:700;">داكن</div>  
            <div style="font-size:10px; opacity:0.8;">أسود + المسيري</div>  
          </div>  
          <div onclick="applyFullDesign('professional')" style="cursor:pointer; padding:15px; border-radius:16px; background:linear-gradient(135deg,#64748b 0%,#334155 100%); color:#fff; text-align:center; box-shadow:0 8px 25px rgba(100,116,139,0.3); transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">  
            <div style="font-size:28px; margin-bottom:8px;">💼</div>  
            <div style="font-weight:700;">احترافي</div>  
            <div style="font-size:10px; opacity:0.8;">رمادي + تجوال</div>  
          </div>  
          <div onclick="applyFullDesign('warm')" style="cursor:pointer; padding:15px; border-radius:16px; background:linear-gradient(135deg,#ef4444 0%,#b91c1c 100%); color:#fff; text-align:center; box-shadow:0 8px 25px rgba(239,68,68,0.3); transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">  
            <div style="font-size:28px; margin-bottom:8px;">🔥</div>  
            <div style="font-weight:700;">دافئ</div>  
            <div style="font-size:10px; opacity:0.8;">أحمر + القاهرة</div>  
          </div>  
          <div onclick="applyFullDesign('ocean')" style="cursor:pointer; padding:15px; border-radius:16px; background:linear-gradient(135deg,#06b6d4 0%,#0891b2 100%); color:#fff; text-align:center; box-shadow:0 8px 25px rgba(6,182,212,0.3); transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">  
            <div style="font-size:28px; margin-bottom:8px;">🌊</div>  
            <div style="font-weight:700;">محيطي</div>  
            <div style="font-size:10px; opacity:0.8;">سماوي + المراعي</div>  
          </div>  
        </div>  
      </div>  
        
      <div style="margin-top:15px;">  
        <label style="font-weight:700; color:#1e293b;">🌈 الثيم (الألوان فقط)</label>  
        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(100px,1fr)); gap:10px; margin-top:10px;">  
          <button onclick="applyTheme('default')" style="padding:15px; border-radius:12px; border:2px solid #3b82f6; background:linear-gradient(135deg,#3b82f6,#1d4ed8); color:#fff; cursor:pointer;">أزرق</button>  
          <button onclick="applyTheme('green')" style="padding:15px; border-radius:12px; border:2px solid #10b981; background:linear-gradient(135deg,#10b981,#047857); color:#fff; cursor:pointer;">أخضر</button>  
          <button onclick="applyTheme('purple')" style="padding:15px; border-radius:12px; border:2px solid #8b5cf6; background:linear-gradient(135deg,#8b5cf6,#6d28d9); color:#fff; cursor:pointer;">بنفسجي</button>  
          <button onclick="applyTheme('gold')" style="padding:15px; border-radius:12px; border:2px solid #f59e0b; background:linear-gradient(135deg,#f59e0b,#d97706); color:#fff; cursor:pointer;">ذهبي</button>  
          <button onclick="applyTheme('dark')" style="padding:15px; border-radius:12px; border:2px solid #475569; background:linear-gradient(135deg,#1e293b,#0f172a); color:#fff; cursor:pointer;">داكن</button>  
        </div>  
      </div>  
        
      <!-- إدارة الخطوط -->  
      <div style="margin-top:20px; padding:15px; background:linear-gradient(135deg,#eff6ff,#dbeafe); border-radius:12px; border:1px solid #93c5fd;">  
        <label style="font-weight:700; color:#1e40af;">✒️ إدارة الخطوط</label>  
        <p style="font-size:12px; color:#3b82f6; margin:5px 0 15px;">اختر الخطوط العربية العصرية للمنصة</p>  
          
        <div style="display:grid; gap:15px;">  
          <!-- الخط الرئيسي -->  
          <div style="padding:12px; background:#fff; border-radius:10px;">  
            <label style="font-size:13px; font-weight:600; color:#374151;">📝 الخط الرئيسي</label>  
            <select id="fontMain" onchange="updateFont('main', this.value)" style="width:100%; padding:12px; margin-top:8px; border-radius:10px; border:1px solid #d1d5db; font-size:14px;">  
              <option value="Tajawal" style="font-family:'Tajawal'">تجوال (Tajawal)</option>  
              <option value="Cairo" style="font-family:'Cairo'">القاهرة (Cairo)</option>  
              <option value="Almarai" style="font-family:'Almarai'">المراعي (Almarai)</option>  
              <option value="Changa" style="font-family:'Changa'">شانجا (Changa)</option>  
              <option value="El Messiri" style="font-family:'El Messiri'">المسيري (El Messiri)</option>  
              <option value="Readex Pro" style="font-family:'Readex Pro'">ريدكس برو (Readex Pro)</option>  
              <option value="IBM Plex Sans Arabic" style="font-family:'IBM Plex Sans Arabic'">IBM بلكس عربي</option>  
              <option value="Noto Kufi Arabic" style="font-family:'Noto Kufi Arabic'">نوتو كوفي (Noto Kufi)</option>  
              <option value="Rubik" style="font-family:'Rubik'">روبيك (Rubik)</option>  
              <option value="Baloo Bhaijaan 2" style="font-family:'Baloo Bhaijaan 2'">بالو بهايجان (Baloo)</option>  
            </select>  
            <div id="fontMainPreview" style="margin-top:10px; padding:15px; background:#f8fafc; border-radius:8px; font-size:16px; text-align:center;">  
              معاينة الخط الرئيسي - منصة FINO  
            </div>  
          </div>  
            
          <!-- خط العناوين -->  
          <div style="padding:12px; background:#fff; border-radius:10px;">  
            <label style="font-size:13px; font-weight:600; color:#374151;">🏷️ خط العناوين</label>  
            <select id="fontTitle" onchange="updateFont('title', this.value)" style="width:100%; padding:12px; margin-top:8px; border-radius:10px; border:1px solid #d1d5db; font-size:14px;">  
              <option value="Cairo" style="font-family:'Cairo'">القاهرة (Cairo)</option>  
              <option value="Tajawal" style="font-family:'Tajawal'">تجوال (Tajawal)</option>  
              <option value="Almarai" style="font-family:'Almarai'">المراعي (Almarai)</option>  
              <option value="Changa" style="font-family:'Changa'">شانجا (Changa)</option>  
              <option value="El Messiri" style="font-family:'El Messiri'">المسيري (El Messiri)</option>  
              <option value="Readex Pro" style="font-family:'Readex Pro'">ريدكس برو (Readex Pro)</option>  
              <option value="IBM Plex Sans Arabic" style="font-family:'IBM Plex Sans Arabic'">IBM بلكس عربي</option>  
              <option value="Noto Kufi Arabic" style="font-family:'Noto Kufi Arabic'">نوتو كوفي (Noto Kufi)</option>  
              <option value="Rubik" style="font-family:'Rubik'">روبيك (Rubik)</option>  
              <option value="Baloo Bhaijaan 2" style="font-family:'Baloo Bhaijaan 2'">بالو بهايجان (Baloo)</option>  
            </select>  
            <div id="fontTitlePreview" style="margin-top:10px; padding:15px; background:#f8fafc; border-radius:8px; font-size:22px; font-weight:800; text-align:center;">  
              معاينة خط العناوين  
            </div>  
          </div>  
            
          <!-- حجم الخط -->  
          <div style="padding:12px; background:#fff; border-radius:10px;">  
            <label style="font-size:13px; font-weight:600; color:#374151;">🔍 حجم الخط الأساسي</label>  
            <div style="display:flex; align-items:center; gap:15px; margin-top:10px;">  
              <input type="range" id="fontSizeRange" min="14" max="24" value="18" style="flex:1;" onchange="updateFontSize(this.value)">  
              <span id="fontSizeValue" style="font-weight:700; color:#3b82f6; min-width:45px;">18px</span>  
            </div>  
          </div>  
            
          <!-- وزن الخط -->  
          <div style="padding:12px; background:#fff; border-radius:10px;">  
            <label style="font-size:13px; font-weight:600; color:#374151;">💪 وزن الخط</label>  
            <select id="fontWeight" onchange="updateFontWeight(this.value)" style="width:100%; padding:12px; margin-top:8px; border-radius:10px; border:1px solid #d1d5db; font-size:14px;">  
              <option value="300">خفيف (Light)</option>  
              <option value="400" selected>عادي (Regular)</option>  
              <option value="500">متوسط (Medium)</option>  
              <option value="600">شبه سميك (Semi Bold)</option>  
              <option value="700">سميك (Bold)</option>  
              <option value="800">أسمك (Extra Bold)</option>  
              <option value="900">أسود (Black)</option>  
            </select>  
          </div>  
        </div>  
          
        <button onclick="saveFontSettings()" style="margin-top:15px; width:100%; padding:12px; background:linear-gradient(135deg,#3b82f6,#1d4ed8); color:#fff; border:none; border-radius:10px; font-weight:700; cursor:pointer;">✅ حفظ إعدادات الخطوط</button>  
        <button onclick="resetFontSettings()" style="margin-top:8px; width:100%; padding:10px; background:#f1f5f9; color:#475569; border:1px solid #cbd5e1; border-radius:10px; cursor:pointer;">🔄 إعادة تعيين للافتراضي</button>  
      </div>  
        
      <!-- الألوان المخصصة الشاملة -->  
      <div style="margin-top:20px; padding:15px; background:linear-gradient(135deg,#fdf4ff,#fae8ff); border-radius:12px; border:1px solid #e879f9;">  
        <label style="font-weight:700; color:#86198f;">🎨 نظام الألوان المتقدم</label>  
        <p style="font-size:12px; color:#a21caf; margin:5px 0 15px;">تحكم كامل في جميع ألوان المنصة</p>  
          
        <!-- الألوان العامة -->  
        <div style="padding:15px; background:#fff; border-radius:10px; margin-bottom:15px;">  
          <h4 style="margin:0 0 12px; font-size:14px; color:#374151;">🌐 الألوان العامة</h4>  
          <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;">  
            <div>  
              <label style="font-size:11px; color:#6b7280;">الرئيسي</label>  
              <input type="color" id="customPrimaryColor" value="#3b82f6" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
            <div>  
              <label style="font-size:11px; color:#6b7280;">الثانوي</label>  
              <input type="color" id="customSecondaryColor" value="#f59e0b" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
            <div>  
              <label style="font-size:11px; color:#6b7280;">التمييز</label>  
              <input type="color" id="customAccentColor" value="#10b981" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
            <div>  
              <label style="font-size:11px; color:#6b7280;">الخلفية الداكنة</label>  
              <input type="color" id="customBgDark" value="#0f172a" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
            <div>  
              <label style="font-size:11px; color:#6b7280;">الخلفية المتوسطة</label>  
              <input type="color" id="customBgMedium" value="#1e3a8a" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
            <div>  
              <label style="font-size:11px; color:#6b7280;">الخلفية الفاتحة</label>  
              <input type="color" id="customBgLight" value="#3b82f6" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
          </div>  
        </div>  
          
        <!-- ألوان شاشة البداية -->  
        <div style="padding:15px; background:#fff; border-radius:10px; margin-bottom:15px;">  
          <h4 style="margin:0 0 12px; font-size:14px; color:#374151;">🚀 ألوان شاشة البداية (Splash)</h4>  
          <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;">  
            <div>  
              <label style="font-size:11px; color:#6b7280;">التدرج 1</label>  
              <input type="color" id="splashBg1" value="#0f172a" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
            <div>  
              <label style="font-size:11px; color:#6b7280;">التدرج 2</label>  
              <input type="color" id="splashBg2" value="#1e3a8a" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
            <div>  
              <label style="font-size:11px; color:#6b7280;">التدرج 3</label>  
              <input type="color" id="splashBg3" value="#3b82f6" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
          </div>  
        </div>  
          
        <!-- ألوان الصفحة الرئيسية -->  
        <div style="padding:15px; background:#fff; border-radius:10px; margin-bottom:15px;">  
          <h4 style="margin:0 0 12px; font-size:14px; color:#374151;">🏠 ألوان الصفحة الرئيسية</h4>  
          <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px;">  
            <div>  
              <label style="font-size:11px; color:#6b7280;">التدرج 1</label>  
              <input type="color" id="landingBg1" value="#0f172a" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
            <div>  
              <label style="font-size:11px; color:#6b7280;">التدرج 2</label>  
              <input type="color" id="landingBg2" value="#1e3a8a" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
            <div>  
              <label style="font-size:11px; color:#6b7280;">التدرج 3</label>  
              <input type="color" id="landingBg3" value="#1e40af" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
            <div>  
              <label style="font-size:11px; color:#6b7280;">التدرج 4</label>  
              <input type="color" id="landingBg4" value="#3b82f6" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
          </div>  
        </div>  
          
        <!-- ألوان صفحة النتيجة -->  
        <div style="padding:15px; background:#fff; border-radius:10px; margin-bottom:15px;">  
          <h4 style="margin:0 0 12px; font-size:14px; color:#374151;">🏆 ألوان صفحة النتيجة</h4>  
          <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;">  
            <div>  
              <label style="font-size:11px; color:#6b7280;">التدرج 1</label>  
              <input type="color" id="resultBg1" value="#0f172a" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
            <div>  
              <label style="font-size:11px; color:#6b7280;">التدرج 2</label>  
              <input type="color" id="resultBg2" value="#1e3a8a" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
            <div>  
              <label style="font-size:11px; color:#6b7280;">لون البطاقات</label>  
              <input type="color" id="customCardColor" value="#ffffff" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
          </div>  
        </div>  
          
        <!-- ألوان النصوص -->  
        <div style="padding:15px; background:#fff; border-radius:10px; margin-bottom:15px;">  
          <h4 style="margin:0 0 12px; font-size:14px; color:#374151;">✍️ ألوان النصوص</h4>  
          <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;">  
            <div>  
              <label style="font-size:11px; color:#6b7280;">النص الداكن</label>  
              <input type="color" id="textDark" value="#111827" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
            <div>  
              <label style="font-size:11px; color:#6b7280;">النص المتوسط</label>  
              <input type="color" id="textMedium" value="#374151" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
            <div>  
              <label style="font-size:11px; color:#6b7280;">النص الفاتح</label>  
              <input type="color" id="textLight" value="#6b7280" style="width:100%; height:40px; border:none; border-radius:8px; cursor:pointer;">  
            </div>  
          </div>  
        </div>  
          
        <button onclick="applyAdvancedColors()" style="margin-top:10px; width:100%; padding:12px; background:linear-gradient(135deg,#a855f7,#7c3aed); color:#fff; border:none; border-radius:10px; font-weight:700; cursor:pointer;">✅ تطبيق جميع الألوان</button>  
        <button onclick="resetAdvancedColors()" style="margin-top:8px; width:100%; padding:10px; background:#f1f5f9; color:#475569; border:1px solid #cbd5e1; border-radius:10px; cursor:pointer;">🔄 إعادة تعيين للافتراضي</button>  
      </div>  
        
      <div style="margin-top:20px;">  
        <label style="font-weight:700; color:#1e293b;">🌿 الخلفية المتحركة (الموسم)</label>  
        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(100px,1fr)); gap:10px; margin-top:10px;">  
          <button onclick="applySeasonTheme('default')" style="padding:15px; border-radius:12px; border:2px solid #64748b; background:#f1f5f9; cursor:pointer;">افتراضي</button>  
          <button onclick="applySeasonTheme('winter')" style="padding:15px; border-radius:12px; border:2px solid #60a5fa; background:linear-gradient(135deg,#dbeafe,#bfdbfe); cursor:pointer;">❄️ شتوي</button>  
          <button onclick="applySeasonTheme('spring')" style="padding:15px; border-radius:12px; border:2px solid #34d399; background:linear-gradient(135deg,#d1fae5,#a7f3d0); cursor:pointer;">🌸 ربيعي</button>  
          <button onclick="applySeasonTheme('summer')" style="padding:15px; border-radius:12px; border:2px solid #fbbf24; background:linear-gradient(135deg,#fef3c7,#fde68a); cursor:pointer;">☀️ صيفي</button>  
          <button onclick="applySeasonTheme('autumn')" style="padding:15px; border-radius:12px; border:2px solid #f97316; background:linear-gradient(135deg,#ffedd5,#fed7aa); cursor:pointer;">🍂 خريفي</button>  
        </div>  
      </div>  
        
      <!-- إدارة الواجهات والصور -->  
      <div style="margin-top:20px; padding:15px; background:#fef3c7; border-radius:12px; border:1px solid #fbbf24;">  
        <label style="font-weight:700; color:#92400e;">🖼️ إدارة الواجهات والصور</label>  
        <p style="font-size:12px; color:#78350f; margin:5px 0 15px;">رفع صور متحركة (GIF) أو ثابتة للواجهات</p>  
          
        <div style="display:grid; gap:15px;">  
          <!-- شاشة البداية -->  
          <div style="padding:12px; background:#fff; border-radius:10px;">  
            <label style="font-size:13px; font-weight:600; color:#374151;">📱 شاشة البداية (Splash)</label>  
            <div style="display:flex; gap:10px; margin-top:8px;">  
              <input type="file" id="splashImageUpload" accept="image/*,.gif" style="flex:1; font-size:12px;" onchange="previewInterfaceImage('splash')">  
              <select id="splashImageType" style="width:100px; padding:8px; border-radius:8px; border:1px solid #d1d5db;">  
                <option value="static">ثابتة</option>  
                <option value="animated">متحركة</option>  
              </select>  
            </div>  
            <div id="splashPreview" style="margin-top:10px; display:none;">  
              <img id="splashPreviewImg" style="max-width:150px; max-height:100px; border-radius:8px;">  
              <button onclick="removeInterfaceImage('splash')" style="margin-right:10px; padding:5px 10px; background:#ef4444; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:11px;">حذف</button>  
            </div>  
          </div>  
            
          <!-- الشعار -->  
          <div style="padding:12px; background:#fff; border-radius:10px;">  
            <label style="font-size:13px; font-weight:600; color:#374151;">🎯 الشعار (Logo)</label>  
            <div style="display:flex; gap:10px; margin-top:8px;">  
              <input type="file" id="logoImageUpload" accept="image/*,.gif" style="flex:1; font-size:12px;" onchange="previewInterfaceImage('logo')">  
              <select id="logoImageType" style="width:100px; padding:8px; border-radius:8px; border:1px solid #d1d5db;">  
                <option value="static">ثابتة</option>  
                <option value="animated">متحركة</option>  
              </select>  
            </div>  
            <div id="logoPreview" style="margin-top:10px; display:none;">  
              <img id="logoPreviewImg" style="max-width:150px; max-height:100px; border-radius:8px;">  
              <button onclick="removeInterfaceImage('logo')" style="margin-right:10px; padding:5px 10px; background:#ef4444; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:11px;">حذف</button>  
            </div>  
          </div>  
            
          <!-- خلفية الصفحة الرئيسية -->  
          <div style="padding:12px; background:#fff; border-radius:10px;">  
            <label style="font-size:13px; font-weight:600; color:#374151;">🏘️ خلفية الصفحة الرئيسية</label>  
            <div style="display:flex; gap:10px; margin-top:8px;">  
              <input type="file" id="homeBgImageUpload" accept="image/*,.gif" style="flex:1; font-size:12px;" onchange="previewInterfaceImage('homeBg')">  
              <select id="homeBgImageType" style="width:100px; padding:8px; border-radius:8px; border:1px solid #d1d5db;">  
                <option value="static">ثابتة</option>  
                <option value="animated">متحركة</option>  
              </select>  
            </div>  
            <div id="homeBgPreview" style="margin-top:10px; display:none;">  
              <img id="homeBgPreviewImg" style="max-width:150px; max-height:100px; border-radius:8px;">  
              <button onclick="removeInterfaceImage('homeBg')" style="margin-right:10px; padding:5px 10px; background:#ef4444; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:11px;">حذف</button>  
            </div>  
          </div>  
            
          <!-- خلفية النتيجة -->  
          <div style="padding:12px; background:#fff; border-radius:10px;">  
            <label style="font-size:13px; font-weight:600; color:#374151;">🏆 خلفية صفحة النتيجة</label>  
            <div style="display:flex; gap:10px; margin-top:8px;">  
              <input type="file" id="resultBgImageUpload" accept="image/*,.gif" style="flex:1; font-size:12px;" onchange="previewInterfaceImage('resultBg')">  
              <select id="resultBgImageType" style="width:100px; padding:8px; border-radius:8px; border:1px solid #d1d5db;">  
                <option value="static">ثابتة</option>  
                <option value="animated">متحركة</option>  
              </select>  
            </div>  
            <div id="resultBgPreview" style="margin-top:10px; display:none;">  
              <img id="resultBgPreviewImg" style="max-width:150px; max-height:100px; border-radius:8px;">  
              <button onclick="removeInterfaceImage('resultBg')" style="margin-right:10px; padding:5px 10px; background:#ef4444; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:11px;">حذف</button>  
            </div>  
          </div>  
        </div>  
          
        <button onclick="saveInterfaceImages()" style="margin-top:15px; width:100%; padding:12px; background:linear-gradient(135deg,#f59e0b,#d97706); color:#fff; border:none; border-radius:10px; font-weight:700; cursor:pointer;">💾 حفظ الواجهات</button>  
        <button onclick="resetInterfaceImages()" style="margin-top:8px; width:100%; padding:10px; background:#f1f5f9; color:#475569; border:1px solid #cbd5e1; border-radius:10px; cursor:pointer;">🔄 إعادة تعيين للافتراضي</button>  
      </div>  
        
      <!-- إدارة الشعارات الشاملة -->  
      <div style="margin-top:20px; padding:15px; background:linear-gradient(135deg,#ecfdf5,#d1fae5); border-radius:12px; border:1px solid #34d399;">  
        <label style="font-weight:700; color:#047857;">🏦 إدارة الشعارات</label>  
        <p style="font-size:12px; color:#059669; margin:5px 0 15px;">تخصيص شعارات البنوك وجهات العمل والمنتجات</p>  
          
        <!-- شعار المنصة -->  
        <div style="padding:15px; background:#fff; border-radius:10px; margin-bottom:15px;">  
          <h4 style="margin:0 0 12px; font-size:14px; color:#374151;">🎯 شعار المنصة الرئيسي</h4>  
          <div style="display:flex; gap:10px; align-items:center;">  
            <input type="file" id="platformLogoUpload" accept="image/*" style="flex:1; font-size:12px;" onchange="previewLogo('platform')">  
            <div id="platformLogoPreview" style="width:60px; height:60px; border-radius:10px; background:#f1f5f9; display:flex; align-items:center; justify-content:center; overflow:hidden;">  
              <span style="font-size:24px;">FINO</span>  
            </div>  
          </div>  
        </div>  
          
        <!-- شعارات البنوك -->  
        <div style="padding:15px; background:#fff; border-radius:10px; margin-bottom:15px;">  
          <h4 style="margin:0 0 12px; font-size:14px; color:#374151;">🏦 شعارات البنوك وشركات التمويل</h4>  
          <p style="font-size:11px; color:#6b7280; margin-bottom:10px;">اختر البنك وارفع شعاره المخصص</p>  
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">  
            <select id="bankLogoSelect" style="padding:10px; border-radius:8px; border:1px solid #d1d5db;">  
              <option value="">اختر البنك...</option>  
              <option value="مصرف الراجحي">مصرف الراجحي</option>  
              <option value="البنك الأهلي السعودي">البنك الأهلي السعودي</option>  
              <option value="بنك الرياض">بنك الرياض</option>  
              <option value="مصرف الإنماء">مصرف الإنماء</option>  
              <option value="بنك البلاد">بنك البلاد</option>  
              <option value="بنك ساب">بنك ساب</option>  
              <option value="البنك العربي الوطني">البنك العربي الوطني</option>  
              <option value="البنك السعودي الفرنسي">البنك السعودي الفرنسي</option>  
              <option value="بنك الجزيرة">بنك الجزيرة</option>  
              <option value="شركة تسهيل">شركة تسهيل</option>  
              <option value="شركة نايفات">شركة نايفات</option>  
              <option value="شركة اليسر">شركة اليسر</option>  
            </select>  
            <input type="file" id="bankLogoUpload" accept="image/*" style="font-size:12px;" onchange="uploadBankLogo()">  
          </div>  
          <div id="bankLogosGrid" style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; margin-top:15px;"></div>  
        </div>  
          
        <!-- شعارات جهات العمل -->  
        <div style="padding:15px; background:#fff; border-radius:10px; margin-bottom:15px;">  
          <h4 style="margin:0 0 12px; font-size:14px; color:#374151;">🏢 شعارات جهات العمل</h4>  
          <p style="font-size:11px; color:#6b7280; margin-bottom:10px;">أضف شعارات لجهات العمل المختلفة</p>  
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">  
            <input type="text" id="employerNameInput" placeholder="اسم جهة العمل" style="padding:10px; border-radius:8px; border:1px solid #d1d5db;">  
            <input type="file" id="employerLogoUpload" accept="image/*" style="font-size:12px;">  
          </div>  
          <button onclick="addEmployerLogo()" style="margin-top:10px; width:100%; padding:10px; background:linear-gradient(135deg,#3b82f6,#1d4ed8); color:#fff; border:none; border-radius:8px; cursor:pointer;">➕ إضافة جهة عمل</button>  
          <div id="employerLogosGrid" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-top:15px;"></div>  
        </div>  
          
        <!-- شعارات المنتجات -->  
        <div style="padding:15px; background:#fff; border-radius:10px; margin-bottom:15px;">  
          <h4 style="margin:0 0 12px; font-size:14px; color:#374151;">📦 شعارات المنتجات</h4>  
          <p style="font-size:11px; color:#6b7280; margin-bottom:10px;">تخصيص شعارات أنواع التمويل</p>  
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">  
            <select id="productLogoSelect" style="padding:10px; border-radius:8px; border:1px solid #d1d5db;">  
              <option value="">اختر المنتج...</option>  
              <option value="تمويل شخصي">تمويل شخصي</option>  
              <option value="تمويل عقاري">تمويل عقاري</option>  
              <option value="شراء مديونية">شراء مديونية</option>  
              <option value="تمويل التأجيري">تمويل التأجيري</option>  
              <option value="تمويل استهلاكي">تمويل استهلاكي</option>  
            </select>  
            <input type="file" id="productLogoUpload" accept="image/*" style="font-size:12px;" onchange="uploadProductLogo()">  
          </div>  
          <div id="productLogosGrid" style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-top:15px;"></div>  
        </div>  
          
        <button onclick="saveAllLogos()" style="width:100%; padding:12px; background:linear-gradient(135deg,#10b981,#059669); color:#fff; border:none; border-radius:10px; font-weight:700; cursor:pointer;">💾 حفظ جميع الشعارات</button>  
        <button onclick="resetAllLogos()" style="margin-top:8px; width:100%; padding:10px; background:#f1f5f9; color:#475569; border:1px solid #cbd5e1; border-radius:10px; cursor:pointer;">🔄 إعادة تعيين للافتراضي</button>  
      </div>  
        
      <div style="margin-top:15px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">  
        <button class="primary" onclick="executeAllAdminChanges()" style="padding:12px 30px; font-size:16px;">✅ تنفيذ التغييرات</button>
        <button class="secondary small" onclick="showPage('adminHub')">🔙 رجوع</button>  
      </div>  
    </div>  
  </div>  
  
  <!-- صفحة محرر النصوص -->  
  <div id="adminTextsPage" class="page">  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">✏️ محرر النصوص والرسائل</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        تعديل جميع النصوص والرسائل في المنصة.  
      </p>  
        
      <!-- رسائل الترحيب -->  
      <div style="margin-top:15px; padding:15px; background:#f0fdf4; border-radius:12px; border:1px solid #86efac;">  
        <h4 style="margin:0 0 10px; font-size:15px; color:#166534;">👋 رسائل الترحيب</h4>  
        <div class="admin-grid">  
          <div>  
            <label>رسالة الترحيب الرئيسية</label>  
            <input id="textWelcome" type="text" value="نورت المنصة يا {name}">  
            <div style="font-size:11px; color:#6b7280;">استخدم {name} لاسم العميل</div>  
          </div>  
          <div>  
            <label>رسالة نتيجة الحسبة</label>  
            <input id="textResultGreeting" type="text" value="أرحب يا {name}! خلصنا الحسبة وجاك الخبر الحلو!">  
          </div>  
        </div>  
      </div>  
        
      <!-- رسائل النتيجة -->  
      <div style="margin-top:15px; padding:15px; background:#eff6ff; border-radius:12px; border:1px solid #93c5fd;">  
        <h4 style="margin:0 0 10px; font-size:15px; color:#1e40af;">📊 رسائل النتيجة</h4>  
        <div class="admin-grid">  
          <div>  
            <label>رسالة انتهاء التمويل</label>  
            <input id="textFinanceEnd" type="text" value="الله يطول بعمرنا ويبارك لنا">  
          </div>  
          <div>  
            <label>رسالة العجز</label>  
            <input id="textDeficit" type="text" value="للأسف يا {name} معليش! عندك عجز بالأقساط.">  
          </div>  
          <div>  
            <label>رسالة التقاعد</label>  
            <input id="textRetirement" type="text" value="تتقاعد يا {name} بعد عمر طويل بالطاعة">  
          </div>  
          <div>  
            <label>رسالة التواصل</label>  
            <input id="textContact" type="text" value="تواصل معنا 📞 0506214458">  
          </div>  
        </div>  
      </div>  
        
      <!-- رسائل التنبيهات -->  
      <div style="margin-top:15px; padding:15px; background:#fef3c7; border-radius:12px; border:1px solid #fcd34d;">  
        <h4 style="margin:0 0 10px; font-size:15px; color:#92400e;">⚠️ رسائل التنبيهات</h4>  
        <div class="admin-grid">  
          <div>  
            <label>تنبيه الحسبة التقريبية</label>  
            <textarea id="textDisclaimer" rows="2">هذه الحسبة تقريبية، والنسب الفعلية ومنح التمويل يعتمد على سياسات الجهة الممولة.</textarea>  
          </div>  
          <div>  
            <label>تنبيه القطاع الخاص</label>  
            <textarea id="textPrivateSector" rows="2">جميع حالات القطاع الخاص تخضع لاعتماد الجهة الممولة.</textarea>  
          </div>  
        </div>  
      </div>  
        
      <!-- رسائل مخصصة حسب الصفحة -->  
      <div style="margin-top:15px; padding:15px; background:#fdf4ff; border-radius:12px; border:1px solid #e879f9;">  
        <h4 style="margin:0 0 10px; font-size:15px; color:#86198f;">📝 رسائل مخصصة حسب الصفحة</h4>  
        <div id="customPageMessages"></div>  
        <button type="button" class="secondary small" onclick="addCustomPageMessage()" style="margin-top:10px;">➕ إضافة رسالة مخصصة</button>  
      </div>  
        
      <div style="margin-top:15px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">  
        <button class="primary" onclick="executeAllAdminChanges()" style="padding:12px 30px; font-size:16px;">✅ تنفيذ التغييرات</button>
        <button class="primary small" onclick="saveCustomTexts()">💾 حفظ النصوص</button>  
        <button class="secondary small" onclick="showPage('adminHub')">🔙 رجوع</button>  
      </div>  
    </div>  
  </div>  
  
  <!-- صفحة إدارة أنواع الوظائف -->  
  <div id="adminJobTypesPage" class="page">  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">💼 إدارة أنواع الوظائف</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        أضف وعدل واحذف أنواع الوظائف (مثل: حكومي، عسكري، قطاع خاص، إلخ).  
      </p>  
        
      <!-- نموذج إضافة نوع وظيفة جديد -->  
      <div style="background:linear-gradient(135deg, #fff1f2, #ffe4e6); padding:15px; border-radius:12px; margin-bottom:20px; border-right:4px solid #f43f5e;">  
        <h4 style="margin:0 0 12px; font-size:15px; color:#9f1239;">➕ إضافة نوع وظيفة جديد</h4>  
        <div style="display:grid; grid-template-columns:1fr auto; gap:10px; align-items:end;">  
          <div>  
            <label style="font-size:12px; color:#374151;">اسم نوع الوظيفة</label>  
            <input id="newJobTypeName" type="text" placeholder="مثل: قطاع شبه حكومي" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px;">  
          </div>  
          <button onclick="addNewJobType()" style="background:linear-gradient(135deg, #f43f5e, #e11d48); color:#fff; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600;">➕ إضافة</button>  
        </div>  
      </div>  
        
      <!-- قائمة أنواع الوظائف الحالية -->  
      <div style="background:#f8fafc; padding:15px; border-radius:12px;">  
        <h4 style="margin:0 0 12px; font-size:15px; color:#374151;">📝 أنواع الوظائف الحالية</h4>  
        <div id="jobTypesList" style="display:grid; gap:8px; max-height:400px; overflow-y:auto;"></div>  
      </div>  
        
      <div style="margin-top:15px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">  
        <button class="primary" onclick="executeAllAdminChanges()" style="padding:12px 30px; font-size:16px;">✅ تنفيذ التغييرات</button>
        <button class="primary" onclick="saveJobTypesList()" style="padding:12px 25px;">💾 حفظ التغييرات</button>  
        <button class="secondary" onclick="resetJobTypesList()">🔄 إعادة تعيين</button>  
        <button class="secondary" onclick="showPage('adminHub')">🔙 رجوع</button>  
      </div>  
    </div>  
  </div>  
  
  <!-- صفحة إدارة جهات الوظيفة -->  
  <div id="adminEmployersPage" class="page">  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">🏢 إدارة جهات الوظيفة</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        أضف وعدل واحذف جهات العمل التي تظهر للعميل وفي العروض.  
      </p>  
        
      <!-- نموذج إضافة جهة جديدة -->  
      <div style="background:linear-gradient(135deg, #f0fdf4, #dcfce7); padding:15px; border-radius:12px; margin-bottom:20px; border-right:4px solid #22c55e;">  
        <h4 style="margin:0 0 12px; font-size:15px; color:#166534;">➕ إضافة جهة جديدة</h4>  
        <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:10px; align-items:end;">  
          <div>  
            <label style="font-size:12px; color:#374151;">اسم الجهة</label>  
            <input id="newEmployerName" type="text" placeholder="مثل: الصحة القابضة" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px;">  
          </div>  
          <div>  
            <label style="font-size:12px; color:#374151;">الأيقونة (اختياري)</label>  
            <input id="newEmployerIcon" type="text" placeholder="🏥" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px;">  
          </div>  
          <button onclick="addNewEmployer()" style="background:linear-gradient(135deg, #22c55e, #16a34a); color:#fff; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600;">➕ إضافة</button>  
        </div>  
      </div>  
        
      <!-- قائمة الجهات الحالية -->  
      <div style="background:#f8fafc; padding:15px; border-radius:12px;">  
        <h4 style="margin:0 0 12px; font-size:15px; color:#374151;">📝 الجهات الحالية</h4>  
        <div id="employersList" style="display:grid; gap:8px; max-height:400px; overflow-y:auto;"></div>  
      </div>  
        
      <div style="margin-top:15px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">  
        <button class="primary" onclick="executeAllAdminChanges()" style="padding:12px 30px; font-size:16px;">✅ تنفيذ التغييرات</button>
        <button class="primary" onclick="saveEmployersList()" style="padding:12px 25px;">💾 حفظ التغييرات</button>  
        <button class="secondary" onclick="resetEmployersList()">🔄 إعادة تعيين</button>  
        <button class="secondary" onclick="showPage('adminHub')">🔙 رجوع</button>  
      </div>  
    </div>  
  </div>  
  
  <!-- صفحة إدارة جهات التمويل -->  
  <div id="adminFinanceEntitiesPage" class="page">  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">🏦 إدارة جهات التمويل</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        أضف وعدل واحذف البنوك وشركات التمويل.  
      </p>  
        
      <!-- نموذج إضافة جهة تمويل جديدة -->  
      <div style="background:linear-gradient(135deg, #eff6ff, #dbeafe); padding:15px; border-radius:12px; margin-bottom:20px; border-right:4px solid #3b82f6;">  
        <h4 style="margin:0 0 12px; font-size:15px; color:#1e40af;">➕ إضافة جهة تمويل جديدة</h4>  
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:10px; align-items:end;">  
          <div>  
            <label style="font-size:12px; color:#374151;">اسم الجهة</label>  
            <input id="newFinanceEntityName" type="text" placeholder="مثل: بنك الراجحي" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px;">  
          </div>  
          <div>  
            <label style="font-size:12px; color:#374151;">النوع</label>  
            <select id="newFinanceEntityType" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px;">  
              <option value="بنك">🏦 بنك</option>  
              <option value="شركة تمويل">🏢 شركة تمويل</option>  
              <option value="تقنية مالية">📱 تقنية مالية</option>  
            </select>  
          </div>  
          <div>  
            <label style="font-size:12px; color:#374151;">الأيقونة</label>  
            <input id="newFinanceEntityIcon" type="text" placeholder="🏦" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px;">  
          </div>  
          <button onclick="addNewFinanceEntity()" style="background:linear-gradient(135deg, #3b82f6, #2563eb); color:#fff; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600;">➕ إضافة</button>  
        </div>  
      </div>  
        
      <!-- قائمة جهات التمويل الحالية -->  
      <div style="background:#f8fafc; padding:15px; border-radius:12px;">  
        <h4 style="margin:0 0 12px; font-size:15px; color:#374151;">📝 جهات التمويل الحالية</h4>  
        <div id="financeEntitiesList" style="display:grid; gap:8px; max-height:400px; overflow-y:auto;"></div>  
      </div>  
        
      <div style="margin-top:15px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">  
        <button class="primary" onclick="executeAllAdminChanges()" style="padding:12px 30px; font-size:16px;">✅ تنفيذ التغييرات</button>
        <button class="primary" onclick="saveFinanceEntitiesList()" style="padding:12px 25px;">💾 حفظ التغييرات</button>  
        <button class="secondary" onclick="resetFinanceEntitiesList()">🔄 إعادة تعيين</button>  
        <button class="secondary" onclick="showPage('adminHub')">🔙 رجوع</button>  
      </div>  
    </div>  
  </div>  
  
  <!-- صفحة الإعدادات العامة -->  
  <div id="adminSettingsPage" class="page">  
    <div class="card fade-in">  
      <h2 style="margin-top:0; font-size:19px; color:#111827;">⚙️ إعدادات المنصة</h2>  
      <p style="font-size:13px; color:#6b7280; text-align:right;">  
        تخصيص اسم المنصة والنصوص والإعدادات العامة.  
      </p>  
        
      <div class="admin-grid" style="margin-top:15px;">  
        <div>  
          <label>اسم المنصة</label>  
          <input id="settingsPlatformName" type="text" value="منصة FINO">  
        </div>  
        <div>  
          <label>العنوان الفرعي</label>  
          <input id="settingsPlatformSubtitle" type="text" value="منصة ذكية تحسب لك التمويل">  
        </div>  
        <div>  
          <label>رسالة الترحيب (استخدم {name} للاسم)</label>  
          <input id="settingsWelcomeMessage" type="text" value="نورت المنصة يا {name}">  
        </div>  
        <div>  
          <label>رسالة تاريخ انتهاء التمويل</label>  
          <input id="settingsEndDateMessage" type="text" value="الله يطول بعمرنا ويبارك لنا">  
        </div>  
      </div>  
        
      <div class="admin-grid" style="margin-top:15px;">  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="settingsShowWeather" onchange="savePlatformSettingsFromUI()">  
            <span>تفعيل عرض الطقس</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="settingsShowSplash" onchange="savePlatformSettingsFromUI()" checked>  
            <span>عرض شاشة البداية</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="settingsShowRetirementFormula" onchange="savePlatformSettingsFromUI()">  
            <span>عرض معادلة التقاعد للعميل</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="settingsShowEndDate" onchange="savePlatformSettingsFromUI()" checked>  
            <span>عرض تاريخ انتهاء التمويل</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="settingsShowEarlySettlement" onchange="savePlatformSettingsFromUI()" checked>  
            <span>عرض حاسبة السداد المبكر</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="settingsShowPWABanner" onchange="savePlatformSettingsFromUI()" checked>  
            <span>عرض شعار تثبيت التطبيق (PWA)</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="settingsShowMarketing" onchange="savePlatformSettingsFromUI()" checked>  
            <span>عرض قسم "ننجز تمويلك" (التسويق)</span>  
          </label>  
        </div>  
      </div>  
        
      <!-- إعدادات شاشة البداية -->  
      <div style="margin-top:20px; padding:15px; background:#f0f9ff; border-radius:12px; border:1px solid #bae6fd;">  
        <h4 style="margin:0 0 10px; font-size:15px; color:#0369a1;">📱 إعدادات شاشة البداية (الأيفون الذي يخرج منه المال)</h4>  
        <div class="admin-grid">  
          <div>  
            <label>مدة عرض شاشة البداية (بالثواني)</label>  
            <input id="settingsSplashDuration" type="number" value="3" min="1" max="30" step="1" onchange="updateSplashDurationPreview()">  
            <span id="splashDurationPreview" style="font-size:12px; color:#6b7280; margin-top:5px; display:block;">المدة: 3 ثواني</span>  
          </div>  
          <div>  
            <label>رابط صورة مخصصة (اختياري - GIF أو PNG)</label>  
            <input id="settingsSplashImage" type="text" placeholder="https://example.com/image.gif">  
          </div>  
          <div>  
            <label>رابط فيديو مخصص (اختياري - MP4)</label>  
            <input id="settingsSplashVideo" type="text" placeholder="https://example.com/video.mp4">  
          </div>  
          <div style="grid-column: 1 / -1;">  
            <button onclick="testSplashScreen()" style="background:#3b82f6; color:#fff; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">👁️ معاينة شاشة البداية</button>  
          </div>  
        </div>  
      </div>  
        
      <!-- إعدادات الصور المتحركة للصفحات -->  
      <div style="margin-top:20px; padding:15px; background:#fef3c7; border-radius:12px; border:1px solid #fcd34d;">  
        <h4 style="margin:0 0 10px; font-size:15px; color:#92400e;">🌟 الصور المتحركة للصفحات</h4>  
          
        <!-- سؤال للمسؤول: هل الخلفية لكافة الصفحات؟ -->  
        <div style="margin-bottom:15px; padding:12px; background:#fff7ed; border-radius:8px; border:2px solid #f97316;">  
          <label style="display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:600; color:#c2410c;">  
            <input type="checkbox" id="settingsBgAllPages" style="width:20px; height:20px;">  
            <span>🌍 تطبيق الخلفية على كافة الصفحات (الرئيسية + الحاسبة + النتيجة + السداد المبكر)</span>  
          </label>  
          <p style="margin:8px 0 0; font-size:12px; color:#9a3412;">إذا مفعّل، ستظهر الخلفية العامة على جميع صفحات المنصة. إذا معطّل، يمكنك تخصيص خلفية لكل صفحة على حدة.</p>  
        </div>  
          
        <div class="admin-grid">  
          <div>  
            <label>صورة عامة لكل الصفحات</label>  
            <input id="settingsGlobalImage" type="text" placeholder="رابط الصورة المتحركة أو الثابتة">  
          </div>  
          <div id="specificPagesImages">  
            <div>  
              <label>صورة صفحة البداية</label>  
              <input id="settingsHomeImage" type="text" placeholder="رابط الصورة">  
            </div>  
            <div>  
              <label>صورة صفحة النتيجة</label>  
              <input id="settingsResultImage" type="text" placeholder="رابط الصورة">  
            </div>  
            <div>  
              <label>صورة صفحة الحاسبة</label>  
              <input id="settingsCalcImage" type="text" placeholder="رابط الصورة">  
            </div>  
          </div>  
        </div>  
      </div>  
        
      <!-- إدارة أنواع الوظائف -->  
      <div style="margin-top:20px; padding:15px; background:#ecfdf5; border-radius:12px; border:1px solid #6ee7b7;">  
        <h4 style="margin:0 0 10px; font-size:15px; color:#065f46;">👤 إدارة أنواع الوظائف</h4>  
        <div style="display:flex; gap:8px; margin-bottom:10px;">  
          <input id="newJobTypeName" type="text" placeholder="اسم نوع الوظيفة الجديد" style="flex:1;">  
          <input id="newJobTypeLogo" type="text" placeholder="رابط الشعار (اختياري)" style="flex:1;">  
          <button class="primary small" onclick="addJobType()">➕ إضافة</button>  
        </div>  
        <div id="jobTypesList" style="max-height:200px; overflow-y:auto;"></div>  
      </div>  
        
      <!-- إعدادات حاسبة السداد المبكر -->  
      <div style="margin-top:20px; padding:15px; background:#fef2f2; border-radius:12px; border:1px solid #fca5a5;">  
        <h4 style="margin:0 0 10px; font-size:15px; color:#991b1b;">💰 إعدادات حاسبة السداد المبكر</h4>  
        <div class="admin-grid">  
          <div>  
            <label>رسالة تنبيه العقاري (شرط سنتين)</label>  
            <input id="settingsEarlySettlementWarning" type="text" value="أكثر جهات التمويل يشترطون انتهاء سنتين من الأقساط للسماح بالسداد المبكر. راجع العقد.">  
          </div>  
          <div>  
            <label>طريقة حساب العقاري</label>  
            <input id="settingsEarlySettlementFormula" type="text" value="أرباح سنتين + أرباح 3 أشهر (رسوم إدارية)">  
          </div>  
        </div>  
        <div style="margin-top:10px;">  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="settingsShowEarlyWarning" checked>  
            <span>عرض تنبيه شرط السنتين للعقاري</span>  
          </label>  
        </div>  
      </div>  
        
      <!-- نظام الدفع والباقات -->  
      <div style="margin-top:20px; padding:15px; background:linear-gradient(135deg, #fef3c7, #fde68a); border-radius:12px; border:2px solid #f59e0b;">  
        <h4 style="margin:0 0 15px; font-size:16px; color:#92400e;">💳 نظام الدفع والباقات</h4>  
          
        <!-- تفعيل/تعطيل النظام -->  
        <div style="margin-bottom:15px; padding:10px; background:#fff; border-radius:8px;">  
          <label style="display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:700;">  
            <input type="checkbox" id="paymentSystemEnabled" onchange="savePaymentSettings()">  
            <span>تفعيل نظام الدفع (إذا معطل ستعمل الحاسبة مجاناً)</span>  
          </label>  
        </div>  
          
        <div id="paymentSettingsContainer">  
          <!-- المرات المجانية -->  
          <div class="admin-grid" style="margin-bottom:15px;">  
            <div>  
              <label>عدد المرات المجانية</label>  
              <input id="paymentFreeTrials" type="number" value="3" min="0" max="100" onchange="savePaymentSettings()">  
              <small style="color:#6b7280;">عدد مرات استخدام الحاسبة مجاناً قبل طلب الدفع</small>  
            </div>  
            <div>  
              <label>سعر الاستخدام الواحد (ريال)</label>  
              <input id="paymentSinglePrice" type="number" value="10" min="1" step="0.5" onchange="savePaymentSettings()">  
            </div>  
          </div>  
            
          <!-- الباقات -->  
          <div style="margin-bottom:15px; padding:12px; background:#fff; border-radius:8px;">  
            <h5 style="margin:0 0 10px; font-size:14px; color:#1f2937;">🎁 الباقات</h5>  
            <div id="paymentPackagesList"></div>  
            <div style="display:flex; gap:8px; margin-top:10px;">  
              <input id="newPackageName" type="text" placeholder="اسم الباقة" style="flex:1;">  
              <input id="newPackageUses" type="number" placeholder="عدد الاستخدامات" style="width:100px;" min="1">  
              <input id="newPackagePrice" type="number" placeholder="السعر" style="width:80px;" min="1" step="0.5">  
              <button class="primary small" onclick="addPaymentPackage()">➕ إضافة</button>  
            </div>  
          </div>  
            
          <!-- طرق الدفع -->  
          <div style="padding:12px; background:#fff; border-radius:8px;">  
            <h5 style="margin:0 0 10px; font-size:14px; color:#1f2937;">💰 طرق الدفع</h5>  
              
            <!-- رابط المتجر الخارجي -->  
            <div style="margin-bottom:12px;">  
              <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
                <input type="checkbox" id="paymentStoreEnabled" onchange="savePaymentSettings()">  
                <span>تفعيل الدفع عبر المتجر الخارجي</span>  
              </label>  
              <input id="paymentStoreUrl" type="text" placeholder="رابط المتجر (مثل: https://store.example.com)" style="margin-top:5px;" onchange="savePaymentSettings()">  
              <input id="paymentStoreButtonText" type="text" placeholder="نص زر الدفع (مثل: ادفع الآن)" style="margin-top:5px;" value="🛒 ادفع عبر المتجر" onchange="savePaymentSettings()">  
            </div>  
              
            <!-- التحويل البنكي -->  
            <div style="margin-bottom:12px;">  
              <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
                <input type="checkbox" id="paymentBankEnabled" onchange="savePaymentSettings()">  
                <span>تفعيل الدفع عبر التحويل البنكي</span>  
              </label>  
              <textarea id="paymentBankDetails" placeholder="تفاصيل الحساب البنكي...  
مثال:  
البنك: مصرف الراجحي  
رقم الحساب: 123456789  
الآيبان: SA12345678901234567890" style="margin-top:5px; min-height:80px; width:100%;" onchange="savePaymentSettings()"></textarea>  
            </div>  
              
            <!-- رابط دفع مخصص -->  
            <div>  
              <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
                <input type="checkbox" id="paymentCustomEnabled" onchange="savePaymentSettings()">  
                <span>تفعيل رابط دفع مخصص (مثل PayPal, Stripe)</span>  
              </label>  
              <input id="paymentCustomUrl" type="text" placeholder="رابط الدفع المخصص" style="margin-top:5px;" onchange="savePaymentSettings()">  
              <input id="paymentCustomButtonText" type="text" placeholder="نص الزر" value="💳 ادفع الآن" style="margin-top:5px;" onchange="savePaymentSettings()">  
            </div>  
          </div>  
            
          <!-- رسائل الدفع -->  
          <div style="margin-top:15px; padding:12px; background:#fff; border-radius:8px;">  
            <h5 style="margin:0 0 10px; font-size:14px; color:#1f2937;">✉️ رسائل الدفع</h5>  
            <div class="admin-grid">  
              <div>  
                <label>رسالة انتهاء المرات المجانية</label>  
                <input id="paymentExpiredMessage" type="text" value="انتهت مراتك المجانية! اختر باقة للمتابعة." onchange="savePaymentSettings()">  
              </div>  
              <div>  
                <label>رسالة بعد الدفع الناجح</label>  
                <input id="paymentSuccessMessage" type="text" value="شكراً لك! تم تفعيل حسابك بنجاح." onchange="savePaymentSettings()">  
              </div>  
            </div>  
          </div>  
            
          <!-- إدارة المستخدمين المدفوعين -->  
          <div style="margin-top:15px; padding:12px; background:#ecfdf5; border-radius:8px;">  
            <h5 style="margin:0 0 10px; font-size:14px; color:#065f46;">✅ تفعيل مستخدم يدوياً (بعد التحويل)</h5>  
            <div style="display:flex; gap:8px;">  
              <input id="activateUserPhone" type="text" placeholder="رقم الجوال أو المعرف" style="flex:1;">  
              <input id="activateUserUses" type="number" placeholder="عدد الاستخدامات" style="width:120px;" min="1" value="10">  
              <button class="primary small" onclick="activatePaidUser()">✅ تفعيل</button>  
            </div>  
            <div id="paidUsersList" style="margin-top:10px; max-height:150px; overflow-y:auto;"></div>  
          </div>  
        </div>  
      </div>  
        
      <!-- نظام الرقم السري للمنصة -->  
      <div style="margin-top:20px; padding:15px; background:linear-gradient(135deg, #fecaca, #fca5a5); border-radius:12px; border:2px solid #ef4444;">  
        <h4 style="margin:0 0 15px; font-size:16px; color:#991b1b;">🔐 نظام الرقم السري</h4>  
          
        <div style="margin-bottom:15px; padding:10px; background:#fff; border-radius:8px;">  
          <label style="display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:700;">  
            <input type="checkbox" id="platformPinEnabled" onchange="savePinSettings()">  
            <span>تفعيل الرقم السري للدخول للمنصة</span>  
          </label>  
          <small style="color:#6b7280;">إذا مفعل، سيطلب رقم سري قبل استخدام المنصة</small>  
        </div>  
          
        <div style="margin-bottom:15px; padding:10px; background:#fff; border-radius:8px;">  
          <label style="display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:700;">  
            <input type="checkbox" id="resultPinEnabled" onchange="savePinSettings()">  
            <span>تفعيل الرقم السري قبل عرض النتيجة</span>  
          </label>  
          <small style="color:#6b7280;">إذا مفعل، سيطلب رقم سري قبل عرض نتيجة الحسبة</small>  
        </div>  
          
        <div class="admin-grid">  
          <div>  
            <label>الرقم السري للمنصة</label>  
            <input id="platformPinCode" type="text" placeholder="أدخل الرقم السري" onchange="savePinSettings()">  
          </div>  
          <div>  
            <label>الرقم السري للنتيجة</label>  
            <input id="resultPinCode" type="text" placeholder="أدخل الرقم السري" onchange="savePinSettings()">  
          </div>  
        </div>  
      </div>  
        
      <!-- إعدادات الصفحة الرئيسية -->  
      <div style="margin-top:20px; padding:15px; background:#f0fdf4; border-radius:12px; border:1px solid #86efac;">  
        <h4 style="margin:0 0 10px; font-size:15px; color:#166534;">🏠 إعدادات الصفحة الرئيسية</h4>  
          
        <!-- وسام الأفضل في المملكة -->  
        <div style="margin-bottom:15px; padding:10px; background:#fff; border-radius:8px;">  
          <label style="display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:700; margin-bottom:10px;">  
            <input type="checkbox" id="settingsShowBestBadge" onchange="savePlatformSettingsFromUI()" checked>  
            <span>✨ عرض وسام "الأفضل في المملكة"</span>  
          </label>  
          <div class="admin-grid">  
            <div>  
              <label>نص الوسام</label>  
              <input id="settingsBestBadgeText" type="text" value="الأفضل في المملكة" onchange="savePlatformSettingsFromUI()">  
            </div>  
          </div>  
        </div>  
          
        <!-- المميزات (مقارنة البنوك، حساب دقيق، نتيجة فورية) -->  
        <div style="margin-bottom:15px; padding:10px; background:#fff; border-radius:8px;">  
          <label style="display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:700; margin-bottom:10px;">  
            <input type="checkbox" id="settingsShowFeatures" onchange="savePlatformSettingsFromUI()" checked>  
            <span>🎯 عرض المميزات (مقارنة البنوك، حساب دقيق، نتيجة فورية)</span>  
          </label>  
          <div class="admin-grid">  
            <div>  
              <label>نص الميزة 1</label>  
              <input id="settingsFeature1" type="text" value="مقارنة البنوك" onchange="savePlatformSettingsFromUI()">  
            </div>  
            <div>  
              <label>نص الميزة 2</label>  
              <input id="settingsFeature2" type="text" value="حساب دقيق" onchange="savePlatformSettingsFromUI()">  
            </div>  
            <div>  
              <label>نص الميزة 3</label>  
              <input id="settingsFeature3" type="text" value="نتيجة فورية" onchange="savePlatformSettingsFromUI()">  
            </div>  
          </div>  
        </div>  
          
        <!-- خلفية البطاقة الرئيسية -->  
        <div style="padding:10px; background:#fff; border-radius:8px;">  
          <h5 style="margin:0 0 10px; font-size:14px; color:#1f2937;">🎨 خلفية البطاقة الرئيسية</h5>  
          <div class="admin-grid">  
            <div>  
              <label>لون الخلفية (HEX)</label>  
              <input id="settingsCardBgColor" type="color" value="#ffffff" onchange="updateCardBackground()">  
            </div>  
            <div>  
              <label>الشفافية (0-100%)</label>  
              <input id="settingsCardOpacity" type="range" min="0" max="100" value="95" onchange="updateCardBackground()">  
              <span id="cardOpacityValue">95%</span>  
            </div>  
            <div>  
              <label>قوة التغبيش Blur (0-30px)</label>  
              <input id="settingsCardBlur" type="range" min="0" max="30" value="10" onchange="updateCardBackground()">  
              <span id="cardBlurValue">10px</span>  
            </div>  
            <div>  
              <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">  
                <input type="checkbox" id="settingsCardTransparent" onchange="updateCardBackground()">  
                <span>جعل الخلفية شفافة تماماً</span>  
              </label>  
            </div>  
          </div>  
        </div>  
      </div>  
        
      <!-- التحكم بالنصوص والبطاقات -->  
      <div style="margin-top:20px; padding:15px; background:linear-gradient(135deg, #e0e7ff, #c7d2fe); border-radius:12px; border:2px solid #6366f1;">  
        <h4 style="margin:0 0 15px; font-size:16px; color:#4338ca;">✍️ التحكم بالنصوص والبطاقات</h4>  
          
        <!-- لون النص الرئيسي -->  
        <div class="admin-grid" style="margin-bottom:15px;">  
          <div>  
            <label>لون النص الرئيسي</label>  
            <input id="settingsTextColor" type="color" value="#111827" onchange="updateTextStyles()">  
          </div>  
          <div>  
            <label>لون النص الثانوي</label>  
            <input id="settingsSecondaryTextColor" type="color" value="#6b7280" onchange="updateTextStyles()">  
          </div>  
          <div>  
            <label>نوع الخط</label>  
            <select id="settingsFontFamily" onchange="updateTextStyles()">  
              <option value="'Tajawal', sans-serif">تجوال (افتراضي)</option>  
              <option value="'Cairo', sans-serif">القاهرة</option>  
              <option value="'Almarai', sans-serif">المراعي</option>  
              <option value="'Noto Kufi Arabic', sans-serif">نوتو كوفي</option>  
              <option value="'Amiri', serif">أميري</option>  
            </select>  
          </div>  
          <div>  
            <label>حجم الخط الأساسي</label>  
            <input id="settingsFontSize" type="range" min="12" max="20" value="16" onchange="updateTextStyles()">  
            <span id="fontSizeValue">16px</span>  
          </div>  
        </div>  
          
        <!-- إخفاء البطاقات -->  
        <div style="margin-bottom:15px; padding:10px; background:#fff; border-radius:8px;">  
          <label style="display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:700;">  
            <input type="checkbox" id="settingsHideCards" onchange="toggleCardsVisibility()">  
            <span>إخفاء خلفيات البطاقات (لإظهار الخلفية بشكل كامل)</span>  
          </label>  
        </div>  
      </div>  
        
      <!-- إدارة عناصر صفحة النتيجة -->  
      <div style="margin-top:20px; padding:15px; background:linear-gradient(135deg, #fef3c7, #fde68a); border-radius:12px; border:2px solid #f59e0b;">  
        <h4 style="margin:0 0 15px; font-size:16px; color:#92400e;">📊 إدارة عناصر صفحة النتيجة</h4>  
        <p style="font-size:12px; color:#92400e; margin-bottom:15px;">يمكنك إخفاء أو إظهار أي عنصر في صفحة النتيجة</p>  
          
        <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:10px;">  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; background:#fff; border-radius:8px;">  
            <input type="checkbox" id="resultShowType" checked onchange="saveResultElementsSettings()">  
            <span>نوع التمويل</span>  
          </label>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; background:#fff; border-radius:8px;">  
            <input type="checkbox" id="resultShowBank" checked onchange="saveResultElementsSettings()">  
            <span>البنك المرشح</span>  
          </label>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; background:#fff; border-radius:8px;">  
            <input type="checkbox" id="resultShowAmount" checked onchange="saveResultElementsSettings()">  
            <span>مبلغ التمويل</span>  
          </label>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; background:#fff; border-radius:8px;">  
            <input type="checkbox" id="resultShowInstallment" checked onchange="saveResultElementsSettings()">  
            <span>القسط الشهري</span>  
          </label>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; background:#fff; border-radius:8px;">  
            <input type="checkbox" id="resultShowDuration" checked onchange="saveResultElementsSettings()">  
            <span>مدة التمويل</span>  
          </label>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; background:#fff; border-radius:8px;">  
            <input type="checkbox" id="resultShowRate" checked onchange="saveResultElementsSettings()">  
            <span>نسبة الربح</span>  
          </label>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; background:#fff; border-radius:8px;">  
            <input type="checkbox" id="resultShowProfit" checked onchange="saveResultElementsSettings()">  
            <span>إجمالي الأرباح</span>  
          </label>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; background:#fff; border-radius:8px;">  
            <input type="checkbox" id="resultShowTotal" checked onchange="saveResultElementsSettings()">  
            <span>إجمالي السداد</span>  
          </label>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; background:#fff; border-radius:8px;">  
            <input type="checkbox" id="resultShowEndDate" checked onchange="saveResultElementsSettings()">  
            <span>تاريخ الانتهاء</span>  
          </label>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; background:#fff; border-radius:8px;">  
            <input type="checkbox" id="resultShowRetirement" checked onchange="saveResultElementsSettings()">  
            <span>عمر التقاعد</span>  
          </label>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; background:#fff; border-radius:8px;">  
            <input type="checkbox" id="resultShowSalaryDetails" checked onchange="saveResultElementsSettings()">  
            <span>تفاصيل الراتب</span>  
          </label>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; background:#fff; border-radius:8px;">  
            <input type="checkbox" id="resultShowCommitments" checked onchange="saveResultElementsSettings()">  
            <span>الالتزامات</span>  
          </label>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px; background:#fff; border-radius:8px;">  
            <input type="checkbox" id="resultShowButtons" checked onchange="saveResultElementsSettings()">  
            <span>أزرار المشاركة</span>  
          </label>  
        </div>  
      </div>  
        
      <!-- تصاميم جاهزة للنتيجة -->  
      <div style="margin-top:20px; padding:15px; background:linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius:12px; border:2px solid #3b82f6;">  
        <h4 style="margin:0 0 15px; font-size:16px; color:#1e40af;">🎨 تصاميم جاهزة للمنصة</h4>  
        <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:10px;">  
          <button onclick="applyPresetTheme('classic')" style="padding:15px; background:#fff; border:2px solid #e5e7eb; border-radius:10px; cursor:pointer; text-align:center;">  
            <div style="font-size:24px;">💼</div>  
            <div style="font-weight:600; margin-top:5px;">كلاسيكي</div>  
            <div style="font-size:11px; color:#6b7280;">أبيض ورمادي</div>  
          </button>  
          <button onclick="applyPresetTheme('dark')" style="padding:15px; background:#1f2937; border:2px solid #374151; border-radius:10px; cursor:pointer; text-align:center; color:#fff;">  
            <div style="font-size:24px;">🌙</div>  
            <div style="font-weight:600; margin-top:5px;">داكن</div>  
            <div style="font-size:11px; color:#9ca3af;">أسود ورمادي</div>  
          </button>  
          <button onclick="applyPresetTheme('gold')" style="padding:15px; background:linear-gradient(135deg, #fef3c7, #fde68a); border:2px solid #f59e0b; border-radius:10px; cursor:pointer; text-align:center;">  
            <div style="font-size:24px;">🌟</div>  
            <div style="font-weight:600; margin-top:5px;">ذهبي</div>  
            <div style="font-size:11px; color:#92400e;">فاخر وأنيق</div>  
          </button>  
          <button onclick="applyPresetTheme('green')" style="padding:15px; background:linear-gradient(135deg, #d1fae5, #a7f3d0); border:2px solid #10b981; border-radius:10px; cursor:pointer; text-align:center;">  
            <div style="font-size:24px;">🌿</div>  
            <div style="font-weight:600; margin-top:5px;">أخضر</div>  
            <div style="font-size:11px; color:#065f46;">طبيعي ومريح</div>  
          </button>  
          <button onclick="applyPresetTheme('blue')" style="padding:15px; background:linear-gradient(135deg, #dbeafe, #bfdbfe); border:2px solid #3b82f6; border-radius:10px; cursor:pointer; text-align:center;">  
            <div style="font-size:24px;">💠</div>  
            <div style="font-weight:600; margin-top:5px;">أزرق</div>  
            <div style="font-size:11px; color:#1e40af;">مهني ورسمي</div>  
          </button>  
          <button onclick="applyPresetTheme('transparent')" style="padding:15px; background:rgba(255,255,255,0.3); border:2px dashed #9ca3af; border-radius:10px; cursor:pointer; text-align:center;">  
            <div style="font-size:24px;">🕳️</div>  
            <div style="font-weight:600; margin-top:5px;">شفاف</div>  
            <div style="font-size:11px; color:#6b7280;">لإظهار الخلفية</div>  
          </button>  
        </div>  
      </div>  
        
      <!-- زر الحفظ الرئيسي -->  
      <div id="saveSettingsContainer" style="position:sticky; bottom:0; background:linear-gradient(135deg, #28a745, #20c997); padding:15px; border-radius:15px; margin-top:20px; box-shadow:0 -5px 20px rgba(40,167,69,0.3);">  
        <button id="mainSaveBtn" class="primary" onclick="savePlatformSettingsFromUI()" style="width:100%; padding:15px 30px; font-size:18px; font-weight:bold; background:#fff; color:#28a745; border:none; border-radius:10px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition:all 0.3s;">  
          <span style="font-size:24px;">💾</span>  
          <span>حفظ جميع الإعدادات</span>  
        </button>  
        <p style="text-align:center; color:#fff; margin-top:8px; font-size:12px;">⚠️ تأكد من الحفظ قبل الخروج لتطبيق التغييرات</p>  
      </div>  
        
      <div style="margin-top:15px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">  
        <button class="primary" onclick="executeAllAdminChanges()" style="padding:12px 30px; font-size:16px;">✅ تنفيذ التغييرات</button>
        <button class="secondary" onclick="showPage('adminHub')" style="padding:12px 30px;">🔙 رجوع للوحة التحكم</button>  
      </div>  
    </div>  
  </div>  
  
</div>  
  
<footer>  
  <div class="footer-inner">  
    <div>  
      جميع الحقوق محفوظة -  سرعة تملك العقار والحلول التمويلية -  
      <span id="datetime"></span>  
      <span class="hijri-chip">هجري: <span id="datetimeHijri"></span></span>  
    </div>  
  
    <!-- ▫️ أدوات المسؤول تحت الفوتر -->  
    <div id="miniAdminTools" title="أدوات المسؤول" onclick="openMiniAdminTools()">  
      ⚙️  
    </div>  
  </div>  
</footer>  
  
<!-- مكتبة حفظ النتيجة كصورة -->  
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>  
  
<!-- نافذة التحقق لأدوات المسؤول (▫️) -->  
<div id="miniAdminAuthModal" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); z-index:9999; padding:18px;">  
  <div style="max-width:700px; margin:70px auto; background:#fff; border-radius:18px; padding:14px; text-align:right; box-shadow:0 18px 40px rgba(0,0,0,.25);">  
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">  
      <div style="font-weight:900; color:#111827;">▫️ أدوات المسؤول</div>  
      <button class="secondary small" onclick="closeMiniAdminAuth()">إغلاق</button>  
    </div>  
  
    <div class="alert-error" style="margin-top:10px;">  
      ⚠️ تحذير: هذا القسم خاص بالمسؤولين فقط. أي استخدام غير مصرح به قد يعرّضك للمساءلة.  
    </div>  
  
    <label>رمز دخول المسؤول</label>  
    <input id="miniAdminPin" type="password" placeholder="أدخل رمز المسؤول" />  
  
    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">  
      <button class="primary small" onclick="verifyMiniAdminPin()">تأكيد</button>  
      <button class="secondary small" onclick="closeMiniAdminAuth()">إلغاء</button>  
    </div>  
  
    <div id="miniAdminPinError" class="alert-error" style="display:none; margin-top:8px;">  
      الرمز غير صحيح.  
    </div>  
  </div>  
</div>  
  
<!-- نافذة خيارات المسؤول بعد التحقق -->  
<div id="miniAdminActionsModal" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); z-index:9999; padding:18px;">  
  <div style="max-width:820px; margin:70px auto; background:#fff; border-radius:18px; padding:14px; text-align:right; box-shadow:0 18px 40px rgba(0,0,0,.25);">  
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">  
      <div style="font-weight:900; color:#111827;">▫️ خيارات المسؤول</div>  
      <button class="secondary small" onclick="closeMiniAdminActions()">إغلاق</button>  
    </div>  
  
    <p style="font-size:13px; color:#6b7280; margin:10px 0 0;">  
      اختر:  
    </p>  
  
    <div style="margin-top:10px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">  
      <button class="primary small" onclick="openClientResultModal(true)">نتيجة للعميل</button>  
      <button class="secondary small" onclick="openArchiveSaveModal()">حفظ النتيجة بالأرشيف</button>  
      <button class="secondary small" onclick="openAdminLoginFromMiniTools()">دخول المشرف</button>  
    </div>  
  
    <div style="margin-top:10px; font-size:12px; color:#6b7280;">  
      * “نتيجة للعميل” = نفس النتيجة المختصرة + التحذيرات + رقم التواصل. ويمكن حفظها كصورة.  
    </div>  
  </div>  
</div>  
  
<!-- نافذة حفظ بالأرشيف -->  
<div id="archiveSaveModal" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); z-index:9999; padding:18px;">  
  <div style="max-width:820px; margin:70px auto; background:#fff; border-radius:18px; padding:14px; text-align:right; box-shadow:0 18px 40px rgba(0,0,0,.25);">  
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">  
      <div style="font-weight:900; color:#111827;">🗂️ حفظ النتيجة بالأرشيف</div>  
      <button class="secondary small" onclick="closeArchiveSaveModal()">إغلاق</button>  
    </div>  
  
    <div class="alert-error" style="margin-top:10px;">  
      ⚠️ تنبيه: سيتم حفظ النتيجة داخل الجهاز (LocalStorage) — مسؤولية حفظ البيانات تقع على المستخدم.  
    </div>  
  
    <label>رقم جوال العميل أو السجل المدني (إلزامي)</label>  
    <input id="archiveKeyInput" type="text" placeholder="مثال: 05xxxxxxxx أو 1xxxxxxxxx" />  
  
    <div style="margin-top:10px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">  
      <button class="primary small" onclick="saveCurrentResultToArchive()">حفظ</button>  
      <button class="secondary small" onclick="closeArchiveSaveModal()">إلغاء</button>  
    </div>  
  
    <div id="archiveSaveMsg" style="display:none; margin-top:10px; font-size:13px; color:#0f766e; font-weight:900;"></div>  
  </div>  
</div>  
  
<!-- نافذة النتيجة للعميل (بعد تحقق المسؤول) -->  
<div id="clientResultModal" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); z-index:9999; padding:18px;">  
  <div style="max-width:900px; margin:40px auto; background:#fff; border-radius:18px; padding:14px; text-align:right; box-shadow:0 18px 40px rgba(0,0,0,.25);">  
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">  
      <div style="font-weight:900; color:#111827;">📄 النتيجة للعميل (مختصرة)</div>  
      <button class="secondary small" onclick="closeClientResultModal()">إغلاق</button>  
    </div>  
  
    <div style="margin-top:10px; font-size:13px; color:#6b7280;">  
      * الحقول التالية اختيارية — إذا تركتها فاضية سيتم اعتماد “النتيجة الحقيقة” من الحاسبة.  
    </div>  
  
    <div class="admin-grid" style="margin-top:10px;">  
      <div>  
        <label>التمويل الصافي (اختياري)</label>  
        <input id="clientNetOverride" type="number" min="0" placeholder="مثال: 450000">  
      </div>  
      <div>  
        <label>القسط الشهري (اختياري)</label>  
        <input id="clientInstOverride" type="number" min="0" placeholder="مثال: 3200">  
      </div>  
      <div style="grid-column:1/-1;">  
        <label>ملاحظة (اختيارية)</label>  
        <input id="clientNoteOverride" type="text" placeholder="اكتب ملاحظة تظهر للعميل (اختياري)">  
      </div>  
    </div>  
  
    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">  
      <button class="primary small" onclick="generateClientResultText()">إنشاء النتيجة المختصرة</button>  
      <button class="secondary small" onclick="copyClientResultText()">📋 نسخ</button>  
      <button class="secondary small" onclick="shareClientResultOnWhatsApp()">📲 مشاركة واتساب</button>  
      <button class="secondary small" onclick="saveClientResultAsImage()">🖼️ حفظ كصورة</button>  
    </div>  
  
    <div style="margin-top:10px;">  
      <label>النص الجاهز للإرسال</label>  
      <textarea id="clientResultText" style="width:100%; min-height:180px; padding:10px; font-size:14px; border-radius:12px; border:1px solid #e5e7eb; background:#f9fafb; direction:rtl;"></textarea>  
    </div>  
  
    <div style="margin-top:10px;">  
      <label>معاينة (للصورة)</label>  
      <div id="clientPreviewCard" class="client-preview">  
        <div class="h">نتيجة الحسبة (التقريبية)</div>  
        <div style="color:#6b7280; font-size:12px;">قم بإنشاء النتيجة المختصرة أولاً لتظهر المعاينة هنا.</div>  
      </div>  
    </div>  
  </div>  
</div>  
  
<!-- نافذة البحث عن العروض الخاصة -->  
<div id="offersSearchModal" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,.7); z-index:10000; padding:18px; overflow-y:auto;">  
  <div style="max-width:600px; margin:50px auto; background:linear-gradient(135deg, #fff 0%, #f8fafc 100%); border-radius:20px; padding:20px; box-shadow:0 25px 50px rgba(0,0,0,.25);">  
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">  
      <div style="font-weight:900; font-size:18px; color:#111827;">🎁 العروض الخاصة لقطاعك</div>  
      <button onclick="closeOffersSearchModal()" style="background:#ef4444; color:#fff; border:none; border-radius:50%; width:32px; height:32px; cursor:pointer; font-size:16px;">✕</button>  
    </div>  
      
    <div style="background:#fef3c7; border:1px solid #fbbf24; border-radius:12px; padding:12px; margin-bottom:15px;">  
      <p style="margin:0; font-size:13px; color:#92400e;">  
        💡 <strong>ابحث عن عروض خاصة لجهة عملك!</strong><br>  
        بعض جهات التمويل تقدم نسب أرباح مخفضة لموظفي بعض القطاعات.  
      </p>  
    </div>  
      
    <div style="margin-bottom:15px;">  
      <label style="font-weight:600; color:#374151; display:block; margin-bottom:8px;">اختر جهة عملك:</label>  
      <select id="searchOfferEmployer" style="width:100%; padding:12px; border:2px solid #e5e7eb; border-radius:10px; font-size:15px;" onchange="searchOffersForEmployer()">  
        <option value="">اختر جهة العمل...</option>  
        <option value="أرامكو">🛢️ أرامكو</option>  
        <option value="سابك">🏭 سابك</option>  
        <option value="ستك">📞 ستك</option>  
        <option value="الاتصالات السعودية">📱 الاتصالات السعودية</option>  
        <option value="موبايلي">📲 موبايلي</option>  
        <option value="زين">📶 زين</option>  
        <option value="الكهرباء السعودية">⚡ الكهرباء السعودية</option>  
        <option value="الخطوط السعودية">✈️ الخطوط السعودية</option>  
        <option value="وزارة الصحة">🏥 وزارة الصحة</option>  
        <option value="وزارة التعليم">🏫 وزارة التعليم</option>  
        <option value="وزارة الدفاع">🎖️ وزارة الدفاع</option>  
        <option value="وزارة الداخلية">🚨 وزارة الداخلية</option>  
        <option value="الحرس الوطني">🛡️ الحرس الوطني</option>  
        <option value="الأمن العام">👮 الأمن العام</option>  
        <option value="الجوازات">🛂 الجوازات</option>  
        <option value="الدفاع المدني">🚒 الدفاع المدني</option>  
      </select>  
    </div>  
      
    <div id="offersSearchResults" style="min-height:100px;">  
      <div style="text-align:center; color:#9ca3af; padding:30px;">  
        <div style="font-size:40px; margin-bottom:10px;">🔍</div>  
        <p>اختر جهة عملك لعرض العروض المتاحة</p>  
      </div>  
    </div>  
      
    <div style="margin-top:15px; text-align:center;">  
      <button onclick="closeOffersSearchModal()" style="background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color:#fff; border:none; border-radius:10px; padding:12px 30px; font-size:15px; cursor:pointer;">  
        متابعة الحساب  
      </button>  
    </div>  
  </div>  
</div>  
  
<!-- صفحة تخصيص النتيجة -->  
<div id="adminResultSettingsPage" class="page">  
  <div class="card fade-in">  
    <h2 style="margin-top:0; font-size:19px; color:#111827;">📊 تخصيص عناصر النتيجة</h2>  
    <p style="font-size:13px; color:#6b7280; text-align:right;">  
      تحكم بما يظهر للعميل في صفحة النتيجة - إخفاء/إظهار كل عنصر  
    </p>  
      
    <div style="margin-top:15px; padding:15px; background:#f0fdf4; border-radius:12px; border:1px solid #86efac;">  
      <h4 style="margin:0 0 10px; font-size:15px; color:#166534;">✅ عناصر النتيجة الأساسية</h4>  
      <div class="admin-grid">  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultShowNetAmount" checked onchange="saveResultSettings()">  
            <span>عرض المبلغ الصافي</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultShowInstallment" checked onchange="saveResultSettings()">  
            <span>عرض القسط الشهري</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultShowDuration" checked onchange="saveResultSettings()">  
            <span>عرض مدة التمويل</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultShowBank" checked onchange="saveResultSettings()">  
            <span>عرض البنك المقترح</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultShowProfit" checked onchange="saveResultSettings()">  
            <span>عرض نسبة الربح</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="settingsShowEndDate" onchange="savePlatformSettingsFromUI()" checked>  
            <span>عرض تاريخ انتهاء التمويل</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="settingsShowBestBadge" onchange="savePlatformSettingsFromUI()" checked>  
            <span>عرض وسام الأفضل</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="settingsShowFeatures" onchange="savePlatformSettingsFromUI()" checked>  
            <span>عرض المميزات (مقارنة البنوك...)</span>  
          </label>  
        </div>  
      </div>  
        
      <div class="admin-grid" style="margin-top:15px;">  
        <div>  
          <label>نص وسام الأفضل</label>  
          <input id="settingsBestBadgeText" type="text" value="الأفضل في المملكة" oninput="savePlatformSettingsFromUI()">  
        </div>  
        <div>  
          <label>لون خلفية البطاقة (RGBA)</label>  
          <input id="settingsCardBgColor" type="text" value="rgba(255, 255, 255, 0.85)" oninput="savePlatformSettingsFromUI()">  
        </div>  
        <div>  
          <label>قوة التغبيش (Blur px)</label>  
          <input id="settingsCardBlur" type="number" value="20" oninput="savePlatformSettingsFromUI()">  
        </div>  
      </div>  
    </div>  
      
    <div style="margin-top:15px; padding:15px; background:#fef3c7; border-radius:12px; border:1px solid #fcd34d;">  
      <h4 style="margin:0 0 10px; font-size:15px; color:#92400e;">📅 إعدادات تاريخ انتهاء التمويل</h4>  
      <div class="admin-grid">  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultShowEndDateHijri" checked onchange="saveResultSettings()">  
            <span>عرض التاريخ الهجري</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultShowEndDateGregorian" checked onchange="saveResultSettings()">  
            <span>عرض التاريخ الميلادي</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultShowEndMessage" checked onchange="saveResultSettings()">  
            <span>عرض رسالة انتهاء التمويل</span>  
          </label>  
        </div>  
      </div>  
    </div>  
      
    <div style="margin-top:15px; padding:15px; background:#eff6ff; border-radius:12px; border:1px solid #bfdbfe;">  
      <h4 style="margin:0 0 10px; font-size:15px; color:#1d4ed8;">📝 عناصر إضافية</h4>  
      <div class="admin-grid">  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultShowRetirement" checked onchange="saveResultSettings()">  
            <span>عرض راتب التقاعد (للعسكريين)</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultShowPeriods" checked onchange="saveResultSettings()">  
            <span>عرض الفترات التفصيلية</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultShowBankNote" checked onchange="saveResultSettings()">  
            <span>عرض ملاحظات البنك</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultShowAds" checked onchange="saveResultSettings()">  
            <span>عرض الإعلانات المستهدفة</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultShowCustomLink" checked onchange="saveResultSettings()">  
            <span>عرض الرابط المخصص</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultShowRating" checked onchange="saveResultSettings()">  
            <span>عرض التقييم</span>  
          </label>  
        </div>  
      </div>  
    </div>  
      
    <div style="margin-top:15px; padding:15px; background:#fef2f2; border-radius:12px; border:1px solid #fecaca;">  
      <h4 style="margin:0 0 10px; font-size:15px; color:#dc2626;">🔗 الرابط المخصص في النتيجة</h4>  
      <div class="admin-grid">  
        <div>  
          <label>نص الرابط</label>  
          <input id="resultCustomLinkText" type="text" placeholder="مثال: اضغط هنا للتواصل" onchange="saveResultSettings()">  
        </div>  
        <div>  
          <label>رابط URL</label>  
          <input id="resultCustomLinkUrl" type="text" placeholder="https://example.com" onchange="saveResultSettings()">  
        </div>  
      </div>  
    </div>  
      
    <!-- طريقة عرض النتيجة -->  
    <div style="margin-top:15px; padding:15px; background:#f0f9ff; border-radius:12px; border:1px solid #7dd3fc;">  
      <h4 style="margin:0 0 10px; font-size:15px; color:#0369a1;">🎬 طريقة عرض النتيجة</h4>  
      <div class="admin-grid">  
        <div>  
          <label>نمط العرض</label>  
          <select id="resultDisplayMode" onchange="saveResultSettings()" style="width:100%; padding:10px; border-radius:8px; border:1px solid #d1d5db;">  
            <option value="static">ثابت (افتراضي)</option>  
            <option value="animated">متحرك (أنيميشن)</option>  
            <option value="slide">انزلاقي</option>  
            <option value="fade">تلاشي</option>  
          </select>  
        </div>  
        <div>  
          <label>سرعة العرض (بالثواني)</label>  
          <input id="resultDisplaySpeed" type="number" min="0.5" max="5" step="0.5" value="1" onchange="saveResultSettings()">  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultShowConfetti" onchange="saveResultSettings()">  
            <span>عرض احتفال (كونفيتي) عند النتيجة</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultPlaySound" onchange="saveResultSettings()">  
            <span>تشغيل صوت عند النتيجة</span>  
          </label>  
        </div>  
      </div>  
    </div>  
      
    <!-- إعدادات معادلة التقاعد -->  
    <div style="margin-top:15px; padding:15px; background:#fdf4ff; border-radius:12px; border:1px solid #e879f9;">  
      <h4 style="margin:0 0 10px; font-size:15px; color:#a21caf;">📊 إعدادات معادلة التقاعد</h4>  
      <div class="admin-grid">  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultShowRetirementFormula" checked onchange="saveResultSettings()">  
            <span>عرض معادلة حساب التقاعد للمسؤول</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultShowRetirementToClient" onchange="saveResultSettings()">  
            <span>عرض راتب التقاعد للعميل</span>  
          </label>  
        </div>  
        <div>  
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">  
            <input type="checkbox" id="resultHideRetirementCalc" onchange="saveResultSettings()">  
            <span>إخفاء حسابات التقاعد بالكامل</span>  
          </label>  
        </div>  
      </div>  
    </div>  
      
    <!-- تخصيص ألوان صفحة النتيجة -->  
    <div style="margin-top:15px; padding:15px; background:linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); border-radius:12px; border:1px solid #f9a8d4;">  
      <h4 style="margin:0 0 10px; font-size:15px; color:#be185d;">🎨 ألوان صفحة النتيجة</h4>  
      <div class="admin-grid">  
        <div>  
          <label>لون خلفية الصفحة</label>  
          <input type="color" id="resultBgColor" value="#f0f9ff" onchange="saveResultSettings()" style="width:100%; height:40px; border-radius:8px; border:1px solid #d1d5db; cursor:pointer;">  
        </div>  
        <div>  
          <label>لون خلفية البطاقة</label>  
          <input type="color" id="resultCardBgColor" value="#ffffff" onchange="saveResultSettings()" style="width:100%; height:40px; border-radius:8px; border:1px solid #d1d5db; cursor:pointer;">  
        </div>  
        <div>  
          <label>لون النص الرئيسي</label>  
          <input type="color" id="resultTextColor" value="#111827" onchange="saveResultSettings()" style="width:100%; height:40px; border-radius:8px; border:1px solid #d1d5db; cursor:pointer;">  
        </div>  
        <div>  
          <label>لون الأرقام والمبالغ</label>  
          <input type="color" id="resultNumberColor" value="#3b82f6" onchange="saveResultSettings()" style="width:100%; height:40px; border-radius:8px; border:1px solid #d1d5db; cursor:pointer;">  
        </div>  
        <div>  
          <label>لون العناوين</label>  
          <input type="color" id="resultTitleColor" value="#1e40af" onchange="saveResultSettings()" style="width:100%; height:40px; border-radius:8px; border:1px solid #d1d5db; cursor:pointer;">  
        </div>  
        <div>  
          <label>لون الحدود</label>  
          <input type="color" id="resultBorderColor" value="#bfdbfe" onchange="saveResultSettings()" style="width:100%; height:40px; border-radius:8px; border:1px solid #d1d5db; cursor:pointer;">  
        </div>  
      </div>  
    </div>  
      
    <!-- تخصيص خطوط صفحة النتيجة -->  
    <div style="margin-top:15px; padding:15px; background:linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius:12px; border:1px solid #93c5fd;">  
      <h4 style="margin:0 0 10px; font-size:15px; color:#1e40af;">✒️ خطوط صفحة النتيجة</h4>  
      <div class="admin-grid">  
        <div>  
          <label>خط العناوين</label>  
          <select id="resultTitleFont" onchange="saveResultSettings()" style="width:100%; padding:10px; border-radius:8px; border:1px solid #d1d5db;">  
            <option value="Tajawal">تجوال</option>  
            <option value="Cairo">القاهرة</option>  
            <option value="Almarai">المراعي</option>  
            <option value="Changa">شانجا</option>  
            <option value="El Messiri">المسيري</option>  
          </select>  
        </div>  
        <div>  
          <label>خط الأرقام</label>  
          <select id="resultNumberFont" onchange="saveResultSettings()" style="width:100%; padding:10px; border-radius:8px; border:1px solid #d1d5db;">  
            <option value="Tajawal">تجوال</option>  
            <option value="Cairo">القاهرة</option>  
            <option value="Almarai">المراعي</option>  
            <option value="Changa">شانجا</option>  
            <option value="El Messiri">المسيري</option>  
          </select>  
        </div>  
        <div>  
          <label>حجم خط العناوين</label>  
          <input type="range" id="resultTitleSize" min="14" max="28" value="18" onchange="saveResultSettings(); document.getElementById('resultTitleSizeValue').textContent = this.value + 'px';" style="width:100%;">  
          <span id="resultTitleSizeValue" style="font-size:12px; color:#6b7280;">18px</span>  
        </div>  
        <div>  
          <label>حجم خط الأرقام</label>  
          <input type="range" id="resultNumberSize" min="20" max="40" value="28" onchange="saveResultSettings(); document.getElementById('resultNumberSizeValue').textContent = this.value + 'px';" style="width:100%;">  
          <span id="resultNumberSizeValue" style="font-size:12px; color:#6b7280;">28px</span>  
        </div>  
      </div>  
    </div>  
      
    <!-- تخصيص شكل البطاقة -->  
    <div style="margin-top:15px; padding:15px; background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-radius:12px; border:1px solid #6ee7b7;">  
      <h4 style="margin:0 0 10px; font-size:15px; color:#047857;">📝 تخصيص شكل البطاقة</h4>  
      <div class="admin-grid">  
        <div>  
          <label>استدارة الزوايا</label>  
          <input type="range" id="resultCardRadius" min="0" max="30" value="16" onchange="saveResultSettings(); document.getElementById('resultCardRadiusValue').textContent = this.value + 'px';" style="width:100%;">  
          <span id="resultCardRadiusValue" style="font-size:12px; color:#6b7280;">16px</span>  
        </div>  
        <div>  
          <label>ظل البطاقة</label>  
          <select id="resultCardShadow" onchange="saveResultSettings()" style="width:100%; padding:10px; border-radius:8px; border:1px solid #d1d5db;">  
            <option value="none">بدون ظل</option>  
            <option value="soft" selected>ظل خفيف</option>  
            <option value="medium">ظل متوسط</option>  
            <option value="strong">ظل قوي</option>  
          </select>  
        </div>  
        <div>  
          <label>عرض الحدود</label>  
          <input type="range" id="resultCardBorder" min="0" max="5" value="1" onchange="saveResultSettings(); document.getElementById('resultCardBorderValue').textContent = this.value + 'px';" style="width:100%;">  
          <span id="resultCardBorderValue" style="font-size:12px; color:#6b7280;">1px</span>  
        </div>  
        <div>  
          <label>المسافة الداخلية</label>  
          <input type="range" id="resultCardPadding" min="10" max="40" value="20" onchange="saveResultSettings(); document.getElementById('resultCardPaddingValue').textContent = this.value + 'px';" style="width:100%;">  
          <span id="resultCardPaddingValue" style="font-size:12px; color:#6b7280;">20px</span>  
        </div>  
      </div>  
    </div>  
      
    <div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end;">  
      <button class="primary" onclick="saveResultSettings()">💾 حفظ الإعدادات</button>  
      <button class="secondary" onclick="resetResultDesign()">🔄 إعادة تعيين</button>  
      <button class="secondary" onclick="showPage('adminHub')">🔙 رجوع</button>  
    </div>  
  </div>  
</div>  
  
<!-- صفحة صيغ النتيجة -->  
<div id="adminResultTextsPage" class="page">  
  <div class="card fade-in">  
    <h2 style="margin-top:0; font-size:19px; color:#111827;">✏️ صيغ ونصوص النتيجة</h2>  
    <p style="font-size:13px; color:#6b7280; text-align:right;">  
      تعديل النصوص والصيغ التي تظهر للعميل في صفحة النتيجة  
    </p>  
      
    <div style="margin-top:15px; padding:15px; background:#f0fdf4; border-radius:12px; border:1px solid #86efac;">  
      <h4 style="margin:0 0 10px; font-size:15px; color:#166534;">💰 صيغ المبالغ</h4>  
      <div class="admin-grid">  
        <div>  
          <label>عنوان المبلغ الصافي</label>  
          <input id="resultTextNetAmount" type="text" value="المبلغ الصافي" onchange="saveResultTexts()">  
        </div>  
        <div>  
          <label>عنوان القسط الشهري</label>  
          <input id="resultTextInstallment" type="text" value="القسط الشهري" onchange="saveResultTexts()">  
        </div>  
        <div>  
          <label>عنوان مدة التمويل</label>  
          <input id="resultTextDuration" type="text" value="مدة التمويل" onchange="saveResultTexts()">  
        </div>  
        <div>  
          <label>عنوان البنك المقترح</label>  
          <input id="resultTextBank" type="text" value="البنك المقترح" onchange="saveResultTexts()">  
        </div>  
      </div>  
    </div>  
      
    <div style="margin-top:15px; padding:15px; background:#fef3c7; border-radius:12px; border:1px solid #fcd34d;">  
      <h4 style="margin:0 0 10px; font-size:15px; color:#92400e;">📅 صيغ التواريخ</h4>  
      <div class="admin-grid">  
        <div>  
          <label>عنوان تاريخ انتهاء التمويل</label>  
          <input id="resultTextEndDate" type="text" value="تاريخ انتهاء التمويل" onchange="saveResultTexts()">  
        </div>  
        <div>  
          <label>رسالة انتهاء التمويل (استخدم {year} للسنة)</label>  
          <input id="resultTextEndMessage" type="text" value="ينتهي سنة {year}... الله يطول بعمرنا ويبارك لنا" onchange="saveResultTexts()">  
        </div>  
      </div>  
    </div>  
      
    <div style="margin-top:15px; padding:15px; background:#eff6ff; border-radius:12px; border:1px solid #bfdbfe;">  
      <h4 style="margin:0 0 10px; font-size:15px; color:#1d4ed8;">💬 رسائل مخصصة</h4>  
      <div class="admin-grid">  
        <div>  
          <label>رسالة العجز (عندما لا يكفي الراتب)</label>  
          <input id="resultTextDeficit" type="text" value="للأسف الراتب لا يكفي للتمويل المطلوب" onchange="saveResultTexts()">  
        </div>  
        <div>  
          <label>رسالة التقاعد (للعسكريين)</label>  
          <input id="resultTextRetirement" type="text" value="راتب التقاعد المتوقع" onchange="saveResultTexts()">  
        </div>  
        <div style="grid-column:1/-1;">  
          <label>رسالة التنبيه (تظهر أسفل النتيجة)</label>  
          <input id="resultTextDisclaimer" type="text" value="هذه حسبة تقريبية وليست عرض رسمي" onchange="saveResultTexts()">  
        </div>  
      </div>  
    </div>  
      
    <div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end;">  
      <button class="primary" onclick="saveResultTexts()">💾 حفظ الصيغ</button>  
      <button class="secondary" onclick="showPage('adminHub')">🔙 رجوع</button>  
    </div>  
  </div>  
</div>  
  
<script>  
  // ====== إدارة جهات الوظيفة - تعريف مبكر ======  
  window.EMPLOYERS_LIST_KEY = 'fino_employers_list';  
  window.defaultEmployers = [  
    { name: 'أرامكو', icon: '🛢️' },  
    { name: 'سابك', icon: '🏭' },  
    { name: 'ستك', icon: '📞' },  
    { name: 'الاتصالات السعودية', icon: '📱' },  
    { name: 'موبايلي', icon: '📲' },  
    { name: 'زين', icon: '📶' },  
    { name: 'الكهرباء السعودية', icon: '⚡' },  
    { name: 'الخطوط السعودية', icon: '✈️' },  
    { name: 'وزارة الصحة', icon: '🏥' },  
    { name: 'وزارة التعليم', icon: '🏫' },  
    { name: 'وزارة الدفاع', icon: '🏛️' },  
    { name: 'وزارة الداخلية', icon: '🚨' },  
    { name: 'الحرس الوطني', icon: '🛡️' },  
    { name: 'الأمن العام', icon: '👮' },  
    { name: 'الجوازات', icon: '🛂' },  
    { name: 'الدفاع المدني', icon: '🚒' },  
    { name: 'الصحة القابضة', icon: '🏥' },  
    { name: 'وزارة العدل', icon: '⚖️' },  
    { name: 'وزارة المالية', icon: '💰' },  
    { name: 'وزارة الإسكان', icon: '🏠' }  
  ];  
    
  window.getEmployersList = function() {  
    try {  
      const saved = localStorage.getItem(window.EMPLOYERS_LIST_KEY);  
      return saved ? JSON.parse(saved) : [...window.defaultEmployers];  
    } catch (e) {  
      return [...window.defaultEmployers];  
    }  
  };  
    
  window.loadEmployersList = function() {  
    const container = document.getElementById('employersList');  
    if (!container) return;  
      
    const employers = window.getEmployersList();  
    container.innerHTML = '';  
      
    employers.forEach((emp, index) => {  
      const div = document.createElement('div');  
      div.style.cssText = 'display:flex; align-items:center; gap:10px; padding:12px; background:#f8fafc; border-radius:8px; margin-bottom:8px;';  
      div.innerHTML = `  
        <span style="font-size:24px;">${emp.icon}</span>  
        <input type="text" value="${emp.name}" onchange="window.updateEmployerName(${index}, this.value)" style="flex:1; padding:8px; border:1px solid #e2e8f0; border-radius:6px;">  
        <input type="text" value="${emp.icon}" onchange="window.updateEmployerIcon(${index}, this.value)" style="width:60px; padding:8px; border:1px solid #e2e8f0; border-radius:6px; text-align:center;">  
        <button onclick="window.deleteEmployer(${index})" style="background:#ef4444; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">🗑️</button>  
      `;  
      container.appendChild(div);  
    });  
  };  
  
  // --- إدارة أنواع الوظائف (Job Types) ---  
  window.JOB_TYPES_KEY = 'fino_job_types_list';  
  window.defaultJobTypes = ['حكومي', 'عسكري', 'قطاع خاص', 'متقاعد'];  
  
  window.getJobTypes = function() {  
    try {  
      const saved = localStorage.getItem(window.JOB_TYPES_KEY);  
      return saved ? JSON.parse(saved) : [...window.defaultJobTypes];  
    } catch (e) {  
      return [...window.defaultJobTypes];  
    }  
  };  
  
  window.loadJobTypesList = function() {  
    const container = document.getElementById('jobTypesList');  
    if (!container) return;  
      
    const list = window.getJobTypes();  
    container.innerHTML = '';  
      
    list.forEach((type, index) => {  
      const div = document.createElement('div');  
      div.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:12px; background:#f8fafc; border-radius:8px; margin-bottom:8px; border:1px solid #e2e8f0;';  
      div.innerHTML = `  
        <span style="font-weight:600; color:#1e293b;">${type}</span>  
        <button onclick="window.deleteJobType(${index})" style="background:#fee2e2; color:#ef4444; border:none; padding:8px 15px; border-radius:6px; cursor:pointer; font-size:12px; font-weight:bold;">🗑️ حذف</button>  
      `;  
      container.appendChild(div);  
    });  
  };  
  
  window.addNewJobType = function() {  
    const nameInput = document.getElementById('newJobTypeName');  
    const name = nameInput?.value?.trim();  
    if (!name) { alert('يرجى إدخال اسم نوع الوظيفة'); return; }  
      
    const list = window.getJobTypes();  
    if (list.includes(name)) { alert('هذا النوع موجود مسبقاً'); return; }  
      
    list.push(name);  
    localStorage.setItem(window.JOB_TYPES_KEY, JSON.stringify(list));  
    nameInput.value = '';  
    window.loadJobTypesList();  
  };  
  
  window.deleteJobType = function(index) {  
    if (!confirm('هل أنت متأكد من حذف نوع الوظيفة هذا؟')) return;  
    const list = window.getJobTypes();  
    list.splice(index, 1);  
    localStorage.setItem(window.JOB_TYPES_KEY, JSON.stringify(list));  
    window.loadJobTypesList();  
  };  
  
  window.saveJobTypesList = function() {  
    alert('تم حفظ التغييرات بنجاح');  
  };  
  
  window.resetJobTypesList = function() {  
    if (!confirm('هل أنت متأكد من إعادة تعيين أنواع الوظائف للافتراضي؟')) return;  
    localStorage.removeItem(window.JOB_TYPES_KEY);  
    window.loadJobTypesList();  
  };  
  
  // تحديث دالة الحصول على خيارات نوع الوظيفة لتكون ديناميكية  
  window.getJobTypeOptions = function() {  
    return window.getJobTypes();  
  };  
    
  window.addNewEmployer = function() {  
    const nameInput = document.getElementById('newEmployerName');  
    const iconInput = document.getElementById('newEmployerIcon');  
    const name = nameInput?.value?.trim();  
    const icon = iconInput?.value?.trim() || '🏢';  
      
    if (!name) {  
      if (typeof showToast === 'function') showToast('أدخل اسم الجهة', 'error');  
      return;  
    }  
      
    const employers = window.getEmployersList();  
    if (employers.find(e => e.name === name)) {  
      if (typeof showToast === 'function') showToast('هذه الجهة موجودة بالفعل', 'error');  
      return;  
    }  
      
    employers.push({ name, icon });  
    localStorage.setItem(window.EMPLOYERS_LIST_KEY, JSON.stringify(employers));  
    window.loadEmployersList();  
    if (typeof window.updateAllEmployerDropdowns === 'function') window.updateAllEmployerDropdowns();  
    nameInput.value = '';  
    iconInput.value = '';  
    if (typeof showToast === 'function') showToast(`تم إضافة جهة الوظيفة: ${name}`, 'success');  
  };  
    
  window.updateEmployerName = function(index, newName) {  
    const employers = window.getEmployersList();  
    if (employers[index]) {  
      employers[index].name = newName;  
      localStorage.setItem(window.EMPLOYERS_LIST_KEY, JSON.stringify(employers));  
    }  
  };  
    
  window.updateEmployerIcon = function(index, newIcon) {  
    const employers = window.getEmployersList();  
    if (employers[index]) {  
      employers[index].icon = newIcon;  
      localStorage.setItem(window.EMPLOYERS_LIST_KEY, JSON.stringify(employers));  
      window.loadEmployersList();  
    }  
  };  
    
  window.deleteEmployer = function(index) {  
    const employers = window.getEmployersList();  
    const deleted = employers.splice(index, 1);  
    localStorage.setItem(window.EMPLOYERS_LIST_KEY, JSON.stringify(employers));  
    window.loadEmployersList();  
    if (typeof window.updateAllEmployerDropdowns === 'function') window.updateAllEmployerDropdowns();  
    if (typeof showToast === 'function') showToast(`تم حذف جهة الوظيفة: ${deleted[0]?.name}`, 'info');  
  };  
    
  window.saveEmployersList = function() {  
    if (typeof showSaveConfirmation === 'function') showSaveConfirmation('تم حفظ جهات الوظيفة بنجاح');  
  };  
    
  window.resetEmployersList = function() {  
    if (confirm('هل تريد إعادة تعيين جهات الوظيفة للقيم الافتراضية؟')) {  
      localStorage.removeItem(window.EMPLOYERS_LIST_KEY);  
      window.loadEmployersList();  
      if (typeof window.updateAllEmployerDropdowns === 'function') window.updateAllEmployerDropdowns();  
      if (typeof showToast === 'function') showToast('تم إعادة تعيين جهات الوظيفة', 'info');  
    }  
  };  
    
  console.log('[FINO] تم تحميل دوال إدارة جهات الوظيفة');  
    
  // دالة عرض الصفحات - متاحة عالمياً  
  window.showPage = function(name) {  
    ['landing','calculator','result','adminLogin','adminHub','admin','adminProducts','adminArchive','comingSoon','earlySettlement','adminRatings','adminOffers','adminMarketing','adminQuestions','adminVisitors','adminClientResults','adminAds','adminSettings','adminThemes','adminTexts','adminResultSettings','adminResultTexts','adminEmployers','adminFinanceEntities'].forEach(id => {  
      const el = document.getElementById(id + 'Page');  
      if (!el) return;  
      el.classList.toggle('active', id === name);  
    });  
      
    // تهيئة لوحة المسؤول عند فتحها  
    if (name === 'adminHub' || name.startsWith('admin')) {  
      if (typeof renderBankTable === 'function') renderBankTable();  
      if (typeof renderFinanceProductsTable === 'function') renderFinanceProductsTable();  
      if (typeof renderArchiveTable === 'function') renderArchiveTable();  
      if (typeof loadRetirementSettingsToUI === 'function') loadRetirementSettingsToUI();  
      if (typeof initAdminHub === 'function') initAdminHub();  
      if (typeof applyAllSettings === 'function') applyAllSettings();  
      if (name === 'adminQuestions' && typeof renderQuestionsList === 'function') {  
        renderQuestionsList();  
        // تحميل جهات التمويل في القائمة المنسدلة  
        if (typeof loadFinanceEntitiesForQuestions === 'function') {  
          loadFinanceEntitiesForQuestions();  
        }  
        // تحميل المنتجات في القائمة المنسدلة  
        if (typeof loadProductsForQuestions === 'function') {  
          loadProductsForQuestions();  
        }
        // تهيئة إعدادات سؤال التمويل المحدد
        if (typeof initSpecificAmountVisibility === 'function') {
          initSpecificAmountVisibility();
        }
        // تهيئة واجهة التحكم في الأسئلة
        if (typeof renderQuestionSettingsUI === 'function') {
          renderQuestionSettingsUI();
        }
      }  
      // تحميل قائمة جهات الوظيفة  
      if (pageId === 'adminEmployers') {  
      if (typeof window.loadEmployersList === 'function') window.loadEmployersList();  
    }  
    if (pageId === 'adminJobTypes') {  
      if (typeof window.loadJobTypesList === 'function') window.loadJobTypesList();  
    }  
      // تحميل قائمة جهات التمويل  
      if (name === 'adminFinanceEntities' && typeof window.loadFinanceEntitiesList === 'function') {  
        window.loadFinanceEntitiesList();  
      }  
    }  
  };  
  function showPage(name) { window.showPage(name); }  
  
  function backToLanding() { showPage('landing'); }  

// دالة تطبيق جميع التغييرات
function applyAllChanges() {
  // إظهار رسالة تحميل
  const btn = event.target;
  const originalText = btn.innerHTML;
  btn.innerHTML = '⏳ جاري التطبيق...';
  btn.disabled = true;
  
  setTimeout(() => {
    // إعادة تحميل جميع البيانات من localStorage
    try {
      // إعادة تحميل إعدادات البنوك
      if (typeof loadBankConfigsFromStorage === 'function') {
        loadBankConfigsFromStorage();
      }
      
      // إعادة تحميل التعديلات التراكمية
      if (typeof loadRateAdjustmentsFromStorage === 'function') {
        loadRateAdjustmentsFromStorage();
      }
      
      // إعادة تحميل إعدادات الأسئلة
      if (typeof loadCustomQuestions === 'function') {
        loadCustomQuestions();
      }
      
      // إعادة تحميل إعدادات المنتجات
      if (typeof loadProductSettings === 'function') {
        loadProductSettings();
      }
      
      // إعادة عرض جدول البنوك
      if (typeof renderBankTable === 'function') {
        renderBankTable();
      }
      
      // إعادة عرض قائمة الأسئلة
      if (typeof renderQuestionsList === 'function') {
        renderQuestionsList();
      }
      
      // إعادة عرض قائمة التعديلات
      if (typeof renderRateAdjustmentsList === 'function') {
        renderRateAdjustmentsList();
      }
      
      btn.innerHTML = '✅ تم التطبيق بنجاح!';
      btn.style.background = '#10b981';
      btn.style.color = '#fff';
      
      // إظهار رسالة نجاح
      alert('✅ تم تطبيق جميع التغييرات بنجاح!\n\nسيتم إعادة تحميل الصفحة لضمان تطبيق التغييرات.');
      
      // إعادة تحميل الصفحة لضمان تطبيق جميع التغييرات
      setTimeout(() => {
        location.reload();
      }, 500);
      
    } catch (error) {
      console.error('خطأ في تطبيق التغييرات:', error);
      btn.innerHTML = '❌ حدث خطأ';
      btn.style.background = '#ef4444';
      btn.style.color = '#fff';
      alert('حدث خطأ أثناء تطبيق التغييرات. يرجى المحاولة مرة أخرى.');
    }
    
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.style.background = '#fff';
      btn.style.color = '#059669';
      btn.disabled = false;
    }, 2000);
  }, 500);
}

  
  window.startClientFlow = function() {  
    showPage('calculator');  
    resetCalc();  
      
    // تتبع بدء الحسبة  
    if (typeof trackVisitor === 'function') trackVisitor();  
  };  
  // startClientFlow معرّفة في window مباشرة  
  
  function backToFinanceType(){  
    showPage('calculator');  
    hasStarted = true;  
    const idx = generalQuestions.findIndex(q => q.id === 'financeType');  
    step = idx >= 0 ? idx : 0;  
    commitmentStep = 0;  
    currentCommitment = {};  
    document.getElementById('mainButton').style.display = 'none';  
    document.getElementById('resetButtonContainer').style.display = 'block';  
    document.getElementById('nextButton').style.display = 'inline-flex';  
    showQuestion();  
  }  
  
  // شعارات البنوك وشركات التمويل - يمكن تعديلها من لوحة التحكم  
  const BANK_LOGOS_KEY = 'fino_bank_logos';  
  const defaultBankLogos = {  
    // البنوك المحلية  
    'مصرف الراجحي': 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/8a/Al_Rajhi_Bank_Logo.svg/200px-Al_Rajhi_Bank_Logo.svg.png',  
    'البنك الأهلي السعودي': 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/8e/Saudi_National_Bank_Logo.svg/200px-Saudi_National_Bank_Logo.svg.png',  
    'بنك الرياض': 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Riyad_Bank_logo.svg/200px-Riyad_Bank_logo.svg.png',  
    'البنك السعودي الأول': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9f/Saudi_Awwal_Bank_logo.svg/200px-Saudi_Awwal_Bank_logo.svg.png',  
    'البنك العربي الوطني': 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Arab_National_Bank_logo.svg/200px-Arab_National_Bank_logo.svg.png',  
    'مصرف الإنماء': 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/8c/Alinma_Bank_logo.svg/200px-Alinma_Bank_logo.svg.png',  
    'البنك السعودي الفرنسي': 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/4e/Banque_Saudi_Fransi_logo.svg/200px-Banque_Saudi_Fransi_logo.svg.png',  
    'البنك السعودي للاستثمار': 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/1a/Saudi_Investment_Bank_logo.svg/200px-Saudi_Investment_Bank_logo.svg.png',  
    'بنك البلاد': 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/2b/Bank_Albilad_logo.svg/200px-Bank_Albilad_logo.svg.png',  
    'بنك الجزيرة': 'https://upload.wikimedia.org/wikipedia/commons/thumb/f/f0/Bank_AlJazira_logo.svg/200px-Bank_AlJazira_logo.svg.png',  
    'بنك الخليج الدولي': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Gulf_International_Bank_logo.svg/200px-Gulf_International_Bank_logo.svg.png',  
    'بنك ساب': 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9f/Saudi_Awwal_Bank_logo.svg/200px-Saudi_Awwal_Bank_logo.svg.png',  
    // البنوك الرقمية  
    'بنك STC': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a7/STC_Pay_logo.svg/200px-STC_Pay_logo.svg.png',  
    'بنك D360': '',  
    'بنك فيجن': '',  
    // البنوك الأجنبية  
    'بنك الإمارات دبي الوطني': 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/eb/Emirates_NBD_logo.svg/200px-Emirates_NBD_logo.svg.png',  
    'بنك المشرق': 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/7d/Mashreq_Bank_logo.svg/200px-Mashreq_Bank_logo.svg.png',  
    'بنك البحرين الوطني': '',  
    'البنك الأول (FAB)': 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/First_Abu_Dhabi_Bank_logo.svg/200px-First_Abu_Dhabi_Bank_logo.svg.png',  
    'بنك HSBC': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/aa/HSBC_logo_%282018%29.svg/200px-HSBC_logo_%282018%29.svg.png',  
    'ستاندرد تشارترد': 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/ab/Standard_Chartered_%282021%29.svg/200px-Standard_Chartered_%282021%29.svg.png',  
    // شركات التمويل  
    'عبداللطيف جميل للتمويل': 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Abdul_Latif_Jameel_logo.svg/200px-Abdul_Latif_Jameel_logo.svg.png',  
    'شركة تسهيل': '',  
    'شركة نايفات': '',  
    'شركة اليسر': '',  
    'دويتشه الخليج للتمويل': ''  
  };  
    
  // شعارات جهات العمل  
  const EMPLOYER_LOGOS_KEY = 'fino_employer_logos';  
  const defaultEmployerLogos = {  
    'وزارة الدفاع': '',  
    'وزارة الداخلية': '',  
    'وزارة الحرس الوطني': '',  
    'رئاسة أمن الدولة': '',  
    'وزارة الصحة': '',  
    'وزارة التعليم': '',  
    'أرامكو': '',  
    'سابك': ''  
  };  
    
  // شعارات المنتجات  
  const PRODUCT_LOGOS_KEY = 'fino_product_logos';  
  const defaultProductLogos = {  
    'شخصي': '',  
    'عقاري': '',  
    'سيارات': ''  
  };  
    
  // دوال تحميل وحفظ الشعارات  
  function getBankLogos() {  
    const saved = localStorage.getItem(BANK_LOGOS_KEY);  
    return saved ? {...defaultBankLogos, ...JSON.parse(saved)} : {...defaultBankLogos};  
  }  
    
  function saveBankLogos(logos) {  
    localStorage.setItem(BANK_LOGOS_KEY, JSON.stringify(logos));  
  }  
    
  function getEmployerLogos() {  
    const saved = localStorage.getItem(EMPLOYER_LOGOS_KEY);  
    return saved ? {...defaultEmployerLogos, ...JSON.parse(saved)} : {...defaultEmployerLogos};  
  }  
    
  function saveEmployerLogos(logos) {  
    localStorage.setItem(EMPLOYER_LOGOS_KEY, JSON.stringify(logos));  
  }  
    
  function getProductLogos() {  
    const saved = localStorage.getItem(PRODUCT_LOGOS_KEY);  
    return saved ? {...defaultProductLogos, ...JSON.parse(saved)} : {...defaultProductLogos};  
  }  
    
  function saveProductLogos(logos) {  
    localStorage.setItem(PRODUCT_LOGOS_KEY, JSON.stringify(logos));  
  }  
    
  // دالة للحصول على شعار بنك معين  
  function getBankLogo(bankName) {  
    const logos = getBankLogos();  
    return logos[bankName] || '';  
  }  
    
  // دالة للحصول على شعار جهة عمل  
  function getEmployerLogo(employer) {  
    const logos = getEmployerLogos();  
    return logos[employer] || '';  
  }  
    
  // دالة للحصول على شعار منتج  
  function getProductLogo(product) {  
    const logos = getProductLogos();  
    return logos[product] || '';  
  }  
    
  // خريطة الشعارات القديمة للتوافق العكسي  
  const bankLogoMap = getBankLogos();  
  
  // ====== الدالة المركزية لقائمة جهات التمويل المشتركة ======  
  // هذه الدالة تُستخدم في كل مكان: لوحة تحكم المسؤول + واجهة العميل  
  function getMasterFinanceEntitiesList() {  
    // القائمة الأساسية لجميع جهات التمويل المرخصة من ساما  
    const defaultEntities = [  
      // البنوك المحلية (12 بنك)  
      { name: 'البنك الأهلي السعودي', type: 'بنك محلي' },  
      { name: 'مصرف الراجحي', type: 'بنك محلي' },  
      { name: 'بنك الرياض', type: 'بنك محلي' },  
      { name: 'البنك السعودي الأول', type: 'بنك محلي' },  
      { name: 'البنك العربي الوطني', type: 'بنك محلي' },  
      { name: 'مصرف الإنماء', type: 'بنك محلي' },  
      { name: 'البنك السعودي الفرنسي', type: 'بنك محلي' },  
      { name: 'البنك السعودي للاستثمار', type: 'بنك محلي' },  
      { name: 'بنك البلاد', type: 'بنك محلي' },  
      { name: 'بنك الجزيرة', type: 'بنك محلي' },  
      { name: 'بنك الخليج الدولي', type: 'بنك محلي' },  
      { name: 'بنك ساب', type: 'بنك محلي' },  
      // البنوك الرقمية  
      { name: 'بنك STC', type: 'بنك رقمي' },  
      { name: 'بنك D360', type: 'بنك رقمي' },  
      { name: 'بنك فيجن', type: 'بنك رقمي' },  
      // فروع البنوك الأجنبية  
      { name: 'بنك الإمارات دبي الوطني', type: 'بنك أجنبي' },  
      { name: 'بنك المشرق', type: 'بنك أجنبي' },  
      { name: 'بنك البحرين الوطني', type: 'بنك أجنبي' },  
      { name: 'البنك الأول (FAB)', type: 'بنك أجنبي' },  
      { name: 'بنك HSBC', type: 'بنك أجنبي' },  
      { name: 'بنك Citibank', type: 'بنك أجنبي' },  
      // شركات التمويل العقاري  
      { name: 'أملاك العالمية للتمويل', type: 'شركة تمويل عقاري' },  
      { name: 'شركة دار التمليك', type: 'شركة تمويل عقاري' },  
      { name: 'شركة سهل للتمويل', type: 'شركة تمويل عقاري' },  
      { name: 'شركة مسار النمو للتمويل', type: 'شركة تمويل عقاري' },  
      { name: 'شركة عبداللطيف جميل للتمويل العقاري', type: 'شركة تمويل عقاري' },  
      { name: 'شركة بداية للتمويل', type: 'شركة تمويل عقاري' },  
      { name: 'الشركة السعودية لإعادة التمويل العقاري', type: 'شركة تمويل عقاري' },  
      // شركات التمويل الاستهلاكي والإيجار  
      { name: 'شركة النايفات للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة ينال للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة اليسر للإجارة والتمويل', type: 'شركة تمويل' },  
      { name: 'شركة آجل للخدمات التمويلية', type: 'شركة تمويل' },  
      { name: 'الشركة الوطنية للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة المرابحة المرنة للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة كرناف للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة الجاسرية للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة متاجر للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة تسهيل للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة السعودي الفرنسي للتأجير التمويلي', type: 'شركة تمويل' },  
      { name: 'شركة الأولى للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة الجبر للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة موني للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة كوارا للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة إمكان للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة الأمثل للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة دويتشه الخليج للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة الراجحي للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة الأهلي للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة التسهيلات المالية', type: 'شركة تمويل' },  
      { name: 'شركة رسن للتمويل', type: 'شركة تمويل' },  
      { name: 'شركة لندو للتمويل', type: 'شركة تمويل' },  
      // شركات التمويل الجماعي والتقنية المالية  
      { name: 'شركة فندينق سوق للتمويل', type: 'تقنية مالية' },  
      { name: 'شركة منافع للتمويل', type: 'تقنية مالية' },  
      { name: 'شركة سلفة للتمويل', type: 'تقنية مالية' },  
      { name: 'شركة تمارا للتمويل', type: 'تقنية مالية' },  
      { name: 'شركة تابي للتمويل', type: 'تقنية مالية' },  
      { name: 'شركة سبوتي للتمويل', type: 'تقنية مالية' },  
      { name: 'شركة بوست باي للتمويل', type: 'تقنية مالية' },  
      { name: 'شركة قسطها للتمويل', type: 'تقنية مالية' },  
      { name: 'شركة حصيل للتمويل', type: 'تقنية مالية' },  
      { name: 'شركة ليندا للتمويل', type: 'تقنية مالية' },  
      { name: 'شركة فرصة للتمويل', type: 'تقنية مالية' },  
      { name: 'شركة سكوبير للتمويل', type: 'تقنية مالية' }  
    ];  
      
    // إضافة الجهات المخصصة التي أضافها المسؤول  
    const customBanks = JSON.parse(localStorage.getItem('fino_custom_banks') || '[]');  
      
    // دمج القائمتين مع إزالة التكرار  
    const allEntities = [...defaultEntities];  
    customBanks.forEach(cb => {  
      if (!allEntities.find(e => e.name === cb.name)) {  
        allEntities.push({ name: cb.name, type: cb.type || 'جهة مخصصة' });  
      }  
    });  
      
    return allEntities;  
  }  
  
  let bankConfigs = [];  
  const defaultBankConfigs = [  
    // مصرف الراجحي  
    { bankName: 'مصرف الراجحي', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 8000, margin: 5.5, jobType: 'الكل' },  
    { bankName: 'مصرف الراجحي', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 8001, maxSalary: 20000, margin: 4.9, jobType: 'الكل' },  
    { bankName: 'مصرف الراجحي', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 20001, maxSalary: 999999, margin: 4.5, jobType: 'الكل' },  
    { bankName: 'مصرف الراجحي', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 12, maxMonths: 240, margin: 4.31, jobType: 'الكل', productDetail: 'الكل', bankNote: 'نسب سكني 20 سنة' },  
  
    // البنك الأهلي السعودي  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 8000, margin: 5.25, jobType: 'الكل' },  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 8001, maxSalary: 20000, margin: 4.75, jobType: 'الكل' },  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 20001, maxSalary: 999999, margin: 4.25, jobType: 'الكل' },  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 12, maxMonths: 240, margin: 4.20, jobType: 'الكل', productDetail: 'الكل', bankNote: 'نسب سكني 20 سنة' },  
  
    // بنك الرياض  
    { bankName: 'بنك الرياض', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 10000, margin: 5.35, jobType: 'الكل' },  
    { bankName: 'بنك الرياض', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 10001, maxSalary: 999999, margin: 4.65, jobType: 'الكل' },  
    { bankName: 'بنك الرياض', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 12, maxMonths: 240, margin: 4.10, jobType: 'الكل', productDetail: 'الكل', bankNote: 'نسب سكني 20 سنة' },  
  
    // مصرف الإنماء  
    { bankName: 'مصرف الإنماء', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 8000, margin: 5.45, jobType: 'الكل' },  
    { bankName: 'مصرف الإنماء', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 8001, maxSalary: 999999, margin: 4.85, jobType: 'الكل' },  
    { bankName: 'مصرف الإنماء', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 12, maxMonths: 240, margin: 3.65, jobType: 'الكل', productDetail: 'الكل', bankNote: 'نسب سكني 20 سنة' },  
  
    // بنك البلاد  
    { bankName: 'بنك البلاد', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 999999, margin: 5.15, jobType: 'الكل' },  
    { bankName: 'بنك البلاد', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 12, maxMonths: 240, margin: 3.94, jobType: 'الكل', productDetail: 'الكل', bankNote: 'نسب سكني 20 سنة' },  
  
    // البنك السعودي الفرنسي  
    { bankName: 'البنك السعودي الفرنسي', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 5000, maxSalary: 999999, margin: 4.95, jobType: 'الكل' },  
    { bankName: 'البنك السعودي الفرنسي', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 5000, maxSalary: 999999, minMonths: 12, maxMonths: 240, margin: 4.40, jobType: 'الكل', productDetail: 'الكل', bankNote: 'نسب سكني 20 سنة' },  
  
    // بنك الجزيرة  
    { bankName: 'بنك الجزيرة', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 999999, margin: 5.2, jobType: 'الكل' },  
    { bankName: 'بنك الجزيرة', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 12, maxMonths: 240, margin: 4.20, jobType: 'الكل', productDetail: 'الكل', bankNote: 'نسب سكني 20 سنة' },  
  
    // البنك العربي الوطني  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 5000, maxSalary: 999999, margin: 5.0, jobType: 'الكل' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 5000, maxSalary: 999999, minMonths: 12, maxMonths: 240, margin: 4.09, jobType: 'الكل', productDetail: 'الكل', bankNote: 'نسب سكني 20 سنة' },  
  
    // بنك ساب  
    { bankName: 'بنك ساب', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 5000, maxSalary: 999999, margin: 4.85, jobType: 'الكل' },  
    { bankName: 'بنك ساب', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 5000, maxSalary: 999999, minMonths: 12, maxMonths: 240, margin: 4.35, jobType: 'الكل', productDetail: 'الكل', bankNote: 'نسب سكني 20 سنة' },  
  
    // شركة عبداللطيف جميل للتمويل  
    { bankName: 'عبداللطيف جميل للتمويل', bankType:'شركة', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 999999, margin: 6.5, jobType: 'الكل' },  
    // شركة تسهيل  
    { bankName: 'شركة تسهيل', bankType:'شركة', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 999999, margin: 6.75, jobType: 'الكل' },  
    // شركة نايفات  
    { bankName: 'شركة نايفات', bankType:'شركة', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 999999, margin: 6.25, jobType: 'الكل' },  
    // شركة اليسر  
    { bankName: 'شركة اليسر', bankType:'شركة', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 999999, margin: 6.5, jobType: 'الكل' },  
    // شركة دويتشه الخليج للتمويل  
    { bankName: 'دويتشه الخليج للتمويل', bankType:'شركة', financeType: 'personal', supportedType: 'الكل', minSalary: 5000, maxSalary: 999999, margin: 6.0, jobType: 'الكل' },  
    // نسب البنوك الجديدة من الصور المرفقة  
  
    // === نسب اعتزاز - البنك الأهلي السعودي (وزارة الدفاع) ===  
    // هذه النسب ثابتة ولا تُطبق عليها التعديلات التراكمية (+0.90%) إلا إذا فعّلها المسؤول
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 999999, minMonths: 12, maxMonths: 60, margin: 2.50, jobType: 'عسكري', etezaaz: 'وزارة الدفاع', isEtezaaz: true, bankNote: 'عرض اعتزاز - وزارة الدفاع (1-5 سنوات)' },  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 999999, minMonths: 72, maxMonths: 180, margin: 3.50, jobType: 'عسكري', etezaaz: 'وزارة الدفاع', isEtezaaz: true, bankNote: 'عرض اعتزاز - وزارة الدفاع (6-15 سنة)' },  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 999999, minMonths: 192, maxMonths: 240, margin: 3.65, jobType: 'عسكري', etezaaz: 'وزارة الدفاع', isEtezaaz: true, bankNote: 'عرض اعتزاز - وزارة الدفاع (16-20 سنة)' },  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 999999, minMonths: 252, maxMonths: 300, margin: 3.75, jobType: 'عسكري', etezaaz: 'وزارة الدفاع', isEtezaaz: true, bankNote: 'عرض اعتزاز - وزارة الدفاع (21-25 سنة)' },  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 999999, minMonths: 312, maxMonths: 360, margin: 3.85, jobType: 'عسكري', etezaaz: 'وزارة الدفاع', isEtezaaz: true, bankNote: 'عرض اعتزاز - وزارة الدفاع (26-30 سنة)' },  
  
// === البنك الأهلي السعودي - عقاري مدعوم (الوحدات الجاهزة) ===  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 1, maxMonths: 59, margin: 3.70, jobType: 'الكل', productDetail: 'وحدة جاهزة', bankNote: 'وحدات جاهزة - مدعوم' },  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 60, maxMonths: 119, margin: 3.80, jobType: 'الكل', productDetail: 'وحدة جاهزة', bankNote: 'وحدات جاهزة - مدعوم' },  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 120, maxMonths: 179, margin: 3.90, jobType: 'الكل', productDetail: 'وحدة جاهزة', bankNote: 'وحدات جاهزة - مدعوم' },  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 180, maxMonths: 239, margin: 4.20, jobType: 'الكل', productDetail: 'وحدة جاهزة', bankNote: 'وحدات جاهزة - مدعوم' },  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 240, maxMonths: 299, margin: 4.30, jobType: 'الكل', productDetail: 'وحدة جاهزة', bankNote: 'وحدات جاهزة - مدعوم' },  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 300, maxMonths: 360, margin: 4.50, jobType: 'الكل', productDetail: 'وحدة جاهزة', bankNote: 'وحدات جاهزة - مدعوم' },  

// === البنك الأهلي السعودي - عقاري غير مدعوم ===  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'mortgage', supportedType: 'غير مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 1, maxMonths: 119, margin: 3.80, jobType: 'الكل', productDetail: 'الكل', bankNote: 'غير مدعوم' },  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'mortgage', supportedType: 'غير مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 120, maxMonths: 179, margin: 4.20, jobType: 'الكل', productDetail: 'الكل', bankNote: 'غير مدعوم' },  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'mortgage', supportedType: 'غير مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 180, maxMonths: 239, margin: 4.40, jobType: 'الكل', productDetail: 'الكل', bankNote: 'غير مدعوم' },  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'mortgage', supportedType: 'غير مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 240, maxMonths: 299, margin: 4.60, jobType: 'الكل', productDetail: 'الكل', bankNote: 'غير مدعوم' },  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'mortgage', supportedType: 'غير مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 300, maxMonths: 360, margin: 5.00, jobType: 'الكل', productDetail: 'الكل', bankNote: 'غير مدعوم' },  

// === البنك الأهلي السعودي - عقاري مدعوم على الخارطة 2.99% ===  
    { bankName: 'البنك الأهلي السعودي', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 12, maxMonths: 240, margin: 2.99, jobType: 'الكل', productDetail: 'تحت الإنشاء', bankNote: 'عرض على الخارطة - يشمل دعم الباقة المقدمة والدعم الشهري' },  
  
// === البنك السعودي للاستثمار - عقاري مدعوم (سكني 20 سنة) ===  
    { bankName: 'البنك السعودي للاستثمار', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 12, maxMonths: 240, margin: 4.16, jobType: 'الكل', bankNote: 'نسب سكني 20 سنة' },  
  
// === البنك السعودي للاستثمار - عقاري مدعوم (أرامكو) ===  
    { bankName: 'البنك السعودي للاستثمار', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 12, maxMonths: 60, margin: 1.99, jobType: 'قطاع خاص', productDetail: 'أرامكو', bankNote: 'عرض خاص لمنسوبي أرامكو' },  
    { bankName: 'البنك السعودي للاستثمار', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 72, maxMonths: 120, margin: 2.55, jobType: 'قطاع خاص', productDetail: 'أرامكو', bankNote: 'عرض خاص لمنسوبي أرامكو' },  
    { bankName: 'البنك السعودي للاستثمار', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 132, maxMonths: 180, margin: 3.39, jobType: 'قطاع خاص', productDetail: 'أرامكو', bankNote: 'عرض خاص لمنسوبي أرامكو' },  
    { bankName: 'البنك السعودي للاستثمار', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 192, maxMonths: 240, margin: 3.95, jobType: 'قطاع خاص', productDetail: 'أرامكو', bankNote: 'عرض خاص لمنسوبي أرامكو' },  
    { bankName: 'البنك السعودي للاستثمار', bankType:'بنك', financeType: 'mortgage', supportedType: 'مدعوم', minSalary: 4000, maxSalary: 999999, minMonths: 252, maxMonths: 300, margin: 4.33, jobType: 'قطاع خاص', productDetail: 'أرامكو', bankNote: 'عرض خاص لمنسوبي أرامكو' },  
  
// === بنك الإمارات دبي الوطني - جهات حكومية ===  
    { bankName: 'بنك الإمارات دبي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 999999, margin: 1.85, jobType: 'حكومي', productDetail: 'بتحويل راتب', bankNote: 'عرض خاص للجهات الحكومية - بتحويل راتب' },  
    { bankName: 'بنك الإمارات دبي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 999999, margin: 3.99, jobType: 'حكومي', productDetail: 'بدون تحويل راتب', bankNote: 'عرض خاص للجهات الحكومية - بدون تحويل راتب' },  
    { bankName: 'بنك الإمارات دبي الوطني', bankType:'بنك', financeType: 'buyoutPersonal', supportedType: 'الكل', minSalary: 4000, maxSalary: 999999, margin: 1.85, jobType: 'حكومي', productDetail: 'بتحويل راتب', bankNote: 'شراء مديونية - بتحويل راتب' },  
    { bankName: 'بنك الإمارات دبي الوطني', bankType:'بنك', financeType: 'buyoutPersonal', supportedType: 'الكل', minSalary: 4000, maxSalary: 999999, margin: 3.99, jobType: 'حكومي', productDetail: 'بدون تحويل راتب', bankNote: 'شراء مديونية - بدون تحويل راتب' },  
  
// === بنك البلاد - شراء مديونية (تمويل شخصي) ===  
    { bankName: 'بنك البلاد', bankType:'بنك', financeType: 'buyoutPersonal', supportedType: 'الكل', minSalary: 5000, maxSalary: 9999, margin: 2.99, jobType: 'الكل', bankNote: 'عرض شراء مديونية' },  
    { bankName: 'بنك البلاد', bankType:'بنك', financeType: 'buyoutPersonal', supportedType: 'الكل', minSalary: 10000, maxSalary: 14999, margin: 2.19, jobType: 'الكل', bankNote: 'عرض شراء مديونية' },  
    { bankName: 'بنك البلاد', bankType:'بنك', financeType: 'buyoutPersonal', supportedType: 'الكل', minSalary: 15000, maxSalary: 19999, margin: 1.99, jobType: 'الكل', bankNote: 'عرض شراء مديونية' },  
    { bankName: 'بنك البلاد', bankType:'بنك', financeType: 'buyoutPersonal', supportedType: 'الكل', minSalary: 20000, maxSalary: 24999, margin: 1.79, jobType: 'الكل', bankNote: 'عرض شراء مديونية' },  
    { bankName: 'بنك البلاد', bankType:'بنك', financeType: 'buyoutPersonal', supportedType: 'الكل', minSalary: 25000, maxSalary: 34999, margin: 1.59, jobType: 'الكل', bankNote: 'عرض شراء مديونية' },  
    { bankName: 'بنك البلاد', bankType:'بنك', financeType: 'buyoutPersonal', supportedType: 'الكل', minSalary: 35000, maxSalary: 44999, margin: 1.49, jobType: 'الكل', bankNote: 'عرض شراء مديونية' },  
    { bankName: 'بنك البلاد', bankType:'بنك', financeType: 'buyoutPersonal', supportedType: 'الكل', minSalary: 45000, maxSalary: 64999, margin: 1.29, jobType: 'الكل', bankNote: 'عرض شراء مديونية' },  
    { bankName: 'بنك البلاد', bankType:'بنك', financeType: 'buyoutPersonal', supportedType: 'الكل', minSalary: 65000, maxSalary: 999999, margin: 0.99, jobType: 'الكل', bankNote: 'عرض شراء مديونية' },  
  
// === البنك العربي الوطني (anb) - تمويل شخصي - القطاع الحكومي ===  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 70000, maxSalary: 999999, margin: 1.59, jobType: 'حكومي', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 40000, maxSalary: 69999, margin: 1.79, jobType: 'حكومي', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 25000, maxSalary: 39999, margin: 1.99, jobType: 'حكومي', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 15000, maxSalary: 24999, margin: 2.09, jobType: 'حكومي', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 10000, maxSalary: 14999, margin: 2.29, jobType: 'حكومي', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 5000, maxSalary: 9999, margin: 3.29, jobType: 'حكومي', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 4999, margin: 4.59, jobType: 'حكومي', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
  
// === البنك العربي الوطني (anb) - تمويل شخصي - العسكري ===  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 70000, maxSalary: 999999, margin: 1.59, jobType: 'عسكري', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 40000, maxSalary: 69999, margin: 1.79, jobType: 'عسكري', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 25000, maxSalary: 39999, margin: 1.99, jobType: 'عسكري', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 15000, maxSalary: 24999, margin: 2.09, jobType: 'عسكري', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 10000, maxSalary: 14999, margin: 2.29, jobType: 'عسكري', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 5000, maxSalary: 9999, margin: 3.29, jobType: 'عسكري', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 4999, margin: 4.59, jobType: 'عسكري', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
  
// === البنك العربي الوطني (anb) - تمويل شخصي - المتقاعدين ===  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 70000, maxSalary: 999999, margin: 1.59, jobType: 'متقاعد', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 40000, maxSalary: 69999, margin: 1.79, jobType: 'متقاعد', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 25000, maxSalary: 39999, margin: 1.99, jobType: 'متقاعد', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 15000, maxSalary: 24999, margin: 2.09, jobType: 'متقاعد', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 10000, maxSalary: 14999, margin: 2.29, jobType: 'متقاعد', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 5000, maxSalary: 9999, margin: 3.29, jobType: 'متقاعد', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 4999, margin: 4.59, jobType: 'متقاعد', bankNote: 'عرض خاص ينتهي 15/01/2026' },  
  
// === البنك العربي الوطني (anb) - تمويل شخصي - القطاع الخاص أ ===  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 70000, maxSalary: 999999, margin: 1.99, jobType: 'قطاع خاص', bankNote: 'عرض خاص - القطاع الخاص أ' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 40000, maxSalary: 69999, margin: 2.09, jobType: 'قطاع خاص', bankNote: 'عرض خاص - القطاع الخاص أ' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 25000, maxSalary: 39999, margin: 2.19, jobType: 'قطاع خاص', bankNote: 'عرض خاص - القطاع الخاص أ' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 15000, maxSalary: 24999, margin: 2.39, jobType: 'قطاع خاص', bankNote: 'عرض خاص - القطاع الخاص أ' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 10000, maxSalary: 14999, margin: 2.59, jobType: 'قطاع خاص', bankNote: 'عرض خاص - القطاع الخاص أ' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 5000, maxSalary: 9999, margin: 3.59, jobType: 'قطاع خاص', bankNote: 'عرض خاص - القطاع الخاص أ' },  
    { bankName: 'البنك العربي الوطني', bankType:'بنك', financeType: 'personal', supportedType: 'الكل', minSalary: 4000, maxSalary: 4999, margin: 4.79, jobType: 'قطاع خاص', bankNote: 'عرض خاص - القطاع الخاص أ' }  
  ];  
  
  function loadBankConfigs() {  
    try {  
      const saved = localStorage.getItem('stBankConfigs');  
      if (saved) {  
        const savedConfigs = JSON.parse(saved);  
        // دمج النسب الافتراضية الجديدة مع المحفوظة  
        // إضافة النسب الجديدة التي لا توجد في المحفوظة  
        const mergedConfigs = [...savedConfigs];  
        defaultBankConfigs.forEach(defaultCfg => {  
          // التحقق من عدم وجود نفس التكوين  
          const exists = savedConfigs.some(saved =>   
            saved.bankName === defaultCfg.bankName &&  
            saved.financeType === defaultCfg.financeType &&  
            saved.minSalary === defaultCfg.minSalary &&  
            saved.maxSalary === defaultCfg.maxSalary &&  
            saved.jobType === defaultCfg.jobType &&  
            saved.minMonths === defaultCfg.minMonths &&  
            saved.maxMonths === defaultCfg.maxMonths &&  
            saved.etezaaz === defaultCfg.etezaaz &&  
            saved.productDetail === defaultCfg.productDetail  
          );  
          if (!exists) {  
            mergedConfigs.push(defaultCfg);  
          }  
        });  
        bankConfigs = mergedConfigs;  
        saveBankConfigs();  
      } else {  
        bankConfigs = [...defaultBankConfigs];  
        saveBankConfigs();  
      }  
    } catch (e) {  
      bankConfigs = [...defaultBankConfigs];  
    }  
    renderBankTable();  
  }  
  function saveBankConfigs() {  
    localStorage.setItem('stBankConfigs', JSON.stringify(bankConfigs));  
  }  
  
  function renderBankTable() {  
    const tbody = document.querySelector('#adminTable tbody');  
    if(!tbody) return;  
    tbody.innerHTML = '';  
    bankConfigs.forEach((cfg, index) => {  
      let financeLabel =  
        cfg.financeType === 'personal' ? 'شخصي/تأجيري' :  
        cfg.financeType === 'consumer' ? 'استهلاكي' :  
        cfg.financeType === 'mortgage' ? 'عقاري' :  
        cfg.financeType === 'buyoutPersonal' ? 'شراء مديونية شخصي' :  
        cfg.financeType === 'buyoutMortgage' ? 'شراء مديونية عقاري' :  
        cfg.financeType;  
  
      const tr = document.createElement('tr');  
      tr.innerHTML = `  
        <td>${cfg.bankName || ''}</td>  
        <td>${financeLabel}</td>  
        <td>${cfg.supportedType || ''}</td>  
        <td>${(cfg.minSalary || 0).toLocaleString()}</td>  
        <td>${(cfg.maxSalary || 0).toLocaleString()}</td>  
        <td>${cfg.minMonths || ''}</td>  
        <td>${cfg.maxMonths || ''}</td>  
        <td>${cfg.jobType || ''}</td>  
        <td>${cfg.productDetail || ''}</td>  
        <td>${cfg.etezaaz || ''}</td>  
        <td>${cfg.flexibleInstallment ? '✅ (' + (cfg.flexibleMinAmount || 400) + 'ر)' : ''}</td>  
        <td>${cfg.margin}</td>  
        <td>${cfg.ageCalcType === 'gregorian' ? 'ميلادي' : 'هجري'}</td>  
        <td>${cfg.maxAge || 60}</td>  
        <td style="max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${cfg.bankNote || ''}">${cfg.bankNote || '-'}</td>  
        <td>  
          <button class="btn small secondary" onclick="editBankConfig(${index})">تعديل</button>  
          <button class="btn small secondary" onclick="deleteBankConfig(${index})">حذف</button>  
        </td>  
      `;  
      tbody.appendChild(tr);  
    });  
  }  
  
  // دالة إظهار/إخفاء حقل الحد الأدنى للقسط المرن
  function toggleFlexibleMinAmount() {
    const flexibleSelect = document.getElementById('adminFlexibleInstallment');
    const minAmountDiv = document.getElementById('flexibleMinAmountDiv');
    if (flexibleSelect && minAmountDiv) {
      minAmountDiv.style.display = flexibleSelect.value === 'نعم' ? 'block' : 'none';
    }
  }

  function clearAdminForm() {  
    document.getElementById('adminBankName').value = '';  
    document.getElementById('adminFinanceType').value = 'personal';  
    document.getElementById('adminSupportedType').value = 'الكل';  
    document.getElementById('adminMinSalary').value = '';  
    document.getElementById('adminMaxSalary').value = '';  
    document.getElementById('adminMargin').value = '';  
    document.getElementById('adminJobType').value = '';  
    document.getElementById('adminMinMonths').value = '';  
    document.getElementById('adminMaxMonths').value = '';  
    document.getElementById('adminProductDetail').value = '';  
    document.getElementById('adminEtezaaz').value = '';  
    document.getElementById('adminFlexibleInstallment').value = '';  
    document.getElementById('adminFlexibleMinAmount').value = '400';  
    document.getElementById('flexibleMinAmountDiv').style.display = 'none';  
    document.getElementById('adminAgeCalcType').value = 'hijri';  
    document.getElementById('adminMaxAge').value = '';  
    document.getElementById('adminBankNote').value = '';  
    document.getElementById('adminRateExpiry').value = '';  
    document.getElementById('adminRateExpiryCustom').value = '';  
    document.getElementById('adminRateExpiryCustom').style.display = 'none';  
    document.getElementById('adminEditIndex').value = '';  
  }  
  
  function saveBankConfig(e) {  
    e.preventDefault();  
    const bankName = document.getElementById('adminBankName').value;  
    const financeType = document.getElementById('adminFinanceType').value;  
    const supportedType = document.getElementById('adminSupportedType').value;  
    const minSalary = parseFloat(document.getElementById('adminMinSalary').value || '0');  
    const maxSalary = parseFloat(document.getElementById('adminMaxSalary').value || '0');  
    const margin = parseFloat(document.getElementById('adminMargin').value || '0');  
    const jobType = document.getElementById('adminJobType').value;  
    const minMonths = parseInt(document.getElementById('adminMinMonths').value || '0');  
    const maxMonths = parseInt(document.getElementById('adminMaxMonths').value || '0');  
    const productDetail = document.getElementById('adminProductDetail').value;  
    const etezaaz = document.getElementById('adminEtezaaz').value;  
    const flexibleInstallment = document.getElementById('adminFlexibleInstallment').value;  
    const flexibleMinAmount = parseInt(document.getElementById('adminFlexibleMinAmount').value || '400');  
    const ageCalcType = document.getElementById('adminAgeCalcType').value;  
    const maxAge = parseInt(document.getElementById('adminMaxAge').value || '60');  
    const bankNote = (document.getElementById('adminBankNote').value || '').trim();  
    const rateExpirySelect = document.getElementById('adminRateExpiry').value;  
    const rateExpiryCustom = document.getElementById('adminRateExpiryCustom').value;  
    const editIndex = document.getElementById('adminEditIndex').value;  
      
    // حساب تاريخ انتهاء النسبة  
    let rateExpiryDate = null;  
    if (rateExpirySelect === 'custom' && rateExpiryCustom) {  
      rateExpiryDate = rateExpiryCustom;  
    } else if (rateExpirySelect && rateExpirySelect !== '') {  
      const days = parseInt(rateExpirySelect);  
      const expiry = new Date();  
      expiry.setDate(expiry.getDate() + days);  
      rateExpiryDate = expiry.toISOString().split('T')[0];  
    }  
  
    if (!bankName || !margin || !minSalary || !maxSalary) {  
      alert('رجاءً أكمل جميع الحقول الأساسية.');  
      return;  
    }  
    const cfg = { bankName, financeType, supportedType, minSalary, maxSalary, margin };  
  
    if (jobType) cfg.jobType = jobType;  
    if (minMonths) cfg.minMonths = minMonths;  
    if (maxMonths) cfg.maxMonths = maxMonths;  
    if (productDetail) cfg.productDetail = productDetail;  
    if (etezaaz) cfg.etezaaz = etezaaz;  
    if (flexibleInstallment) {
      cfg.flexibleInstallment = flexibleInstallment;
      cfg.flexibleMinAmount = flexibleMinAmount || 400;
    }
    if (bankNote) cfg.bankNote = bankNote;  
    if (rateExpiryDate) cfg.rateExpiryDate = rateExpiryDate;  
    cfg.ageCalcType = ageCalcType || 'hijri';  
    cfg.maxAge = maxAge || 60;  
  
    if (editIndex === '') bankConfigs.push(cfg);  
    else bankConfigs[parseInt(editIndex)] = cfg;  
  
    saveBankConfigs();  
    renderBankTable();  
    clearAdminForm();  
  }  
  
  function editBankConfig(index) {  
    const cfg = bankConfigs[index];  
    document.getElementById('adminBankName').value = cfg.bankName || '';  
    document.getElementById('adminFinanceType').value = cfg.financeType || 'personal';  
    document.getElementById('adminSupportedType').value = cfg.supportedType || 'الكل';  
    document.getElementById('adminMinSalary').value = cfg.minSalary || '';  
    document.getElementById('adminMaxSalary').value = cfg.maxSalary || '';  
    document.getElementById('adminMargin').value = cfg.margin || '';  
    document.getElementById('adminJobType').value = cfg.jobType || '';  
    document.getElementById('adminMinMonths').value = cfg.minMonths || '';  
    document.getElementById('adminMaxMonths').value = cfg.maxMonths || '';  
    document.getElementById('adminProductDetail').value = cfg.productDetail || '';  
    document.getElementById('adminEtezaaz').value = cfg.etezaaz || '';  
    document.getElementById('adminFlexibleInstallment').value = cfg.flexibleInstallment || '';  
    // إظهار حقل الحد الأدنى إذا كان القسط المرن مفعل
    if (cfg.flexibleInstallment === 'نعم') {
      document.getElementById('flexibleMinAmountDiv').style.display = 'block';
      document.getElementById('adminFlexibleMinAmount').value = cfg.flexibleMinAmount || '400';
    } else {
      document.getElementById('flexibleMinAmountDiv').style.display = 'none';
      document.getElementById('adminFlexibleMinAmount').value = '400';
    }
    document.getElementById('adminAgeCalcType').value = cfg.ageCalcType || 'hijri';  
    document.getElementById('adminMaxAge').value = cfg.maxAge || '';  
    document.getElementById('adminBankNote').value = cfg.bankNote || '';  
    // تحميل تاريخ انتهاء النسبة  
    const rateExpiryEl = document.getElementById('adminRateExpiry');  
    const rateExpiryCustomEl = document.getElementById('adminRateExpiryCustom');  
    if (cfg.rateExpiryDate) {  
      rateExpiryEl.value = 'custom';  
      rateExpiryCustomEl.value = cfg.rateExpiryDate;  
      rateExpiryCustomEl.style.display = 'block';  
    } else {  
      rateExpiryEl.value = '';  
      rateExpiryCustomEl.value = '';  
      rateExpiryCustomEl.style.display = 'none';  
    }  
    document.getElementById('adminEditIndex').value = index;  
  }  
  
  function deleteBankConfig(index) {  
    if (!confirm('متأكد من حذف هذا السطر؟')) return;  
    bankConfigs.splice(index, 1);  
    saveBankConfigs();  
    renderBankTable();  
  }  
  
  // دالة للحصول على النسبة المناسبة لبنك معين حسب بيانات العميل - مطورة لتطابق كافة المعايير  
  function getBankRateForClient(bankName, clientAnswers) {  
    const salary = parseFloat(clientAnswers.salary || '0');  
    if (!salary || !bankName) return null;  
  
    // 1. تحديد نوع التمويل بدقة  
    let fType;  
    if (clientAnswers.financeType === 'شراء مديونية تمويل شخصي') fType = 'buyoutPersonal';  
    else if (clientAnswers.financeType === 'شراء مديونية تمويل عقاري') fType = 'buyoutMortgage';  
    else if (clientAnswers.financeType === 'تمويل استهلاكي') fType = 'consumer';  
    else if (clientAnswers.financeType && (clientAnswers.financeType.includes('شخصي') || clientAnswers.financeType === 'تمويل التأجيري')) fType = 'personal';  
    else if (clientAnswers.financeType && clientAnswers.financeType.includes('عقاري')) fType = 'mortgage';  
    else fType = 'personal';  
  
    // 2. تحديد نوع الدعم (مدعوم/غير مدعوم)  
    const supp = clientAnswers.supported || 'الكل';  
      
    // 3. تحديد نوع الوظيفة  
    const jobType = clientAnswers.jobType || '';  
      
    // 4. تحديد مدة التمويل  
    const months = parseInt(clientAnswers.months || '0');  
      
    // 5. تحديد حالة اعتزاز (إن وجدت)  
    const isEtizaz = clientAnswers.isEtizaz === 'نعم';  
    
    // 6. تحديد تفاصيل المنتج العقاري (وحدة جاهزة / تحت الإنشاء)
    let mortgageDetail = clientAnswers.mortgageProductType || '';
    if (mortgageDetail === 'وحدة جاهزة من السوق') mortgageDetail = 'وحدة جاهزة';
    else if (mortgageDetail === 'وحدة تحت الإنشاء (على الخارطة)') mortgageDetail = 'تحت الإنشاء';
  
    // البحث عن النسبة المناسبة للبنك بناءً على كافة المعايير  
    const matchingConfigs = bankConfigs.filter(cfg => {  
      // أ. مطابقة اسم البنك ونوع التمويل  
      if (cfg.bankName !== bankName) return false;  
      if (cfg.financeType !== fType) return false;  
        
      // ب. مطابقة نطاق الراتب  
      if (!(salary >= cfg.minSalary && salary <= cfg.maxSalary)) return false;  
        
      // ج. مطابقة نوع الدعم  
      if (cfg.supportedType && cfg.supportedType !== 'الكل' && cfg.supportedType !== supp) return false;  
        
      // د. مطابقة نوع الوظيفة (حكومي، عسكري، إلخ)  
      if (cfg.jobType && cfg.jobType !== 'الكل' && jobType && cfg.jobType !== jobType) return false;  
        
      // هـ. مطابقة مدة التمويل (الأشهر)  
      if (cfg.minMonths && months && months < cfg.minMonths) return false;  
      if (cfg.maxMonths && months && months > cfg.maxMonths) return false;  
        
      // و. مطابقة حالة اعتزاز (إذا كان العرض مخصصاً لمشتركي اعتزاز)  
      if (cfg.isEtizazOnly && !isEtizaz) return false;  
      
      // ز. مطابقة تفاصيل المنتج العقاري (وحدة جاهزة / تحت الإنشاء)
      if (fType === 'mortgage' && mortgageDetail && cfg.productDetail) {
        if (cfg.productDetail !== 'الكل' && cfg.productDetail !== mortgageDetail) return false;
      }
        
      return true;  
    });  
  
    if (matchingConfigs.length > 0) {  
      // إرجاع أفضل نسبة (الأقل هامش ربح)  
      matchingConfigs.sort((a, b) => a.margin - b.margin);  
      return matchingConfigs[0].margin;  
    }  
    return null;  
  }  
  
  // دالة للحصول على جميع البنوك المتاحة مع نسبها  
  function getAllBanksWithRates(clientAnswers) {  
    const uniqueBanks = [...new Set(bankConfigs.map(cfg => cfg.bankName))];  
    return uniqueBanks.map(bankName => {  
      const rate = getBankRateForClient(bankName, clientAnswers);  
      return { bankName, rate };  
    }).filter(b => b.rate !== null);  
  }  
  
  function getMatchingBanksForAnswers() {  
    const salary = parseFloat(answers.salary || '0');  
    if (!salary) return [];  

    // تحديد نوع التمويل
    let fType;  
    if (answers.financeType === 'شراء مديونية تمويل شخصي') fType = 'buyoutPersonal';  
    else if (answers.financeType === 'شراء مديونية تمويل عقاري') fType = 'buyoutMortgage';  
    else if (answers.financeType === 'تمويل استهلاكي') fType = 'consumer';  
    else if (answers.financeType && (answers.financeType.includes('شخصي') || answers.financeType === 'تمويل التأجيري')) fType = 'personal';  
    else if (answers.financeType && answers.financeType.includes('عقاري')) fType = 'mortgage';  
    else fType = 'personal';  

    const supp = answers.supported || 'الكل';  
    const jobType = answers.jobType || '';  
    const months = parseInt(answers.months || '0');  
    // تحويل تفاصيل المنتج العقاري إلى القيم المستخدمة في قاعدة البيانات
    let mortgageDetail = answers.mortgageProductType || '';
    if (mortgageDetail === 'وحدة جاهزة من السوق') mortgageDetail = 'وحدة جاهزة';
    else if (mortgageDetail === 'وحدة تحت الإنشاء (على الخارطة)') mortgageDetail = 'تحت الإنشاء';  
    const wantsEtezaaz = (answers.financeType === 'تمويل عقاري' && answers.supported === 'مدعوم' && answers.isEtezaaz === 'نعم');  

    console.log('=== بدء عملية الترشيح ===');
    console.log('بيانات العميل:', { 
      financeType: answers.financeType,
      fType, 
      salary, 
      supp, 
      jobType, 
      months, 
      mortgageDetail,
      wantsEtezaaz
    });  
    console.log('عدد البنوك المسجلة:', bankConfigs.length);

    const list = bankConfigs.filter(cfg => {  
      // ========== 1. فحص نوع التمويل (إلزامي) ==========
      if (cfg.financeType !== fType) {
        console.log(`❌ ${cfg.bankName}: نوع التمويل لا يتطابق (${cfg.financeType} ≠ ${fType})`);
        return false;
      }
        
      // ========== 2. فحص الراتب (إلزامي) ==========
      if (!(salary >= cfg.minSalary && salary <= cfg.maxSalary)) {
        console.log(`❌ ${cfg.bankName}: الراتب خارج النطاق (${salary} ليس بين ${cfg.minSalary}-${cfg.maxSalary})`);
        return false;
      }
        
      // ========== 3. فحص الدعم (إلزامي) ==========
      if (cfg.supportedType && cfg.supportedType !== 'الكل' && cfg.supportedType !== supp) {
        console.log(`❌ ${cfg.bankName}: نوع الدعم لا يتطابق (${cfg.supportedType} ≠ ${supp})`);
        return false;
      }

      // ========== 4. فحص نوع الوظيفة (إلزامي) ==========
      // إذا كان العميل له نوع وظيفة محدد:
      // - يُرشح له فقط البنوك التي تدعم "الكل" أو تدعم نفس نوع الوظيفة
      if (jobType && jobType !== '') {
        if (cfg.jobType && cfg.jobType !== '' && cfg.jobType !== 'الكل') {
          if (cfg.jobType !== jobType) {
            console.log(`❌ ${cfg.bankName}: نوع الوظيفة لا يتطابق (${cfg.jobType} ≠ ${jobType})`);
            return false;
          }
        }
      }  
        
      // ========== 5. فحص المدة بالأشهر ==========
      if (cfg.minMonths && months && months < cfg.minMonths) {
        console.log(`❌ ${cfg.bankName}: المدة أقل من الحد الأدنى (${months} < ${cfg.minMonths})`);
        return false;
      }
      if (cfg.maxMonths && months && months > cfg.maxMonths) {
        console.log(`❌ ${cfg.bankName}: المدة أكبر من الحد الأقصى (${months} > ${cfg.maxMonths})`);
        return false;
      }
        
      // ========== 6. فحص تفاصيل المنتج (إلزامي للعقاري) ==========
      // إذا كان العميل اختار منتج محدد (مثل "بناء ذاتي" أو "وحدات جاهزة"):
      // - يُرشح له فقط البنوك التي تدعم "الكل" أو تدعم نفس المنتج المحدد
      if (mortgageDetail && mortgageDetail !== '') {
        if (cfg.productDetail && cfg.productDetail !== '' && cfg.productDetail !== 'الكل') {
          if (cfg.productDetail !== mortgageDetail) {
            console.log(`❌ ${cfg.bankName}: تفاصيل المنتج لا تتطابق (${cfg.productDetail} ≠ ${mortgageDetail})`);
            return false;
          }
        }
      }  
        
      // ========== 7. فحص برنامج اعتزاز ==========
      if (wantsEtezaaz && cfg.etezaaz && cfg.etezaaz !== 'نعم') {
        console.log(`❌ ${cfg.bankName}: لا يدعم برنامج اعتزاز`);
        return false;
      }
      
      // ✅ البنك مطابق لجميع الشروط
      console.log(`✅ ${cfg.bankName}: مطابق - نسبة: ${cfg.margin}%`);
  
      return true;  
    });  
  
    console.log('البنوك المطابقة قبل الترتيب:', list.length);  
      
    // ترتيب حسب النسبة الأقل  
    list.sort((a,b)=> a.margin - b.margin);  
    return list;  
  }  
  
  const ADMIN_PIN = '11qq11qQ@';  
  
  function handleAdminLogin() {  
    const pin = document.getElementById('adminPin').value;  
    const err = document.getElementById('adminLoginError');  
    if (pin === ADMIN_PIN) {  
      err.style.display = 'none';  
      showPage('adminHub');  
    } else {  
      err.style.display = 'block';  
    }  
  }  
  
  // ====== أدوات المسؤول (▫️) ======  
  let _miniAdminVerified = false;  
  window.openMiniAdminTools = function(){  
    document.getElementById('miniAdminPin').value = '';  
    document.getElementById('miniAdminPinError').style.display = 'none';  
    document.getElementById('miniAdminAuthModal').style.display = 'block';  
  }  
  function closeMiniAdminAuth(){  
    document.getElementById('miniAdminAuthModal').style.display = 'none';  
  }  
  function verifyMiniAdminPin(){  
    const pin = document.getElementById('miniAdminPin').value;  
    if(pin === ADMIN_PIN){  
      _miniAdminVerified = true;  
      document.getElementById('miniAdminPinError').style.display = 'none';  
      document.getElementById('miniAdminAuthModal').style.display = 'none';  
      document.getElementById('miniAdminActionsModal').style.display = 'block';  
    } else {  
      document.getElementById('miniAdminPinError').style.display = 'block';  
    }  
  }  
  function closeMiniAdminActions(){  
    document.getElementById('miniAdminActionsModal').style.display = 'none';  
  }  
  
  function openAdminLoginFromMiniTools(){  
    closeMiniAdminActions();  
    showPage('adminLogin');  
  }  
  
  function openArchiveSaveModal(){  
    closeMiniAdminActions();  
    const lc = answers._lastCalc;  
    if(!lc){  
      alert('لا توجد نتيجة حالياً. احسب أولاً ثم احفظ بالأرشيف.');  
      return;  
    }  
    document.getElementById('archiveKeyInput').value = '';  
    document.getElementById('archiveSaveMsg').style.display = 'none';  
    document.getElementById('archiveSaveModal').style.display = 'block';  
  }  
  function closeArchiveSaveModal(){  
    document.getElementById('archiveSaveModal').style.display = 'none';  
  }  
  
  // ====== (إضافة) إدارة منتجات التمويل ======  
  const FIN_PRODUCTS_KEY = 'stFinanceProducts';  
  let financeProducts = [];  
  
  function getDefaultFinanceProducts(){  
    // نفس الخيارات الحالية، لكن مع حالة (مفعّل/غير مفعّل) + رسالة  
    return [  
      { name:'تمويل شخصي', enabled:true, message:'' },  
      { name:'تمويل استهلاكي', enabled:true, message:'' },  
      { name:'تمويل التأجيري', enabled:true, message:'' },  
      { name:'تمويل عقاري', enabled:true, message:'' },  
      { name:'شراء مديونية تمويل شخصي', enabled:true, message:'' },  
      { name:'شراء مديونية تمويل عقاري', enabled:false, message:'حالياً لا يوجد احتساب لشراء المديونية العقارية عبر هذه الحاسبة.' },  
      { name:'بطاقات الإتمان', enabled:false, message:'نعتذر منك، قريباً سيتم تحديث نسب هذا المنتج في المنصة.' },  
      { name:'تمويل نقاط البيع', enabled:false, message:'نعتذر منك، قريباً سيتم تحديث نسب هذا المنتج في المنصة.' },  
      { name:'تمويل المؤسسات', enabled:false, message:'نعتذر منك، قريباً سيتم تحديث نسب هذا المنتج في المنصة.' },  
      { name:'تمويل الأسطول', enabled:false, message:'نعتذر منك، قريباً سيتم تحديث نسب هذا المنتج في المنصة.' },  
      { name:'مفوتر', enabled:true, message:'' }  
    ];  
  }  
  
  function loadFinanceProducts(){  
    try{  
      const s = localStorage.getItem(FIN_PRODUCTS_KEY);  
      if(s){  
        const arr = JSON.parse(s);  
        financeProducts = Array.isArray(arr) ? arr : getDefaultFinanceProducts();  
      } else {  
        financeProducts = getDefaultFinanceProducts();  
        saveFinanceProducts();  
      }  
    }catch(e){  
      financeProducts = getDefaultFinanceProducts();  
    }  
  }  
  
  function saveFinanceProducts(){  
    localStorage.setItem(FIN_PRODUCTS_KEY, JSON.stringify(financeProducts || []));  
  }  
  
  function getFinanceProductNames(){  
    // لضمان عدم كسر أي شيء: نرجّع قائمة الأسماء فقط  
    const list = (financeProducts && financeProducts.length) ? financeProducts : getDefaultFinanceProducts();  
    return list.map(x=>x.name);  
  }  
  
  function findFinanceProduct(name){  
    const list = (financeProducts && financeProducts.length) ? financeProducts : getDefaultFinanceProducts();  
    return list.find(x=>x.name===name) || null;  
  }  
  
  function isFinanceProductEnabled(name){  
    const p = findFinanceProduct(name);  
    if(!p) return true;  
    return !!p.enabled;  
  }  
  
  function getFinanceProductMessage(name){  
    const p = findFinanceProduct(name);  
    return (p && p.message) ? String(p.message) : '';  
  }  
  
  function clearFinanceProductForm(){  
    // مسح جهة التمويل  
    const entitySelect = document.getElementById('fpFinanceEntity');  
    if (entitySelect) entitySelect.value = '';  
    const newEntityInput = document.getElementById('fpNewEntityName');  
    if (newEntityInput) {  
      newEntityInput.value = '';  
      newEntityInput.style.display = 'none';  
    }  
      
    document.getElementById('fpName').value = '';  
    document.getElementById('fpEnabled').value = 'true';  
    document.getElementById('fpMessage').value = '';  
    document.getElementById('fpEditIndex').value = '';  
    document.getElementById('fpDeductionRate').value = '';  
    document.getElementById('fpCustomQuestionsList').innerHTML = '';  
  }  
    
  // دالة إضافة حقل سؤال مخصص جديد  
  let customQuestionCounter = 0;  
  function addCustomQuestionField(questionData = null) {  
    const container = document.getElementById('fpCustomQuestionsList');  
    const idx = customQuestionCounter++;  
      
    const questionDiv = document.createElement('div');  
    questionDiv.className = 'custom-question-item';  
    questionDiv.id = `customQ_${idx}`;  
    questionDiv.style.cssText = 'background:#fff; border:1px solid #e2e8f0; border-radius:6px; padding:10px; margin-bottom:8px;';  
      
    questionDiv.innerHTML = `  
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-start;">  
        <div style="flex:2; min-width:200px;">  
          <label style="font-size:12px; color:#374151;">نص السؤال</label>  
          <input type="text" class="cq-label" placeholder="مثال: هل يوجد لديك دفعة مقدمة؟" value="${questionData?.label || ''}" style="width:100%;" />  
        </div>  
        <div style="flex:1; min-width:120px;">  
          <label style="font-size:12px; color:#374151;">نوع الإجابة</label>  
          <select class="cq-type" style="width:100%;">  
            <option value="text" ${questionData?.type==='text'?'selected':''}>نص</option>  
            <option value="number" ${questionData?.type==='number'?'selected':''}>رقم</option>  
            <option value="select" ${questionData?.type==='select'?'selected':''}>اختيار</option>  
          </select>  
        </div>  
        <div style="flex:1; min-width:150px;" class="cq-options-container" ${questionData?.type!=='select'?'style="display:none;"':''}>  
          <label style="font-size:12px; color:#374151;">الخيارات (مفصولة بفاصلة)</label>  
          <input type="text" class="cq-options" placeholder="نعم,لا" value="${questionData?.options?.join(',') || ''}" style="width:100%;" />  
        </div>  
        <div style="display:flex; align-items:flex-end;">  
          <button type="button" onclick="removeCustomQuestion(${idx})" style="background:#ef4444; color:#fff; border:none; border-radius:4px; padding:6px 10px; cursor:pointer;">❌</button>  
        </div>  
      </div>  
    `;  
      
    container.appendChild(questionDiv);  
      
    // إظهار/إخفاء حقل الخيارات حسب النوع  
    const typeSelect = questionDiv.querySelector('.cq-type');  
    const optionsContainer = questionDiv.querySelector('.cq-options-container');  
    typeSelect.addEventListener('change', function() {  
      optionsContainer.style.display = this.value === 'select' ? 'block' : 'none';  
    });  
  }  
    
  function removeCustomQuestion(idx) {  
    const el = document.getElementById(`customQ_${idx}`);  
    if(el) el.remove();  
  }  
    
  function getCustomQuestionsFromForm() {  
    const questions = [];  
    const items = document.querySelectorAll('.custom-question-item');  
    items.forEach(item => {  
      const label = item.querySelector('.cq-label')?.value?.trim();  
      const type = item.querySelector('.cq-type')?.value || 'text';  
      const optionsStr = item.querySelector('.cq-options')?.value?.trim();  
        
      if(label) {  
        const q = { label, type };  
        if(type === 'select' && optionsStr) {  
          q.options = optionsStr.split(',').map(o => o.trim()).filter(o => o);  
        }  
        questions.push(q);  
      }  
    });  
    return questions;  
  }  
  
  function saveFinanceProduct(e){  
    e.preventDefault();  
      
    // الحصول على جهة التمويل  
    let financeEntity = (document.getElementById('fpFinanceEntity')?.value || '').trim();  
    const newEntityName = (document.getElementById('fpNewEntityName')?.value || '').trim();  
      
    // إذا اختار "جهة جديدة" وأدخل اسماً  
    if (financeEntity === 'جهة جديدة' && newEntityName) {  
      financeEntity = newEntityName;  
      // حفظ الجهة الجديدة في localStorage  
      const customBanks = JSON.parse(localStorage.getItem('fino_custom_banks') || '[]');  
      if (!customBanks.some(b => b.name === newEntityName)) {  
        customBanks.push({ name: newEntityName, type: 'custom', createdAt: new Date().toISOString() });  
        localStorage.setItem('fino_custom_banks', JSON.stringify(customBanks));  
        // تحديث قوائم البنوك  
        if (typeof updateAllBankDropdowns === 'function') updateAllBankDropdowns();  
      }  
    }  
      
    const name = (document.getElementById('fpName').value || '').trim();  
    const enabled = (document.getElementById('fpEnabled').value === 'true');  
    const message = (document.getElementById('fpMessage').value || '').trim();  
    const deductionRate = parseFloat(document.getElementById('fpDeductionRate').value) || 0;  
    const customQuestions = getCustomQuestionsFromForm();  
    const editIndex = document.getElementById('fpEditIndex').value;  
  
    if(!financeEntity || financeEntity === 'جهة جديدة'){  
      alert('فضلاً اختر جهة التمويل.');  
      return;  
    }  
      
    if(!name){  
      alert('فضلاً أدخل اسم المنتج.');  
      return;  
    }  
  
    const item = { name, financeEntity, enabled, message, deductionRate, customQuestions };  
  
    if(editIndex === ''){  
      // منع تكرار نفس الاسم  
      const exists = financeProducts.some(x=>x.name===name);  
      if(exists){  
        alert('هذا المنتج موجود مسبقاً. عدّله بدل الإضافة.');  
        return;  
      }  
      financeProducts.push(item);  
    }else{  
      financeProducts[parseInt(editIndex)] = item;  
    }  
  
    saveFinanceProducts();  
    // مزامنة مع النظام الديناميكي  
    localStorage.setItem('finoProducts', JSON.stringify(financeProducts));  
      
    renderFinanceProductsTable();  
    clearFinanceProductForm();  
      
    // تحديث الأسئلة والقوائم  
    if (typeof updateAllBankDropdowns === 'function') updateAllBankDropdowns();  
  }  
  
  function renderFinanceProductsTable(){  
    const tbody = document.querySelector('#financeProductsTable tbody');  
    if(!tbody) return;  
    tbody.innerHTML = '';  
      
    // استخدام المنتجات الديناميكية إذا وجدت  
    const products = (typeof loadDynamicProducts === 'function') ? loadDynamicProducts() : (financeProducts || []);  
      
    products.forEach((p, idx)=>{  
      const tr = document.createElement('tr');  
      const questionsCount = (p.customQuestions && p.customQuestions.length) ? p.customQuestions.length : 0;  
      const deductionDisplay = p.deductionRate ? `${p.deductionRate}%` : '-';  
      const entityDisplay = p.financeEntity || 'غير محدد';  
      tr.innerHTML = `  
        <td style="font-size:12px;">${escapeHtml(entityDisplay)}</td>  
        <td>${escapeHtml(p.name || '')}</td>  
        <td>${p.enabled ? '✅ مفعّل' : '❌ غير مفعّل'}</td>  
        <td style="text-align:center;">${deductionDisplay}</td>  
        <td style="text-align:center;">${questionsCount > 0 ? `📝 ${questionsCount}` : '-'}</td>  
        <td>  
          <button class="secondary small" style="padding:4px 8px; font-size:12px;" onclick="editFinanceProduct(${idx})">✏️</button>  
          <button class="secondary small" style="padding:4px 8px; font-size:12px;" onclick="deleteFinanceProduct(${idx})">🗑️</button>  
        </td>  
      `;  
      tbody.appendChild(tr);  
    });  
  }  
  
  function editFinanceProduct(idx){  
    const p = financeProducts[idx];  
    if(!p) return;  
      
    // تحميل جهة التمويل  
    const entitySelect = document.getElementById('fpFinanceEntity');  
    const newEntityInput = document.getElementById('fpNewEntityName');  
    if (entitySelect) {  
      // التحقق من وجود الجهة في القائمة  
      const entityExists = Array.from(entitySelect.options).some(opt => opt.value === p.financeEntity);  
      if (entityExists) {  
        entitySelect.value = p.financeEntity || '';  
        if (newEntityInput) newEntityInput.style.display = 'none';  
      } else if (p.financeEntity) {  
        // الجهة مخصصة - إضافتها للقائمة  
        const newOpt = document.createElement('option');  
        newOpt.value = p.financeEntity;  
        newOpt.textContent = p.financeEntity;  
        entitySelect.insertBefore(newOpt, entitySelect.lastElementChild);  
        entitySelect.value = p.financeEntity;  
        if (newEntityInput) newEntityInput.style.display = 'none';  
      }  
    }  
      
    document.getElementById('fpName').value = p.name || '';  
    document.getElementById('fpEnabled').value = p.enabled ? 'true' : 'false';  
    document.getElementById('fpMessage').value = p.message || '';  
    document.getElementById('fpDeductionRate').value = p.deductionRate || '';  
    document.getElementById('fpEditIndex').value = idx;  
      
    // تحميل الأسئلة المخصصة  
    document.getElementById('fpCustomQuestionsList').innerHTML = '';  
    customQuestionCounter = 0;  
    if(p.customQuestions && p.customQuestions.length > 0) {  
      p.customQuestions.forEach(q => addCustomQuestionField(q));  
    }  
  }  
  
  function deleteFinanceProduct(idx){  
    if(!confirm('هل أنت متأكد من حذف هذا المنتج؟')) return;  
    financeProducts.splice(idx, 1);  
    saveFinanceProducts();  
    // مزامنة مع النظام الديناميكي  
    localStorage.setItem('finoProducts', JSON.stringify(financeProducts));  
      
    renderFinanceProductsTable();  
      
    // تحديث الأسئلة والقوائم  
    if (typeof updateAllBankDropdowns === 'function') updateAllBankDropdowns();  
  }  
  
  // ====== (إضافة) إعدادات تقديرية للتقاعد (معامل) ======  
  const RET_SETTINGS_KEY = 'stRetirementSettings';  
  let retirementSettings = { basicMultiplier: 1.00 };  
  
  function loadRetirementSettings(){  
    try{  
      const s = localStorage.getItem(RET_SETTINGS_KEY);  
      if(s){  
        const obj = JSON.parse(s);  
        if(obj && typeof obj.basicMultiplier === 'number'){  
          retirementSettings = obj;  
        } else {  
          retirementSettings = { basicMultiplier: 1.00 };  
        }  
      } else {  
        retirementSettings = { basicMultiplier: 1.00 };  
        localStorage.setItem(RET_SETTINGS_KEY, JSON.stringify(retirementSettings));  
      }  
    }catch(e){  
      retirementSettings = { basicMultiplier: 1.00 };  
    }  
  }  
  
  function loadRetirementSettingsToUI(){  
    const el = document.getElementById('retBasicMultiplier');  
    if(!el) return;  
    el.value = (retirementSettings.basicMultiplier ?? 1.00).toFixed(2);  
  }  
  
  function saveRetirementSettings(){  
    const el = document.getElementById('retBasicMultiplier');  
    if(!el) return;  
    const v = parseFloat(el.value || '1');  
    if(!isFinite(v) || v <= 0){  
      alert('قيمة المعامل غير صحيحة.');  
      return;  
    }  
    retirementSettings.basicMultiplier = v;  
    localStorage.setItem(RET_SETTINGS_KEY, JSON.stringify(retirementSettings));  
    alert('تم حفظ الإعداد ✅');  
  }  
  
  // ====== أرشيف النتائج (LocalStorage) ======  
  function loadArchive(){  
    try{  
      const s = localStorage.getItem('stClientArchive');  
      if(!s) return [];  
      const a = JSON.parse(s);  
      return Array.isArray(a) ? a : [];  
    }catch(e){ return []; }  
  }  
  function saveArchive(list){  
    localStorage.setItem('stClientArchive', JSON.stringify(list || []));  
  }  
  
  function saveCurrentResultToArchive(){  
    const key = (document.getElementById('archiveKeyInput').value || '').trim();  
    if(!key){  
      alert('فضلاً أدخل رقم الجوال أو السجل المدني.');  
      return;  
    }  
    const lc = answers._lastCalc;  
    if(!lc){  
      alert('لا توجد نتيجة للحفظ.');  
      return;  
    }  
  
    // لو فيه "نتيجة للعميل" تم إنشاؤها، نخزنها كذلك  
    const clientText = (document.getElementById('clientResultText') && document.getElementById('clientResultText').value.trim())  
      ? document.getElementById('clientResultText').value.trim()  
      : (lc._lastClientText || '');  
  
    const rec = {  
      id: Date.now(),  
      key: key,  
      clientName: lc.clientName || '',  
      financeType: lc.financeType || '',  
      calcDateTimeStr: lc.calcDateTimeStr || '',  
      recommendedBankName: lc.recommendedBankName || '',  
      real: lc,  
      clientText: clientText || '',  
    };  
  
    const list = loadArchive();  
    list.unshift(rec);  
    saveArchive(list);  
  
    document.getElementById('archiveSaveMsg').style.display = 'block';  
    document.getElementById('archiveSaveMsg').textContent = 'تم الحفظ بالأرشيف ✅';  
    renderArchiveTable();  
  }  
  
  function renderArchiveTable(){  
    const table = document.querySelector('#archiveTable tbody');  
    if(!table) return;  
    table.innerHTML = '';  
    const q = (document.getElementById('archiveSearch')?.value || '').trim();  
    const list = loadArchive().filter(r=>{  
      if(!q) return true;  
      return (String(r.key||'').includes(q));  
    });  
  
    list.forEach((r, idx)=>{  
      const tr = document.createElement('tr');  
      const hasExtended = r.real && r.real.extended;  
      const hasFormula = r.real && r.real.retirementFormula;  
      tr.innerHTML = `  
        <td>${escapeHtml(r.key || '')}</td>  
        <td>${escapeHtml(r.clientName || '')}</td>  
        <td>${escapeHtml(r.financeType || '')}</td>  
        <td>${escapeHtml(r.calcDateTimeStr || '')}</td>  
        <td>${escapeHtml(r.recommendedBankName || '')}</td>  
        <td>${hasExtended ? '<span style="color:#047857;">\u2705 نعم</span>' : '<span style="color:#6b7280;">-</span>'}</td>  
        <td>  
          <button class="btn small secondary" onclick="viewArchiveRecord(${idx})">عرض</button>  
          ${hasFormula ? `<button class="btn small secondary" onclick="showRetirementFormula(${idx})">📊 معادلة</button>` : ''}  
          <button class="btn small secondary" onclick="deleteArchiveRecord(${idx})">حذف</button>  
        </td>  
      `;  
      table.appendChild(tr);  
    });  
  }  
  
  function showRetirementFormula(indexFiltered){  
    const q = (document.getElementById('archiveSearch')?.value || '').trim();  
    const all = loadArchive();  
    const filtered = all.filter(r=> !q || String(r.key||'').includes(q));  
    const rec = filtered[indexFiltered];  
    if(!rec || !rec.real || !rec.real.retirementFormula) return;  
      
    alert('📊 معادلة حساب راتب التقاعد:\n\n' + rec.real.retirementFormula);  
  }  
  
  function deleteArchiveRecord(indexFiltered){  
    const q = (document.getElementById('archiveSearch')?.value || '').trim();  
    const all = loadArchive();  
    const filtered = all.filter(r=> !q || String(r.key||'').includes(q));  
    const rec = filtered[indexFiltered];  
    if(!rec) return;  
    if(!confirm('متأكد من حذف هذه النتيجة من الأرشيف؟')) return;  
    const newAll = all.filter(x => x.id !== rec.id);  
    saveArchive(newAll);  
    renderArchiveTable();  
  }  
  
  function viewArchiveRecord(indexFiltered){  
    const q = (document.getElementById('archiveSearch')?.value || '').trim();  
    const all = loadArchive();  
    const filtered = all.filter(r=> !q || String(r.key||'').includes(q));  
    const rec = filtered[indexFiltered];  
    if(!rec) return;  
  
    // نعرضها داخل نافذة "نتيجة للعميل" + نضع النص المرسل إن وجد  
    const lc = rec.real;  
    answers._lastCalc = lc;  
  
    openClientResultModal(true);  
  
    setTimeout(()=>{  
      if(rec.clientText){  
        document.getElementById('clientResultText').value = rec.clientText;  
        _clientResultTextCache = rec.clientText;  
        renderClientPreviewFromText(rec.clientText);  
      } else {  
        // إذا ما فيه نص مرسل، ننشئ من النتيجة الحقيقة  
        generateClientResultText();  
      }  
        
      // عرض معادلة حساب التقاعد للمسؤول (إذا وجدت)  
      if(lc && lc.retirementFormula){  
        alert('📊 معادلة حساب التقاعد:\n\n' + lc.retirementFormula);  
      }  
    }, 200);  
  }  
  
  function escapeHtml(s){  
    return String(s||'')  
      .replace(/&/g,'&amp;')  
      .replace(/</g,'&lt;')  
      .replace(/>/g,'&gt;')  
      .replace(/"/g,'&quot;')  
      .replace(/'/g,'&#39;');  
  }  
  
  // ====== (إضافة) قراءة التاريخ الهجري (أم القرى) ======  
  function getHijriNowParts(){  
    try{  
      const fmt = new Intl.DateTimeFormat('en-US-u-ca-islamic-umalqura', {year:'numeric', month:'numeric', day:'numeric'});  
      const parts = fmt.formatToParts(new Date());  
      const y = parseInt(parts.find(p=>p.type==='year')?.value || '0', 10);  
      const m = parseInt(parts.find(p=>p.type==='month')?.value || '0', 10);  
      const d = parseInt(parts.find(p=>p.type==='day')?.value || '0', 10);  
      return {y, m, d};  
    }catch(e){  
      // fallback تقريبي  
      return {y:1446, m:1, d:1};  
    }  
  }  
  
  function getHijriNowDisplay(){  
    try{  
      const fmt = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura', {year:'numeric', month:'2-digit', day:'2-digit'});  
      return fmt.format(new Date());  
    }catch(e){  
      return '';  
    }  
  }  
  
  function monthsDiffHijri(fromY,fromM,fromD,toY,toM,toD){  
    let months = (toY*12 + toM) - (fromY*12 + fromM);  
    if(toD < fromD) months -= 1;  
    return Math.max(0, months);  
  }  
  
  // ====== جدول الرواتب العسكرية الرسمي ======  
  const militarySalaryTable = {  
    // الضباط  
    'ملازم': { allowance: 380, salaries: [7590,7970,8350,8730,9110,9490,9870,10250,10630,11010,11390,11770,12150,12530,12910] },  
    'ملازم أول': { allowance: 440, salaries: [8835,9275,9715,10155,10595,11035,11475,11915,12355,12795,13235,13675,14115,14555,14995] },  
    'نقيب': { allowance: 495, salaries: [10600,11095,11590,12085,12580,13075,13570,13835,14100,14365,14630,14895,15160,15425,15690] },  
    'رائد': { allowance: 265, salaries: [13515,13780,14045,14310,14575,14840,15105,15370,15635,15900,16165,16430,16695,16960,17225] },  
    'مقدم': { allowance: 470, salaries: [14645,15115,15585,16055,16525,16995,17465,17935,18405,18875,19345,19815,20285,20755] },  
    'عقيد': { allowance: 590, salaries: [16520,17110,17700,18290,18880,19470,20060,20650,21240,21830,22420,23010,23600] },  
    'عميد': { allowance: 650, salaries: [18800,19450,20100,20750,21400,22050,22700,23350,24000,24650,25300,25950] },  
    'لواء': { allowance: 730, salaries: [21390,22120,22850,23580,24310,25040,25770,26500,27230,27960,28690] },  
    // الأفراد  
    'جندي': { allowance: 130, salaries: [3220,3350,3480,3610,3740,3870,4000,4130,4260,4390,4520,4650,4780,4910,5040] },  
    'جندي أول': { allowance: 145, salaries: [3395,3540,3685,3830,3975,4120,4265,4410,4555,4700,4845,4990,5135,5280,5425] },  
    'عريف': { allowance: 175, salaries: [3765,3940,4115,4290,4465,4640,4815,4990,5165,5340,5515,5690,5865,6040,6215] },  
    'وكيل رقيب': { allowance: 210, salaries: [4455,4665,4875,5085,5295,5505,5715,5925,6135,6345,6555,6765,6975,7185,7395] },  
    'رقيب': { allowance: 250, salaries: [5260,5510,5760,6010,6260,6510,6760,7010,7260,7510,7760,8010,8260,8510,8760] },  
    'رقيب أول': { allowance: 300, salaries: [6180,6480,6780,7080,7380,7680,7980,8280,8580,8880,9180,9480,9780,10080,10380] },  
    'رئيس رقباء': { allowance: 360, salaries: [7215,7575,7935,8295,8655,9015,9375,9735,10095,10455,10815,11175,11535,11895,12255] }  
  };  
  
  // ====== أسئلة الحاسبة ======  
  let answers = { commitments: [] }, step = 0, commitmentStep = 0, currentCommitment = {};  
  let hasStarted = false;  
  
  let generalQuestions = [  
    { id:'clientName',label:'تعرفنا بأسمك  ',type:'text' },  
    { id:'birthDate',label:'تاريخ الميلاد هجري\u2728',type:'birthdate' },  
    { id:'jobType',label:'نوع الوظيفة',type:'select',options: function() { return typeof getJobTypeOptions === 'function' ? getJobTypeOptions() : ['حكومي', 'عسكري', 'قطاع خاص', 'متقاعد']; } },  
    {  
      id:'militaryRank',  
      label:'اذكر الرتبة العسكرية',  
      type:'select',  
      options:[  
        'جندي','جندي أول','عريف','وكيل رقيب','رقيب','رقيب أول',  
        'رئيس رقباء','ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء'  
      ],  
      show:a=>a.jobType==='عسكري' && isQuestionEnabledForProduct('militaryRank', a.financeType)  
    },  
    {  
      id:'financeType',  
      label:'اختر نوع التمويل تريد حسبته:',  
      type:'select',  
      options: loadDynamicProducts  
    },  
    {  
      id:'mortgageProductType',  
      label:'نوع التمويل العقاري',  
      type:'select',  
      options:[  
        'وحدة جاهزة من السوق',  
        'بناء ذاتي',  
        'مشاريع الخارطة',  
        'تحت الانشاء (بيت تملكه عظم)',  
        'ارض وقرض (ارض وبناء ذاتي)',  
        'ارض (سكنية)',  
        'رهن'  
      ],  
      show:a=>a.financeType==='تمويل عقاري'  
    },  
    { id:'supported',label:'هل التمويل مدعوم؟',type:'select',options:['مدعوم','غير مدعوم'],  
      show:a=>a.financeType==='تمويل عقاري' && ['وحدة جاهزة من السوق','بناء ذاتي','مشاريع الخارطة','تحت الانشاء (بيت تملكه عظم)','ارض وقرض (ارض وبناء ذاتي)'].includes(a.mortgageProductType)  
    },  
    {  
      id:'isEtezaaz',  
      label:'هل أنت من منسوبي وزارة الدفاع (مؤهل لبرنامج اعتزاز)؟',  
      type:'select',  
      options:['نعم','لا'],  
      show:a=>a.financeType==='تمويل عقاري' && a.supported==='مدعوم' && a.jobType==='عسكري'  
    },  
    { id:'bundle',label:'هل ترغب في دفعة مقدمة من سكني؟',type:'select',options:['نعم','لا'],show:a=>a.supported==='مدعوم' },  
      
    /* (إضافة) أسئلة ديناميكية حسب نوع المنتج العقاري */  
    {  
      id:'propertyValue',  
      label:'كم قيمة العقار الذي تحتاجه؟ (ريال)',  
      type:'number',  
      show:a=>a.financeType==='تمويل عقاري' && ['وحدة جاهزة من السوق','مشاريع الخارطة','تحت الانشاء (بيت تملكه عظم)'].includes(a.mortgageProductType)  
    },  
    {  
      id:'landValue',  
      label:'كم قيمة الأرض التي تحتاجها؟ (ريال)',  
      type:'number',  
      show:a=>a.financeType==='تمويل عقاري' && a.mortgageProductType==='ارض (سكنية)'  
    },  
    {  
      id:'buildingCost',  
      label:'كم تكلفة البناء المتوقعة؟ (ريال)',  
      type:'number',  
      show:a=>a.financeType==='تمويل عقاري' && ['بناء ذاتي','ارض وقرض (ارض وبناء ذاتي)'].includes(a.mortgageProductType)  
    },  
    {  
      id:'hasDownPayment',  
      label:'هل لديك دفعة مقدمة خاصة بك؟',  
      type:'select',  
      options:['نعم','لا'],  
      show:a=>a.financeType==='تمويل عقاري' && ['ارض (سكنية)','وحدة جاهزة من السوق','مشاريع الخارطة'].includes(a.mortgageProductType)  
    },  
    {  
      id:'downPaymentPercent',  
      label:'كم نسبة الدفعة المقدمة؟ (%)',  
      type:'select',  
      options:['10%','15%','20%','25%','30%','35%','40%','50%'],  
      show:a=>a.hasDownPayment==='نعم'  
    },  
    {  
      id:'mortgageValue',  
      label:'كم قيمة العقار المرهون؟ (ريال)',  
      type:'number',  
      show:a=>a.financeType==='تمويل عقاري' && a.mortgageProductType==='رهن'  
    },  
      
    { id:'salary',label:'كم الراتب الشهري الصافي؟',type:'number' },  
  
    /* (إضافة) دمج الدعم الشهري مع الراتب + استقطاع 65% */  
    {  
      id:'includeSupportInSalary',  
      label:'هل تريد إضافة الدعم الشهري على الراتب (للاحتساب)؟',  
      type:'select',  
      options:['نعم','لا'],  
      show:a=>{  
        const sal = parseFloat(a.salary || '0');  
        return (a.financeType==='تمويل عقاري' && a.supported==='مدعوم' && a.bundle==='لا' && sal > 0 && sal < 15000);  
      }  
    },  
  
    /* (إضافة) سؤال الجهة الحكومية للموظف المدني */  
    {  
      id:'governmentEntity',  
      label:'اختر الجهة الحكومية',  
      type:'select',  
      options:[  
        'وزارة التعليم - معلم',  
        'وزارة التعليم - إداري',  
        'وزارة الصحة',  
        'وزارة الداخلية - مدني',  
        'وزارة المالية',  
        'وزارة العدل',  
        'وزارة الموارد البشرية',  
        'وزارة الشؤون البلدية',  
        'الجامعات',  
        'المؤسسات الحكومية',  
        'جهة أخرى'  
      ],  
      show:a=>a.jobType==='حكومي'  
    },  
      
    /* (إضافة) التمويل الممتد للعسكري */  
    {  
      id:'extendAfterRetirement',  
      label:'هل تريد التمويل على الممتد بعد التقاعد حتى عمر 60 سنة؟',  
      type:'select',  
      options:['نعم','لا'],  
      show:a=>{  
        if(a.jobType!=='عسكري') return false;  
        if(!a.militaryRank) return false;  
        const ft = a.financeType || '';  
        const allowed = (ft==='تمويل عقاري' || ft==='تمويل شخصي' || ft==='تمويل التأجيري' || ft==='شراء مديونية تمويل شخصي');  
        if(!allowed) return false;  
  
        const info = getMilitaryTimingInfoFromAnswers(a);  
        // شرطك: أقل من 25 سنة على التقاعد + وفيه تمديد إلى 60  
        return (info.rankRemainingMonths > 0 && info.rankRemainingMonths <= (25*12) && info.monthsTo60 > info.rankRemainingMonths) && isQuestionEnabledForProduct('extendAfterRetirement', a.financeType);  
      }  
    },  
    { id:'appointDate',label:'تاريخ التعيين (هجري)✨',type:'appointdate', show:a=>a.extendAfterRetirement==='نعم' && a.jobType==='عسكري' },  
      
    /* (إضافة) التمويل الممتد للمدني والقطاع الخاص */  
    {  
      id:'extendAfterRetirementCivil',  
      label:'هل تريد التمويل على الممتد بعد التقاعد؟',  
      type:'select',  
      options:['نعم','لا'],  
      show:a=>{  
        // يظهر فقط للمدني والقطاع الخاص (ليس العسكري ولا المتقاعد)  
        if(a.jobType==='عسكري' || a.jobType==='متقاعد') return false;  
        if(!a.jobType) return false;  
          
        // يظهر فقط إذا كان العميل سيتقاعد قبل انتهاء أقصى مدة للمنتج  
        // ويوجد بنك يدعم عمر أكثر من 60 سنة  
        const ft = a.financeType || '';  
        const allowed = (ft==='تمويل عقاري' || ft==='تمويل شخصي' || ft==='تمويل التأجيري');  
        if(!allowed) return false;  
          
        // التحقق من العمر وسنوات التقاعد  
        const by = parseInt(a.birthYear || '0', 10);  
        if(!by) return false;  
          
        const nowH = getHijriNowParts();  
        const currentAge = nowH.y - by;  
        const yearsToRetirement = 60 - currentAge; // سن التقاعد المدني 60 سنة  
          
        // يظهر إذا كان سيتقاعد خلال 25 سنة ويوجد بنوك تدعم عمر أكثر من 60  
        return (yearsToRetirement > 0 && yearsToRetirement <= 25 && checkBanksSupport65()) && isQuestionEnabledForProduct('extendAfterRetirement', a.financeType);  
      }  
    },  
    { id:'appointDateCivil',label:'تاريخ التعيين (هجري)',type:'appointdate', show:a=>a.extendAfterRetirementCivil==='نعم' },  
  
    { id:'months',label:'على كم شهر تريد التمويل؟',type:'select',options:[],dynamic:true },  
    { id:'calcMode',label:'كيف تفضّل اختيار النسبة؟',type:'select',options:['أدخل النسبة بنفسي','نسبة على جهة تمويل معينة','ترشيح بنك مناسب تلقائياً'] },  
    { id:'profitMargin',label:'نسبة هامش الربح السنوي (%)؟',type:'number',show:a=>a.calcMode==='أدخل النسبة بنفسي' },  
    /* سؤال البنك - يظهر فقط عند اختيار "أدخل النسبة بنفسي" */  
    {  
      id:'currentBank',  
      label:'اذكر البنك الذي عليه هذه النسبة',  
      type:'select',  
      options:[  
        // البنوك المحلية  
        'البنك الأهلي السعودي',  
        'مصرف الراجحي',  
        'بنك الرياض',  
        'بنك ساب',  
        'البنك العربي الوطني',  
        'مصرف الإنماء',  
        'البنك السعودي الفرنسي',  
        'البنك السعودي للاستثمار',  
        'بنك البلاد',  
        'بنك الجزيرة',  
        'البنك السعودي الأول',  
        'بنك الخليج الدولي',  
        // البنوك الرقمية  
        'بنك STC',  
        'بنك D360',  
        'بنك فيجن',  
        // فروع البنوك الأجنبية  
        'بنك الإمارات دبي الوطني',  
        'بنك المشرق',  
        'بنك HSBC',  
        'بنك Citibank',  
        // شركات التمويل  
        'عبداللطيف جميل للتمويل',  
        'شركة تسهيل',  
        'شركة نايفات',  
        'شركة اليسر',  
        'دويتشه الخليج للتمويل',  
        'شركة أملاك العالمية',  
        'شركة دار التمليك',  
        'شركة بداية للتمويل',  
        'شركة كوارا للتمويل',  
        'شركة إمكان للتمويل',  
        'شركة الأمثل للتمويل',  
        'شركة الأولى للتمويل',  
        'بنك آخر'  
      ],  
      show:a=>a.calcMode==='أدخل النسبة بنفسي'  
    },  
    /* سؤال جهة التمويل - يظهر عند اختيار "نسبة على جهة تمويل معينة" */  
    {  
      id:'selectedFinanceEntity',  
      label:'اختر جهة التمويل',  
      type:'financeEntitySelect',  
      show:a=>a.calcMode==='نسبة على جهة تمويل معينة'  
    },  
    {  
      id:'buyoutAmount',  
      label:'كم مبلغ التسديد المبكر للتمويل الشخصي الحالي (المديونية الحالية)؟',  
      type:'number',  
      show:a=>a.financeType==='شراء مديونية تمويل شخصي'  
    },  
    { id:'hasCommitments',label:'هل لديك التزامات؟',type:'select',options:['نعم','لا'], show:a=>isQuestionEnabledForProduct('hasCommitments', a.financeType) },
    
    /* (إضافة) سؤال القسط المرن المخفض - يظهر للتمويل العقاري المدعوم فقط إذا كان البنك يدعمه */
    {
      id:'wantFlexibleInstallment',
      label:'هل ترغب في القسط المرن المخفض؟ (تخفيض القسط لفترة محددة)',
      type:'select',
      options:['لا','نعم'],
      show:a=>a.financeType==='تمويل عقاري' && a.supported==='مدعوم' && a.hasCommitments==='نعم' && a.bankSupportsFlexible === true && isQuestionEnabledForProduct('wantFlexibleInstallment', a.financeType)
    },
    {
      id:'flexibleInstallmentAmount',
      label:'حدد مبلغ القسط المخفض (ريال)',
      type:'flexibleAmountSelect',
      show:a=>a.wantFlexibleInstallment==='نعم'
    },
    {
      id:'flexibleInstallmentMonths',
      label:'كم مدة القسط المخفض؟ (بالشهور)',
      type:'select',
      options:['12','24','36','48','60'],
      show:a=>a.wantFlexibleInstallment==='نعم'
    },
  ];  
  
  const commitmentQuestions = [  
    { id:'type',label:'نوع الالتزام',type:'select',options:['قرض شخصي','قرض سيارة','قرض استهلاكي','قرض عقاري'] },  
    { id:'amount',label:'كم القسط الشهري؟',type:'number' },  
    { id:'months',label:'كم عدد الأشهر المتبقية؟',type:'select',options:[],dynamic:true },  
    { id:'balloon',label:'هل يوجد دفعة أخيرة (لقرض السيارة)؟',type:'select',options:['نعم','لا'],show:c=>c.type==='قرض سيارة' },  
    { id:'balloonAmount',label:'كم مبلغ الدفعة الأخيرة؟',type:'number',show:c=>c.balloon==='نعم' },  
    { id:'more',label:'هل لديك التزامات أخرى؟',type:'select',options:['نعم','لا'] }  
  ];  
  
  // دالة تحميل المنتجات الديناميكية من localStorage  
  function loadDynamicProducts() {  
    // المنتجات الافتراضية  
    const defaultProducts = [  
      { name: 'تمويل شخصي', enabled: true },  
      { name: 'تمويل استهلاكي', enabled: true },  
      { name: 'تمويل التأجيري', enabled: true },  
      { name: 'تمويل عقاري', enabled: true },  
      { name: 'شراء مديونية تمويل شخصي', enabled: true },  
      { name: 'شراء مديونية تمويل عقاري', enabled: true },  
      { name: 'بطاقات الإتمان', enabled: true },  
      { name: 'تمويل نقاط البيع', enabled: true },  
      { name: 'تمويل المؤسسات', enabled: true },  
      { name: 'تمويل الأسطول', enabled: true },  
      { name: 'مفوتر', enabled: true }  
    ];  
      
    // تحميل المنتجات المخصصة من localStorage  
    const customProducts = JSON.parse(localStorage.getItem('finoProducts') || '[]');  
    const financeProducts = JSON.parse(localStorage.getItem('fino_finance_products') || '[]');  
      
    // دمج المنتجات  
    const allProducts = [...defaultProducts];  
      
    // إضافة المنتجات المخصصة  
    customProducts.forEach(p => {  
      if (!allProducts.some(dp => dp.name === p.name)) {  
        allProducts.push({ name: p.name, enabled: p.enabled !== false });  
      }  
    });  
      
    financeProducts.forEach(p => {  
      if (!allProducts.some(dp => dp.name === p.name)) {  
        allProducts.push({ name: p.name, enabled: p.enabled !== false });  
      }  
    });  
      
    // تحويل المنتجات إلى صيغة الخيارات المطلوبة  
    return allProducts.filter(p => p.enabled !== false).map(p => ({  
      value: p.name,  
      label: p.name  
    }));  
  }  
  
  function getRetirementAge(rank) {  
    const retirementAges = {  
      'جندي': 44,'جندي أول': 44,'عريف': 46,'وكيل رقيب': 48,'رقيب': 50,'رقيب أول': 50,  
      'رئيس رقباء': 52,'ملازم': 44,'ملازم أول': 44,'نقيب': 48,'رائد': 50,'مقدم': 52,  
      'عقيد': 54,'عميد': 56,'لواء': 58  
    };  
    return retirementAges[rank] || 60;  
  }  
  
  // (إضافة) حساب معلومات التقاعد/الـ60 من إجابات العميل (هجري)  
  function getMilitaryTimingInfoFromAnswers(a){  
    const nowH = getHijriNowParts();  
    const by = parseInt(a.birthYear || '0', 10);  
    const bm = parseInt(a.birthMonth || '0', 10);  
    const bd = parseInt(a.birthDay || '0', 10);  
  
    const rankAge = getRetirementAge(a.militaryRank || 'جندي');  
    const retY = by + rankAge;  
    const retM = bm;  
    const retD = bd;  
  
    const y60 = by + 60;  
    const m60 = bm;  
    const d60 = bd;  
  
    const rankRemainingMonths = monthsDiffHijri(nowH.y, nowH.m, nowH.d, retY, retM, retD);  
    const monthsTo60 = monthsDiffHijri(nowH.y, nowH.m, nowH.d, y60, m60, d60);  
  
    return {  
      nowH,  
      birth:{y:by,m:bm,d:bd},  
      rankAge,  
      rankRemainingMonths,  
      monthsTo60,  
      rankRetHijriStr: `${retY}/${String(retM).padStart(2,'0')}/${String(retD).padStart(2,'0')}`  
    };  
  }  
  
  // التحقق من وجود بنوك تدعم عمر أكثر من 60 (للتمويل الممتد)  
  function checkBanksSupport65() {  
    // هذه الدالة تتحقق من وجود بنوك في النظام تدعم عمر أكثر من 60  
    // حالياً نرجع true لأن العقاري يدعم حتى 65-70 سنة  
    return true;  
  }  
    
  function getMaxAllowedMonths(){  
    const info = getMilitaryTimingInfoFromAnswers(answers);  
    const by = info.birth.y;  
    if(!by){ return 0; }  
  
    let maxAge = 60;  
  
    if(answers.jobType === 'عسكري'){  
      // افتراضياً على سن التقاعد حسب الرتبة  
      maxAge = info.rankAge;  
  
      // إذا اختار الممتد -> نسمح حتى 60  
      if(answers.extendAfterRetirement === 'نعم'){  
        maxAge = 60;  
      }  
    } else if(answers.jobType === 'حكومي' || answers.jobType === 'قطاع خاص'){  
      // سن التقاعد المدني 60 سنة  
      maxAge = 60;  
        
      // إذا اختار الممتد والتمويل عقاري -> نسمح حتى 65  
      if(answers.extendAfterRetirementCivil === 'نعم' && answers.financeType === 'تمويل عقاري'){  
        maxAge = 65;  
      }  
    }  
  
    // حساب أشهر متبقية بدقة هجرياً (حتى maxAge)  
    const retY = by + maxAge;  
    const retM = info.birth.m;  
    const retD = info.birth.d;  
    const remainingMonths = monthsDiffHijri(info.nowH.y, info.nowH.m, info.nowH.d, retY, retM, retD);  
  
    answers.retirementYearHijri = retY;  
  
    if(remainingMonths <= 0){  
      showSorryPage(answers.clientName || "العميل");  
      return 0;  
    }  
  
    const isPersonal = answers.financeType && (  
      answers.financeType.includes('شخصي') ||  
      answers.financeType === 'تمويل استهلاكي' ||  
      answers.financeType === 'تمويل التأجيري' ||  
      answers.financeType === 'شراء مديونية تمويل شخصي'  
    );  
  
    return Math.min(remainingMonths, isPersonal ? 60 : 360);  
  }  
  
  function describeMonths(m){  
    const y = Math.floor(m / 12), mo = m % 12;  
    let result = `${m} شهر`;  
    let yTxt = y === 1 ? "سنة واحدة" : y === 2 ? "سنتان" : y >= 3 && y <= 10 ? `${y} سنوات` : y > 10 ? `${y} سنة` : '';  
    let mTxt = mo === 1 ? "وشهر واحد" : mo === 2 ? "وشهرين" : mo >= 3 && mo <= 10 ? `و${mo} أشهر` : mo > 10 ? `و${mo} شهر` : '';  
    if (yTxt || mTxt) result += ` (${yTxt} ${mTxt})`;  
    return result.trim();  
  }  
  
  function numberToArabicWords(n){  
    if (n < 1000) return `${n} ريال`;  
    let parts = [];  
    if(n >= 1_000_000){  
      let mil = Math.floor(n / 1_000_000);  
      parts.push(mil === 1 ? "مليون" : mil === 2 ? "مليونان" : mil <= 10 ? `${mil} ملايين` : `${mil} مليون`);  
      n %= 1_000_000;  
    }  
    if(n >= 1000){  
      let th = Math.floor(n / 1000);  
      parts.push(th === 1 ? "ألف" : th === 2 ? "ألفان" : th <= 10 ? `${th} آلاف` : `${th} ألف`);  
      n %= 1000;  
    }  
    if(n > 0) parts.push(`${n}`);  
    return parts.join(" و ") + " ريال";  
  }  
  
  // دعم سكني شهري حسب الجدول (20 سنة = 240 شهر)  
  function getHousingSupportMonthlyBySalary(salary){  
    const s = Number(salary || 0);  
    if (s <= 3000) return 1350;  
    if (s <= 4000) return 1206;  
    if (s <= 5000) return 1073;  
    if (s <= 6000) return 955;  
    if (s <= 7000) return 850;  
    if (s <= 8000) return 757;  
    if (s <= 9000) return 673;  
    if (s <= 10000) return 599;  
    return 416; // أكثر من 10,000  
  }  
  
  function fmtMoney(n){  
    const x = Number(n || 0);  
    return x.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") + " ريال";  
  }  
  function safeNum(v){  
    const n = parseFloat(v);  
    return isNaN(n) ? null : n;  
  }  
  
  function showSorryPage(name){  
    showPage('calculator');  
    const cont = document.getElementById('question');  
    document.getElementById('nextButton').style.display = 'none';  
    cont.innerHTML = `<div class="fade-in alert-error">  
      <strong>معليش ${name}، يظهر إن عمرك تعدّى سن التقاعد المسموح للتمويل.</strong><br>  
      إذا كنت متقاعد تواصل معنا مباشرة على الجوال للاستفسار.  
    </div>`;  
  }  
  
  function handleStartOrReset(){  
    if(!hasStarted){  
      hasStarted = true;  
      document.getElementById('mainButton').style.display = 'none';  
      document.getElementById('resetButtonContainer').style.display = 'block';  
      document.getElementById('nextButton').style.display = 'inline-flex';  
      showQuestion();  
    }else{ resetCalc(); }  
  }  
  
  function resetCalc(){  
    answers = { commitments: [] };  
    step = 0;  
    commitmentStep = 0;  
    currentCommitment = {};  
    hasStarted = true;  
    document.getElementById('mainButton').style.display = 'none';  
    document.getElementById('resetButtonContainer').style.display = 'block';  
    document.getElementById('nextButton').style.display = 'inline-flex';  
    showQuestion();  
  }  
  
  function showComingSoonForProduct(productName){  
    const titleEl = document.getElementById('comingSoonTitle');  
    const textEl = document.getElementById('comingSoonText');  
  
    titleEl.textContent = productName || 'المنتج غير مفعّل حالياً';  
  
    const msg = getFinanceProductMessage(productName);  
    if(msg){  
      textEl.innerHTML = `${escapeHtml(msg)}<br><br>يمكنك اختيار نوع تمويل آخر للاحتساب.`;  
    } else if (productName === 'شراء مديونية تمويل عقاري') {  
      textEl.innerHTML = 'حالياً لا يوجد احتساب لشراء المديونية العقارية عبر هذه الحاسبة.<br>سيتم التحديث وإضافة الخدمة في الأسابيع القادمة إن شاء الله 🙏<br><br>يمكنك اختيار نوع تمويل آخر للاحتساب.';  
    } else {  
      textEl.innerHTML = 'نعتذر منك، قريباً سيتم تحديث نسب هذا المنتج في المنصة.<br>يمكنك اختيار احتساب تمويل آخر من خلال الزر أدناه.';  
    }  
    showPage('comingSoon');  
  }  
  
  function showQuestion(){  
    const cont = document.getElementById('question');  
    cont.innerHTML = '';  
    let q;  
  
    if(step < generalQuestions.length){  
      q = generalQuestions[step];  
  
      // (إضافة) فحص الأسئلة المخفية من قبل المسؤول  
      const customQ = loadCustomQuestions();  
      if(customQ.hidden && customQ.hidden.includes('general_' + step)){  
        // تخطي السؤال المخفي بدون حفظ الحالة (لأن الحالة محفوظة من السؤال السابق)  
        step++;  
        showQuestion();  
        return;  
      }  
  
      // (إضافة) استبدال خيارات نوع التمويل من لوحة المنتجات (بدون تغيير الشكل)  
      if(q.id === 'financeType'){  
        q.options = getFinanceProductNames();  
      }  
  
      if(q.show && !q.show(answers)){ step++; showQuestion(); return; }  
  
      // (إضافة) إذا المنتج غير مفعّل من لوحة المنتجات -> صفحة قريباً  
      if(q.id === 'salary'){  
        const ft = answers.financeType;  
        if(ft && !isFinanceProductEnabled(ft)){  
          showComingSoonForProduct(ft);  
          return;  
        }  
      }  
  
      if(q.id === 'salary' && (  
        answers.financeType === 'شراء مديونية تمويل عقاري' ||  
        answers.financeType === 'بطاقات الإتمان' ||  
        answers.financeType === 'تمويل نقاط البيع' ||  
        answers.financeType === 'تمويل المؤسسات' ||  
        answers.financeType === 'تمويل الأسطول'  
      )){  
        showComingSoonForProduct(answers.financeType);  
        return;  
      }  
  
      if(q.id === 'profitMargin' && answers.calcMode === 'ترشيح بنك مناسب تلقائياً'){  
        const list = getMatchingBanksForAnswers();  
        const rec = list[0];  
        if(rec){  
          answers.recommendedBank = rec;  
          answers.profitMargin = rec.margin;  
          step++;  
          showQuestion();  
          return;  
        } else {  
          alert('للاسف حسب بياناتك لايمكننا ترشيح بنك معيّن    ، سيتم استخدام النسبة التي تدخلها يدوياً.');  
        }  
      }  
    }else if(answers.hasCommitments === 'نعم'){  
      q = commitmentQuestions[commitmentStep];  
        
      // (إضافة) فحص أسئلة الالتزامات المخفية من قبل المسؤول  
      const customQCommit = loadCustomQuestions();  
      if(customQCommit.hidden && customQCommit.hidden.includes('commitment_' + commitmentStep)){  
        commitmentStep++;  
        showQuestion();  
        return;  
      }  
        
      if(q.show && !q.show(currentCommitment)){ commitmentStep++; showQuestion(); return; }  
    }else{  
      // إذا كان المستخدم أجاب بـ "لا" على سؤال الالتزامات - عرض سؤال التمويل المحدد إذا كان مفعلاً
      if(answers.hasCommitments === 'لا') {
        console.log('=== المستخدم أجاب بـ لا على الالتزامات ===');
        answers.commitments = []; // تعيين مصفوفة فارغة للالتزامات
        
        // فحص إذا كان سؤال التمويل المحدد مفعلاً لهذا المنتج
        if (isSpecificAmountEnabledForProduct(answers.financeType) && !answers.wantSpecificAmount) {
          showSpecificAmountQuestion();
          return;
        }
        
        document.getElementById('nextButton').style.display = 'none';
        calculate();
        return;
      }
      
      // فحص الأسئلة المخصصة للمنتجات  
      const productQuestions = loadProductQuestions();  
      const currentProduct = answers.financeType;  
      const selectedBank = answers.selectedFinanceEntity || answers.currentBank || '';  
      const clientJobType = answers.jobType || '';  
      const relevantQuestions = productQuestions.filter(pq => {  
        // فحص التفعيل  
        if (!pq.enabled) return false;  
        // فحص المنتج  
        if (pq.product !== 'all' && pq.product !== currentProduct) return false;  
        // فحص جهة التمويل المستهدفة  
        if (pq.target && pq.target !== 'all' && pq.target !== selectedBank) return false;  
        // فحص نوع الوظيفة  
        if (pq.jobType && pq.jobType !== 'all' && pq.jobType !== clientJobType) return false;  
        return true;  
      });  
        
      // التحقق من الأسئلة المخصصة التي لم تُجب بعد  
      if (!window.productQuestionStep) window.productQuestionStep = 0;  
        
      if (window.productQuestionStep < relevantQuestions.length) {  
        const pq = relevantQuestions[window.productQuestionStep];  
        q = {  
          id: pq.id,  
          label: pq.text,  
          type: pq.type,  
          options: pq.options  
        };  
        window.productQuestionStep++;  
      } else {  
        // إعادة تعيين العداد للمرة القادمة  
        window.productQuestionStep = 0;  
          
        document.getElementById('nextButton').style.display = 'none';  
        console.log('=== انتهت الأسئلة - سيتم استدعاء calculate() ===');  
        console.log('الإجابات النهائية:', answers);  
        calculate();  
        return;  
      }  
    }  
  
    const div = document.createElement('div');  
    div.classList.add('fade-in');  
    div.innerHTML = `<label>${q.label}</label>`;  
  
    if(q.type === 'birthdate'){  
      // تاريخ الميلاد في صفحة واحدة  
      const bdDiv = document.createElement('div');  
      bdDiv.style.cssText = 'display:flex;gap:10px;justify-content:center;flex-wrap:wrap;';  
        
      // اليوم  
      const daySelect = document.createElement('select');  
      daySelect.id = 'birthDay';  
      daySelect.innerHTML = '<option value="">اليوم</option>';  
      for(let i=1;i<=30;i++) daySelect.innerHTML += `<option value="${i}">${i}</option>`;  
        
      // الشهر  
      const monthSelect = document.createElement('select');  
      monthSelect.id = 'birthMonth';  
      const hijriMonths = ['1 - محرم','2 - صفر','3 - ربيع أول','4 - ربيع ثاني','5 - جمادى أولى','6 - جمادى الثانية','7 - رجب','8 - شعبان','9 - رمضان','10 - شوال','11 - ذو القعدة','12 - ذو الحجة'];  
      monthSelect.innerHTML = '<option value="">الشهر</option>';  
      hijriMonths.forEach((m,i) => monthSelect.innerHTML += `<option value="${i+1}">${m}</option>`);  
        
      // السنة  
      const yearSelect = document.createElement('select');  
      yearSelect.id = 'birthYear';  
      yearSelect.innerHTML = '<option value="">السنة</option>';  
      for(let y=1430;y>=1370;y--) yearSelect.innerHTML += `<option value="${y}">${y}</option>`;  
        
      bdDiv.appendChild(daySelect);  
      bdDiv.appendChild(monthSelect);  
      bdDiv.appendChild(yearSelect);  
      div.appendChild(bdDiv);  
        
      // حفظ القيم فور اختيارها  
      daySelect.addEventListener('change', function(){  
        console.log('Day selected:', this.value);  
      });  
      monthSelect.addEventListener('change', function(){  
        console.log('Month selected:', this.value);  
      });  
        
      // الانتقال التلقائي عند اختيار السنة  
      yearSelect.addEventListener('change', function(){  
        console.log('Year selected:', this.value);  
        console.log('All values - Day:', daySelect.value, 'Month:', monthSelect.value, 'Year:', yearSelect.value);  
        if(daySelect.value && monthSelect.value && yearSelect.value){  
          // حفظ الحالة للرجوع قبل الانتقال  
          saveQuestionState();  
            
          answers.birthDay = daySelect.value;  
          answers.birthMonth = monthSelect.value;  
          answers.birthYear = yearSelect.value;  
          console.log('Birth date saved:', answers.birthDay, answers.birthMonth, answers.birthYear);  
          step++;  
          showQuestion();  
        } else {  
          console.log('Missing values - please select all fields');  
        }  
      });  
    } else if(q.type === 'appointdate'){  
      // تاريخ التعيين في صفحة واحدة  
      const adDiv = document.createElement('div');  
      adDiv.style.cssText = 'display:flex;gap:10px;justify-content:center;flex-wrap:wrap;';  
        
      // اليوم  
      const daySelectA = document.createElement('select');  
      daySelectA.id = 'appointDay';  
      daySelectA.innerHTML = '<option value="">اليوم</option>';  
      for(let i=1;i<=30;i++) daySelectA.innerHTML += `<option value="${i}">${i}</option>`;  
        
      // الشهر  
      const monthSelectA = document.createElement('select');  
      monthSelectA.id = 'appointMonth';  
      const hijriMonthsA = ['1 - محرم','2 - صفر','3 - ربيع أول','4 - ربيع ثاني','5 - جمادى أولى','6 - جمادى الثانية','7 - رجب','8 - شعبان','9 - رمضان','10 - شوال','11 - ذو القعدة','12 - ذو الحجة'];  
      monthSelectA.innerHTML = '<option value="">الشهر</option>';  
      hijriMonthsA.forEach((m,i) => monthSelectA.innerHTML += `<option value="${i+1}">${m}</option>`);  
        
      // السنة  
      const yearSelectA = document.createElement('select');  
      yearSelectA.id = 'appointYear';  
      yearSelectA.innerHTML = '<option value="">السنة</option>';  
      const nowH = getHijriNowParts();  
      for(let y=nowH.y;y>=nowH.y-40;y--) yearSelectA.innerHTML += `<option value="${y}">${y}</option>`;  
        
      adDiv.appendChild(daySelectA);  
      adDiv.appendChild(monthSelectA);  
      adDiv.appendChild(yearSelectA);  
      div.appendChild(adDiv);  
        
      // الانتقال التلقائي عند اختيار السنة  
      yearSelectA.addEventListener('change', function(){  
        if(daySelectA.value && monthSelectA.value && yearSelectA.value){  
          // حفظ الحالة للرجوع قبل الانتقال  
          saveQuestionState();  
            
          answers.appointDay = daySelectA.value;  
          answers.appointMonth = monthSelectA.value;  
          answers.appointYear = yearSelectA.value;  
          step++;  
          showQuestion();  
        }  
      });  
    } else if(q.type === 'financeEntitySelect'){  
      // ====== عرض جهات التمويل للعميل - فقط البنوك المناسبة لوضع العميل ======  
      const entitiesContainer = document.createElement('div');  
      entitiesContainer.style.cssText = 'max-height:400px; overflow-y:auto; margin-top:10px;';  
        
      const bankLogos = typeof getBankLogos === 'function' ? getBankLogos() : {};  
        
      // استخدام الدالة المركزية للحصول على نفس قائمة المسؤول  
      const masterEntities = getMasterFinanceEntitiesList();  
        
      // فلترة البنوك حسب وضع العميل (نوع الوظيفة، نوع المنتج، المدة)  
      const banksWithRates = [];  
      masterEntities.forEach(entity => {  
        const rate = getBankRateForClient(entity.name, answers);  
        if (rate !== null) {  
          banksWithRates.push({ name: entity.name, rate: rate, category: entity.category });  
        }  
      });  
        
      // ترتيب حسب النسبة (الأقل أولاً)  
      banksWithRates.sort((a, b) => a.rate - b.rate);  
        
      // إضافة عنوان يوضح عدد البنوك المتاحة  
      const headerInfo = document.createElement('div');  
      headerInfo.style.cssText = 'background:linear-gradient(135deg, #10b981 0%, #059669 100%); color:#fff; padding:10px 15px; border-radius:10px; margin-bottom:15px; text-align:center;';  
      headerInfo.innerHTML = `<strong>🎯 ${banksWithRates.length} بنك متاح حسب وضعك</strong><br><small>نوع الوظيفة: ${answers.jobType || 'غير محدد'} | المنتج: ${answers.financeType || 'غير محدد'}</small>`;  
      entitiesContainer.appendChild(headerInfo);  
        
      if (banksWithRates.length === 0) {  
        const noResults = document.createElement('div');  
        noResults.style.cssText = 'text-align:center; padding:30px; color:#6b7280;';  
        noResults.innerHTML = '<p>لا توجد بنوك متاحة حسب بياناتك الحالية</p><p>يرجى التواصل مع المسؤول لإضافة نسب مناسبة</p>';  
        entitiesContainer.appendChild(noResults);  
      }  
        
      banksWithRates.forEach(bank => {  
        const bankName = bank.name;  
        const rate = bank.rate;  
          
        const card = document.createElement('div');  
        card.style.cssText = 'display:flex; align-items:center; padding:15px; margin:10px 0; background:linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius:12px; cursor:pointer; transition:all 0.3s; border:2px solid transparent;';  
        card.onmouseover = function() { this.style.borderColor = '#3b82f6'; this.style.transform = 'translateY(-2px)'; };  
        card.onmouseout = function() { this.style.borderColor = 'transparent'; this.style.transform = 'translateY(0)'; };  
          
        const logo = bankLogos[bankName];  
        const logoHtml = logo ? `<img src="${logo}" style="width:50px; height:50px; object-fit:contain; margin-left:15px; border-radius:8px;">` : `<div style="width:50px; height:50px; background:#e2e8f0; border-radius:8px; display:flex; align-items:center; justify-content:center; margin-left:15px; font-size:20px;">🏦</div>`;  
          
        const rateHtml = rate ? `<span style="color:#10b981 !important; font-weight:700;">${rate}%</span>` : `<span style="color:#9ca3af !important;">غير محدد</span>`;  
          
        card.innerHTML = `  
          ${logoHtml}  
          <div style="flex:1;">  
            <div style="font-weight:600; color:#1e293b !important; font-size:15px;">${bankName}</div>  
            <div style="font-size:12px; color:#64748b !important; margin-top:4px;">نسبة الهامش: ${rateHtml}</div>  
          </div>  
          <div style="font-size:20px;">➡️</div>  
        `;  
          
        card.onclick = function() {  
          saveQuestionState();  
          answers.selectedFinanceEntity = bankName;  
          answers.currentBank = bankName;  
          
          // تعيين البنك المختار كـ recommendedBank لضمان عرضه في النتائج
          answers.recommendedBank = {
            bankName: bankName,
            margin: rate || 0,
            bankNote: ''
          };
            
          // إذا كانت النسبة مخزنة، استخدمها  
          if (rate) {  
            answers.profitMargin = rate.toString();  
            answers.entityRate = rate;  
          }  
            
          step++;  
          showQuestion();  
        };  
          
        entitiesContainer.appendChild(card);  
      });  
        
      div.appendChild(entitiesContainer);  
        
      // إضافة ملاحظة  
      const note = document.createElement('p');  
      note.style.cssText = 'text-align:center; color:#64748b; font-size:12px; margin-top:15px;';  
      note.textContent = 'اختر جهة التمويل للحصول على النسبة المخزنة تلقائياً';  
      div.appendChild(note);  
        
    } else if(q.type === 'flexibleAmountSelect'){
      // ====== قائمة القسط المرن المخفض ======
      const flexContainer = document.createElement('div');
      flexContainer.style.cssText = 'background:linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); padding:15px; border-radius:12px; border:2px solid #10b981; margin-top:10px;';
      
      // حساب الحد الأقصى المسموح للقسط (بعد خصم الالتزامات)
      const salary = parseFloat(answers.salary || '0');
      const deductionRate = 0.65; // 65% للعقاري المدعوم
      const maxAllowed = salary * deductionRate;
      
      // حساب إجمالي الالتزامات
      let totalCommitments = 0;
      if (answers.commitments && Array.isArray(answers.commitments)) {
        answers.commitments.forEach(c => {
          totalCommitments += parseFloat(c.amount || 0);
        });
      }
      
      // القسط المتاح بعد خصم الالتزامات
      const availableInstallment = Math.max(0, maxAllowed - totalCommitments);
      
      // إنشاء قائمة القسط المرن (من 400 إلى الحد الأقصى)
      const flexSelect = document.createElement('select');
      flexSelect.id = q.id;
      flexSelect.style.cssText = 'width:100%; padding:12px; border-radius:8px; border:2px solid #10b981; font-size:16px; font-weight:bold; background:#fff;';
      flexSelect.innerHTML = '<option value="">اختر مبلغ القسط المخفض...</option>';
      
      // الحصول على الحد الأدنى المحدد للبنك (افتراضي 400 ريال)
      const minAmount = parseInt(answers.flexibleMinAmount) || 400;
      const maxAmount = Math.floor(availableInstallment / 100) * 100; // تقريب لأقرب 100
      
      // إضافة خيارات من الحد الأدنى إلى الحد الأقصى (بزيادة 100 ريال)
      for (let amount = minAmount; amount <= maxAmount; amount += 100) {
        flexSelect.innerHTML += `<option value="${amount}">${amount.toLocaleString()} ريال</option>`;
      }
      
      // إضافة الحد الأقصى إذا لم يكن مضافاً
      if (maxAmount < availableInstallment) {
        flexSelect.innerHTML += `<option value="${Math.floor(availableInstallment)}">${Math.floor(availableInstallment).toLocaleString()} ريال (الحد الأقصى)</option>`;
      }
      
      // إضافة معلومات توضيحية
      const infoDiv = document.createElement('div');
      infoDiv.style.cssText = 'margin-bottom:15px; padding:10px; background:#fff; border-radius:8px; font-size:13px; color:#065f46;';
      infoDiv.innerHTML = `
        <div style="margin-bottom:8px;"><strong>💰 الراتب:</strong> ${salary.toLocaleString()} ريال</div>
        <div style="margin-bottom:8px;"><strong>📊 الحد الأقصى للاستقطاع (65%):</strong> ${maxAllowed.toLocaleString()} ريال</div>
        <div style="margin-bottom:8px;"><strong>📉 إجمالي الالتزامات:</strong> ${totalCommitments.toLocaleString()} ريال</div>
        <div style="margin-bottom:8px; color:#0369a1;"><strong>🏦 الحد الأدنى للبنك:</strong> ${minAmount.toLocaleString()} ريال</div>
        <div style="color:#059669; font-weight:bold;"><strong>✅ القسط المتاح للتخفيض:</strong> من ${minAmount.toLocaleString()} إلى ${Math.floor(availableInstallment).toLocaleString()} ريال</div>
      `;
      
      flexContainer.appendChild(infoDiv);
      flexContainer.appendChild(flexSelect);
      
      // ملاحظة توضيحية
      const noteDiv = document.createElement('div');
      noteDiv.style.cssText = 'margin-top:10px; padding:10px; background:#fef3c7; border-radius:8px; font-size:12px; color:#92400e;';
      noteDiv.innerHTML = `
        <strong>💡 ملاحظة:</strong> القسط المرن المخفض يتيح لك تخفيض القسط لفترة محددة (حتى 60 شهر)، 
        وبعد انتهاء هذه الفترة يرتفع القسط تلقائياً ليصل إلى الحد الأقصى المسموح.
      `;
      flexContainer.appendChild(noteDiv);
      
      div.appendChild(flexContainer);
      
      // الانتقال التلقائي عند الاختيار
      flexSelect.addEventListener('change', function(){
        if(this.value){
          saveQuestionState();
          answers[q.id] = this.value;
          step++;
          showQuestion();
        }
      });
        
    } else if(q.type === 'specificAmountInput'){
      // ====== حقل إدخال التمويل المحدد ======
      const specificContainer = document.createElement('div');
      specificContainer.style.cssText = 'background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding:20px; border-radius:12px; border:2px solid #0ea5e9; margin-top:10px;';
      
      // حساب الحد الأقصى للتمويل (تقديري)
      const salary = parseFloat(answers.salary || '0');
      const months = parseInt(answers.months || '60');
      const profitMargin = parseFloat(answers.profitMargin || '5');
      const years = months / 12;
      const profitFactor = (years * profitMargin / 100) + 1;
      
      // حساب القسط المتاح (تقريبي)
      let deductionRate = 0.65; // افتراضي
      if(answers.financeType === 'تمويل عقاري' && answers.supported === 'مدعوم') deductionRate = 0.65;
      else if(answers.financeType === 'تمويل عقاري') deductionRate = 0.55;
      else deductionRate = 0.45;
      
      const maxInstallment = salary * deductionRate;
      const totalCommitments = (answers.commitments || []).reduce((sum, c) => sum + (c.amount || 0), 0);
      const availableInstallment = Math.max(0, maxInstallment - totalCommitments);
      const totalAvailable = availableInstallment * months;
      const maxFinanceAmount = Math.floor(totalAvailable / profitFactor);
      
      // عرض الحد الأقصى
      const infoDiv = document.createElement('div');
      infoDiv.style.cssText = 'margin-bottom:15px; font-size:14px; color:#0369a1;';
      infoDiv.innerHTML = `
        <div style="margin-bottom:10px;"><strong>💰 الحد الأقصى للتمويل الممنوح لك:</strong> <span style="font-size:18px; font-weight:bold; color:#059669;">${maxFinanceAmount.toLocaleString()} ريال</span></div>
        <div style="font-size:12px; color:#64748b;">يمكنك إدخال مبلغ أقل من هذا الحد إذا كنت لا تحتاج كامل المبلغ</div>
      `;
      specificContainer.appendChild(infoDiv);
      
      // حقل الإدخال
      const inputDiv = document.createElement('div');
      inputDiv.style.cssText = 'display:flex; gap:10px; align-items:center;';
      
      const amountInput = document.createElement('input');
      amountInput.type = 'number';
      amountInput.id = q.id;
      amountInput.placeholder = 'أدخل المبلغ...';
      amountInput.style.cssText = 'flex:1; padding:15px; border-radius:10px; border:2px solid #0ea5e9; font-size:18px; font-weight:bold; text-align:center;';
      amountInput.max = maxFinanceAmount;
      inputDiv.appendChild(amountInput);
      
      const confirmBtn = document.createElement('button');
      confirmBtn.type = 'button';
      confirmBtn.innerHTML = 'تأكيد';
      confirmBtn.style.cssText = 'padding:15px 25px; background:linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color:#fff; border:none; border-radius:10px; font-size:16px; font-weight:bold; cursor:pointer;';
      inputDiv.appendChild(confirmBtn);
      
      specificContainer.appendChild(inputDiv);
      
      // رسالة التحقق
      const errorDiv = document.createElement('div');
      errorDiv.id = 'specificAmountError';
      errorDiv.style.cssText = 'display:none; margin-top:10px; padding:10px; background:#fee2e2; border-radius:8px; color:#dc2626; font-size:13px;';
      specificContainer.appendChild(errorDiv);
      
      // حفظ الحد الأقصى للاستخدام لاحقاً
      answers._maxFinanceAmount = maxFinanceAmount;
      
      confirmBtn.onclick = function() {
        const enteredAmount = parseFloat(amountInput.value || '0');
        
        if(!enteredAmount || enteredAmount <= 0) {
          errorDiv.innerHTML = '⚠️ يرجى إدخال مبلغ صحيح';
          errorDiv.style.display = 'block';
          return;
        }
        
        if(enteredAmount > maxFinanceAmount) {
          errorDiv.innerHTML = `⚠️ التمويل المذكور (${enteredAmount.toLocaleString()} ريال) يتجاوز الحد الأقصى للتمويل الممنوح لك (${maxFinanceAmount.toLocaleString()} ريال)`;
          errorDiv.style.display = 'block';
          return;
        }
        
        // المبلغ صحيح - حفظه والانتقال
        errorDiv.style.display = 'none';
        saveQuestionState();
        answers[q.id] = enteredAmount;
        answers._specificAmountApproved = true;
        step++;
        showQuestion();
      };
      
      div.appendChild(specificContainer);
        
    } else if(q.type === 'select'){  
      // جميع الأسئلة تستخدم قائمة منسدلة (select)
      const sel = document.createElement('select');  
      sel.id = q.id;  
      sel.innerHTML = '<option value="">اختر...</option>';  

      if(q.dynamic && q.id === 'months'){
        const isMainQuestion = (step < generalQuestions.length);  
        const isCommitmentMortgage = currentCommitment.type === 'قرض عقاري';  
          
        let limit;  
        if(isMainQuestion){  
          limit = getMaxAllowedMonths();  
        } else {  
          // التزامات: عقاري = 360، غيره = 60  
          limit = isCommitmentMortgage ? 360 : 60;  
        }  
          
        // القيمة الافتراضية دائماً 1 شهر  
        for(let i=1; i<=limit; i++){  
          const selected = (i === 1) ? ' selected' : '';  
          sel.innerHTML += `<option value="${i}"${selected}>${i} شهر</option>`;  
        }  
      } else if (q.id === 'financeType' && typeof loadDynamicProducts === 'function') {  
        const products = loadDynamicProducts();  
        sel.innerHTML = '<option value="">اختر...</option>';  
        products.forEach(p => {  
          sel.innerHTML += `<option value="${p.value}">${p.label}</option>`;  
        });  
      } else if(q.dynamic && q.id === 'appointYear'){  
        const nowH = getHijriNowParts();  
        const start = Math.max(1300, nowH.y - 40);  
        for(let y = nowH.y; y >= start; y--){  
          sel.innerHTML += `<option value="${y}">${y}</option>`;  
        }  
      } else {  
        // دعم الخيارات الديناميكية (دالة أو مصفوفة)  
        const optionsList = typeof q.options === 'function' ? q.options() : q.options;  
        optionsList.forEach(opt => {  
          sel.innerHTML += `<option value="${opt}">${opt}</option>`;  
        });  
      }  
      div.appendChild(sel);  
        
      // تم نقل زر البحث عن العروض إلى مرحلة اختيار طريقة النسبة (calcMode) بناءً على طلب المستخدم  
        
      // إضافة زر البحث عن العروض وعرضها تحت سؤال اختيار النسبة (calcMode)  
      if (q.id === 'calcMode') {  
        const offersBtn = document.createElement('button');  
        offersBtn.type = 'button';  
        offersBtn.innerHTML = '🎁 ابحث عن عروض لقطاعي';  
        offersBtn.style.cssText = 'display:block; margin:15px auto 15px; background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color:#fff; border:none; border-radius:10px; padding:12px 20px; font-size:14px; cursor:pointer; box-shadow:0 4px 15px rgba(245,158,11,0.3); width:100%; font-weight:bold;';  
        offersBtn.onclick = function() { openOffersSearchModal(); };  
        div.appendChild(offersBtn);  
  
        const offersContainer = document.createElement('div');  
        offersContainer.id = 'calcModeOffersContainer';  
        offersContainer.style.cssText = 'margin-top:10px; padding:15px; background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius:12px; border:2px solid #f59e0b;';  
        offersContainer.innerHTML = '<h4 style="margin:0 0 10px; font-size:14px; color:#92400e;"><span style="font-size:18px;">🎁</span> عروض متاحة لقطاعك</h4><div id="calcModeOffersList" style="max-height:200px; overflow-y:auto;"></div>';  
        div.appendChild(offersContainer);  
          
        // تحميل العروض المناسبة للعميل  
        setTimeout(() => loadCalcModeOffers(), 100);  
      }  
        
      // الانتقال التلقائي عند اختيار قيمة  
      sel.addEventListener('change', function(){  
        if(this.value){  
          // حفظ الحالة للرجوع قبل الانتقال  
          saveQuestionState();  
            
          // حفظ القيمة والانتقال  
          if(step < generalQuestions.length){  
            answers[q.id] = this.value;  
            
            // معالجة خاصة لسؤال hasCommitments عند اختيار "لا"
            if(q.id === 'hasCommitments' && this.value === 'لا') {
              console.log('=== المستخدم اختار لا في سؤال الالتزامات (من change event) ===');
              answers.commitments = []; // تعيين مصفوفة فارغة للالتزامات
              
              // فحص إذا كان سؤال التمويل المحدد مفعلاً لهذا المنتج
              if (isSpecificAmountEnabledForProduct(answers.financeType) && !answers.wantSpecificAmount) {
                showSpecificAmountQuestion();
                return;
              }
              
              // إذا لم يكن سؤال التمويل المحدد مفعلاً، انتقل للحساب مباشرة
              document.getElementById('nextButton').style.display = 'none';
              calculate();
              return;
            }
            
            step++;  
            showQuestion();  
          } else {  
            // التعامل مع أسئلة الالتزامات  
            if(q.id === 'more'){  
              // حفظ الالتزام الحالي أولاً (بدون حقل more)  
              answers.commitments.push({...currentCommitment});  
              currentCommitment = {};  
                
              if(this.value === 'نعم'){  
                // إعادة بدء أسئلة الالتزامات لالتزام جديد  
                commitmentStep = 0;  
                showQuestion();  
              } else {  
                // انتهاء الالتزامات - فحص سؤال التمويل المحدد
                console.log('=== انتهت الالتزامات (من change event) ===');
                
                // فحص إذا كان سؤال التمويل المحدد مفعلاً لهذا المنتج
                if (isSpecificAmountEnabledForProduct(answers.financeType) && !answers.wantSpecificAmount) {
                  showSpecificAmountQuestion();
                  return;
                }
                
                document.getElementById('nextButton').style.display = 'none';  
                console.log('الالتزامات النهائية:', answers.commitments);  
                calculate();  
              }  
            } else {  
              currentCommitment[q.id] = this.value;  
              commitmentStep++;  
              showQuestion();  
            }  
          }  
        }  
      });  
    } else {  
      div.innerHTML += `<input type="${q.type}" id="${q.id}" ${q.default ? `value="${q.default}"` : ''}>`; 
    }  
  
    cont.appendChild(div);  
      
    // إظهار زر التالي فقط عند الضرورة (الأسئلة النصية والرقمية والتواريخ)  
    const nextBtn = document.getElementById('nextButton');  
    if(q.type === 'text' || q.type === 'number' || q.type === 'birthdate' || q.type === 'appointdate'){  
      nextBtn.style.display = 'inline-flex';  
    } else {  
      nextBtn.style.display = 'none';  
    }  
  }  
  
  function nextQuestion(){  
    // حفظ الحالة للرجوع  
    saveQuestionState();  
      
    console.log('=== nextQuestion called ===');  
    const q = step < generalQuestions.length ? generalQuestions[step] : commitmentQuestions[commitmentStep];  
    console.log('Current question:', q.id, 'type:', q.type, 'step:', step);  
      
    // دعم نوع birthdate  
    if(q.type === 'birthdate'){  
      console.log('Processing birthdate question...');  
      const day = document.getElementById('birthDay');  
      const month = document.getElementById('birthMonth');  
      const year = document.getElementById('birthYear');  
      console.log('Birth date values - Day:', day ? day.value : 'null', 'Month:', month ? month.value : 'null', 'Year:', year ? year.value : 'null');  
      console.log('Day element:', day, 'selectedIndex:', day ? day.selectedIndex : 'null');  
      console.log('Month element:', month, 'selectedIndex:', month ? month.selectedIndex : 'null');  
      console.log('Year element:', year, 'selectedIndex:', year ? year.selectedIndex : 'null');  
      if(!day.value || !month.value || !year.value){  
        alert('يرجى اختيار تاريخ الميلاد كاملاً');  
        return;  
      }  
      answers.birthDay = day.value;  
      answers.birthMonth = month.value;  
      answers.birthYear = year.value;  
      step++;  
      showQuestion();  
      return;  
    }  
      
    const el = document.getElementById(q.id);  
    const val = el ? el.value : '';  
  
    if(!val){  
      alert('يرجى تعبئة الحقل قبل المتابعة');  
      return;  
    }  
  
    if(step < generalQuestions.length){  
      answers[q.id] = val;  
  
      if(q.id === 'financeType'){  
        // (إضافة) لو المنتج غير مفعّل عبر لوحة المنتجات -> صفحة قريباً  
        if(!isFinanceProductEnabled(val)){  
          showComingSoonForProduct(val);  
          return;  
        }  
  
        if(  
          val === 'شراء مديونية تمويل عقاري' ||  
          val === 'بطاقات الإتمان' ||  
          val === 'تمويل نقاط البيع' ||  
          val === 'تمويل المؤسسات' ||  
          val === 'تمويل الأسطول'  
        ){  
          showComingSoonForProduct(val);  
          return;  
        }  
      }  
  
      if(q.id === 'months'){  
        const max = getMaxAllowedMonths();  
        if(parseInt(val) > max){  
          alert(`أقصى مدة مسموحة حسب العمر والتقاعد: ${describeMonths(max)}.`);  
          answers[q.id] = max.toString();  
        }  
      }  
      step++;  
    }else{  
      if(q.id === 'months') currentCommitment[q.id] = parseInt(val);  
      else if(q.id === 'amount' || q.id === 'balloonAmount') currentCommitment[q.id] = parseFloat(val);  
      else currentCommitment[q.id] = val;  
  
      if(q.id === 'more'){  
        answers.commitments.push(currentCommitment);  
        currentCommitment = {};  
        if(val === 'نعم'){  
          commitmentStep = 0;  
          showQuestion();  
          return;  
        }else{  
          // انتهاء الالتزامات - فحص سؤال التمويل المحدد
          console.log('=== انتهت الالتزامات ===');
          
          // فحص إذا كان سؤال التمويل المحدد مفعلاً لهذا المنتج
          if (isSpecificAmountEnabledForProduct(answers.financeType) && !answers.wantSpecificAmount) {
            showSpecificAmountQuestion();
            return;
          }
          
          document.getElementById('nextButton').style.display = 'none';  
          console.log('الإجابات النهائية:', answers);  
          calculate();  
          return;  
        }  
      }  
      commitmentStep++;  
    }  
    showQuestion();  
  }  
  
  // ====== حساب راتب التقاعد للمدني والقطاع الخاص ======  
  function estimateCivilPensionFromAnswers(){  
    // التحقق من الشروط  
    if(answers.jobType === 'عسكري' || answers.jobType === 'متقاعد') return { pension: 0, formula: '' };  
    if(answers.extendAfterRetirementCivil !== 'نعم') return { pension: 0, formula: '' };  
      
    const ad = parseInt(answers.appointDayCivil || answers.appointDay || '0', 10);  
    const am = parseInt(answers.appointMonthCivil || answers.appointMonth || '0', 10);  
    const ay = parseInt(answers.appointYearCivil || answers.appointYear || '0', 10);  
    if(!ad || !am || !ay) return { pension: 0, formula: '' };  
      
    const salary = parseFloat(answers.salary || '0');  
    if(!salary) return { pension: 0, formula: '' };  
      
    const nowH = getHijriNowParts();  
    const by = parseInt(answers.birthYear || '0', 10);  
    const bm = parseInt(answers.birthMonth || '1', 10);  
    const bd = parseInt(answers.birthDay || '1', 10);  
      
    // حساب سنوات الخدمة الحالية  
    const currentServiceMonths = monthsDiffHijri(ay, am, ad, nowH.y, nowH.m, nowH.d);  
    const currentServiceYears = Math.floor(currentServiceMonths / 12);  
      
    // تاريخ التقاعد (60 سنة هجرية)  
    const retY = by + 60;  
    const retM = bm;  
    const retD = bd;  
      
    // إجمالي سنوات الخدمة عند التقاعد  
    const totalServiceMonths = monthsDiffHijri(ay, am, ad, retY, retM, retD);  
    const totalServiceYears = Math.floor(totalServiceMonths / 12);  
      
    // تقدير الراتب الأساسي (تقريبياً 70% من الصافي)  
    const estimatedBasicSalary = salary * 0.7;  
      
    let pension = 0;  
    let formula = '';  
      
    if(answers.jobType === 'حكومي'){  
      // معادلة التقاعد المدني: (الراتب الأساسي × أشهر الخدمة) ÷ 480  
      pension = (estimatedBasicSalary * totalServiceMonths) / 480;  
      pension = Math.min(pension, estimatedBasicSalary); // لا يتجاوز الراتب الأساسي  
        
      formula = `معادلة حساب راتب التقاعد المدني:  
الجهة: ${answers.governmentEntity || 'حكومي'}  
تاريخ التعيين: ${ay}/${String(am).padStart(2,'0')}/${String(ad).padStart(2,'0')}  
سنوات الخدمة الحالية: ${currentServiceYears} سنة  
سنوات الخدمة عند التقاعد: ${totalServiceYears} سنة (${totalServiceMonths} شهر)  
الراتب الأساسي (تقديري): ${estimatedBasicSalary.toLocaleString()} ريال  
  
المعادلة: (الراتب الأساسي × أشهر الخدمة) ÷ 480  
= (${estimatedBasicSalary.toLocaleString()} × ${totalServiceMonths}) ÷ 480  
= ${pension.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال`;  
    } else {  
      // معادلة التأمينات الاجتماعية: 2.25% × متوسط الأجر × أشهر الاشتراك ÷ 12  
      pension = (0.0225 * estimatedBasicSalary * totalServiceMonths) / 12;  
      pension = Math.min(pension, estimatedBasicSalary); // لا يتجاوز الراتب  
        
      formula = `معادلة حساب راتب التقاعد (التأمينات الاجتماعية):  
تاريخ التعيين: ${ay}/${String(am).padStart(2,'0')}/${String(ad).padStart(2,'0')}  
سنوات الاشتراك الحالية: ${currentServiceYears} سنة  
سنوات الاشتراك عند التقاعد: ${totalServiceYears} سنة (${totalServiceMonths} شهر)  
متوسط الأجر (تقديري): ${estimatedBasicSalary.toLocaleString()} ريال  
  
المعادلة: 2.25% × متوسط الأجر × أشهر الاشتراك ÷ 12  
= (0.0225 × ${estimatedBasicSalary.toLocaleString()} × ${totalServiceMonths}) ÷ 12  
= ${pension.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال`;  
    }  
      
    return {  
      pension: Math.max(0, pension),  
      basicSalaryAtRetirement: estimatedBasicSalary,  
      totalServiceMonths,  
      totalServiceYears,  
      currentServiceYears,  
      formula  
    };  
  }  
    
  // ====== حساب راتب التقاعد العسكري بالمعادلة الرسمية ======  
  // المعادلة: (الراتب الأساسي الأخير × عدد أشهر الخدمة) ÷ 420  
  function estimateMilitaryPensionFromAnswers(){  
    // إذا ما فيه ممتد أو ما فيه تاريخ تعيين -> نرجع كائن فارغ  
    if(answers.jobType !== 'عسكري') return { pension: 0, formula: '' };  
    if(answers.extendAfterRetirement !== 'نعم') return { pension: 0, formula: '' };  
  
    const ad = parseInt(answers.appointDay || '0', 10);  
    const am = parseInt(answers.appointMonth || '0', 10);  
    const ay = parseInt(answers.appointYear || '0', 10);  
    if(!ad || !am || !ay) return { pension: 0, formula: '' };  
  
    const rank = answers.militaryRank || 'جندي';  
    const rankData = militarySalaryTable[rank];  
    if(!rankData) return { pension: 0, formula: '' };  
  
    const info = getMilitaryTimingInfoFromAnswers(answers);  
    const nowH = getHijriNowParts();  
      
    // حساب سنوات الخدمة الحالية (من تاريخ التعيين إلى اليوم)  
    const currentServiceMonths = monthsDiffHijri(ay, am, ad, nowH.y, nowH.m, nowH.d);  
    const currentServiceYears = Math.floor(currentServiceMonths / 12);  
      
    // تاريخ التقاعد (حسب الرتبة)  
    const retY = info.birth.y + info.rankAge;  
    const retM = info.birth.m;  
    const retD = info.birth.d;  
      
    // إجمالي سنوات الخدمة عند التقاعد  
    const totalServiceMonths = monthsDiffHijri(ay, am, ad, retY, retM, retD);  
    const totalServiceYears = Math.floor(totalServiceMonths / 12);  
      
    // السنوات المتبقية للتقاعد  
    const yearsToRetirement = totalServiceYears - currentServiceYears;  
      
    // تحديد سنة الخدمة الحالية في الرتبة (افتراضياً سنة 1 إذا لم نعرف)  
    // نفترض أن العميل في السنة الأولى من رتبته الحالية  
    // ونحسب الراتب الأساسي عند التقاعد بإضافة العلاوات  
      
    // الراتب الأساسي الحالي (افتراضياً السنة الأولى)  
    const currentBasicSalary = rankData.salaries[0];  
      
    // حساب الراتب الأساسي عند التقاعد  
    // نضيف العلاوات السنوية للسنوات المتبقية  
    let futureYearIndex = Math.min(yearsToRetirement, rankData.salaries.length - 1);  
    let basicSalaryAtRetirement = rankData.salaries[futureYearIndex];  
      
    // إذا تجاوزت السنوات الجدول، نستخدم آخر راتب + العلاوات الإضافية  
    if(yearsToRetirement > rankData.salaries.length - 1){  
      const extraYears = yearsToRetirement - (rankData.salaries.length - 1);  
      basicSalaryAtRetirement = rankData.salaries[rankData.salaries.length - 1] + (extraYears * rankData.allowance);  
    }  
      
    // التأكد من أن الراتب لا يتجاوز الحد الأقصى للرتبة  
    const maxSalary = rankData.salaries[rankData.salaries.length - 1];  
    basicSalaryAtRetirement = Math.min(basicSalaryAtRetirement, maxSalary + (10 * rankData.allowance));  
      
    // المعادلة الرسمية: (الراتب الأساسي الأخير × عدد أشهر الخدمة) ÷ 420  
    let pension = (basicSalaryAtRetirement * totalServiceMonths) / 420;  
      
    // المعاش لا يتجاوز الراتب الأساسي الأخير  
    pension = Math.min(pension, basicSalaryAtRetirement);  
      
    // إعداد معادلة الحساب للمسؤول  
    const formula = `معادلة حساب راتب التقاعد:  
الرتبة: ${rank}  
تاريخ التعيين: ${ay}/${String(am).padStart(2,'0')}/${String(ad).padStart(2,'0')}  
سنوات الخدمة الحالية: ${currentServiceYears} سنة  
سنوات الخدمة عند التقاعد: ${totalServiceYears} سنة (${totalServiceMonths} شهر)  
الراتب الأساسي الحالي (سنة 1): ${currentBasicSalary.toLocaleString()} ريال  
العلاوة السنوية: ${rankData.allowance} ريال  
الراتب الأساسي عند التقاعد: ${basicSalaryAtRetirement.toLocaleString()} ريال  
  
المعادلة: (الراتب الأساسي الأخير × أشهر الخدمة) ÷ 420  
= (${basicSalaryAtRetirement.toLocaleString()} × ${totalServiceMonths}) ÷ 420  
= ${pension.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال`;  
      
    return {  
      pension: Math.max(0, pension),  
      basicSalaryAtRetirement,  
      totalServiceMonths,  
      totalServiceYears,  
      currentServiceYears,  
      yearsToRetirement,  
      formula  
    };  
  }  
  
  // ====== الحسبة ======  
  function calculate(){  
    console.log('========== بدء الحساب ==========');  
    console.log('جميع الإجابات:', JSON.stringify(answers, null, 2));  
      
    const salary = parseFloat(answers.salary),  
          months = parseInt(answers.months),  
          years  = months / 12,  
          financeType = answers.financeType,  
          supported = answers.supported,  
          bundle = answers.bundle;  
      
    console.log('الراتب:', salary);  
    console.log('المدة:', months);  
    console.log('نوع التمويل:', financeType);  
    console.log('الدعم:', supported);  
  
    // ====== معالجة ترشيح البنك تلقائياً ======  
    // إذا كان المستخدم اختار "ترشيح بنك مناسب تلقائياً"، نحصل على النسبة من البنك المرشح  
    if (answers.calcMode === 'ترشيح بنك مناسب تلقائياً') {  
      console.log('وضع ترشيح البنك تلقائياً - جاري البحث عن أفضل بنك...');  
      const matchingBanks = getMatchingBanksForAnswers();  
      console.log('البنوك المطابقة:', matchingBanks);  
      if (matchingBanks && matchingBanks.length > 0) {  
        const bestBank = matchingBanks[0];  
        answers.profitMargin = bestBank.margin;  
        answers.recommendedBank = bestBank;
        // حفظ معلومة إذا كانت النسبة من نوع اعتزاز (لا تطبق عليها التعديلات التراكمية)
        answers.isEtezaazRate = bestBank.isEtezaaz || false;
        // حفظ معلومة دعم القسط المرن المخفض
        answers.bankSupportsFlexible = bestBank.flexibleInstallment === 'نعم' || bestBank.flexibleInstallment === true;
        // حفظ الحد الأدنى للقسط المرن المحدد للبنك
        answers.flexibleMinAmount = bestBank.flexibleMinAmount || 400;
        console.log('تم اختيار البنك:', bestBank.bankName, 'بنسبة:', bestBank.margin, 'اعتزاز:', bestBank.isEtezaaz || false, 'قسط مرن:', bestBank.flexibleInstallment || false, 'حد أدنى:', bestBank.flexibleMinAmount || 400);  
      } else {  
        // إذا لم يتم العثور على بنك مطابق، نستخدم نسبة افتراضية  
        answers.profitMargin = 5.0;  
        console.log('لم يتم العثور على بنك مطابق، استخدام نسبة افتراضية: 5.0%');  
      }  
    } else if (answers.calcMode === 'اختيار جهة تمويل معينة' || answers.calcMode === 'نسبة على جهة تمويل معينة') {
      // المستخدم اختار جهة تمويل معينة - لا نقوم بالترشيح التلقائي
      console.log('وضع اختيار جهة تمويل معينة - لا يتم الترشيح التلقائي');
      const selectedBankName = answers.selectedBank || answers.selectedFinanceEntity || answers.currentBank || '';
      if (selectedBankName && !answers.recommendedBank) {
        // إنشاء كائن recommendedBank من البنك المختار
        answers.recommendedBank = {
          bankName: selectedBankName,
          margin: parseFloat(answers.profitMargin) || 5,
          bankNote: 'تم اختيار هذه الجهة يدوياً'
        };
        console.log('تم تعيين البنك المختار:', selectedBankName);
      }
    }  
  
    // تنظيف ومعالجة النسبة المدخلة  
    let profitMarginRaw = String(answers.profitMargin || '').trim();  
    // استبدال الفاصلة العربية بالنقطة الإنجليزية  
    profitMarginRaw = profitMarginRaw.replace(/٫/g, '.').replace(/،/g, '.').replace(/,/g, '.');  
    // إزالة أي أحرف غير رقمية ما عدا النقطة  
    profitMarginRaw = profitMarginRaw.replace(/[^0-9.]/g, '');  
    let profitMargin = parseFloat(profitMarginRaw);  
      
    console.log('النسبة المدخلة الأصلية:', answers.profitMargin);  
    console.log('النسبة بعد التنظيف:', profitMarginRaw);  
    console.log('النسبة كرقم:', profitMargin);  
      
if (!profitMargin || isNaN(profitMargin) || profitMargin <= 0) {
      alert('نسبة هامش الربح غير صحيحة. يرجى إدخال رقم صحيح مثل 5.20');
      console.error('خطأ في النسبة:', answers.profitMargin, '->', profitMargin);
      return;
    }

    // ========== تطبيق التعديلات التراكمية على النسبة ==========
    const originalProfitMargin = profitMargin;
    let appliedAdjustmentsInfo = [];
    
    // تحديد حالة العميل للتعديلات
    const clientConditions = {
      supportAdvance: answers.supportAdvance === 'نعم',
      hasPersonalLoan: answers.hasPersonalLoan === 'نعم' || (answers.commitments && answers.commitments.some(c => c.type === 'تمويل شخصي')),
      hasMortgageLoan: answers.hasMortgageLoan === 'نعم' || (answers.commitments && answers.commitments.some(c => c.type === 'تمويل عقاري')),
      hasCreditCard: answers.hasCreditCard === 'نعم' || (answers.commitments && answers.commitments.some(c => c.type === 'بطاقة ائتمانية')),
      isNewCustomer: answers.isNewCustomer === 'نعم',
      salaryTransfer: answers.salaryTransfer === 'نعم'
    };
    
    // الحصول على اسم البنك المختار
    const selectedBankName = answers.recommendedBank?.bankName || answers.currentBank || answers.selectedFinanceEntity || '';
    
    // التحقق من إذا كانت النسبة من نوع اعتزاز
    const isEtezaazRate = answers.isEtezaazRate || false;
    
    // تطبيق التعديلات التراكمية
    if (typeof calculateAdjustedRate === 'function') {
      const adjustmentResult = calculateAdjustedRate(
        profitMargin,
        selectedBankName,
        financeType === 'تمويل عقاري' ? 'mortgage' : 'personal',
        clientConditions,
        isEtezaazRate
      );
      
      if (adjustmentResult.totalAdjustment !== 0) {
        profitMargin = adjustmentResult.adjustedRate;
        appliedAdjustmentsInfo = adjustmentResult.appliedAdjustments;
        console.log('تم تطبيق التعديلات التراكمية:', {
          'النسبة الأصلية': originalProfitMargin,
          'النسبة بعد التعديل': profitMargin,
          'إجمالي التعديل': adjustmentResult.totalAdjustment,
          'التعديلات المطبقة': appliedAdjustmentsInfo,
          'نسبة اعتزاز': isEtezaazRate
        });
      }
    }
    
    // حفظ معلومات التعديلات لعرضها في النتائج
    answers._appliedAdjustments = appliedAdjustmentsInfo;
    answers._originalProfitMargin = originalProfitMargin;
    answers._adjustedProfitMargin = profitMargin;

    const isBuyoutPersonal = financeType === 'شراء مديونية تمويل شخصي';
    const isConsumer = financeType === 'تمويل استهلاكي';  
    const isLeasing = financeType === 'تمويل التأجيري';  
  
    if(financeType === 'تمويل عقاري' && !answers.supported){  
      answers.supported = 'غير مدعوم';  
    }  
  
    const now = new Date();  
    const dayNames = ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];  
    const dayName = dayNames[now.getDay()];  
    const y = now.getFullYear();  
    const m = String(now.getMonth()+1).padStart(2,'0');  
    const d = String(now.getDate()).padStart(2,'0');  
    const hh = String(now.getHours()).padStart(2,'0');  
    const mm = String(now.getMinutes()).padStart(2,'0');  
    const ss = String(now.getSeconds()).padStart(2,'0');  
    const calcDateTimeStr = `${dayName} ${y}-${m}-${d} ${hh}:${mm}:${ss}`;  
  
    // ====== (إضافة) معلومات التقاعد/الممتد ======  
    const timing = getMilitaryTimingInfoFromAnswers(answers);  
    const isExtended = (answers.jobType === 'عسكري' && answers.extendAfterRetirement === 'نعم');  
    const preRetMonths = isExtended ? Math.min(months, timing.rankRemainingMonths) : months;  
    const pensionResult = isExtended ? estimateMilitaryPensionFromAnswers() : { pension: 0, formula: '' };  
    const pensionSalaryEst = pensionResult.pension;  
    const retirementFormula = pensionResult.formula;  
  
    // ==== التمويل الاستهلاكي (موجود كما هو) ====  
    if (isConsumer) {  
      const consumerInst = salary * 0.1167;  
      const totalCommits = (answers.commitments || []).reduce((s,c)=> s + (c.amount || 0), 0);  
      const maxAll = salary * 0.45;  
  
      if (consumerInst + totalCommits > maxAll) {  
        showPage('result');  
        const name = answers.clientName || 'العميل';  
        // أيقونة نوع الوظيفة لنتيجة العجز  
        const deficitJobIcon = answers.jobType === 'عسكري' ? '🎖️' :   
                               answers.jobType === 'حكومي' ? '👔' :   
                               answers.jobType === 'قطاع خاص' ? '🏢' :   
                               answers.jobType === 'متقاعد' ? '🧓' : '👤';  
        const deficitJobLabel = answers.jobType || 'غير محدد';  
        const resultCard = document.getElementById('resultCard');  
        resultCard.innerHTML = `  
          <h2 style="margin:0 0 6px; font-size:18px; text-align:right; color:#111827;">  
            نتيجة الحسبة (التقريبية)  
          </h2>  
          <div style="font-size:12px; color:#6b7280; text-align:right; margin-bottom:4px;">  
            تاريخ ووقت الحسبة: ${calcDateTimeStr}  
          </div>  
          <div class="result-header">  
            <div class="client-chip">${deficitJobIcon} مرحباً ومسهلا يا ${name} <span style="font-size:11px; color:#6b7280; margin-right:5px;">(${deficitJobLabel})</span></div>  
            <div style="text-align:right;">  
              <span class="badge-mode">تمويل استهلاكي - نظام 11.67%</span><br>  
              <span class="badge-duration">مدة التمويل: ${describeMonths(months)}</span>  
            </div>  
          </div>  
          <div class="alert-error">  
            نعتذر منك، حسب البيانات المدخلة فإن إجمالي التزاماتك الحالية مع قسط التمويل الاستهلاكي  
            يتجاوز 45% من صافي الراتب، ولذلك قد لا يكون التمويل متاحاً بهذا المنتج.  
          </div>  
          <div style="margin-top:10px; font-size:13px; color:#6b7280; text-align:right;">  
            يمكنك تجربة نوع تمويل آخر أو تقليل الالتزامات الحالية قبل طلب التمويل الاستهلاكي.  
          </div>  
        `;  
  
        answers._lastCalc = {  
          calcDateTimeStr,  
          clientName: name,  
          financeType: financeType,  
          durationText: describeMonths(months),  
          months: months,  
          recommendedBankName: 'غير محدد',  
          finalNet: 0,  
          netWithoutFees: 0,  
          netAfterAdmin: 0,  
          totalInst: 0,  
          adminFee: 0,  
          vat: 0,  
          commodityFee: 0,  
          supportSakaniAdded: 0,  
          supportEtezaazAdded: 0,  
          supportTotalAdded: 0,  
          mainShownValue: 0,  
          mainShownLabel: '',  
          hasHousingSupport: false,  
          housingSupportMonthly: 0,  
          housingSupportTotalForLoan: 0,  
          housingSupportLumpSum: 0,  
          isEtezaaz: false,  
          phases: []  
        };  
        return;  
      }  
  
      const totalInst = consumerInst * months;  
      const profitFactor = (years * profitMargin / 100) + 1;  
      const netFinance = totalInst / profitFactor;  
  
      let adminFee = netFinance * 0.005;  
      if (adminFee > 2500) adminFee = 2500;  
      const vat = adminFee * 0.15;  
      const commodityFee = netFinance * 0.01;  
  
      const netWithoutFees = netFinance;  
      const netAfterAdmin = netFinance - (adminFee + vat);  
      const finalNet = netAfterAdmin - commodityFee;  
      const totalProfitWithFees = totalInst - finalNet;  
  
      const name = answers.clientName || "العميل";  
      const duration = describeMonths(months);  
      const finalNetFixed = finalNet.toFixed(0);  
      const netAfterAdminFixed = netAfterAdmin.toFixed(0);  
      const netWithoutFeesFixed = netWithoutFees.toFixed(0);  
  
      const matchingBanks = getMatchingBanksForAnswers();  
      // استخدام البنك المختار من العميل إذا كان موجوداً
      // إذا كان المستخدم اختار جهة معينة، لا نستبدلها بالبنك الأفضل
      let recommendedBank = answers.recommendedBank;
      if (!recommendedBank && answers.calcMode === 'ترشيح بنك مناسب تلقائياً') {
        recommendedBank = matchingBanks[0] || null;
      }
      const altBanks = matchingBanks.filter(b => b.bankName !== (recommendedBank ? recommendedBank.bankName : '')).slice(0, 3);  
      if (recommendedBank) answers.recommendedBank = recommendedBank;  

      showPage('result');
      const resultCard = document.getElementById('resultCard');  
  
      // أيقونة نوع الوظيفة للتمويل الاستهلاكي  
      const consumerJobIcon = answers.jobType === 'عسكري' ? '🎖️' :   
                              answers.jobType === 'حكومي' ? '👔' :   
                              answers.jobType === 'قطاع خاص' ? '🏢' :   
                              answers.jobType === 'متقاعد' ? '🧓' : '👤';  
      const consumerJobLabel = answers.jobType || 'غير محدد';  
        
      let html = '';  
      html += `<h2 style="margin:0 0 6px; font-size:18px; text-align:right; color:#111827;">نتيجة الحسبة (التقريبية)</h2>`;  
      html += `<div style="font-size:12px; color:#6b7280; text-align:right; margin-bottom:4px;">تاريخ ووقت الحسبة: ${calcDateTimeStr}</div>`;  
      html += `<div class="result-header">  
        <div class="client-chip">${consumerJobIcon} مرحباً ومسهلا يا ${name} <span style="font-size:11px; color:#6b7280; margin-right:5px;">(${consumerJobLabel})</span></div>  
        <div style="text-align:right;">  
          <span class="badge-mode">تمويل استهلاكي - نظام 11.67%</span><br>  
          <span class="badge-duration">مدة التمويل: ${duration}</span>  
        </div>  
      </div>`;  
  
      if (recommendedBank) {  
        const b = recommendedBank;  
        // الحصول على شعار البنك من الدالة المخصصة  
        const logoSrc = typeof getBankLogo === 'function' ? getBankLogo(b.bankName) : (bankLogoMap[b.bankName] || '');  
        const bankNoteHtml = b.bankNote ? `<div style="margin-top:8px; background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding:8px 12px; border-radius:8px; font-size:12px; color:#92400e;"><strong>📌 ملاحظة:</strong> ${b.bankNote}</div>` : '';  
        html += `<div class="bank-card">  
          <div class="bank-logo">${logoSrc ? `<img src="${logoSrc}" alt="${b.bankName}" style="width:60px; height:60px; object-fit:contain; border-radius:10px;">` : '🏦'}</div>  
          <div style="text-align:right; flex:1;">  
            <div class="bank-text-main" style="display:flex; align-items:center; gap:8px; justify-content:flex-end;">  
              <span>${b.bankName}</span>  
              ${logoSrc ? `<img src="${logoSrc}" style="width:24px; height:24px; object-fit:contain; border-radius:4px;">` : ''}  
            </div>  
            <div class="bank-text-sub">تم ترشيح هذا البنك/الشركة بناءً على راتبك ونوع التمويل بنسبة هامش ربح تقريبية: <strong>${b.margin}%</strong></div>  
            ${bankNoteHtml}  
          </div>  
        </div>`;  
      }  
  
      const monthlyInstFixed = consumerInst.toFixed(0);  
  
      html += `  
        <div class="result-main-block">  
          <div class="result-main-title">💳 التمويل الصافي </div>  
          <div class="result-amount-main">${finalNetFixed.replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</div>  
          <div class="result-amount-sub">التمويل الصافي بعد الرسوم الإدارية والضريبة ورسوم السلع.</div>  
  
          <div class="dual-main-grid">  
            <div class="dual-box">  
              <div class="dual-box-title">الصافي قبل أي رسوم</div>  
              <div class="dual-box-amount">${netWithoutFeesFixed.replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ر.س</div>  
            </div>  
            <div class="dual-box">  
              <div class="dual-box-title">بعد الرسوم الإدارية + الضريبة فقط</div>  
              <div class="dual-box-amount">${netAfterAdminFixed.replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ر.س</div>  
            </div>  
          </div>  
  
          <div style="margin-top:8px; font-size:13px; color:#374151;">  
            التمويل الصافي مكتوب بالحروف: <strong>${numberToArabicWords(parseInt(finalNetFixed))}</strong>  
          </div>  
  
          <div class="result-amount-small" style="margin-top:4px;">  
            القسط الشهري (11.67% من الراتب): <strong>${monthlyInstFixed.replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</strong>  
          </div>  
  
          <div class="result-amount-small" style="margin-top:2px;">  
            نسبة هامش الربح المحتسبة: <strong>${profitMargin}% سنوياً</strong>  
          </div>  
        </div>  
      `;  
  
      html += `  
        <div class="result-section-title">تفاصيل القسط المتوقع</div>  
        <div class="result-section-box">  
          <div class="instalment-row">  
            القسط من الشهر <strong>1</strong> إلى <strong>${months}</strong>:  
            <strong>${monthlyInstFixed.replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</strong>  
          </div>  
        </div>  
      `;  
  
      if (altBanks.length > 0) {  
        html += `  
          <div class="result-section-title">بنوك/شركات أخرى منافسة</div>  
          <div class="result-section-box">  
            <ul style="margin:0; padding-right:16px; font-size:13px; color:#4b5563; list-style-type:disc; text-align:right;">  
        `;  
        altBanks.forEach(b => {  
          html += `<li>${b.bankName} - نسبة هامش ربح تقريبية: <strong>${b.margin}%</strong></li>`;  
        });  
        html += `</ul></div>`;  
      }  
  
      html += `  
        <div class="result-section-title">ملخص الأرباح والرسوم</div>  
        <div class="result-section-box">  
          <div class="instalment-row">الربح دون الرسوم: <strong>${(totalInst - netWithoutFees).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</strong></div>  
          <div class="instalment-row">الربح مع الرسوم: <strong>${totalProfitWithFees.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</strong></div>  
          <div class="instalment-row">  
            الرسوم الإدارية: <strong>${adminFee.toFixed(0)} ريال</strong>  
            <div class="vat-small">(ضريبة القيمة المضافة لرسوم الادارية): ${vat.toFixed(0)} ريال</div>  
            + رسوم السلع: <strong>${commodityFee.toFixed(0)} ريال</strong>  
          </div>  
          <div class="instalment-row">إجمالي التمويل مع الأرباح : <strong>${totalInst.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</strong></div>  
        </div>  
  
        <div style="margin-top:10px; font-size:13px; color:#6b7280; text-align:right;">  
          ⚠️ هذه الحسبة تقريبية ، والنسب الفعلية ومنح التمويل يعتمد على سياسات الجهه الممولة وقت تقديم الطلب.  
          🔺تنوية/نحن لسنا جهة تمويلية، دورنا الوساطة و ننجزك مع الجهة التمويلية الافضل بأسرع وقت وبدون تعقيدات .  
        </div>  
        <div style="margin-top:8px; font-size:14px; font-weight:bold; color:#1e3a8a; text-align:center;">  
          تواصل معنا 📞 0506214458  
        </div>  
      `;  
  
      resultCard.innerHTML = html;  
        
      // عرض العروض الخاصة  
      showSpecialOffers(financeType, Number(finalNetFixed));  
        
      // عرض قسم التسويق والتقييم  
      updateMarketingAndRatingDisplay();  
  
      answers._lastCalc = {  
        calcDateTimeStr,  
        clientName: name,  
        financeType: financeType,  
        durationText: duration,  
        months: months,  
        recommendedBankName: (recommendedBank && recommendedBank.bankName) ? recommendedBank.bankName : 'غير محدد',  
        finalNet: Number(finalNetFixed),  
        netWithoutFees: Number(netWithoutFeesFixed),  
        netAfterAdmin: Number(netAfterAdminFixed),  
        totalInst: Number(totalInst.toFixed(0)),  
        adminFee: Number(adminFee.toFixed(0)),  
        vat: Number(vat.toFixed(0)),  
        commodityFee: Number(commodityFee.toFixed(0)),  
        supportSakaniAdded: 0,  
        supportEtezaazAdded: 0,  
        supportTotalAdded: 0,  
        mainShownValue: Number(finalNetFixed),  
        mainShownLabel: 'التمويل الصافي',  
        hasHousingSupport: false,  
        housingSupportMonthly: 0,  
        housingSupportTotalForLoan: 0,  
        housingSupportLumpSum: 0,  
        isEtezaaz: false,  
        phases: [{from:1,to:months,inst: Number(monthlyInstFixed)}]  
      };  
      return;  
    }  
  
    // ==== باقي المنتجات (شخصي/تأجيري/عقاري/شراء مديونية شخصي) ====  
    const isPersonalLike = (financeType && (financeType.includes('شخصي') || isLeasing)) || isBuyoutPersonal;  
    const isMortgage = financeType && financeType.includes('عقاري');  
  
    let deductionRate = 0, addCommodityFee = false;  
  
    // (إضافة) دعم سكني شهري (مؤقت) فقط لاستخدامه في دمج الراتب  
    const housingSupportMonthlyTmp = (financeType === 'تمويل عقاري' && supported === 'مدعوم' && bundle === 'لا')  
      ? getHousingSupportMonthlyBySalary(salary)  
      : 0;  
  
    // (إضافة) الراتب المستخدم لاحتساب الاستقطاع قبل التقاعد (قد يدمج الدعم)  
    let salaryForDeductionPre = salary;  
  
    if(isPersonalLike){  
      if(months > 60){ alert('مدة التمويل الشخصي / التأجيري لا تتجاوز 60 شهر'); return; }  
      deductionRate = 45;  
      addCommodityFee = true;  
    }else if(isMortgage){  
      // (إضافة) إذا راتب < 15000 + دعم شهري + العميل اختار دمج الدعم -> 65% على (الراتب + الدعم)  
      if(answers.includeSupportInSalary === 'نعم' && salary < 15000 && supported === 'مدعوم' && bundle === 'لا'){  
        deductionRate = 65;  
        salaryForDeductionPre = salary + housingSupportMonthlyTmp;  
      } else {  
        if(supported === 'مدعوم'){  
          if(answers.isEtezaaz === 'نعم'){  
            deductionRate = 65;  
          } else if(bundle === 'لا'){  
            deductionRate = 65;  
          } else {  
            deductionRate = salary < 15000 ? 55 : 65;  
          }  
        }else{  
          deductionRate = salary < 15000 ? 55 : 65;  
        }  
      }  
    }  
  
    // (إضافة) الاستقطاع بعد التقاعد:  
    // - العقاري: نفس النسبة لكن على راتب التقاعد  
    // - الشخصي/التأجيري/شراء المديونية الشخصي: 25% على راتب التقاعد  
    const postDeductionRate = (isPersonalLike && isExtended) ? 25 : deductionRate;  
  
    let allowedInstPre = salaryForDeductionPre * deductionRate / 100;  
    let allowedInstPost = (isExtended ? (pensionSalaryEst * postDeductionRate / 100) : allowedInstPre);  
  
    let commits = [...answers.commitments].sort((a,b)=>parseInt(a.months)-parseInt(b.months));  
    let balloonPhases = [];  
  
    commits.forEach((c) => {  
      if (c.type === 'قرض سيارة' && c.balloon === 'نعم' && c.balloonAmount) {  
        const start = parseInt(c.months);  
        const end = start + 24;  
        balloonPhases.push({ start, end, value: c.balloonAmount / 24 });  
      }  
    });  
  
    // (إضافة) التحقق من اختيار القسط المرن المخفض
    const wantFlexible = answers.wantFlexibleInstallment === 'نعم';
    const flexibleAmount = wantFlexible ? parseFloat(answers.flexibleInstallmentAmount || '0') : 0;
    const flexibleMonths = wantFlexible ? parseInt(answers.flexibleInstallmentMonths || '0') : 0;

    let futurePhases = [];  
    for(let mmx = 1; mmx <= months; mmx++) {  
      let activeCommits = commits  
        .filter(c => mmx <= parseInt(c.months))  
        .reduce((sum, c) => sum + (c.amount || 0), 0);  

      let balloonExtra = balloonPhases.reduce((sum, b) =>  
        (mmx >= b.start && mmx < b.end) ? sum + b.value : sum, 0);  

      // (إضافة) تحديد الاستقطاع حسب قبل/بعد التقاعد للممتد  
      const monthAllowed = (isExtended && mmx > preRetMonths) ? allowedInstPost : allowedInstPre;  

      let available = monthAllowed - activeCommits - balloonExtra;  

      if(isPersonalLike){  
        // (إضافة) حد 33.33% قبل التقاعد على الراتب، وبعد التقاعد على راتب التقاعد (لو ممتد)  
        const baseForCap = (isExtended && mmx > preRetMonths) ? (pensionSalaryEst || 0) : salary;  
        available = Math.min(available, baseForCap * 0.3333);  
      }
      
      // (إضافة) تطبيق القسط المرن المخفض إذا اختاره العميل
      if (wantFlexible && mmx <= flexibleMonths && flexibleAmount > 0) {
        // في فترة القسط المرن، نستخدم القسط المخفض الذي اختاره العميل
        available = Math.min(available, flexibleAmount);
      }
        
      futurePhases.push({ month: mmx, inst: available });  
    }
  
    let finalPhases = [];  
    for (let i = 0; i < futurePhases.length; i++) {  
      if (i === 0 || futurePhases[i].inst !== finalPhases[finalPhases.length - 1]?.inst) {  
        finalPhases.push({ from: futurePhases[i].month, to: futurePhases[i].month, inst: futurePhases[i].inst });  
      } else {  
        finalPhases[finalPhases.length - 1].to = futurePhases[i].month;  
      }  
    }  
  
    // التحقق من وجود قيم سالبة في الأقساط (عجز)  
    const hasNegativeInstalment = finalPhases.some(p => p.inst < 0);  
    const minInstalment = Math.min(...finalPhases.map(p => p.inst));  
      
    let totalInst = finalPhases.reduce((s,p)=>s + p.inst * (p.to - p.from + 1), 0);  
    const profitFactor = (years * profitMargin / 100) + 1;  
    let netFinance = totalInst / profitFactor;
    
    // ====== معالجة التمويل المحدد ======
    let isSpecificAmountUsed = false;
    let specificAmountValue = 0;
    let recalculatedInstallment = 0;
    
    if (answers._specificAmountApproved && answers.specificFinanceAmount) {
      specificAmountValue = parseFloat(answers.specificFinanceAmount);
      
      // التحقق من أن المبلغ المحدد أقل من الحد الأقصى
      if (specificAmountValue > 0 && specificAmountValue <= netFinance) {
        isSpecificAmountUsed = true;
        
        // إعادة حساب القسط بناءً على التمويل المحدد
        // التمويل المحدد = إجمالي الأقساط / معامل الربح
        // إذن إجمالي الأقساط = التمويل المحدد * معامل الربح
        const newTotalInst = specificAmountValue * profitFactor;
        recalculatedInstallment = newTotalInst / months;
        
        // تحديث القيم
        totalInst = newTotalInst;
        netFinance = specificAmountValue;
        
        // تحديث مراحل الأقساط لتعكس القسط الجديد
        finalPhases = [{ from: 1, to: months, inst: recalculatedInstallment }];
        
        console.log('تم تطبيق التمويل المحدد:', {
          'المبلغ المحدد': specificAmountValue,
          'القسط الجديد': recalculatedInstallment,
          'إجمالي الأقساط': newTotalInst
        });
      }
    }  
  
    let adminFee = 0, vat = 0;  
    if (isPersonalLike) {  
      adminFee = netFinance * 0.005;  
      if (adminFee > 2500) adminFee = 2500;  
      vat = adminFee * 0.15;  
    } else {  
      adminFee = netFinance * 0.01;  
      vat = adminFee * 0.15;  
      if(adminFee + vat > 5750){ adminFee = 5000; vat = 750; }  
    }  
  
    const commodityFee = addCommodityFee ? netFinance * 0.01 : 0;  
  
    const netWithoutFees = netFinance;  
    const netAfterAdmin = netFinance - (adminFee + vat);  
    const finalNet = netAfterAdmin - commodityFee;  
    const totalProfitWithFees = totalInst - finalNet;  
  
    // ✅ دعم سكني/اعتزاز (اعتزاز ثابت 160,000 ولا يتعارض)  
    const ETEZAAZ_FIXED = 160000;  
  
    let supportText = '';  
    let housingSupportMonthly = 0;  
    let housingSupportTotalForLoan = 0;  
    let housingSupportLumpSum = 0;  
  
    let supportSakaniAdded = 0;  
    let supportEtezaazAdded = 0;  
  
    if(financeType === 'تمويل عقاري' && supported === 'مدعوم'){  
      if (bundle === 'لا') {  
        housingSupportMonthly = getHousingSupportMonthlyBySalary(salary);  
        const dist = Math.min(months, 240);  
        housingSupportTotalForLoan = housingSupportMonthly * dist;  
        supportSakaniAdded = housingSupportTotalForLoan;  
  
        supportText += `  
          <div class="support-panel">  
            <div class="support-title">✅ دعم سكني (شهري) حسب مصفوفة الدعم</div>  
            <div class="support-row"><span>قيمة الدعم الشهري</span><strong>${fmtMoney(housingSupportMonthly)}</strong></div>  
            <div class="support-row"><span>إجمالي الدعم حتى ${dist} شهر</span><strong>${fmtMoney(housingSupportTotalForLoan)}</strong></div>  
            <div class="support-badge">🟢 يتم صرف الدعم شهرياً</div>  
          </div>  
        `;  
      } else {  
        // تقديري كما كان  
        const sup = salary < 10000 ? 150000 : 100000;  
        housingSupportLumpSum = sup;  
        supportSakaniAdded = sup;  
  
        supportText += `  
          <div class="support-panel">  
            <div class="support-title">✅ دعم سكني </div>  
            <div class="support-row" style="border-bottom:none;"><span>قيمة الدعم التقديرية</span><strong>${fmtMoney(sup)}</strong></div>  
          </div>  
        `;  
      }  
  
      if (answers.isEtezaaz === 'نعم') {  
        supportEtezaazAdded = ETEZAAZ_FIXED;  
        supportText += `  
          <div class="support-panel" style="margin-top:8px;">  
            <div class="support-title">🛡️ دعم اعتزاز (وزارة الدفاع)</div>  
            <div class="support-row"><span>قيمة الدعم (ثابت)</span><strong>${fmtMoney(ETEZAAZ_FIXED)}</strong></div>  
            <div class="support-row" style="border-bottom:none;"><span>ملاحظة</span><strong>دعم إضافي مستقل لا يتعارض مع دعم سكني</strong></div>  
            <div class="support-badge">⏳ تبدأ الاقساط بعد سنتين</div>  
          </div>  
        `;  
      }  
    }  
  
    const supportTotalAdded = (supportSakaniAdded || 0) + (supportEtezaazAdded || 0);  
  
    const name = answers.clientName || "العميل";  
    const duration = describeMonths(months);  
    const finalNetFixed = finalNet.toFixed(0);  
    const netAfterAdminFixed = netAfterAdmin.toFixed(0);  
    const netWithoutFeesFixed = netWithoutFees.toFixed(0);  
  
    const allNegative = finalPhases.every(p => p.inst <= 0);  
  
    const buyoutAmount = isBuyoutPersonal ? parseFloat(answers.buyoutAmount || '0') : 0;  
    const netAfterBuyout = finalNet - buyoutAmount;  
  
      const matchingBanks = getMatchingBanksForAnswers();
    // استخدام البنك المختار من العميل إذا كان موجوداً
    // إذا كان المستخدم اختار جهة معينة، لا نستبدلها بالبنك الأفضل
    let recommendedBank = answers.recommendedBank;
    if (!recommendedBank && answers.calcMode === 'ترشيح بنك مناسب تلقائياً') {
      recommendedBank = matchingBanks[0] || null;
    }
    const altBanks = matchingBanks.filter(b => b.bankName !== (recommendedBank ? recommendedBank.bankName : '')).slice(0, 3);  
    if (recommendedBank) answers.recommendedBank = recommendedBank;  

    // ====== MAIN DISPLAY VALUEUE حسب طلبك ======  
    let mainShownValue = Number(finalNetFixed);  
    let mainShownLabel = 'التمويل الصافي';  
  
    // (1) العقاري:   = صافي التمويل + الدعم (لكن لا يتم إضافة الدعم الشهري على الصافي)  
    if(isMortgage){  
      const supportAddedToNet = Number(supportEtezaazAdded || 0) + (housingSupportMonthly > 0 ? 0 : Number(supportSakaniAdded || 0));  
      mainShownValue = Number(finalNetFixed) + supportAddedToNet;  
      mainShownLabel = supportAddedToNet > 0 ? 'صافي التمويل مضاف له الدعم' : 'التمويل الصافي';  
    }  
  
    // (2) شراء المديونية الشخصي:  = ما يصفي للعميل  
    if(isBuyoutPersonal && buyoutAmount > 0){  
      mainShownValue = Number(netAfterBuyout.toFixed(0));  
      mainShownLabel = 'ما يصفي للعميل بعد سداد التمويل القديم';  
    }  
  
    showPage('result');  
    const resultCard = document.getElementById('resultCard');  
    let html = '';  
  
    // الترحيب حسب الوقت  
    const hour = new Date().getHours();  
    let greetEmoji = '🌅';  
    let greetText = 'صباح الخير';  
    if (hour >= 12 && hour < 17) { greetEmoji = '☀️'; greetText = 'مساء النور'; }  
    else if (hour >= 17 && hour < 21) { greetEmoji = '🌇'; greetText = 'مساء الخير'; }  
    else if (hour >= 21 || hour < 5) { greetEmoji = '🌙'; greetText = 'أهلاً بالليل'; }  
      
    // بطاقة الترحيب العصرية  
    html += `  
      <div class="result-greeting-card">  
        <div class="result-greeting-emoji">${greetEmoji}</div>  
        <div class="result-greeting-text">أرحب يا ${name}! ${greetText}</div>  
        <div class="result-greeting-sub">🎉 خلصنا الحسبة وجاك الخبر الحلو!</div>  
      </div>  
    `;  
      
    // رسالة تنبيه عند وجود عجز في الأقساط  
    if (hasNegativeInstalment) {  
      html += `  
        <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: 2px solid #ef4444; border-radius: 16px; padding: 20px; margin-bottom: 16px; text-align: center;">  
          <div style="font-size: 40px; margin-bottom: 10px;">⚠️</div>  
          <div style="font-size: 18px; font-weight: 800; color: #dc2626; margin-bottom: 8px;">للأسف يا ${name} معليش!</div>  
          <div style="font-size: 15px; color: #991b1b; line-height: 1.8;">  
            عندك عجز بالأقساط أو التزاماتك لا تسمح بالحصول على هذا التمويل.<br>  
            <strong>العجز الشهري: ${Math.abs(minInstalment).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</strong><br>  
            <span style="font-size: 13px;">يرجى مراجعة الالتزامات أو تقليل مدة التمويل أو انتظار انتهاء بعض الالتزامات.</span>  
          </div>  
        </div>  
      `;  
    }  
      
    html += `<div style="font-size:13px; color:#64748b; text-align:right; margin-bottom:8px;">تاريخ ووقت الحسبة: ${calcDateTimeStr}</div>`;  
  
    // أيقونة نوع الوظيفة  
    const jobTypeIcon = answers.jobType === 'عسكري' ? '🎖️' :   
                        answers.jobType === 'حكومي' ? '👔' :   
                        answers.jobType === 'قطاع خاص' ? '🏢' :   
                        answers.jobType === 'متقاعد' ? '🧓' : '👤';  
    const jobTypeLabel = answers.jobType || 'غير محدد';  
      
    html += `<div class="result-header">  
      <div class="client-chip">${jobTypeIcon} ${name} <span style="font-size:11px; color:#6b7280; margin-right:5px;">${jobTypeLabel}</span></div>  
      <div style="text-align:right;">  
        <span class="badge-mode">${answers.calcMode === 'ترشيح بنك مناسب تلقائياً' ? 'ترشيح بنك مناسب' : 'الحسبة على النسبة المدخلة'}</span><br>  
        <span class="badge-duration">مدة التمويل: ${duration}</span>  
      </div>  
    </div>`;  
  
    // إضافة اسم المنتج إذا كان موجوداً  
    const productName = answers.mortgageProductType || '';  
    
    // إضافة اسم البنك الذي عليه النسبة (إذا أدخله العميل)
    const selectedBankForRate = answers.currentBank || answers.selectedFinanceEntity || '';
    
    // إضافة جهة العمل (إذا ذكرها العميل)
    const workEntity = answers.governmentEntity || answers.privateCompany || '';
    
    // إضافة التمويل المحدد (إذا اختاره العميل)
    const specificAmount = answers._specificAmountApproved ? answers.specificFinanceAmount : 0;
    
    // إضافة إجابات الأسئلة الإضافية (المخصصة من المسؤول)
    let customQuestionsHtml = '';
    const productQuestionsForResult = typeof loadProductQuestions === 'function' ? loadProductQuestions() : [];
    if (productQuestionsForResult.length > 0) {
      productQuestionsForResult.forEach(pq => {
        // التحقق من وجود إجابة لهذا السؤال
        const answerValue = answers[pq.id];
        if (answerValue !== undefined && answerValue !== null && answerValue !== '') {
          customQuestionsHtml += `<span class="badge-duration" style="background:#f3e8ff; color:#7c3aed;">📝 ${pq.text}: ${answerValue}</span>`;
        }
      });
    }
    
    html += `<div style="display:flex; flex-direction:column; align-items:flex-end; margin:6px 0 10px; gap:4px;">  
      <span class="badge-duration">نوع التمويل: ${financeType}</span>  
      ${productName ? `<span class="badge-duration" style="background:#e0f2fe; color:#0369a1;">المنتج: ${productName}</span>` : ''}  
      ${selectedBankForRate ? `<span class="badge-duration" style="background:#fef3c7; color:#92400e;">🏦 البنك: ${selectedBankForRate}</span>` : ''}  
      ${workEntity ? `<span class="badge-duration" style="background:#ecfdf5; color:#065f46;">🏛️ جهة العمل: ${workEntity}</span>` : ''}  
      ${specificAmount ? `<span class="badge-duration" style="background:#dbeafe; color:#1e40af;">💵 تم تحديد التمويل بـ: ${specificAmount.toLocaleString()} ريال</span>` : ''}  
      ${customQuestionsHtml}
    </div>`;  
  
    if (recommendedBank) {  
      const b = recommendedBank;  
      // الحصول على شعار البنك من الدالة المخصصة  
      const logoSrc = typeof getBankLogo === 'function' ? getBankLogo(b.bankName) : (bankLogoMap[b.bankName] || '');  
      const bankNoteHtml = b.bankNote ? `<div style="margin-top:8px; background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding:8px 12px; border-radius:8px; font-size:12px; color:#92400e;"><strong>📌 ملاحظة:</strong> ${b.bankNote}</div>` : '';  
        
      // تنبيه اقتراب انتهاء صلاحية النسبة  
      let rateExpiryHtml = '';  
      if (b.rateExpiryDate) {  
        const expiryDate = new Date(b.rateExpiryDate);  
        const today = new Date();  
        today.setHours(0, 0, 0, 0);  
        expiryDate.setHours(0, 0, 0, 0);  
        const diffTime = expiryDate - today;  
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));  
          
        if (diffDays <= 10 && diffDays > 0) {  
          rateExpiryHtml = `<div style="margin-top:8px; background:linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); padding:8px 12px; border-radius:8px; font-size:12px; color:#991b1b; border:1px solid #fca5a5;">  
            <strong>⚠️ تنبيه:</strong> هذه النسبة صالحة لمدة <strong>${diffDays} يوم</strong> فقط! قد تتغير بعد ذلك.  
          </div>`;  
        } else if (diffDays <= 0) {  
          rateExpiryHtml = `<div style="margin-top:8px; background:linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); padding:8px 12px; border-radius:8px; font-size:12px; color:#991b1b; border:1px solid #fca5a5;">  
            <strong>⚠️ تنبيه:</strong> هذه النسبة <strong>منتهية الصلاحية</strong>! يرجى التأكد من جهة التمويل.  
          </div>`;  
        }  
      }  
      html += `<div class="bank-card">  
        <div class="bank-logo">${logoSrc ? `<img src="${logoSrc}" alt="${b.bankName}" style="width:60px; height:60px; object-fit:contain; border-radius:10px;">` : '🏦'}</div>  
        <div style="text-align:right; flex:1;">  
          <div class="bank-text-main" style="display:flex; align-items:center; gap:8px; justify-content:flex-end;">  
            <span>${b.bankName}</span>  
            ${logoSrc ? `<img src="${logoSrc}" style="width:24px; height:24px; object-fit:contain; border-radius:4px;">` : ''}  
          </div>  
          <div class="bank-text-sub">تم ترشيح هذا البنك/الشركة بناءً على راتبك ونوع التمويل بنسبة هامش ربح تقريبية: <strong>${b.margin}%</strong></div>  
          ${bankNoteHtml}  
          ${rateExpiryHtml}  
        </div>  
      </div>`;  
    }  
  
    if (allNegative) {  
      html += `<div class="alert-error">نعتذر منك، حسب البيانات المدخلة لا يمكنك الحصول على تمويل.</div>`;  
    }  
  
    // بطاقة التقاعد العصرية (للعسكريين فقط)  
    if(isExtended){  
      // حساب السنوات والأشهر المتبقية  
      const remainingYears = Math.floor(timing.rankRemainingMonths / 12);  
      const remainingMonthsLeft = timing.rankRemainingMonths % 12;  
      const remainingText = remainingYears > 0   
        ? `${remainingYears} سنة و ${remainingMonthsLeft} شهر`  
        : `${remainingMonthsLeft} شهر`;  
        
      // الحصول على معلومات الراتب الأساسي عند التقاعد  
      const basicAtRetirement = pensionResult.basicSalaryAtRetirement || 0;  
      const totalServiceYears = pensionResult.totalServiceYears || 0;  
      const totalServiceMonths = pensionResult.totalServiceMonths || 0;  
        
      html += `  
        <div class="retirement-card">  
          <div class="retirement-title">🎖️ معلومات التقاعد يا ${name}</div>  
          <div class="retirement-row">  
            <span>اخترت التمويل الممتد بعد التقاعد</span>  
            <span class="retirement-value">✅ نعم</span>  
          </div>  
          <div class="retirement-row">  
            <span>الرتبة العسكرية</span>  
            <span class="retirement-value">${answers.militaryRank || 'غير محدد'}</span>  
          </div>  
          <div class="retirement-row">  
            <span>سنوات الخدمة عند التقاعد</span>  
            <span class="retirement-value">${totalServiceYears} سنة (${totalServiceMonths} شهر)</span>  
          </div>  
          <div class="retirement-row">  
            <span>الراتب الأساسي عند التقاعد</span>  
            <span class="retirement-value">${basicAtRetirement.toLocaleString()} ريال</span>  
          </div>  
          <div class="retirement-row" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 10px; margin-top: 8px;">  
            <span style="font-weight: 800; color: #92400e;">راتب التقاعد المتوقع</span>  
            <span class="retirement-value" style="font-size: 18px; color: #92400e; font-weight: 900;">${pensionSalaryEst.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</span>  
          </div>  
          <div class="retirement-row">  
            <span>تتقاعد يا ${name} بعد عمر طويل بالطاعة بعد</span>  
            <span class="retirement-value">${remainingText}</span>  
          </div>  
          <div class="retirement-row">  
            <span>تاريخ التقاعد المتوقع (هجري)</span>  
            <span class="retirement-value">${timing.rankRetHijriStr}</span>  
          </div>  
          <div style="margin-top:12px; font-size:12px; color:#065f46; text-align:right; background: #ecfdf5; padding: 10px; border-radius: 10px;">  
            <strong>📊 المعادلة الرسمية:</strong><br>  
            راتب التقاعد = (الراتب الأساسي الأخير × أشهر الخدمة) ÷ 420<br>  
            = (${basicAtRetirement.toLocaleString()} × ${totalServiceMonths}) ÷ 420 = <strong>${pensionSalaryEst.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</strong>  
          </div>  
          <div style="margin-top:8px; font-size:12px; color:#6b7280; text-align:right;">  
            📝 الأقساط قبل التقاعد على راتبك الحالي، وبعد التقاعد على راتب التقاعد.  
          </div>  
        </div>  
      `;  
    }  
  
    // ====== كتلة النتيجة الأساسية ( ) ======  
    html += `  
      <div class="result-main-block">  
        <div class="result-main-title">${mainShownLabel}</div>  
        <div class="result-amount-main">${fmtMoney(mainShownValue).replace(' ريال','')} ريال</div>  
    `;  
  
    // تفصيل دعم العقاري تحت بخط أصغر (حسب طلبك)  
    if(isMortgage){  
      const base = Number(finalNetFixed);  
      html += `  
        <div class="result-amount-sub">هذه هي النتيجة التي يبحث عنها العميل: (صافي التمويل + الدعم إن وجد)</div>  
        <div class="result-amount-small">  
          صافي التمويل: <strong>${fmtMoney(base)}</strong><br>  
          ${supportSakaniAdded ? `دعم سكني المضاف: <strong>${fmtMoney(supportSakaniAdded)}</strong><br>` : `دعم سكني المضاف: <strong>لا يوجد</strong><br>`}  
          ${supportEtezaazAdded ? `دعم اعتزاز المضاف: <strong>${fmtMoney(supportEtezaazAdded)}</strong><br>` : `دعم اعتزاز المضاف: <strong>لا يوجد</strong><br>`}  
          ${  
            (housingSupportMonthly > 0)  
              ? `الإجمالي المعروض (لا يشمل الدعم الشهري): <strong>${fmtMoney(mainShownValue)}</strong>`  
              : `الإجمالي (صافي التمويل + الدعم): <strong>${fmtMoney(mainShownValue)}</strong>`  
          }  
        </div>  
      `;  
    } else if(isBuyoutPersonal && buyoutAmount > 0){  
      html += `  
        <div class="result-amount-sub">هذه هي النتيجة التي يبحث عنها العميل: (الصافي بعد سداد التمويل القديم)</div>  
        <div class="result-amount-small">  
          التمويل الصافي قبل السداد: <strong>${fmtMoney(Number(finalNetFixed))}</strong><br>  
          مبلغ السداد المبكر: <strong>${fmtMoney(buyoutAmount)}</strong><br>  
          ما يصفي للعميل: <strong>${fmtMoney(mainShownValue)}</strong>  
        </div>  
      `;  
    } else {  
      html += `<div class="result-amount-sub">التمويل الصافي بعد خصم الرسوم الإدارية والضريبة ${addCommodityFee ? 'ورسوم السلع' : ''}.</div>`;  
    }  
  
    // دعم تفصيلي (لو موجود) يبقى داخل النتيجة  
    if(supportText) html += supportText;  
  
    // مربعات الصافي التفصيلية (تبقى)  
    html += `  
        <div class="dual-main-grid">  
          <div class="dual-box">  
            <div class="dual-box-title">الصافي قبل أي رسوم</div>  
            <div class="dual-box-amount">${netWithoutFeesFixed.replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ر.س</div>  
          </div>  
          <div class="dual-box">  
            <div class="dual-box-title">بعد الرسوم الإدارية + ضريبة القيمة المضافة على الرسوم </div>  
            <div class="dual-box-amount">${netAfterAdminFixed.replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ر.س</div>  
          </div>  
        </div>  
  
        <div style="margin-top:8px; font-size:13px; color:#374151;">  
          التمويل الصافي مكتوب بالحروف:  
          <strong>${numberToArabicWords(parseInt(finalNetFixed))}</strong>  
        </div>  
  
        <div class="result-amount-small" style="margin-top:4px;">  
          نسبة هامش الربح المحتسبة: <strong>${profitMargin}% سنوياً</strong>  
        </div>  
      </div>  
    `;  
  
    // الأقساط مع الفترات التفصيلية  
    html += `  
      <div class="result-section-title">تفاصيل القسط المتوقع حسب الفترات</div>  
      <div class="result-section-box">  
    `;  
      
    // تحضير أسباب الفترات  
    const phaseReasons = [];  
    let currentPhaseIndex = 0;  
      
    // التزامات العميل لتحديد الأسباب  
    const commitments = [];  
    if (answers.hasPersonalLoan === 'نعم' && answers.personalLoanMonths > 0) {  
      commitments.push({ type: 'قرض شخصي', months: parseInt(answers.personalLoanMonths) || 0 });  
    }  
    if (answers.hasCarLoan === 'نعم' && answers.carLoanMonths > 0) {  
      commitments.push({ type: 'قرض سيارة', months: parseInt(answers.carLoanMonths) || 0 });  
    }  
    if (answers.hasCreditCard === 'نعم' && answers.creditCardMonths > 0) {  
      commitments.push({ type: 'بطاقة ائتمانية', months: parseInt(answers.creditCardMonths) || 0 });  
    }  
    if (answers.hasOtherLoan === 'نعم' && answers.otherLoanMonths > 0) {  
      commitments.push({ type: 'قرض آخر', months: parseInt(answers.otherLoanMonths) || 0 });  
    }  
      
    // ترتيب الالتزامات حسب الأشهر المتبقية  
    commitments.sort((a, b) => a.months - b.months);  
      
    finalPhases.forEach((p, idx) => {  
      let reason = '';  
        
      if (idx === 0 && commitments.length > 0) {  
        reason = `(فترة الالتزامات الحالية)`;  
      } else if (idx < commitments.length) {  
        const prevCommitment = commitments[idx - 1];  
        if (prevCommitment) {  
          reason = `(بعد انتهاء ${prevCommitment.type})`;  
        }  
      } else if (isExtended && idx === finalPhases.length - 1) {  
        reason = `(فترة التقاعد)`;  
      } else if (idx === finalPhases.length - 1 && commitments.length > 0) {  
        reason = `(بعد انتهاء جميع الالتزامات)`;  
      }  
        
      html += `  
        <div class="instalment-row" style="border-bottom:1px dashed #e5e7eb; padding-bottom:8px; margin-bottom:8px;">  
          <div style="display:flex; justify-content:space-between; align-items:center;">  
            <span>القسط من الشهر <strong>${p.from}</strong> إلى <strong>${p.to}</strong>:</span>  
            <strong style="color:#1e40af;">${p.inst.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</strong>  
          </div>  
          ${reason ? `<div style="font-size:11px; color:#6b7280; margin-top:4px;">📌 ${reason}</div>` : ''}  
        </div>  
      `;  
    });  
    html += `</div>`;  
  
    if (altBanks.length > 0) {  
      html += `  
        <div class="result-section-title">٣ بنوك/شركات أخرى منافسة</div>  
        <div class="result-section-box">  
          <ul style="margin:0; padding-right:16px; font-size:13px; color:#4b5563; list-style-type:disc; text-align:right;">  
      `;  
      altBanks.forEach(b => {  
        html += `<li>${b.bankName} - نسبة هامش ربح تقريبية: <strong>${b.margin}%</strong></li>`;  
      });  
      html += `</ul></div>`;  
    }  
  
    // الرسوم والربح  
    html += `  
      <div class="result-section-title">ملخص الأرباح والرسوم</div>  
      <div class="result-section-box">  
        <div class="instalment-row">  
          الربح دون الرسوم:  
          <strong>${(totalInst - netWithoutFees).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</strong>  
        </div>  
        <div class="instalment-row">  
          الربح مع الرسوم:  
          <strong>${totalProfitWithFees.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</strong>  
        </div>  
        <div class="instalment-row">  
          الرسوم الإدارية:  
          <strong>${adminFee.toFixed(0)} ريال</strong>  
          <div class="vat-small">(ضريبة القيمة المضافة لرسوم الادارية): ${vat.toFixed(0)} ريال</div>  
          ${addCommodityFee ? ` + رسوم السلع: <strong>${commodityFee.toFixed(0)} ريال</strong>` : ''}  
        </div>  
        <div class="instalment-row">  
          إجمالي التمويل مع الأرباح :  
          <strong>${totalInst.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</strong>  
        </div>  
      </div>  
      <div style="margin-top:10px; font-size:13px; color:#6b7280; text-align:right;">  
        ⚠️ هذه الحسبة تقريبية ، والنسب الفعلية ومنح التمويل يعتمد على سياسات الجهه الممولة وقت تقديم الطلب.  
🔺تنويه: لسنا جهة تمويلية، دورنا ننجزك مع افضل جهة تمويلية بأسرع وقت وبدون تعقيدات⚡️  
      </div>  
    `;  
  
    // تنبيه للقطاع الخاص فقط  
    if (answers.jobType === 'قطاع خاص') {  
      html += `  
        <div class="notice-soft">  
          تنبيه: جميع حالات القطاع الخاص (شبه حكومي/معتمد/غير معتمد) تخضع لاعتماد الجهة الممولة وقد تختلف الشروط حسب سياسة كل جهة.  
        </div>  
      `;  
    }  
  
    // تنبيه اعتزاز (طلبك)  
    if (answers.isEtezaaz === 'نعم') {  
      html += `  
        <div class="notice-soft">  
          تنبيه اعتزاز: دعم وزارة الدفاع يبدأ بعد سنتين، ولا تتوفر لدينا تفاصيل دقيقة لقيمة القسط — يرجى التواصل مع جهة عملك لمعرفة التفاصيل الكاملة.  
        </div>  
      `;  
    }  
  
    // (إضافة) تاريخ انتهاء التمويل  
    const platformSettings = loadPlatformSettings();  
    if (platformSettings.showEndDate) {  
      const endDate = calculateFinanceEndDate(months);  
      html += `  
        <div class="result-end-date">  
          <div class="result-end-date-title">📅 تاريخ انتهاء التمويل (تقريبي)</div>  
          <div class="result-end-date-value">${endDate.gregorian}</div>  
          <div style="font-size:13px; color:#047857;">هجري: ${endDate.hijri}</div>  
          <div class="result-end-date-message">${platformSettings.endDateMessage || 'الله يطول بعمرنا ويبارك لنا'}</div>  
        </div>  
      `;  
    }  
      
    // (إضافة) الإعلانات المستهدفة مع الرسائل المخصصة  
    const matchingAds = getMatchingAds(salary, Number(finalNetFixed), financeType, recommendedBank?.bankName || '');  
    if (matchingAds.length > 0) {  
      matchingAds.forEach(ad => {  
        // استبدال المتغيرات في الرسالة المخصصة  
        let customMsg = ad.customMessage || '';  
        if (customMsg) {  
          customMsg = customMsg.replace(/{name}/g, name).replace(/{amount}/g, fmtMoney(Number(finalNetFixed)));  
        }  
          
        html += `  
          <div class="ad-card" style="background:linear-gradient(135deg,#fef3c7,#fde68a); border:2px solid #f59e0b; padding:15px; border-radius:15px; margin-top:12px;">  
            <div class="ad-title" style="font-size:16px; font-weight:800; color:#92400e; margin-bottom:8px;">🌟 ${ad.title}</div>  
            <div class="ad-text" style="font-size:14px; color:#78350f; margin-bottom:10px;">${ad.text}</div>  
            ${customMsg ? `<div style="background:#fff; padding:10px; border-radius:10px; font-size:15px; font-weight:700; color:#1e40af; text-align:center; margin-bottom:10px;">💬 ${customMsg}</div>` : ''}  
            ${ad.videoUrl ? `<div style="margin-bottom:10px;"><a href="${ad.videoUrl}" target="_blank" style="display:inline-flex; align-items:center; gap:5px; background:#ef4444; color:#fff; padding:8px 15px; border-radius:8px; text-decoration:none; font-size:13px;">🎥 شاهد الفيديو</a></div>` : ''}  
            ${ad.link ? `<a href="${ad.link}" target="_blank" class="ad-cta" style="display:inline-block; background:#1e40af; color:#fff; padding:8px 20px; border-radius:8px; text-decoration:none; font-size:13px;">${ad.linkText || 'تواصل معنا'}</a>` : ''}  
          </div>  
        `;  
      });  
    }  
  
    // إضافة إجابات الأسئلة المخصصة للمنتجات في النتيجة  
    const productQuestionsShare = loadProductQuestions();  
    const selectedBankShare = answers.selectedFinanceEntity || answers.currentBank || '';  
    const clientJobTypeShare = answers.jobType || '';  
    const relevantProductQuestions = productQuestionsShare.filter(pq => {  
      // فحص التفعيل  
      if (!pq.enabled) return false;  
      // فحص المنتج  
      if (pq.product !== 'all' && pq.product !== financeType) return false;  
      // فحص جهة التمويل المستهدفة  
      if (pq.target && pq.target !== 'all' && pq.target !== selectedBankShare) return false;  
      // فحص نوع الوظيفة  
      if (pq.jobType && pq.jobType !== 'all' && pq.jobType !== clientJobTypeShare) return false;  
      // فحص إظهار في النتيجة  
      if (pq.showInResult === 'no') return false;  
      return true;  
    });  
      
    if (relevantProductQuestions.length > 0) {  
      let productAnswersHtml = '';  
      relevantProductQuestions.forEach(pq => {  
        const answer = answers[pq.id];  
        if (answer && answer.trim()) {  
          productAnswersHtml += `  
            <div style="background:#f0fdf4; padding:8px 12px; border-radius:8px; margin-bottom:6px; border-right:3px solid #22c55e;">  
              <span style="font-size:12px; color:#166534;">${pq.text}:</span>  
              <span style="font-size:13px; font-weight:600; color:#15803d; margin-right:5px;">${answer}</span>  
            </div>  
          `;  
        }  
      });  
        
      if (productAnswersHtml) {  
        html += `  
          <div style="margin-top:15px; padding:12px; background:#ecfdf5; border-radius:12px; border:1px solid #86efac;">  
            <div style="font-size:13px; font-weight:700; color:#166534; margin-bottom:8px;">📋 معلومات إضافية عن ${name}:</div>  
            ${productAnswersHtml}  
          </div>  
        `;  
      }  
    }  
      
    html += `  
      <div style="margin-top:8px; font-size:14px; font-weight:900; color:#1e3a8a; text-align:center;">  
        تواصل معنا 📞 0506214458  
      </div>  
    `;  
  
    resultCard.innerHTML = html;  
      
    // (إضافة) حفظ النتيجة في سجل العشوائية  
    if (typeof saveClientResult === 'function') {  
      saveClientResult({  
        clientName: name,  
        financeType: financeType,  
        finalNet: Number(finalNetFixed),  
        recommendedBankName: recommendedBank?.bankName || '',  
        salary: salary,  
        months: months  
      });  
    }  
      
    // جلب الإعلانات المستهدفة  
    if (typeof getMatchingAds === 'function') {  
      const ads = getMatchingAds(salary, Number(finalNetFixed), financeType, recommendedBank?.bankName);  
      if (ads.length > 0) {  
        const adsHtml = `  
          <div class="targeted-ads-container" style="margin-top:20px;">  
            ${ads.map(ad => `  
              <div class="ad-card fade-in" style="background:white; padding:15px; border-radius:12px; border:1px solid #e5e7eb; margin-bottom:10px; position:relative;">  
                <div class="ad-badge" style="position:absolute; top:10px; left:10px; background:var(--accent-color); color:white; font-size:10px; padding:2px 8px; border-radius:10px;">إعلان مميز</div>  
                <h4 style="margin:0 0 5px; color:var(--primary-color);">${ad.title}</h4>  
                <p style="margin:0 0 10px; font-size:13px; color:#4b5563;">${ad.text}</p>  
                <button class="secondary small" onclick="window.open('${ad.link || '#'}')">${ad.linkText || 'اكتشف المزيد'}</button>  
              </div>  
            `).join('')}  
          </div>  
        `;  
        resultCard.innerHTML += adsHtml;  
      }  
    }  
  
    // حساب تاريخ انتهاء التمويل  
    if (typeof calculateFinanceEndDate === 'function') {  
      const endDate = calculateFinanceEndDate(months);  
      const settings = JSON.parse(localStorage.getItem('finoPlatformSettings')) || {};  
      const endDateHtml = `  
        <div class="end-date-box fade-in" style="margin-top:20px; padding:15px; background:rgba(30,58,138,0.05); border-radius:12px; border-right:4px solid var(--primary-color);">  
          <div style="font-weight:bold; color:var(--primary-color); margin-bottom:5px;">📅 تاريخ انتهاء التمويل المتوقع:</div>  
          <div style="font-size:15px; color:#1e293b;">  
            <strong>${endDate.hijri}</strong> (هجري)  
            <br>  
            <span style="font-size:13px; color:#64748b;">الموافق: ${endDate.gregorian} (ميلادي)</span>  
          </div>  
          <div style="font-size:12px; color:#94a3b8; margin-top:8px; font-style:italic;">  
            ${settings.endDateMessage || 'الله يطول بعمرنا ويبارك لنا'}  
          </div>  
        </div>  
      `;  
      resultCard.innerHTML += endDateHtml;  
    }  
      
    // عرض العروض الخاصة  
    showSpecialOffers(financeType, Number(finalNetFixed));  
      
    // عرض قسم التسويق والتقييم  
    updateMarketingAndRatingDisplay();  
  
    // معادلة التقاعد موجودة في pensionResult.formula  
      
    // حفظ آخر نتيجة (لاستخدام "النتيجة للعميل" + الأرشيف)  
    answers._lastCalc = {  
      calcDateTimeStr,  
      clientName: name,  
      financeType: financeType,  
      durationText: duration,  
      months: months,  
      recommendedBankName: (recommendedBank && recommendedBank.bankName) ? recommendedBank.bankName : 'غير محدد',  
      finalNet: Number(finalNetFixed),  
      netWithoutFees: Number(netWithoutFeesFixed),  
      netAfterAdmin: Number(netAfterAdminFixed),  
      totalInst: Number(totalInst.toFixed(0)),  
      adminFee: Number(adminFee.toFixed(0)),  
      vat: Number(vat.toFixed(0)),  
      commodityFee: Number(commodityFee.toFixed(0)),  
      supportSakaniAdded: Number(supportSakaniAdded || 0),  
      supportEtezaazAdded: Number(supportEtezaazAdded || 0),  
      supportTotalAdded: Number(supportTotalAdded || 0),  
      mainShownValue: Number(mainShownValue || 0),  
      mainShownLabel: mainShownLabel || '',  
      hasHousingSupport: (financeType === 'تمويل عقاري' && (answers.supported === 'مدعوم')),  
      housingSupportMonthly: Number(housingSupportMonthly || 0),  
      housingSupportTotalForLoan: Number(housingSupportTotalForLoan || 0),  
      housingSupportLumpSum: Number(housingSupportLumpSum || 0),  
      isEtezaaz: (answers.isEtezaaz === 'نعم'),  
      phases: Array.isArray(finalPhases) ? finalPhases : [],  
      // (إضافة) للتوثيق الداخلي فقط  
      extended: !!isExtended,  
      preRetMonths: preRetMonths,  
      pensionSalaryEst: Number(pensionSalaryEst || 0),  
      retirementHijri: timing.rankRetHijriStr || '',  
      // معادلة حساب التقاعد للمسؤول  
      retirementFormula: retirementFormula  
    };  
  }  
  
  // حفظ النتيجة كصورة JPG (واضحة + حجم متوسط)  
  function saveResultAsImage() {  
    const card = document.getElementById('resultCard');  
    if (!card) { alert('لم يتم العثور على بطاقة النتيجة.'); return; }  
  
    html2canvas(card, { scale: 2, backgroundColor: '#ffffff', useCORS: true }).then(canvas => {  
      const MAX_W = 1400;  
      let outCanvas = canvas;  
  
      if (canvas.width > MAX_W) {  
        const ratio = MAX_W / canvas.width;  
        const w = Math.round(canvas.width * ratio);  
        const h = Math.round(canvas.height * ratio);  
  
        const tmp = document.createElement('canvas');  
        tmp.width = w; tmp.height = h;  
        const ctx = tmp.getContext('2d');  
        ctx.imageSmoothingEnabled = true;  
        ctx.imageSmoothingQuality = 'high';  
        ctx.drawImage(canvas, 0, 0, w, h);  
        outCanvas = tmp;  
      }  
  
      const link = document.createElement('a');  
      link.download = 'fino-result.jpg';  
      link.href = outCanvas.toDataURL('image/jpeg', 0.92);  
      document.body.appendChild(link);  
      link.click();  
      document.body.removeChild(link);  
    }).catch(err => {  
      console.error(err);  
      alert('تعذر حفظ النتيجة كصورة، جرّب من متصفح آخر أو تأكد أن جافاسكربت مفعّل.');  
    });  
  }  
  
  // مشاركة النتيجة على الواتساب (النتيجة الحقيقة)  
  function shareResultOnWhatsApp(){  
    const card = document.getElementById('resultCard');  
    if(!card){ alert('لم يتم العثور على بطاقة النتيجة.'); return; }  
    const text = card.innerText || card.textContent || '';  
    const url = 'https://wa.me/?text=' + encodeURIComponent(text);  
    window.open(url, '_blank');  
  }  
  
  function updateDateTime(){  
    const n = new Date();  
    const dayNames = ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];  
    const dayName = dayNames[n.getDay()];  
    const y = n.getFullYear();  
    const m = String(n.getMonth()+1).padStart(2,'0');  
    const d = String(n.getDate()).padStart(2,'0');  
    const hh = String(n.getHours()).padStart(2,'0');  
    const mm = String(n.getMinutes()).padStart(2,'0');  
    const ss = String(n.getSeconds()).padStart(2,'0');  
    const el = document.getElementById('datetime');  
    if (el) el.textContent = `${dayName} ${y}-${m}-${d} ${hh}:${mm}:${ss}`;  
  
    // (إضافة) تحديث الهجري  
    const hEl = document.getElementById('datetimeHijri');  
    if(hEl) hEl.textContent = getHijriNowDisplay();  
  }  
  
  // ====== النتيجة للعميل ======  
  let _clientResultTextCache = '';  
  
  function openClientResultModal(fromAdmin){  
    const lc = answers._lastCalc;  
    if(!lc){  
      alert('لا توجد نتيجة حالياً. احسب أولاً ثم افتح "النتيجة للعميل".');  
      return;  
    }  
    // لازم يكون من المسؤول (بعد تحقق ▫️) أو من لوحة المسؤول  
    if(fromAdmin !== true && _miniAdminVerified !== true){  
      alert('هذه الميزة خاصة بالمسؤول.');  
      return;  
    }  
  
    document.getElementById('clientNetOverride').value = '';  
    document.getElementById('clientInstOverride').value = '';  
    document.getElementById('clientNoteOverride').value = '';  
    document.getElementById('clientResultText').value = '';  
    _clientResultTextCache = '';  
    document.getElementById('clientPreviewCard').innerHTML = `  
      <div class="h">نتيجة الحسبة (التقريبية)</div>  
      <div style="color:#6b7280; font-size:12px;">قم بإنشاء النتيجة المختصرة أولاً لتظهر المعاينة هنا.</div>  
    `;  
    document.getElementById('clientResultModal').style.display = 'block';  
  }  
  
  function closeClientResultModal(){  
    document.getElementById('clientResultModal').style.display = 'none';  
  }  
  
  function generateClientResultText(){  
    const lc = answers._lastCalc;  
    if(!lc){ alert('لا توجد نتيجة.'); return; }  
  
    const netOv = safeNum(document.getElementById('clientNetOverride').value);  
    const instOv = safeNum(document.getElementById('clientInstOverride').value);  
    const note  = (document.getElementById('clientNoteOverride').value || '').trim();  
  
    // الصافي للعميل: إذا كتبته اعتمده، وإلا نعتمد  للنوع:  
    let usedNet = (netOv !== null) ? netOv : lc.finalNet;  
  
    // في العقاري: لا يتم إضافة الدعم الشهري على الصافي  
    let usedNetWithSupport = usedNet;  
    const supportAddedToNet = (lc.supportEtezaazAdded || 0) + ((lc.housingSupportMonthly || 0) > 0 ? 0 : (lc.supportSakaniAdded || 0));  
    if(lc.financeType === 'تمويل عقاري' && supportAddedToNet){  
      usedNetWithSupport = usedNet + supportAddedToNet;  
    }  
  
    const hasMultiPhases = Array.isArray(lc.phases) && lc.phases.length > 1;  
    const singlePhaseInst = (!hasMultiPhases && Array.isArray(lc.phases) && lc.phases[0]) ? Number(lc.phases[0].inst) : null;  
    const usedInst = (instOv !== null) ? instOv : (singlePhaseInst !== null ? singlePhaseInst : null);  
  
    const overrideUsed = (netOv !== null) || (instOv !== null);  
  
    const totalPaid = (usedInst !== null)  
      ? (usedInst * lc.months)  
      : lc.totalInst;  
  
    const computedProfit = totalPaid - usedNet;  
  
    // دعم  
    let supportLines = '';  
    if(lc.supportSakaniAdded){  
      if(lc.housingSupportMonthly > 0){  
        supportLines += `- دعم سكني (شهري) حسب مصفوفة الدعم: ${fmtMoney(lc.housingSupportMonthly)}\n`;  
        supportLines += `- إجمالي دعم سكني (حتى 20 سنة كحد أقصى): ${fmtMoney(lc.supportSakaniAdded)}\n`;  
      } else {  
        supportLines += `- دعم سكني المضاف: ${fmtMoney(lc.supportSakaniAdded)}\n`;  
      }  
    }  
    if(lc.supportEtezaazAdded){  
      supportLines += `- دعم اعتزاز: ${fmtMoney(lc.supportEtezaazAdded)} (دعم إضافي مستقل)\n`;  
      supportLines += `- تنبيه اعتزاز: يبدأ بعد سنتين ولا تتوفر لدينا تفاصيل دقيقة للقسط — تواصل مع جهة عملك.\n`;  
    }  
  
    let instBlock = '';  
    if (usedInst !== null) {  
      instBlock = `القسط الشهري: ${fmtMoney(usedInst)}\n`;  
    } else if (hasMultiPhases) {  
      instBlock = `الأقساط حسب الفترات:\n`;  
      lc.phases.forEach(p=>{  
        instBlock += `- من الشهر ${p.from} إلى ${p.to}: ${fmtMoney(p.inst)}\n`;  
      });  
    } else {  
      instBlock = `القسط الشهري: غير محدد\n`;  
    }  
  
    const feesBlock =  
`تفاصيل الرسوم :  
- الرسوم الإدارية: ${fmtMoney(lc.adminFee)}  
- (ضريبة القيمة المضافة لرسوم الادارية): ${fmtMoney(lc.vat)}${lc.commodityFee ? `\n- رسوم السلع: ${fmtMoney(lc.commodityFee)}` : ''}\n`;  
  
    const profitBlock = overrideUsed  
      ? `الربح ${fmtMoney(computedProfit)}\n`  
      : `الربح مع الرسوم ${fmtMoney(lc.totalInst - lc.finalNet)}\n`;  
  
    const contact = `\nللاستفسار والتقديم: 0506214458\nسرعة تملك العقار والحلول التمويلية\n`;  
  
    const privateNotice = (answers.jobType === 'قطاع خاص')  
      ? `\nتنبيه: القطاع الخاص بجميع أنواعه لابد اعتماده من الجهة الممولة وقد تختلف الشروط.\n`  
      : '';  
  
    let text =  
`نتيجة الحسبة (التقريبية)  
تاريخ ووقت الحسبة: ${lc.calcDateTimeStr}  
مرحباً ومسهلا يا ${lc.clientName}  
نوع التمويل: ${lc.financeType}  
مدة التمويل: ${lc.durationText}  
اسم البنك/الشركة المرشحة: ${lc.recommendedBankName}  
  
التمويل الصافي: ${fmtMoney(usedNet)}  
`;  
  
    if(lc.financeType === 'تمويل عقاري' && (lc.supportSakaniAdded || lc.supportEtezaazAdded)){  
      if(supportAddedToNet){  
        text += `صافي التمويل مضاف له الدعم: ${fmtMoney(usedNetWithSupport)}\n`;  
      }  
      text += `تفاصيل الدعم:\n${supportLines || '- لا يوجد\n'}`;  
    }  
  
    // (إضافة) توضيح الممتد إن وجد  
    if(lc.extended){  
      text += `\nملاحظة: تم احتساب التمويل على الممتد (تقديري) بعد التقاعد.\n`;  
      if(lc.retirementHijri) text += `تاريخ التقاعد المتوقع (هجري): ${lc.retirementHijri}\n`;  
    }  
  
    text += `  
${instBlock}  
${profitBlock}  
${feesBlock}  
${note ? `ملاحظة: ${note}\n` : ''}${privateNotice}  
⚠️ هذه الحسبة تقريبية، والاعتماد النهائي حسب سياسات الجهة الممولة وقت التقديم. 🔺تنوية/نحن لسنا جهة تمويلية، ودورنا يقتصر على الوساطة وترشيح العروض عبر البنوك وشركات التمويل المرخّصة..   
${contact}`.trim();  
  
    _clientResultTextCache = text;  
    lc._lastClientText = text;  
  
    document.getElementById('clientResultText').value = text;  
    renderClientPreviewFromText(text);  
  }  
  
  function renderClientPreviewFromText(text){  
    const lines = String(text||'').split('\n').map(l=>l.trim()).filter(Boolean);  
    if(!lines.length){  
      document.getElementById('clientPreviewCard').innerHTML = `<div class="h">نتيجة الحسبة (التقريبية)</div>`;  
      return;  
    }  
    let html = `<div class="h">${escapeHtml(lines[0])}</div>`;  
    html += `<div class="hr"></div>`;  
    for(let i=1;i<lines.length;i++){  
      const l = lines[i];  
      if(l.includes(':')){  
        const parts = l.split(':');  
        const k = parts.shift();  
        const v = parts.join(':').trim();  
        html += `<div><span class="k">${escapeHtml(k)}:</span> <span class="v">${escapeHtml(v)}</span></div>`;  
      } else {  
        html += `<div>${escapeHtml(l)}</div>`;  
      }  
      if(i===5) html += `<div class="hr"></div>`;  
    }  
    document.getElementById('clientPreviewCard').innerHTML = html;  
  }  
  
  function copyClientResultText(){  
    const ta = document.getElementById('clientResultText');  
    if(!ta.value){ alert('أنشئ النتيجة أولاً.'); return; }  
    ta.select();  
    ta.setSelectionRange(0, 999999);  
    document.execCommand('copy');  
    alert('تم نسخ النتيجة ✅');  
  }  
  
  function shareClientResultOnWhatsApp(){  
    const ta = document.getElementById('clientResultText');  
    const text = (ta && ta.value) ? ta.value : _clientResultTextCache;  
    if(!text){ alert('أنشئ النتيجة أولاً.'); return; }  
    window.open('https://wa.me/?text=' + encodeURIComponent(text), '_blank');  
  }  
  
  function saveClientResultAsImage(){  
    const preview = document.getElementById('clientPreviewCard');  
    const ta = document.getElementById('clientResultText');  
    if(!ta.value){  
      alert('أنشئ النتيجة المختصرة أولاً.');  
      return;  
    }  
  
    html2canvas(preview, { scale: 2, backgroundColor:'#ffffff', useCORS:true }).then(canvas=>{  
      const MAX_W = 1400;  
      let outCanvas = canvas;  
  
      if (canvas.width > MAX_W) {  
        const ratio = MAX_W / canvas.width;  
        const w = Math.round(canvas.width * ratio);  
        const h = Math.round(canvas.height * ratio);  
  
        const tmp = document.createElement('canvas');  
        tmp.width = w; tmp.height = h;  
        const ctx = tmp.getContext('2d');  
        ctx.imageSmoothingEnabled = true;  
        ctx.imageSmoothingQuality = 'high';  
        ctx.drawImage(canvas, 0, 0, w, h);  
        outCanvas = tmp;  
      }  
  
      const link = document.createElement('a');  
      link.download = 'fino-client-result.jpg';  
      link.href = outCanvas.toDataURL('image/jpeg', 0.92);  
      document.body.appendChild(link);  
      link.click();  
      document.body.removeChild(link);  
    }).catch(err=>{  
      console.error(err);  
      alert('تعذر حفظ نتيجة العميل كصورة.');  
    });  
  }  
  
  // ====== حاسبة السداد المبكر ======  
  function calculateEarlySettlement() {  
    const financeType = document.getElementById('esFinanceType').value;  
    const originalAmount = parseFloat(document.getElementById('esOriginalAmount').value) || 0;  
    const totalMonths = parseInt(document.getElementById('esTotalMonths').value) || 0;  
    const paidMonths = parseInt(document.getElementById('esPaidMonths').value) || 0;  
    const annualRate = parseFloat(document.getElementById('esAnnualRate').value) || 0;  
      
    if (!originalAmount || !totalMonths || paidMonths < 0 || !annualRate) {  
      alert('يرجى إدخال جميع البيانات بشكل صحيح');  
      return;  
    }  
      
    if (paidMonths >= totalMonths) {  
      alert('عدد الأقساط المسددة يجب أن يكون أقل من المدة الكلية');  
      return;  
    }  
      
    // ====== حساب APR الهرمي (Declining Balance Method) ======
    // هذه الطريقة المعتمدة في السعودية حسب نظام ساما
    const monthlyRate = annualRate / 100 / 12;
    
    // حساب القسط الشهري الثابت باستخدام معادلة الأقساط المتساوية (PMT)
    // PMT = P * [r(1+r)^n] / [(1+r)^n - 1]
    const monthlyInstallment = originalAmount * (monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) / (Math.pow(1 + monthlyRate, totalMonths) - 1);
    
    // بناء جدول الاستهلاك الهرمي لحساب الرصيد المتبقي الفعلي
    let balance = originalAmount;
    let totalPrincipalPaid = 0;
    let totalInterestPaid = 0;
    
    for (let month = 1; month <= paidMonths; month++) {
      const interestPayment = balance * monthlyRate; // الفائدة على الرصيد المتبقي
      const principalPayment = monthlyInstallment - interestPayment; // الأصل المسدد
      balance -= principalPayment;
      totalPrincipalPaid += principalPayment;
      totalInterestPaid += interestPayment;
    }
    
    // الرصيد المتبقي الفعلي (الأصل المتبقي)
    const remainingPrincipal = Math.max(0, balance);
    const remainingMonths = totalMonths - paidMonths;
    
    // حساب إجمالي الأرباح المتبقية لو أكمل العميل السداد
    let remainingInterest = 0;
    let tempBalance = remainingPrincipal;
    for (let month = 1; month <= remainingMonths; month++) {
      const interestPayment = tempBalance * monthlyRate;
      const principalPayment = monthlyInstallment - interestPayment;
      remainingInterest += interestPayment;
      tempBalance -= principalPayment;
    }  
      
    // ====== المعادلة الصحيحة حسب نظام ساما (APR الهرمي) ======
    // حساب كلفة الأجل لـ 3 أشهر التالية (على أساس الرصيد المتناقص)
    const penaltyMonths = Math.min(3, remainingMonths);
    let threeMonthsProfitCost = 0;
    let tempBalanceForPenalty = remainingPrincipal;
    
    for (let month = 1; month <= penaltyMonths; month++) {
      const interestPayment = tempBalanceForPenalty * monthlyRate;
      threeMonthsProfitCost += interestPayment;
      const principalPayment = monthlyInstallment - interestPayment;
      tempBalanceForPenalty -= principalPayment;
    }
    
    let earlySettlementAmount = 0;
    let penaltyCost = 0;
    let formulaDescription = '';
    
    // مبلغ السداد المبكر = الرصيد المتبقي + كلفة الأجل لـ 3 أشهر (حسب نظام ساما)
    penaltyCost = threeMonthsProfitCost;
    earlySettlementAmount = remainingPrincipal + penaltyCost;
    
    if (financeType === 'mortgage') {
      formulaDescription = `الرصيد المتبقي + كلفة الأجل لـ ${penaltyMonths} أشهر (نظام ساما - الرصيد المتناقص)`;
    } else {
      formulaDescription = `الرصيد المتبقي + كلفة الأجل لـ ${penaltyMonths} أشهر (نظام ساما - الرصيد المتناقص)`;
    }
      
    // المبلغ الموفر = الأرباح المتبقية - رسوم السداد المبكر
    const savedAmount = remainingInterest - penaltyCost;
    const savingPercentage = remainingInterest > 0 ? ((savedAmount / remainingInterest) * 100).toFixed(1) : '0';  
      
    // بناء النتيجة حسب نوع التمويل مع تفاصيل APR الهرمي
    let detailsHtml = `
      <div style="margin-bottom:15px; padding:12px; background:#fef3c7; border-radius:10px; border:1px solid #f59e0b;">
        <div style="font-size:13px; color:#92400e; font-weight:600;">📐 نظام APR الهرمي (Declining Balance)</div>
        <div style="font-size:12px; color:#78350f; margin-top:5px;">الأرباح تُحسب على الرصيد المتبقي الفعلي وليس على المبلغ الأصلي</div>
      </div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div style="padding:10px; background:#fff; border-radius:10px;">
          <div style="font-size:12px; color:#6b7280;">المبلغ الأصلي</div>
          <div style="font-size:16px; font-weight:700; color:#6b7280;">${originalAmount.toLocaleString('ar-SA')} ريال</div>
        </div>
        <div style="padding:10px; background:#fff; border-radius:10px;">
          <div style="font-size:12px; color:#6b7280;">القسط الشهري</div>
          <div style="font-size:16px; font-weight:700; color:#3b82f6;">${monthlyInstallment.toLocaleString('ar-SA', {maximumFractionDigits:0})} ريال</div>
        </div>
        <div style="padding:10px; background:#e0f2fe; border-radius:10px;">
          <div style="font-size:12px; color:#0369a1;">الأصل المسدد</div>
          <div style="font-size:16px; font-weight:700; color:#0284c7;">${totalPrincipalPaid.toLocaleString('ar-SA', {maximumFractionDigits:0})} ريال</div>
        </div>
        <div style="padding:10px; background:#fce7f3; border-radius:10px;">
          <div style="font-size:12px; color:#9d174d;">الأرباح المسددة</div>
          <div style="font-size:16px; font-weight:700; color:#be185d;">${totalInterestPaid.toLocaleString('ar-SA', {maximumFractionDigits:0})} ريال</div>
        </div>
        <div style="padding:10px; background:#dcfce7; border-radius:10px; grid-column: span 2;">
          <div style="font-size:12px; color:#166534;">الرصيد المتبقي الفعلي (الأصل)</div>
          <div style="font-size:20px; font-weight:700; color:#15803d;">${remainingPrincipal.toLocaleString('ar-SA', {maximumFractionDigits:0})} ريال</div>
        </div>
        <div style="padding:10px; background:#fff; border-radius:10px;">
          <div style="font-size:12px; color:#6b7280;">الأرباح المتبقية لو أكملت</div>
          <div style="font-size:16px; font-weight:700; color:#dc2626;">${remainingInterest.toLocaleString('ar-SA', {maximumFractionDigits:0})} ريال</div>
        </div>
        <div style="padding:10px; background:#fef2f2; border-radius:10px;">
          <div style="font-size:12px; color:#991b1b;">رسوم السداد المبكر</div>
          <div style="font-size:16px; font-weight:700; color:#dc2626;">${penaltyCost.toLocaleString('ar-SA', {maximumFractionDigits:0})} ريال</div>
        </div>
      </div>
    `;
    
    const resultHtml = `  
      <h3 style="margin:0 0 15px; color:#059669;">✅ نتيجة السداد المبكر</h3>
      <div style="margin-bottom:10px; padding:8px 12px; background:#e0f2fe; border-radius:8px; font-size:13px; color:#0369a1;">
        <strong>📊 طريقة الحساب:</strong> ${formulaDescription}
      </div>
      ${detailsHtml}
      <div style="margin-top:15px; padding:15px; background:linear-gradient(135deg,#1e3a8a,#3b82f6); border-radius:12px; color:#fff;">  
        <div style="font-size:14px; opacity:0.9;">💰 مبلغ السداد المبكر</div>  
        <div style="font-size:28px; font-weight:900;">${earlySettlementAmount.toLocaleString('ar-SA', {maximumFractionDigits:0})} ريال</div>  
      </div>  
      <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:10px;">  
        <div style="padding:10px; background:#dcfce7; border-radius:10px;">  
          <div style="font-size:12px; color:#166534;">المبلغ الموفر</div>  
          <div style="font-size:16px; font-weight:700; color:#15803d;">${savedAmount.toLocaleString('ar-SA', {maximumFractionDigits:0})} ريال</div>  
        </div>  
        <div style="padding:10px; background:#dbeafe; border-radius:10px;">  
          <div style="font-size:12px; color:#1e40af;">نسبة التوفير</div>  
          <div style="font-size:16px; font-weight:700; color:#1d4ed8;">${savingPercentage}%</div>  
        </div>  
      </div>  
    `;  
      
    document.getElementById('esResult').innerHTML = resultHtml;  
    document.getElementById('esResult').style.display = 'block';  
  }  
    
  // ====== نظام التقييمات ======  
  const RATINGS_KEY = 'stRatings';  
  const RATINGS_SETTINGS_KEY = 'stRatingsSettings';  
  let ratings = [];  
  let ratingsSettings = { showOnHome: false };  
  let currentRating = 0;  
  
  function loadRatings() {  
    try {  
      const s = localStorage.getItem(RATINGS_KEY);  
      ratings = s ? JSON.parse(s) : [];  
      const ss = localStorage.getItem(RATINGS_SETTINGS_KEY);  
      ratingsSettings = ss ? JSON.parse(ss) : { showOnHome: false };  
    } catch(e) {  
      ratings = [];  
      ratingsSettings = { showOnHome: false };  
    }  
  }  
  
  function saveRatings() {  
    localStorage.setItem(RATINGS_KEY, JSON.stringify(ratings));  
  }  
  
  function saveRatingsSettings() {  
    const showOnHome = document.getElementById('showRatingsOnHome')?.checked || false;  
    const showRatingRequest = document.getElementById('showRatingRequest')?.checked || false;  
    const showTrustSection = document.getElementById('showTrustSection')?.checked || false;  
    ratingsSettings = { showOnHome, showRatingRequest, showTrustSection };  
    localStorage.setItem(RATINGS_SETTINGS_KEY, JSON.stringify(ratingsSettings));  
    updateHomeRatings();  
    updateRatingRequestVisibility();  
    updateTrustSectionVisibility();  
    showToast('تم حفظ إعدادات التقييمات بنجاح');  
  }  
    
  // تحديث ظهور طلب التقييم  
  function updateRatingRequestVisibility() {  
    const ratingSection = document.getElementById('ratingSection');  
    if (ratingSection) {  
      ratingSection.style.display = ratingsSettings.showRatingRequest ? 'block' : 'none';  
    }  
  }  
    
  // تحديث ظهور قسم التطمين  
  function updateTrustSectionVisibility() {  
    const trustSection = document.getElementById('trustSection');  
    if (trustSection) {  
      trustSection.style.display = ratingsSettings.showTrustSection ? 'block' : 'none';  
    }  
  }  
    
  // عرض التقييمات للتطمين  
  function showTrustRatings() {  
    const published = ratings.filter(r => r.published);  
    if (published.length === 0) {  
      alert('لا توجد تقييمات منشورة حالياً');  
      return;  
    }  
      
    // إنشاء نافذة عرض التقييمات  
    const modal = document.createElement('div');  
    modal.id = 'trustRatingsModal';  
    modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:9999; padding:20px;';  
    modal.innerHTML = `  
      <div style="background:#fff; border-radius:20px; padding:20px; max-width:400px; width:100%; max-height:80vh; overflow-y:auto;">  
        <h3 style="margin:0 0 15px; text-align:center; color:#111827;">⭐ تقييمات عملائنا</h3>  
        <div style="display:flex; flex-direction:column; gap:12px;">  
          ${published.map(r => `  
            <div style="background:#f9fafb; border-radius:12px; padding:12px; text-align:right;">  
              <div style="color:#f59e0b; font-size:18px;">${'★'.repeat(r.stars)}${'☆'.repeat(5-r.stars)}</div>  
              <div style="font-size:14px; color:#374151; margin-top:6px;">${escapeHtml(r.comment || 'تقييم ممتاز')}</div>  
              <div style="font-size:12px; color:#9ca3af; margin-top:4px;">- ${escapeHtml(r.name)} | ${r.date}</div>  
            </div>  
          `).join('')}  
        </div>  
        <button onclick="document.getElementById('trustRatingsModal').remove()" style="margin-top:15px; width:100%; background:#6b7280; color:#fff; border:none; padding:10px; border-radius:10px; font-size:14px; cursor:pointer;">إغلاق</button>  
      </div>  
    `;  
    document.body.appendChild(modal);  
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };  
  }  
    
  // تحديث إحصائيات التقييمات  
  function updateRatingsStats() {  
    const totalEl = document.getElementById('totalRatingsCount');  
    const publishedEl = document.getElementById('publishedRatingsCount');  
    const avgEl = document.getElementById('avgRating');  
      
    if (totalEl) totalEl.textContent = ratings.length;  
    if (publishedEl) publishedEl.textContent = ratings.filter(r => r.published).length;  
    if (avgEl && ratings.length > 0) {  
      const avg = ratings.reduce((sum, r) => sum + r.stars, 0) / ratings.length;  
      avgEl.textContent = avg.toFixed(1) + ' ⭐';  
    } else if (avgEl) {  
      avgEl.textContent = '0';  
    }  
  }  
  
  function setRating(stars) {  
    currentRating = stars;  
    const starsEl = document.querySelectorAll('#ratingStars .rating-star');  
    starsEl.forEach((el, idx) => {  
      el.textContent = idx < stars ? '★' : '☆';  
      el.style.color = idx < stars ? '#f59e0b' : '#d1d5db';  
    });  
  }  
  
  function submitRating() {  
    if (currentRating === 0) {  
      alert('فضلاً اختر عدد النجوم');  
      return;  
    }  
    const comment = document.getElementById('ratingComment')?.value || '';  
    const name = answers.clientName || 'عميل';  
    const rating = {  
      name,  
      stars: currentRating,  
      comment,  
      date: new Date().toLocaleDateString('ar-SA'),  
      published: false  
    };  
    ratings.push(rating);  
    saveRatings();  
    document.getElementById('ratingSuccess').style.display = 'block';  
    document.getElementById('ratingSection').style.pointerEvents = 'none';  
    document.getElementById('ratingSection').style.opacity = '0.7';  
  }  
  
  function renderRatingsTable() {  
    const tbody = document.querySelector('#ratingsTable tbody');  
    if (!tbody) return;  
    tbody.innerHTML = '';  
    ratings.forEach((r, idx) => {  
      const tr = document.createElement('tr');  
      tr.innerHTML = `  
        <td>${escapeHtml(r.name)}</td>  
        <td>${'★'.repeat(r.stars)}${'☆'.repeat(5-r.stars)}</td>  
        <td style="max-width:150px; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(r.comment || '-')}</td>  
        <td>${r.date}</td>  
        <td>${r.published ? '✅' : '❌'}</td>  
        <td>  
          <button class="btn small secondary" onclick="toggleRatingPublish(${idx})">${r.published ? 'إلغاء النشر' : 'نشر'}</button>  
          <button class="btn small secondary" onclick="deleteRating(${idx})">حذف</button>  
        </td>  
      `;  
      tbody.appendChild(tr);  
    });  
    document.getElementById('showRatingsOnHome').checked = ratingsSettings.showOnHome;  
    document.getElementById('showRatingRequest').checked = ratingsSettings.showRatingRequest !== false;  
    document.getElementById('showTrustSection').checked = ratingsSettings.showTrustSection !== false;  
    updateRatingsStats();  
  }  
  
  function toggleRatingPublish(idx) {  
    ratings[idx].published = !ratings[idx].published;  
    saveRatings();  
    renderRatingsTable();  
    updateHomeRatings();  
  }  
  
  function deleteRating(idx) {  
    if (!confirm('متأكد من حذف هذا التقييم؟')) return;  
    ratings.splice(idx, 1);  
    saveRatings();  
    renderRatingsTable();  
    updateHomeRatings();  
  }  
  
  function updateHomeRatings() {  
    const container = document.getElementById('homeRatings');  
    if (!container) return;  
    if (!ratingsSettings.showOnHome) {  
      container.style.display = 'none';  
      return;  
    }  
    const published = ratings.filter(r => r.published);  
    if (published.length === 0) {  
      container.style.display = 'none';  
      return;  
    }  
    container.style.display = 'block';  
    container.innerHTML = `  
      <h3 style="margin:0 0 10px; font-size:16px; color:#111827;">⭐ آراء العملاء</h3>  
      <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">  
        ${published.slice(0, 6).map(r => `  
          <div style="background:#f9fafb; border-radius:12px; padding:10px; min-width:150px; text-align:right;">  
            <div style="color:#f59e0b;">${'★'.repeat(r.stars)}</div>  
            <div style="font-size:13px; color:#374151; margin-top:4px;">${escapeHtml(r.comment || '')}</div>  
            <div style="font-size:11px; color:#9ca3af; margin-top:4px;">- ${escapeHtml(r.name)}</div>  
          </div>  
        `).join('')}  
      </div>  
    `;  
  }  
  
  // ====== نظام العروض الخاصة ======  
  const OFFERS_KEY = 'stOffers';  
  let offers = [];  
  
  function loadOffers() {  
    try {  
      const s = localStorage.getItem(OFFERS_KEY);  
      offers = s ? JSON.parse(s) : [];  
    } catch(e) {  
      offers = [];  
    }  
  }  
  
  function saveOffersData() {  
    localStorage.setItem(OFFERS_KEY, JSON.stringify(offers));  
  }  
  
  function clearOfferForm() {  
    document.getElementById('offerTitle').value = '';  
    document.getElementById('offerText').value = '';  
    document.getElementById('offerTargetType').value = '';  
    document.getElementById('offerTargetJobType').value = '';  
    document.getElementById('offerLinkedBank').value = '';  
    document.getElementById('offerMinAmount').value = '';  
    document.getElementById('offerMaxAmount').value = '';  
    document.getElementById('offerSpecialRate').value = '';  
    document.getElementById('offerLink').value = '';  
    document.getElementById('offerEnabled').value = 'true';  
    document.getElementById('offerEditIndex').value = '';  
    // الحقول الجديدة  
    document.getElementById('offerTargetEmployer').value = '';  
    document.getElementById('offerCustomEmployer').value = '';  
    document.getElementById('offerStartDate').value = '';  
    document.getElementById('offerEndDate').value = '';  
    document.getElementById('offerNotes').value = '';  
    document.getElementById('offerShowExpiry').value = 'true';  
  }  
  
  function saveOffer(e) {  
    e.preventDefault();  
    const title = document.getElementById('offerTitle').value.trim();  
    const text = document.getElementById('offerText').value.trim();  
    const targetType = document.getElementById('offerTargetType').value;  
    const targetJobType = document.getElementById('offerTargetJobType').value;  
    const linkedBank = document.getElementById('offerLinkedBank').value;  
    const minAmount = parseFloat(document.getElementById('offerMinAmount').value) || 0;  
    const maxAmount = parseFloat(document.getElementById('offerMaxAmount').value) || 999999999;  
    const specialRate = parseFloat(document.getElementById('offerSpecialRate').value) || null;  
    const link = document.getElementById('offerLink').value.trim();  
    const enabled = document.getElementById('offerEnabled').value === 'true';  
    const editIndex = document.getElementById('offerEditIndex').value;  
    // الحقول الجديدة  
    const targetEmployer = document.getElementById('offerTargetEmployer').value;  
    const customEmployer = document.getElementById('offerCustomEmployer').value.trim();  
    const startDate = document.getElementById('offerStartDate').value;  
    const endDate = document.getElementById('offerEndDate').value;  
    const notes = document.getElementById('offerNotes').value.trim();  
    const showExpiry = document.getElementById('offerShowExpiry').value === 'true';  
  
    if (!title || !text) {  
      alert('فضلاً أدخل العنوان والنص');  
      return;  
    }  
  
    const offer = {   
      title, text, targetType, targetJobType, linkedBank,   
      minAmount, maxAmount, specialRate, link, enabled,  
      targetEmployer, customEmployer, startDate, endDate, notes, showExpiry  
    };  
  
    if (editIndex === '') {  
      offers.push(offer);  
    } else {  
      offers[parseInt(editIndex)] = offer;  
    }  
  
    saveOffersData();  
    renderOffersTable();  
    clearOfferForm();  
  }  
  
  function renderOffersTable() {  
    const tbody = document.querySelector('#offersTable tbody');  
    if (!tbody) return;  
    tbody.innerHTML = '';  
    offers.forEach((o, idx) => {  
      const tr = document.createElement('tr');  
      tr.innerHTML = `  
        <td>${escapeHtml(o.title)}</td>  
        <td style="max-width:120px; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(o.text)}</td>  
        <td>${o.targetType || 'الكل'}</td>  
        <td>${o.targetJobType || 'الكل'}</td>  
        <td>${o.linkedBank || 'الكل'}</td>  
        <td>${o.enabled ? 'مفعّل' : 'موقف'}</td>  
        <td>  
          <button class="btn small secondary" onclick="editOffer(${idx})">تعديل</button>  
          <button class="btn small secondary" onclick="deleteOffer(${idx})">حذف</button>  
        </td>  
      `;  
      tbody.appendChild(tr);  
    });  
  }  
  
  function editOffer(idx) {  
    const o = offers[idx];  
    document.getElementById('offerTitle').value = o.title;  
    document.getElementById('offerText').value = o.text;  
    document.getElementById('offerTargetType').value = o.targetType || '';  
    document.getElementById('offerTargetJobType').value = o.targetJobType || '';  
    document.getElementById('offerLinkedBank').value = o.linkedBank || '';  
    document.getElementById('offerMinAmount').value = o.minAmount || '';  
    document.getElementById('offerMaxAmount').value = o.maxAmount || '';  
    document.getElementById('offerSpecialRate').value = o.specialRate || '';  
    document.getElementById('offerLink').value = o.link || '';  
    document.getElementById('offerEnabled').value = o.enabled ? 'true' : 'false';  
    document.getElementById('offerEditIndex').value = idx;  
  }  
  
  function deleteOffer(idx) {  
    if (!confirm('متأكد من حذف هذا العرض؟')) return;  
    offers.splice(idx, 1);  
    saveOffersData();  
    renderOffersTable();  
  }  
  
  function getMatchingOffers(financeType, amount, jobType, bankName) {  
    return offers.filter(o => {  
      if (!o.enabled) return false;  
      // فلترة نوع التمويل  
      if (o.targetType && !financeType.includes(o.targetType.replace('تمويل ', '').replace('شراء ', ''))) return false;  
      // فلترة نوع الوظيفة  
      if (o.targetJobType && jobType && o.targetJobType !== jobType) return false;  
      // فلترة البنك  
      if (o.linkedBank && bankName && !bankName.includes(o.linkedBank)) return false;  
      // فلترة المبلغ  
      if (o.minAmount && amount < o.minAmount) return false;  
      if (o.maxAmount && amount > o.maxAmount) return false;  
      return true;  
    });  
  }  
  
  // ====== إعدادات التسويق ======  
  const MARKETING_KEY = 'stMarketing';  
  let marketingSettings = {  
    showMarketing: true,  
    marketingTitle: 'ننجز تمويلك بأسرع وقت!',  
    marketingText: 'تواصل معنا الحين وخلنا نساعدك في إتمام تمويلك بدون تعقيدات ⚡️',  
    whatsapp: '966506214458',  
    showContract: false,  
    contractText: '📝 إبرام عقد تحويل إلكتروني',  
    contractLink: '',  
    showRating: true,  
    showBankQuestion: true  
  };  
  
  // دالة لتعديل الألوان (تفتيح/تغميق)  
  function adjustColor(hex, percent) {  
    const num = parseInt(hex.replace('#', ''), 16);  
    const amt = Math.round(2.55 * percent);  
    const R = Math.max(0, Math.min(255, (num >> 16) + amt));  
    const G = Math.max(0, Math.min(255, ((num >> 8) & 0x00FF) + amt));  
    const B = Math.max(0, Math.min(255, (num & 0x0000FF) + amt));  
    return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);  
  }  
    
  function loadMarketingSettings() {  
    try {  
      const s = localStorage.getItem(MARKETING_KEY);  
      if (s) marketingSettings = { ...marketingSettings, ...JSON.parse(s) };  
    } catch(e) {}  
  }  
  
  function saveMarketingSettings() {  
    marketingSettings = {  
      showMarketing: document.getElementById('showMarketingSection')?.checked ?? true,  
      marketingTitle: document.getElementById('marketingTitle')?.value || 'ننجز تمويلك بأسرع وقت!',  
      marketingText: document.getElementById('marketingText')?.value || '',  
      whatsapp: document.getElementById('marketingWhatsapp')?.value || '966506214458',  
      showContract: document.getElementById('showContractButton')?.checked ?? false,  
      contractText: document.getElementById('contractButtonText')?.value || '📝 إبرام عقد تحويل إلكتروني',  
      contractLink: document.getElementById('contractLink')?.value || '',  
      showRating: document.getElementById('showRatingSection')?.checked ?? true,  
      showBankQuestion: marketingSettings.showBankQuestion,  
      // الرابط المخصص في النتيجة  
      showCustomResultLink: document.getElementById('showCustomResultLink')?.checked ?? false,  
      customResultLinkText: document.getElementById('customResultLinkText')?.value || '',  
      customResultLinkUrl: document.getElementById('customResultLinkUrl')?.value || '',  
      customResultLinkColor: document.getElementById('customResultLinkColor')?.value || '#7c3aed'  
    };  
    localStorage.setItem(MARKETING_KEY, JSON.stringify(marketingSettings));  
    alert('تم حفظ الإعدادات');  
  }  
  
  function loadMarketingSettingsToUI() {  
    const m = marketingSettings;  
    if (document.getElementById('showMarketingSection')) document.getElementById('showMarketingSection').checked = m.showMarketing;  
    if (document.getElementById('marketingTitle')) document.getElementById('marketingTitle').value = m.marketingTitle;  
    if (document.getElementById('marketingText')) document.getElementById('marketingText').value = m.marketingText;  
    if (document.getElementById('marketingWhatsapp')) document.getElementById('marketingWhatsapp').value = m.whatsapp;  
    if (document.getElementById('showContractButton')) document.getElementById('showContractButton').checked = m.showContract;  
    if (document.getElementById('contractButtonText')) document.getElementById('contractButtonText').value = m.contractText;  
    if (document.getElementById('contractLink')) document.getElementById('contractLink').value = m.contractLink;  
    if (document.getElementById('showRatingSection')) document.getElementById('showRatingSection').checked = m.showRating;  
    // الرابط المخصص  
    if (document.getElementById('showCustomResultLink')) document.getElementById('showCustomResultLink').checked = m.showCustomResultLink;  
    if (document.getElementById('customResultLinkText')) document.getElementById('customResultLinkText').value = m.customResultLinkText || '';  
    if (document.getElementById('customResultLinkUrl')) document.getElementById('customResultLinkUrl').value = m.customResultLinkUrl || '';  
    if (document.getElementById('customResultLinkColor')) document.getElementById('customResultLinkColor').value = m.customResultLinkColor || '#7c3aed';  
  }  
  
  // ====== عرض العروض الخاصة ======  
  function showSpecialOffers(financeType, amount) {  
    const matchingOffers = getMatchingOffers(financeType || '', amount || 0);  
    const offersContainer = document.getElementById('offersSection');  
      
    if (!offersContainer) {  
      // إنشاء الحاوية إذا لم تكن موجودة  
      const resultPage = document.getElementById('resultPage');  
      if (resultPage && matchingOffers.length > 0) {  
        const div = document.createElement('div');  
        div.id = 'offersSection';  
        div.className = 'card fade-in';  
        div.style.marginTop = '12px';  
        div.style.background = 'linear-gradient(135deg, #ecfdf5, #d1fae5)';  
        div.style.border = '2px solid #10b981';  
        resultPage.querySelector('.card')?.after(div);  
      }  
    }  
      
    const container = document.getElementById('offersSection');  
    if (!container) return;  
      
    if (matchingOffers.length === 0) {  
      container.style.display = 'none';  
      return;  
    }  
      
    container.style.display = 'block';  
    const clientName = answers.clientName || 'عزيزنا';  
    container.innerHTML = matchingOffers.map(o => `  
      <div style="text-align:center; padding:10px;">  
        <div style="font-size:24px; margin-bottom:6px;">🎁</div>  
        <h3 style="margin:0 0 6px; font-size:17px; color:#065f46;">${escapeHtml(o.title)}</h3>  
        <p style="font-size:14px; color:#047857; margin:0;">${escapeHtml(o.text.replace(/فلان/g, clientName))}</p>  
      </div>  
    `).join('<hr style="border:none; border-top:1px dashed #10b981; margin:10px 0;">');  
  }  
    
  // ====== عرض قسم التسويق والتقييم ======  
  function updateMarketingAndRatingDisplay() {  
    const m = marketingSettings;  
      
    // قسم التسويق  
    const marketingSection = document.getElementById('marketingSection');  
    if (marketingSection) {  
      if (m.showMarketing) {  
        marketingSection.style.display = 'block';  
        marketingSection.innerHTML = `  
          <div style="text-align:center;">  
            <div style="font-size:24px; margin-bottom:6px;">🚀</div>  
            <h3 style="margin:0 0 6px; font-size:17px; color:#92400e;">${escapeHtml(m.marketingTitle)}</h3>  
            <p style="font-size:14px; color:#78350f; margin-bottom:10px;">${escapeHtml(m.marketingText)}</p>  
            <a href="https://wa.me/${m.whatsapp}" target="_blank" style="display:inline-block; background:linear-gradient(135deg,#25d366,#128c7e); color:#fff; padding:10px 24px; border-radius:25px; font-size:15px; font-weight:bold; text-decoration:none;">📲 تواصل عبر الواتساب</a>  
          </div>  
        `;  
      } else {  
        marketingSection.style.display = 'none';  
      }  
    }  
      
    // زر العقد  
    const contractSection = document.getElementById('contractSection');  
    if (contractSection) {  
      if (m.showContract && m.contractLink) {  
        contractSection.style.display = 'block';  
        contractSection.innerHTML = `  
          <a href="${escapeHtml(m.contractLink)}" target="_blank" style="display:block; background:linear-gradient(135deg,#3b82f6,#1d4ed8); color:#fff; padding:12px 20px; border-radius:12px; font-size:16px; font-weight:bold; text-decoration:none; text-align:center;">${escapeHtml(m.contractText)}</a>  
        `;  
      } else {  
        contractSection.style.display = 'none';  
      }  
    }  
      
    // الرابط المخصص في النتيجة  
    let customLinkSection = document.getElementById('customResultLinkSection');  
    if (!customLinkSection) {  
      // إنشاء القسم إذا لم يكن موجوداً  
      customLinkSection = document.createElement('div');  
      customLinkSection.id = 'customResultLinkSection';  
      customLinkSection.className = 'card fade-in';  
      customLinkSection.style.marginTop = '12px';  
      const contractSection = document.getElementById('contractSection');  
      if (contractSection) {  
        contractSection.parentNode.insertBefore(customLinkSection, contractSection.nextSibling);  
      }  
    }  
    if (customLinkSection) {  
      if (m.showCustomResultLink && m.customResultLinkUrl && m.customResultLinkText) {  
        customLinkSection.style.display = 'block';  
        const linkColor = m.customResultLinkColor || '#7c3aed';  
        customLinkSection.innerHTML = `  
          <a href="${escapeHtml(m.customResultLinkUrl)}" target="_blank" style="display:block; background:linear-gradient(135deg,${linkColor},${adjustColor(linkColor, -30)}); color:#fff; padding:12px 20px; border-radius:12px; font-size:16px; font-weight:bold; text-decoration:none; text-align:center;">🔗 ${escapeHtml(m.customResultLinkText)}</a>  
        `;  
      } else {  
        customLinkSection.style.display = 'none';  
      }  
    }  
      
    // قسم التقييم  
    const ratingSection = document.getElementById('ratingSection');  
    if (ratingSection) {  
      ratingSection.style.display = m.showRating ? 'block' : 'none';  
      // إعادة تعيين التقييم  
      currentRating = 0;  
      const starsEl = document.querySelectorAll('#ratingStars .rating-star');  
      starsEl.forEach(el => {  
        el.textContent = '☆';  
        el.style.color = '#d1d5db';  
      });  
      document.getElementById('ratingComment').value = '';  
      document.getElementById('ratingSuccess').style.display = 'none';  
      ratingSection.style.pointerEvents = 'auto';  
      ratingSection.style.opacity = '1';  
    }  
  }  
  
  // ====== الجزيئات المتحركة ======  
  function createParticles() {  
    const container = document.getElementById('particles');  
    if (!container) return;  
      
    for (let i = 0; i < 50; i++) {  
      const particle = document.createElement('div');  
      particle.className = 'particle';  
      particle.style.left = Math.random() * 100 + '%';  
      particle.style.animationDelay = Math.random() * 20 + 's';  
      particle.style.animationDuration = (15 + Math.random() * 10) + 's';  
      container.appendChild(particle);  
    }  
  }  
    
  // ====== الترحيب حسب الوقت ======  
  function updateTimeGreeting() {  
    const hour = new Date().getHours();  
    const greetingEl = document.getElementById('timeGreeting');  
    if (!greetingEl) return;  
      
    let greeting = '';  
    if (hour >= 5 && hour < 12) {  
      greeting = '🌅 صباح الخير';  
    } else if (hour >= 12 && hour < 17) {  
      greeting = '☀️ مساء النور';  
    } else if (hour >= 17 && hour < 21) {  
      greeting = '🌇 مساء الخير';  
    } else {  
      greeting = '🌙 أهلاً بالليل';  
    }  
    greetingEl.textContent = greeting;  
  }  
    
  // ====== شاشة البداية ======  
  let splashHidden = false;  
    
  function hideSplashScreen() {  
    if (splashHidden) return; // منع التكرار  
    const splash = document.getElementById('splashScreen');  
    if (splash) {  
      splashHidden = true;  
      splash.style.transition = 'opacity 0.5s ease-out';  
      splash.style.opacity = '0';  
      setTimeout(() => {   
        splash.style.display = 'none';  
        splash.style.visibility = 'hidden';  
        splash.style.pointerEvents = 'none';  
      }, 500);  
    }  
  }  
    
  // إخفاء شاشة البداية فوراً عند النقر عليها  
  document.addEventListener('click', function(e) {  
    if (!splashHidden) {  
      hideSplashScreen();  
    }  
  }, { once: true });  
    
  // إخفاء شاشة البداية عند تحميل الصفحة بالكامل  
  // يمكن للمسؤول تعديل مدة العرض من الإعدادات  
  const SPLASH_SETTINGS_KEY = 'finoSplashSettings';  
  function getSplashSettings() {  
    try {  
      const saved = localStorage.getItem(SPLASH_SETTINGS_KEY);  
      if (saved) return JSON.parse(saved);  
    } catch(e) {}  
    return { enabled: true, duration: 3, customImage: '', customVideo: '' };  
  }  
    
  function saveSplashSettings(settings) {  
    localStorage.setItem(SPLASH_SETTINGS_KEY, JSON.stringify(settings));  
  }  
    
  // تحديث عرض مدة شاشة البداية  
  function updateSplashDurationPreview() {  
    const duration = document.getElementById('settingsSplashDuration')?.value || 3;  
    const preview = document.getElementById('splashDurationPreview');  
    if (preview) {  
      preview.textContent = `المدة: ${duration} ثواني`;  
    }  
  }  
    
  // معاينة شاشة البداية  
  function testSplashScreen() {  
    const splash = document.getElementById('splashScreen');  
    if (splash) {  
      splashHidden = false;  
      splash.style.display = 'flex';  
      splash.style.opacity = '1';  
      splash.style.pointerEvents = 'auto';  
        
      const duration = parseInt(document.getElementById('settingsSplashDuration')?.value) || 3;  
      showToast(`سيتم إخفاء شاشة البداية بعد ${duration} ثواني...`);  
        
      setTimeout(() => {  
        hideSplashScreen();  
      }, duration * 1000);  
    }  
  }  
    
  // إخفاء شاشة البداية عند تحميل الصفحة  
  function initSplashScreen() {  
    try {  
      console.log('[Splash] Starting initialization...');  
        
      var splashSettings = getSplashSettings();  
      var duration = splashSettings.duration;  
      if (typeof duration !== 'number' || duration < 1) duration = 3;  
      var durationMs = duration * 1000;  
        
      console.log('[Splash] Duration:', duration, 'seconds');  
        
      var splash = document.getElementById('splashScreen');  
      if (!splash) {  
        console.log('[Splash] Element not found!');  
        return;  
      }  
        
      // التأكد من ظهور شاشة البداية  
      splash.style.display = 'flex';  
      splash.style.opacity = '1';  
        
      if (splashSettings.enabled === false) {  
        console.log('[Splash] Disabled in settings');  
        splash.style.display = 'none';  
        splashHidden = true;  
        return;  
      }  
        
      // الحصول على العناصر  
      var loaderFill = document.getElementById('splashLoaderFill');  
      var percentageEl = document.getElementById('splashPercentage');  
      var loadingTextEl = document.getElementById('splashLoadingText');  
        
      console.log('[Splash] Elements found:', {  
        loaderFill: !!loaderFill,  
        percentageEl: !!percentageEl,  
        loadingTextEl: !!loadingTextEl  
      });  
        
      // إعادة تعيين وتشغيل animation شريط التحميل  
      if (loaderFill) {  
        loaderFill.style.width = '0%';  
        loaderFill.style.animation = 'none';  
        loaderFill.offsetHeight; // force reflow  
        loaderFill.style.animation = 'loaderFill ' + duration + 's ease-in-out forwards, loaderShimmer 1.5s linear infinite';  
      }  
        
      // تحديث النسبة المئوية  
      var loadingMessages = [  
        'جاري تحميل المنصة...',  
        'تجهيز الحاسبة...',  
        'تحميل بيانات البنوك...',  
        'جاهز للانطلاق! 🚀'  
      ];  
      var currentPercent = 0;  
      var stepInterval = durationMs / 100;  
        
      console.log('[Splash] Starting progress timer, interval:', stepInterval);  
        
      var percentTimer = setInterval(function() {  
        currentPercent++;  
        if (percentageEl) percentageEl.textContent = currentPercent + '%';  
          
        if (loadingTextEl) {  
          if (currentPercent < 30) loadingTextEl.textContent = loadingMessages[0];  
          else if (currentPercent < 60) loadingTextEl.textContent = loadingMessages[1];  
          else if (currentPercent < 90) loadingTextEl.textContent = loadingMessages[2];  
          else loadingTextEl.textContent = loadingMessages[3];  
        }  
          
        if (currentPercent >= 100) {  
          clearInterval(percentTimer);  
          console.log('[Splash] Progress complete');  
        }  
      }, stepInterval);  
        
      // إخفاء بعد المدة المحددة  
      setTimeout(function() {  
        console.log('[Splash] Hiding after duration');  
        if (!splashHidden) {  
          splashHidden = true;  
          splash.style.transition = 'opacity 0.5s ease-out';  
          splash.style.opacity = '0';  
          setTimeout(function() {  
            splash.style.display = 'none';  
          }, 500);  
        }  
      }, durationMs + 200);  
        
      // Fallback: إخفاء إجباري بعد 6 ثواني كحد أقصى  
      setTimeout(function() {  
        if (!splashHidden) {  
          console.log('[Splash] Fallback: Force hiding');  
          splashHidden = true;  
          splash.style.display = 'none';  
        }  
      }, 6000);  
        
    } catch(e) {  
      console.error('[Splash] Error:', e);  
      // في حالة أي خطأ، إخفاء شاشة البداية  
      var splash = document.getElementById('splashScreen');  
      if (splash) splash.style.display = 'none';  
    }  
  }  
    
  // تشغيل شاشة البداية فوراً - كود موثوق لجميع الأجهزة  
  (function runSplash() {  
    console.log('[Splash] runSplash called, readyState:', document.readyState);  
      
    // تشغيل فوري  
    if (document.readyState === 'complete' || document.readyState === 'interactive') {  
      console.log('[Splash] Running immediately');  
      setTimeout(initSplashScreen, 50); // تأخير بسيط للتأكد من جاهزية DOM  
    } else {  
      console.log('[Splash] Waiting for DOMContentLoaded');  
      document.addEventListener('DOMContentLoaded', function() {  
        console.log('[Splash] DOMContentLoaded fired');  
        setTimeout(initSplashScreen, 50);  
      });  
    }  
      
    // Fallback إضافي: إخفاء إجباري بعد 5 ثواني  
    setTimeout(function() {  
      var splash = document.getElementById('splashScreen');  
      if (splash && splash.style.display !== 'none' && splash.style.opacity !== '0') {  
        console.log('[Splash] Emergency fallback: hiding splash');  
        splash.style.opacity = '0';  
        setTimeout(function() {  
          splash.style.display = 'none';  
        }, 300);  
      }  
    }, 5000);  
  })();  
  
  // ====== تخصيص النتيجة ======  
  const RESULT_SETTINGS_KEY = 'finoResultSettings';  
  const RESULT_TEXTS_KEY = 'finoResultTexts';  
    
  function getResultSettings() {  
    try {  
      const saved = localStorage.getItem(RESULT_SETTINGS_KEY);  
      if (saved) return JSON.parse(saved);  
    } catch(e) {}  
    return {  
      showNetAmount: true, showInstallment: true, showDuration: true, showBank: true,  
      showProfit: true, showEndDate: true, showEndDateHijri: true, showEndDateGregorian: true,  
      showEndMessage: true, showRetirement: true, showPeriods: true, showBankNote: true,  
      showAds: true, showCustomLink: true, showRating: true,  
      customLinkText: '', customLinkUrl: ''  
    };  
  }  
    
  function saveResultSettings() {  
    const settings = {  
      showNetAmount: document.getElementById('resultShowNetAmount')?.checked ?? true,  
      showInstallment: document.getElementById('resultShowInstallment')?.checked ?? true,  
      showDuration: document.getElementById('resultShowDuration')?.checked ?? true,  
      showBank: document.getElementById('resultShowBank')?.checked ?? true,  
      showProfit: document.getElementById('resultShowProfit')?.checked ?? true,  
      showEndDate: document.getElementById('resultShowEndDate')?.checked ?? true,  
      showEndDateHijri: document.getElementById('resultShowEndDateHijri')?.checked ?? true,  
      showEndDateGregorian: document.getElementById('resultShowEndDateGregorian')?.checked ?? true,  
      showEndMessage: document.getElementById('resultShowEndMessage')?.checked ?? true,  
      showRetirement: document.getElementById('resultShowRetirement')?.checked ?? true,  
      showPeriods: document.getElementById('resultShowPeriods')?.checked ?? true,  
      showBankNote: document.getElementById('resultShowBankNote')?.checked ?? true,  
      showAds: document.getElementById('resultShowAds')?.checked ?? true,  
      showCustomLink: document.getElementById('resultShowCustomLink')?.checked ?? true,  
      showRating: document.getElementById('resultShowRating')?.checked ?? true,  
      customLinkText: document.getElementById('resultCustomLinkText')?.value || '',  
      customLinkUrl: document.getElementById('resultCustomLinkUrl')?.value || ''  
    };  
    localStorage.setItem(RESULT_SETTINGS_KEY, JSON.stringify(settings));  
    alert('تم حفظ إعدادات النتيجة بنجاح!');  
  }  
    
  function loadResultSettingsToUI() {  
    const s = getResultSettings();  
    const setCheck = (id, val) => { const el = document.getElementById(id); if(el) el.checked = val; };  
    const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };  
    setCheck('resultShowNetAmount', s.showNetAmount);  
    setCheck('resultShowInstallment', s.showInstallment);  
    setCheck('resultShowDuration', s.showDuration);  
    setCheck('resultShowBank', s.showBank);  
    setCheck('resultShowProfit', s.showProfit);  
    setCheck('resultShowEndDate', s.showEndDate);  
    setCheck('resultShowEndDateHijri', s.showEndDateHijri);  
    setCheck('resultShowEndDateGregorian', s.showEndDateGregorian);  
    setCheck('resultShowEndMessage', s.showEndMessage);  
    setCheck('resultShowRetirement', s.showRetirement);  
    setCheck('resultShowPeriods', s.showPeriods);  
    setCheck('resultShowBankNote', s.showBankNote);  
    setCheck('resultShowAds', s.showAds);  
    setCheck('resultShowCustomLink', s.showCustomLink);  
    setCheck('resultShowRating', s.showRating);  
    setVal('resultCustomLinkText', s.customLinkText);  
    setVal('resultCustomLinkUrl', s.customLinkUrl);  
  }  
    
  function getResultTexts() {  
    try {  
      const saved = localStorage.getItem(RESULT_TEXTS_KEY);  
      if (saved) return JSON.parse(saved);  
    } catch(e) {}  
    return {  
      netAmount: 'المبلغ الصافي', installment: 'القسط الشهري',  
      duration: 'مدة التمويل', bank: 'البنك المقترح',  
      endDate: 'تاريخ انتهاء التمويل',  
      endMessage: 'ينتهي سنة {year}... الله يطول بعمرنا ويبارك لنا',  
      deficit: 'للأسف الراتب لا يكفي للتمويل المطلوب',  
      retirement: 'راتب التقاعد المتوقع',  
      disclaimer: 'هذه حسبة تقريبية وليست عرض رسمي'  
    };  
  }  
    
  function saveResultTexts() {  
    const texts = {  
      netAmount: document.getElementById('resultTextNetAmount')?.value || 'المبلغ الصافي',  
      installment: document.getElementById('resultTextInstallment')?.value || 'القسط الشهري',  
      duration: document.getElementById('resultTextDuration')?.value || 'مدة التمويل',  
      bank: document.getElementById('resultTextBank')?.value || 'البنك المقترح',  
      endDate: document.getElementById('resultTextEndDate')?.value || 'تاريخ انتهاء التمويل',  
      endMessage: document.getElementById('resultTextEndMessage')?.value || 'ينتهي سنة {year}... الله يطول بعمرنا',  
      deficit: document.getElementById('resultTextDeficit')?.value || 'للأسف الراتب لا يكفي',  
      retirement: document.getElementById('resultTextRetirement')?.value || 'راتب التقاعد المتوقع',  
      disclaimer: document.getElementById('resultTextDisclaimer')?.value || 'هذه حسبة تقريبية'  
    };  
    localStorage.setItem(RESULT_TEXTS_KEY, JSON.stringify(texts));  
    alert('تم حفظ صيغ النتيجة بنجاح!');  
  }  
    
  function loadResultTextsToUI() {  
    const t = getResultTexts();  
    const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };  
    setVal('resultTextNetAmount', t.netAmount);  
    setVal('resultTextInstallment', t.installment);  
    setVal('resultTextDuration', t.duration);  
    setVal('resultTextBank', t.bank);  
    setVal('resultTextEndDate', t.endDate);  
    setVal('resultTextEndMessage', t.endMessage);  
    setVal('resultTextDeficit', t.deficit);  
    setVal('resultTextRetirement', t.retirement);  
    setVal('resultTextDisclaimer', t.disclaimer);  
  }  
  
  // ====== إدارة الجهات التمويلية (البنوك) ======  
  let customBanks = [];  
  const CUSTOM_BANKS_KEY = 'finoCustomBanks';  
    
  function loadCustomBanks() {  
    try {  
      const saved = localStorage.getItem(CUSTOM_BANKS_KEY);  
      if (saved) customBanks = JSON.parse(saved);  
    } catch(e) { console.error('خطأ في تحميل الجهات:', e); }  
  }  
    
  function saveCustomBanks() {  
    localStorage.setItem(CUSTOM_BANKS_KEY, JSON.stringify(customBanks));  
  }  
    
  function addNewBank(e) {  
    e.preventDefault();  
    const name = document.getElementById('newBankName').value.trim();  
    const type = document.getElementById('newBankType').value;  
    const logo = document.getElementById('newBankLogo').value.trim();  
    const note = document.getElementById('newBankNote').value.trim();  
      
    if (!name) { alert('يرجى إدخال اسم الجهة'); return; }  
      
    // التحقق من عدم التكرار  
    const exists = customBanks.find(b => b.name === name);  
    if (exists) { alert('هذه الجهة موجودة مسبقاً'); return; }  
      
    customBanks.push({ name, type, logo, note, createdAt: Date.now() });  
    saveCustomBanks();  
    updateBankDropdowns();  
    renderBanksList();  
      
    // مسح النموذج  
    document.getElementById('newBankName').value = '';  
    document.getElementById('newBankLogo').value = '';  
    document.getElementById('newBankNote').value = '';  
      
    alert('تمت إضافة الجهة بنجاح! ستظهر الآن في قائمة تعديل النسب.');  
  }  
    
  function deleteCustomBank(index) {  
    if (!confirm('هل أنت متأكد من حذف هذه الجهة؟')) return;  
    customBanks.splice(index, 1);  
    saveCustomBanks();  
    updateBankDropdowns();  
    renderBanksList();  
  }  
    
  function renderBanksList() {  
    const tbody = document.getElementById('banksListBody');  
    if (!tbody) return;  
      
    // البنوك الافتراضية - القائمة الكاملة المرخصة من ساما  
    const defaultBanks = [  
      // البنوك المحلية (11 بنك)  
      'البنك الأهلي السعودي', 'مصرف الراجحي', 'بنك الرياض', 'البنك السعودي الأول',  
      'البنك العربي الوطني', 'مصرف الإنماء', 'البنك السعودي الفرنسي',  
      'البنك السعودي للاستثمار', 'بنك البلاد', 'بنك الجزيرة', 'بنك الخليج الدولي',  
      // البنوك الرقمية  
      'بنك STC', 'بنك D360', 'بنك فيجن',  
      // فروع البنوك الأجنبية  
      'بنك الإمارات دبي الوطني', 'بنك المشرق', 'بنك البحرين الوطني',  
      'البنك الأول (FAB)', 'بنك HSBC', 'بنك Citibank',  
      // شركات التمويل العقاري  
      'أملاك العالمية للتمويل', 'شركة دار التمليك', 'شركة سهل للتمويل',  
      'شركة مسار النمو للتمويل', 'شركة عبداللطيف جميل للتمويل العقاري',  
      'شركة بداية للتمويل', 'الشركة السعودية لإعادة التمويل العقاري',  
      // شركات التمويل الاستهلاكي والإيجار  
      'شركة النايفات للتمويل', 'شركة ينال للتمويل', 'شركة اليسر للإجارة والتمويل',  
      'شركة آجل للخدمات التمويلية', 'الشركة الوطنية للتمويل', 'شركة المرابحة المرنة للتمويل',  
      'شركة كرناف للتمويل', 'شركة الجاسرية للتمويل', 'شركة متاجر للتمويل',  
      'شركة تسهيل للتمويل', 'شركة السعودي الفرنسي للتأجير التمويلي',  
      'شركة الأولى للتمويل', 'شركة الجبر للتمويل', 'شركة موني للتمويل',  
      'شركة كوارا للتمويل', 'شركة إمكان للتمويل', 'شركة الأمثل للتمويل',  
      'شركة دويتشه الخليج للتمويل', 'شركة الراجحي للتمويل', 'شركة الأهلي للتمويل',  
      'شركة التسهيلات المالية', 'شركة رسن للتمويل', 'شركة لندو للتمويل',  
      // شركات التمويل الجماعي والتقنية المالية  
      'شركة فندينق سوق للتمويل', 'شركة منافع للتمويل', 'شركة سلفة للتمويل',  
      'شركة تمارا للتمويل', 'شركة تابي للتمويل', 'شركة سبوتي للتمويل',  
      'شركة بوست باي للتمويل', 'شركة قسطها للتمويل', 'شركة حصيل للتمويل',  
      'شركة ليندا للتمويل', 'شركة فرصة للتمويل', 'شركة سكوبير للتمويل'  
    ];  
      
    let html = '';  
      
    // عرض البنوك الافتراضية  
    defaultBanks.forEach(name => {  
      html += `<tr style="background:#f8fafc;">  
        <td>${name}</td>  
        <td>بنك</td>  
        <td>-</td>  
        <td><span style="color:#9ca3af; font-size:12px;">افتراضي</span></td>  
      </tr>`;  
    });  
      
    // عرض الجهات المضافة  
    customBanks.forEach((bank, idx) => {  
      html += `<tr style="background:#fef3c7;">  
        <td><strong>${bank.name}</strong></td>  
        <td>${bank.type}</td>  
        <td>${bank.note || '-'}</td>  
        <td>  
          <button class="secondary small" onclick="deleteCustomBank(${idx})" style="padding:4px 8px;">🗑️ حذف</button>  
        </td>  
      </tr>`;  
    });  
      
    tbody.innerHTML = html;  
  }  
    
  // ====== دالة تحديث قائمة جهات التمويل في لوحة التحكم ======  
  // تستخدم الدالة المركزية getMasterFinanceEntitiesList()  
  function updateBankDropdowns() {  
    const select = document.getElementById('adminBankName');  
    if (!select) return;  
      
    // حفظ القيمة الحالية  
    const currentValue = select.value;  
      
    // استخدام الدالة المركزية للحصول على جميع جهات التمويل  
    const allEntities = getMasterFinanceEntitiesList();  
      
    let html = '<option value="">اختر جهة التمويل...</option>';  
      
    // تصنيف الجهات حسب النوع  
    const categories = {  
      'بنك محلي': [],  
      'بنك رقمي': [],  
      'بنك أجنبي': [],  
      'شركة تمويل عقاري': [],  
      'شركة تمويل': [],  
      'تقنية مالية': [],  
      'جهة مخصصة': []  
    };  
      
    allEntities.forEach(entity => {  
      const type = entity.type || 'جهة مخصصة';  
      if (categories[type]) {  
        categories[type].push(entity.name);  
      } else {  
        categories['جهة مخصصة'].push(entity.name);  
      }  
    });  
      
    // إضافة كل فئة كمجموعة  
    const categoryLabels = {  
      'بنك محلي': '🏦 البنوك المحلية',  
      'بنك رقمي': '📱 البنوك الرقمية',  
      'بنك أجنبي': '🌐 فروع البنوك الأجنبية',  
      'شركة تمويل عقاري': '🏠 شركات التمويل العقاري',  
      'شركة تمويل': '💳 شركات التمويل',  
      'تقنية مالية': '💻 التقنية المالية (FinTech)',  
      'جهة مخصصة': '➕ جهات مضافة بواسطة المسؤول'  
    };  
      
    Object.keys(categories).forEach(type => {  
      if (categories[type].length > 0) {  
        html += `<optgroup label="${categoryLabels[type] || type}">`;  
        categories[type].forEach(name => {  
          html += `<option value="${name}">${name}</option>`;  
        });  
        html += '</optgroup>';  
      }  
    });  
      
    select.innerHTML = html;  
      
    // استعادة القيمة  
    if (currentValue) select.value = currentValue;  
  }  
    
  // ====== تشغيل ======  
  document.addEventListener('DOMContentLoaded', () => {  
    // إخفاء شاشة البداية حسب الإعدادات  
    const splashSettings = getSplashSettings();  
    // تحويل الثواني إلى ميلي ثانية (القيمة المحفوظة بالثواني)  
    const splashDuration = (splashSettings.duration || 3) * 1000;  
    if (splashSettings.enabled !== false) {  
      setTimeout(hideSplashScreen, splashDuration);  
    } else {  
      hideSplashScreen();  
    }  
      
    // إنشاء الجزيئات المتحركة  
    createParticles();  
      
    // تحديث الترحيب حسب الوقت  
    updateTimeGreeting();  
      
    showPage('landing');  
  
    // (إضافة) تحميل منتجات التمويل + إعدادات التقاعد  
    loadFinanceProducts();  
    loadRetirementSettings();  
  
    loadBankConfigs();  
    renderArchiveTable();  
    renderFinanceProductsTable();  
      
    // تحميل الجهات التمويلية المخصصة  
    loadCustomBanks();  
    updateBankDropdowns();  
    renderBanksList();  
    loadRetirementSettingsToUI();  
      
    // تحميل التقييمات والعروض والتسويق  
    loadRatings();  
    loadOffers();  
    loadMarketingSettings();  
    renderRatingsTable();  
    renderOffersTable();  
    loadMarketingSettingsToUI();  
    updateHomeRatings();  
    updateTrustSectionVisibility();  
    updateRatingRequestVisibility();  
  
    updateDateTime();  
    setInterval(updateDateTime, 1000);  
      
    // تحميل الميزات المتقدمة  
    loadAdvancedFeatures();  
      
    // تحميل الواجهات المحفوظة وإعدادات المنصة بعد تأخير لضمان تحميل الدوال  
    setTimeout(function() {  
      console.log('Attempting to load saved interface images...');  
      if (typeof loadSavedInterfaceImages === 'function') {  
        try {  
          loadSavedInterfaceImages();  
          console.log('Successfully loaded saved interface images');  
        } catch (err) {  
          console.error('Error loading interface images:', err);  
        }  
      } else {  
        console.warn('loadSavedInterfaceImages function not found');  
      }  
        
      // تحميل وتطبيق إعدادات المنصة (الاسم، الخلفية، إلخ)  
      if (typeof loadPlatformSettings === 'function' && typeof applyPlatformSettings === 'function') {  
        try {  
          const platformSettings = loadPlatformSettings();  
          applyPlatformSettings(platformSettings);  
          console.log('Successfully applied platform settings');  
        } catch (err) {  
          console.error('Error applying platform settings:', err);  
        }  
      }  
    }, 500);  
  });  
    
  // ====== الميزات المتقدمة ======  
    
  // سجل الأسئلة للرجوع  
  let questionHistory = [];  
    
  // دالة الرجوع للخلف  
  function goBack() {  
    // الرجوع للسؤال السابق الظاهر (تخطي الأسئلة المخفية)  
    while (questionHistory.length > 0) {  
      const prevState = questionHistory.pop();  
      step = prevState.step;  
      commitmentStep = prevState.commitmentStep;  
      answers = JSON.parse(JSON.stringify(prevState.answers));  
      currentCommitment = JSON.parse(JSON.stringify(prevState.currentCommitment || {}));  
        
      // فحص إذا كان السؤال السابق مخفي  
      const customQ = loadCustomQuestions();  
      let isHidden = false;  
        
      if (step < generalQuestions.length) {  
        isHidden = customQ.hidden && customQ.hidden.includes('general_' + step);  
      } else {  
        isHidden = customQ.hidden && customQ.hidden.includes('commitment_' + commitmentStep);  
      }  
        
      // إذا السؤال غير مخفي، اعرضه  
      if (!isHidden) {  
        showQuestion();  
        updateBackButton();  
        return;  
      }  
      // إذا مخفي، استمر في الرجوع  
    }  
      
    // إذا لم يتبقى أسئلة في السجل  
    updateBackButton();  
  }  
    
  // تحديث زر الرجوع  
  function updateBackButton() {  
    const backBtn = document.getElementById('backButton');  
    if (backBtn) {  
      backBtn.style.display = questionHistory.length > 0 ? 'inline-flex' : 'none';  
    }  
  }  
    
  // حفظ الحالة قبل الانتقال للسؤال التالي  
  function saveQuestionState() {  
    questionHistory.push({  
      step: step,  
      commitmentStep: commitmentStep,  
      answers: JSON.parse(JSON.stringify(answers)),  
      currentCommitment: JSON.parse(JSON.stringify(currentCommitment))  
    });  
    updateBackButton();  
  }  
    
  // تحميل الميزات المتقدمة  
  function loadAdvancedFeatures() {  
    // تتبع الزائر  
    trackVisitor();  
      
    // تحديث إحصائيات الزوار  
    updateVisitorStatsDisplay();  
      
    // تحميل إعدادات المنصة  
    loadPlatformSettingsToUI();  
      
    // تحميل الثيم والموسم  
    const savedTheme = localStorage.getItem('finoTheme') || 'default';  
    const savedSeason = localStorage.getItem('finoSeasonTheme') || 'default';  
    applyTheme(savedTheme);  
    applySeasonTheme(savedSeason);  
      
    // تحميل الإعلانات  
    renderAdsTable();  
      
    // تحميل قائمة الأسئلة  
    renderQuestionsList();  
  }  
    
  // ====== نظام تتبع الزوار ======  
  const VISITORS_KEY = 'finoVisitors';  
  const CLIENT_RESULTS_KEY = 'finoClientResults';  
    
  function trackVisitor() {  
    const visitors = loadVisitors();  
    const now = new Date();  
    const today = now.toISOString().split('T')[0];  
      
    const visitor = {  
      id: 'v_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),  
      timestamp: now.toISOString(),  
      date: today,  
      time: now.toLocaleTimeString('ar-SA'),  
      screenSize: screen.width + 'x' + screen.height,  
      referrer: document.referrer || 'مباشر'  
    };  
      
    visitors.unshift(visitor);  
    if (visitors.length > 1000) visitors.length = 1000;  
      
    localStorage.setItem(VISITORS_KEY, JSON.stringify(visitors));  
  }  
    
  function loadVisitors() {  
    try {  
      const data = localStorage.getItem(VISITORS_KEY);  
      return data ? JSON.parse(data) : [];  
    } catch (e) {  
      return [];  
    }  
  }  
    
  function getVisitorStats() {  
    const visitors = loadVisitors();  
    const now = new Date();  
    const today = now.toISOString().split('T')[0];  
    const thisWeek = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];  
    const thisMonth = now.toISOString().substr(0, 7);  
      
    return {  
      total: visitors.length,  
      today: visitors.filter(v => v.date === today).length,  
      thisWeek: visitors.filter(v => v.date >= thisWeek).length,  
      thisMonth: visitors.filter(v => v.date.startsWith(thisMonth)).length  
    };  
  }  
    
  function updateVisitorStatsDisplay() {  
    const stats = getVisitorStats();  
      
    // لوحة المسؤول الرئيسية  
    const el1 = document.getElementById('visitorTotal');  
    const el2 = document.getElementById('visitorToday');  
    const el3 = document.getElementById('visitorWeek');  
    const el4 = document.getElementById('visitorMonth');  
    if (el1) el1.textContent = stats.total;  
    if (el2) el2.textContent = stats.today;  
    if (el3) el3.textContent = stats.thisWeek;  
    if (el4) el4.textContent = stats.thisMonth;  
      
    // صفحة تتبع الزوار  
    const el5 = document.getElementById('visitorTotalPage');  
    const el6 = document.getElementById('visitorTodayPage');  
    const el7 = document.getElementById('visitorWeekPage');  
    const el8 = document.getElementById('visitorMonthPage');  
    if (el5) el5.textContent = stats.total;  
    if (el6) el6.textContent = stats.today;  
    if (el7) el7.textContent = stats.thisWeek;  
    if (el8) el8.textContent = stats.thisMonth;  
      
    // تحديث جدول الزوار  
    renderVisitorsTable();  
  }  
    
  function renderVisitorsTable() {  
    const visitors = loadVisitors();  
    const tbody = document.querySelector('#visitorsTable tbody');  
    if (!tbody) return;  
      
    tbody.innerHTML = visitors.slice(0, 50).map(v => `  
      <tr>  
        <td>${v.date}</td>  
        <td>${v.time}</td>  
        <td>${v.referrer}</td>  
        <td>${v.screenSize}</td>  
      </tr>  
    `).join('');  
  }  
    
  function clearVisitors() {  
    if (confirm('هل أنت متأكد من مسح سجل الزوار؟')) {  
      localStorage.removeItem(VISITORS_KEY);  
      updateVisitorStatsDisplay();  
      alert('تم مسح السجل.');  
    }  
  }  
    
  // ====== نظام نتائج العشوائية ======  
  function saveClientResultToLog(result) {  
    const results = loadClientResultsLog();  
      
    const record = {  
      id: 'r_' + Date.now(),  
      timestamp: new Date().toISOString(),  
      clientName: result.clientName || 'غير محدد',  
      financeType: result.financeType || '',  
      amount: result.finalNet || 0,  
      bank: result.recommendedBankName || '',  
      salary: result.salary || 0,  
      months: result.months || 0  
    };  
      
    results.unshift(record);  
    if (results.length > 500) results.length = 500;  
      
    localStorage.setItem(CLIENT_RESULTS_KEY, JSON.stringify(results));  
  }  
    
  function loadClientResultsLog() {  
    try {  
      const data = localStorage.getItem(CLIENT_RESULTS_KEY);  
      return data ? JSON.parse(data) : [];  
    } catch (e) {  
      return [];  
    }  
  }  
    
  function renderClientResultsTable() {  
    const results = loadClientResultsLog();  
    const tbody = document.querySelector('#clientResultsTable tbody');  
    if (!tbody) return;  
      
    tbody.innerHTML = results.slice(0, 50).map(r => `  
      <tr>  
        <td>${new Date(r.timestamp).toLocaleDateString('ar-SA')}</td>  
        <td>${r.clientName}</td>  
        <td>${r.financeType}</td>  
        <td>${fmtMoney(r.amount)}</td>  
        <td>${r.bank}</td>  
        <td>${fmtMoney(r.salary)}</td>  
      </tr>  
    `).join('');  
  }  
    
  function clearClientResults() {  
    if (confirm('هل أنت متأكد من مسح سجل النتائج؟')) {  
      localStorage.removeItem(CLIENT_RESULTS_KEY);  
      renderClientResultsTable();  
      alert('تم مسح السجل.');  
    }  
  }  
    
  // ====== نظام الثيمات ======  
  const themeColors = {  
    default: 'linear-gradient(-45deg, #0f172a, #1e3a8a, #1e40af, #3b82f6)',  
    green: 'linear-gradient(-45deg, #064e3b, #047857, #059669, #10b981)',  
    purple: 'linear-gradient(-45deg, #4c1d95, #5b21b6, #6d28d9, #8b5cf6)',  
    gold: 'linear-gradient(-45deg, #78350f, #92400e, #b45309, #f59e0b)',  
    dark: 'linear-gradient(-45deg, #0f172a, #1e293b, #334155, #475569)'  
  };  
    
  function applyTheme(theme) {  
    const body = document.body;  
    ['default', 'green', 'purple', 'gold', 'dark'].forEach(t => {  
      body.classList.remove('theme-' + t);  
    });  
    body.classList.add('theme-' + theme);  
      
    // تغيير الخلفية مباشرة باستخدام CSS variable و style مباشر  
    if (themeColors[theme]) {  
      document.documentElement.style.setProperty('--main-bg', themeColors[theme]);  
      body.style.setProperty('background', themeColors[theme], 'important');  
      body.style.backgroundSize = '400% 400%';  
      body.style.animation = 'gradientBG 15s ease infinite';  
    }  
      
    localStorage.setItem('finoTheme', theme);  
      
    // إظهار رسالة تأكيد  
    const themeNames = { default: 'أزرق', green: 'أخضر', purple: 'بنفسجي', gold: 'ذهبي', dark: 'داكن' };  
    showToast('تم تطبيق الثيم ' + themeNames[theme] + ' بنجاح! 🎨');  
  }  
    
  // ====== نظام الألوان المخصصة ======  
  function applyCustomColors() {  
    const primary = document.getElementById('customPrimaryColor')?.value || '#3b82f6';  
    const secondary = document.getElementById('customSecondaryColor')?.value || '#1e40af';  
    const accent = document.getElementById('customAccentColor')?.value || '#f59e0b';  
    const bg = document.getElementById('customBgColor')?.value || '#0f172a';  
    const text = document.getElementById('customTextColor')?.value || '#ffffff';  
    const card = document.getElementById('customCardColor')?.value || '#ffffff';  
      
    // تطبيق الألوان على CSS Variables  
    document.documentElement.style.setProperty('--primary-color', primary);  
    document.documentElement.style.setProperty('--secondary-color', secondary);  
    document.documentElement.style.setProperty('--accent-color', accent);  
    document.documentElement.style.setProperty('--bg-color', bg);  
    document.documentElement.style.setProperty('--text-color', text);  
    document.documentElement.style.setProperty('--card-color', card);  
      
    // تطبيق على الخلفية  
    document.body.style.background = `linear-gradient(-45deg, ${bg}, ${secondary}, ${primary})`;  
    document.body.style.backgroundSize = '400% 400%';  
    document.body.style.animation = 'gradientBG 15s ease infinite';  
      
    // تطبيق على الأزرار  
    document.querySelectorAll('button.primary, button[style*="background"]').forEach(btn => {  
      if (!btn.classList.contains('secondary')) {  
        btn.style.background = `linear-gradient(135deg, ${primary}, ${secondary})`;  
      }  
    });  
      
    // حفظ الألوان  
    const customColors = { primary, secondary, accent, bg, text, card };  
    localStorage.setItem('finoCustomColors', JSON.stringify(customColors));  
      
    showToast('تم تطبيق الألوان المخصصة بنجاح! 🎨');  
  }  
    
  function resetColors() {  
    localStorage.removeItem('finoCustomColors');  
    document.documentElement.style.removeProperty('--primary-color');  
    document.documentElement.style.removeProperty('--secondary-color');  
    document.documentElement.style.removeProperty('--accent-color');  
    document.documentElement.style.removeProperty('--bg-color');  
    document.documentElement.style.removeProperty('--text-color');  
    document.documentElement.style.removeProperty('--card-color');  
      
    // إعادة تعيين حقول الألوان  
    if (document.getElementById('customPrimaryColor')) document.getElementById('customPrimaryColor').value = '#3b82f6';  
    if (document.getElementById('customSecondaryColor')) document.getElementById('customSecondaryColor').value = '#1e40af';  
    if (document.getElementById('customAccentColor')) document.getElementById('customAccentColor').value = '#f59e0b';  
    if (document.getElementById('customBgColor')) document.getElementById('customBgColor').value = '#0f172a';  
    if (document.getElementById('customTextColor')) document.getElementById('customTextColor').value = '#ffffff';  
    if (document.getElementById('customCardColor')) document.getElementById('customCardColor').value = '#ffffff';  
      
    applyTheme('default');  
    showToast('تم إعادة تعيين الألوان للافتراضي! 🔄');  
  }  
    
  function loadSavedCustomColors() {  
    const saved = localStorage.getItem('finoCustomColors');  
    if (saved) {  
      try {  
        const colors = JSON.parse(saved);  
        if (document.getElementById('customPrimaryColor')) document.getElementById('customPrimaryColor').value = colors.primary;  
        if (document.getElementById('customSecondaryColor')) document.getElementById('customSecondaryColor').value = colors.secondary;  
        if (document.getElementById('customAccentColor')) document.getElementById('customAccentColor').value = colors.accent;  
        if (document.getElementById('customBgColor')) document.getElementById('customBgColor').value = colors.bg;  
        if (document.getElementById('customTextColor')) document.getElementById('customTextColor').value = colors.text;  
        if (document.getElementById('customCardColor')) document.getElementById('customCardColor').value = colors.card;  
          
        // تطبيق الألوان المحفوظة  
        document.documentElement.style.setProperty('--primary-color', colors.primary);  
        document.documentElement.style.setProperty('--secondary-color', colors.secondary);  
        document.documentElement.style.setProperty('--accent-color', colors.accent);  
        document.documentElement.style.setProperty('--bg-color', colors.bg);  
        document.documentElement.style.setProperty('--text-color', colors.text);  
        document.documentElement.style.setProperty('--card-color', colors.card);  
          
        document.body.style.background = `linear-gradient(-45deg, ${colors.bg}, ${colors.secondary}, ${colors.primary})`;  
        document.body.style.backgroundSize = '400% 400%';  
        document.body.style.animation = 'gradientBG 15s ease infinite';  
      } catch(e) {}  
    }  
  }  
    
  // تحميل الثيم المحفوظ عند بدء الصفحة  
  (function loadSavedTheme() {  
    const savedTheme = localStorage.getItem('finoTheme');  
    if (savedTheme && themeColors[savedTheme]) {  
      document.body.classList.add('theme-' + savedTheme);  
      document.body.style.background = themeColors[savedTheme];  
      document.body.style.backgroundSize = '400% 400%';  
      document.body.style.animation = 'gradientBG 15s ease infinite';  
    }  
  })();  
    
  // ====== نظام إدارة الواجهات والصور ======  
  const INTERFACE_IMAGES_KEY = 'finoInterfaceImages';  
    
  function previewInterfaceImage(type) {  
    const input = document.getElementById(type + 'ImageUpload');  
    const preview = document.getElementById(type + 'Preview');  
    const previewImg = document.getElementById(type + 'PreviewImg');  
      
    if (input.files && input.files[0]) {  
      const reader = new FileReader();  
      reader.onload = function(e) {  
        previewImg.src = e.target.result;  
        preview.style.display = 'flex';  
        preview.style.alignItems = 'center';  
        preview.style.gap = '10px';  
      };  
      reader.readAsDataURL(input.files[0]);  
    }  
  }  
    
  function removeInterfaceImage(type) {  
    const input = document.getElementById(type + 'ImageUpload');  
    const preview = document.getElementById(type + 'Preview');  
      
    if (input) input.value = '';  
    if (preview) preview.style.display = 'none';  
      
    // حذف من التخزين  
    const images = loadInterfaceImages();  
    delete images[type];  
    localStorage.setItem(INTERFACE_IMAGES_KEY, JSON.stringify(images));  
      
    // إزالة الصورة من الواجهة  
    applyInterfaceImage(type, null);  
    showToast('تم حذف الصورة بنجاح');  
  }  
    
  function saveInterfaceImages() {  
    const images = loadInterfaceImages();  
    const types = ['splash', 'logo', 'homeBg', 'resultBg'];  
    let savedCount = 0;  
    let totalToSave = 0;  
      
    // حساب عدد الصور المراد حفظها  
    types.forEach(type => {  
      const input = document.getElementById(type + 'ImageUpload');  
      if (input && input.files && input.files[0]) {  
        totalToSave++;  
      }  
    });  
      
    if (totalToSave === 0) {  
      showToast('لا توجد صور جديدة لحفظها', 'warning');  
      return;  
    }  
      
    // دالة لحفظ صورة واحدة  
    function saveOneImage(type) {  
      const input = document.getElementById(type + 'ImageUpload');  
      const typeSelect = document.getElementById(type + 'ImageType');  
        
      if (!input || !input.files || !input.files[0]) return;  
        
      const file = input.files[0];  
      const reader = new FileReader();  
        
      reader.onload = function(e) {  
        images[type] = {  
          data: e.target.result,  
          type: typeSelect ? typeSelect.value : 'static',  
          name: file.name  
        };  
          
        try {  
          localStorage.setItem(INTERFACE_IMAGES_KEY, JSON.stringify(images));  
          console.log(`تم حفظ ${type}:`, file.name);  
          applyInterfaceImage(type, images[type]);  
          savedCount++;  
            
          if (savedCount === totalToSave) {  
            showToast(`تم حفظ ${savedCount} صورة بنجاح! 🎨`);  
          }  
        } catch (err) {  
          console.error('خطأ في الحفظ:', err);  
          showToast(`خطأ في حفظ ${type} - الصورة كبيرة`, 'error');  
        }  
      };  
        
      reader.onerror = function() {  
        showToast(`خطأ في قراءة ${type}`, 'error');  
      };  
        
      reader.readAsDataURL(file);  
    }  
      
    // حفظ كل الصور  
    types.forEach(type => saveOneImage(type));  
  }  
    
  function loadInterfaceImages() {  
    try {  
      const data = localStorage.getItem(INTERFACE_IMAGES_KEY);  
      return data ? JSON.parse(data) : {};  
    } catch (e) {  
      return {};  
    }  
  }  
    
  function applyInterfaceImage(type, imageData) {  
    if (!imageData) {  
      // إعادة الافتراضي  
      if (type === 'splash') {  
        const splashImg = document.querySelector('#splashScreen img');  
        if (splashImg) splashImg.src = 'data:image/svg+xml,...'; // الصورة الافتراضية  
      } else if (type === 'logo') {  
        // إعادة الشعار الافتراضي  
      } else if (type === 'homeBg') {  
        const landingPage = document.getElementById('landingPage');  
        if (landingPage) landingPage.style.backgroundImage = '';  
      } else if (type === 'resultBg') {  
        const resultPage = document.getElementById('resultPage');  
        if (resultPage) resultPage.style.backgroundImage = '';  
      }  
      return;  
    }  
      
    if (type === 'splash') {  
      const splashImg = document.querySelector('#splashScreen img');  
      if (splashImg) splashImg.src = imageData.data;  
    } else if (type === 'logo') {  
      // تطبيق الشعار الجديد  
      document.querySelectorAll('.logo-img').forEach(img => {  
        img.src = imageData.data;  
      });  
    } else if (type === 'homeBg') {  
      // تم تعطيل تحميل صورة الصفحة الرئيسية - استخدم الخلفية العامة بدلاً منها  
      console.log('homeBg disabled - use global background instead');  
    } else if (type === 'resultBg') {  
      const resultPage = document.getElementById('resultPage');  
      if (resultPage) {  
        resultPage.style.backgroundImage = `url(${imageData.data})`;  
        resultPage.style.backgroundSize = 'cover';  
        resultPage.style.backgroundPosition = 'center';  
        resultPage.style.backgroundRepeat = 'no-repeat';  
        console.log('Applied resultBg to resultPage');  
      } else {  
        console.error('resultPage not found!');  
      }  
    }  
  }  
    
  function resetInterfaceImages() {  
    if (confirm('هل أنت متأكد من إعادة تعيين جميع الواجهات للافتراضي؟')) {  
      localStorage.removeItem(INTERFACE_IMAGES_KEY);  
        
      // إخفاء المعاينات  
      ['splash', 'logo', 'homeBg', 'resultBg'].forEach(type => {  
        const preview = document.getElementById(type + 'Preview');  
        const input = document.getElementById(type + 'ImageUpload');  
        if (preview) preview.style.display = 'none';  
        if (input) input.value = '';  
        applyInterfaceImage(type, null);  
      });  
        
      showToast('تم إعادة تعيين الواجهات للافتراضي! 🔄');  
    }  
  }  
    
  function loadSavedInterfaceImages() {  
    console.log('loadSavedInterfaceImages called');  
    const images = loadInterfaceImages();  
    console.log('Loaded images:', Object.keys(images));  
      
    Object.keys(images).forEach(type => {  
      console.log('Applying image type:', type);  
      applyInterfaceImage(type, images[type]);  
        
      // عرض المعاينة إذا موجودة  
      const preview = document.getElementById(type + 'Preview');  
      const previewImg = document.getElementById(type + 'PreviewImg');  
      if (preview && previewImg && images[type]) {  
        previewImg.src = images[type].data;  
        preview.style.display = 'flex';  
        preview.style.alignItems = 'center';  
        preview.style.gap = '10px';  
      }  
    });  
      
    // تطبيق الخلفية العامة من إعدادات المنصة  
    const settings = loadPlatformSettings();  
    if (settings && typeof applyGlobalBackground === 'function') {  
      applyGlobalBackground(settings);  
    }  
      
    console.log('loadSavedInterfaceImages completed');  
  }  
    
  // ====== نظام الخلفيات الموسمية ======  
  const seasons = {  
    winter: { class: 'season-winter', particles: ['❄️', '❅', '❆'] },  
    spring: { class: 'season-spring', particles: ['🌸', '🌺', '🌷', '🌼'] },  
    summer: { class: 'season-summer', particles: ['☀️', '🌞', '✨'] },  
    autumn: { class: 'season-autumn', particles: ['🍂', '🍁', '🍃'] },  
    default: { class: '', particles: [] }  
  };  
    
  function applySeasonTheme(season) {  
    const body = document.body;  
      
    // إزالة المواسم السابقة  
    Object.values(seasons).forEach(s => {  
      if (s.class) body.classList.remove(s.class);  
    });  
      
    // إزالة الجزيئات القديمة  
    document.querySelectorAll('.season-particle').forEach(el => el.remove());  
      
    // تطبيق الموسم الجديد  
    const seasonData = seasons[season];  
    if (seasonData && seasonData.class) {  
      body.classList.add(seasonData.class);  
      createSeasonParticles(seasonData);  
    }  
      
    localStorage.setItem('finoSeasonTheme', season);  
  }  
    
  function createSeasonParticles(seasonData) {  
    if (!seasonData.particles.length) return;  
      
    const container = document.getElementById('particles') || document.body;  
      
    for (let i = 0; i < 20; i++) {  
      const particle = document.createElement('div');  
      particle.className = 'season-particle';  
      particle.style.cssText = `  
        position: fixed;  
        font-size: ${Math.random() * 1 + 0.8}em;  
        top: -50px;  
        left: ${Math.random() * 100}%;  
        z-index: 0;  
        pointer-events: none;  
        animation: snowfall ${Math.random() * 10 + 10}s linear infinite;  
        animation-delay: ${Math.random() * 10}s;  
        opacity: 0.7;  
      `;  
      particle.textContent = seasonData.particles[Math.floor(Math.random() * seasonData.particles.length)];  
      container.appendChild(particle);  
    }  
  }  
    
  // ====== نظام الإعلانات المستهدفة ======  
  const ADS_KEY = 'finoTargetedAds';  
    
  function loadTargetedAds() {  
    try {  
      const data = localStorage.getItem(ADS_KEY);  
      return data ? JSON.parse(data) : [];  
    } catch (e) {  
      return [];  
    }  
  }  
    
  function saveTargetedAds(ads) {  
    localStorage.setItem(ADS_KEY, JSON.stringify(ads));  
  }  
    
  function saveAd(event) {  
    event.preventDefault();  
      
    const ads = loadTargetedAds();  
    const editIndex = document.getElementById('adEditIndex').value;  
      
    const ad = {  
      id: editIndex ? ads[editIndex].id : 'ad_' + Date.now(),  
      title: document.getElementById('adTitle').value,  
      text: document.getElementById('adText').value,  
      targetType: document.getElementById('adTargetType').value,  
      targetMin: Number(document.getElementById('adTargetMin').value) || 0,  
      targetMax: Number(document.getElementById('adTargetMax').value) || 999999,  
      financeType: document.getElementById('adFinanceType').value,  
      bank: document.getElementById('adBank').value,  
      link: document.getElementById('adLink').value,  
      linkText: document.getElementById('adLinkText').value || 'تواصل معنا',  
      customMessage: document.getElementById('adCustomMessage')?.value || '',  
      messageType: document.getElementById('adMessageType')?.value || 'text',  
      videoUrl: document.getElementById('adVideoUrl')?.value || '',  
      enabled: document.getElementById('adEnabled').value === 'true'  
    };  
      
    if (editIndex !== '') {  
      ads[editIndex] = ad;  
    } else {  
      ads.push(ad);  
    }  
      
    saveTargetedAds(ads);  
    clearAdForm();  
    renderAdsTable();  
    alert('تم حفظ الإعلان.');  
  }  
    
  function clearAdForm() {  
    document.getElementById('adEditIndex').value = '';  
    document.getElementById('adTitle').value = '';  
    document.getElementById('adText').value = '';  
    document.getElementById('adTargetType').value = 'salary';  
    document.getElementById('adTargetMin').value = '';  
    document.getElementById('adTargetMax').value = '';  
    document.getElementById('adFinanceType').value = '';  
    document.getElementById('adBank').value = '';  
    document.getElementById('adLink').value = '';  
    document.getElementById('adLinkText').value = '';  
    if (document.getElementById('adCustomMessage')) document.getElementById('adCustomMessage').value = '';  
    if (document.getElementById('adMessageType')) document.getElementById('adMessageType').value = 'text';  
    if (document.getElementById('adVideoUrl')) document.getElementById('adVideoUrl').value = '';  
    document.getElementById('adEnabled').value = 'true';  
  }  
    
  function editAd(index) {  
    const ads = loadTargetedAds();  
    const ad = ads[index];  
    if (!ad) return;  
      
    document.getElementById('adEditIndex').value = index;  
    document.getElementById('adTitle').value = ad.title;  
    document.getElementById('adText').value = ad.text;  
    document.getElementById('adTargetType').value = ad.targetType;  
    document.getElementById('adTargetMin').value = ad.targetMin;  
    document.getElementById('adTargetMax').value = ad.targetMax;  
    document.getElementById('adFinanceType').value = ad.financeType || '';  
    document.getElementById('adBank').value = ad.bank || '';  
    document.getElementById('adLink').value = ad.link || '';  
    document.getElementById('adLinkText').value = ad.linkText || '';  
    if (document.getElementById('adCustomMessage')) document.getElementById('adCustomMessage').value = ad.customMessage || '';  
    if (document.getElementById('adMessageType')) document.getElementById('adMessageType').value = ad.messageType || 'text';  
    if (document.getElementById('adVideoUrl')) document.getElementById('adVideoUrl').value = ad.videoUrl || '';  
    document.getElementById('adEnabled').value = ad.enabled ? 'true' : 'false';  
  }  
    
  function deleteAd(index) {  
    if (!confirm('هل أنت متأكد من حذف هذا الإعلان؟')) return;  
      
    const ads = loadTargetedAds();  
    ads.splice(index, 1);  
    saveTargetedAds(ads);  
    renderAdsTable();  
  }  
    
  function toggleAdStatus(index) {  
    const ads = loadTargetedAds();  
    ads[index].enabled = !ads[index].enabled;  
    saveTargetedAds(ads);  
    renderAdsTable();  
  }  
    
  function renderAdsTable() {  
    const ads = loadTargetedAds();  
    const tbody = document.querySelector('#adsTable tbody');  
    if (!tbody) return;  
      
    tbody.innerHTML = ads.map((ad, i) => `  
      <tr>  
        <td>${ad.title}</td>  
        <td>${ad.targetType === 'salary' ? 'راتب' : 'مبلغ'}</td>  
        <td>${fmtMoney(ad.targetMin)} - ${fmtMoney(ad.targetMax)}</td>  
        <td><span style="color:${ad.enabled ? '#10b981' : '#ef4444'}">${ad.enabled ? 'مفعّل' : 'موقف'}</span></td>  
        <td>  
          <button class="question-btn question-btn-edit" onclick="editAd(${i})">تعديل</button>  
          <button class="question-btn question-btn-hide" onclick="toggleAdStatus(${i})">${ad.enabled ? 'إيقاف' : 'تفعيل'}</button>  
          <button class="question-btn question-btn-delete" onclick="deleteAd(${i})">حذف</button>  
        </td>  
      </tr>  
    `).join('');  
  }  
    
  function getMatchingAds(salary, amount, financeType, bank) {  
    const ads = loadTargetedAds();  
      
    return ads.filter(ad => {  
      if (!ad.enabled) return false;  
        
      if (ad.targetType === 'salary') {  
        if (salary < ad.targetMin || salary > ad.targetMax) return false;  
      }  
        
      if (ad.targetType === 'amount') {  
        if (amount < ad.targetMin || amount > ad.targetMax) return false;  
      }  
        
      if (ad.financeType && financeType && ad.financeType !== financeType) return false;  
      if (ad.bank && bank && !bank.includes(ad.bank)) return false;  
        
      return true;  
    });  
  }  
    
  // ====== نظام إدارة الأسئلة ======  
  const QUESTIONS_KEY = 'finoCustomQuestions';  
    
  function loadCustomQuestions() {  
    try {  
      const data = localStorage.getItem(QUESTIONS_KEY);  
      return data ? JSON.parse(data) : { hidden: [], labels: {}, order: [] };  
    } catch (e) {  
      return { hidden: [], labels: {}, order: [] };  
    }  
  }  
    
  function saveCustomQuestions(data) {  
    localStorage.setItem(QUESTIONS_KEY, JSON.stringify(data));  
  }
  
  // ====== نظام التحكم في تفعيل/إيقاف الأسئلة لكل منتج ======
  const QUESTION_SETTINGS_KEY = 'finoQuestionSettings';
  
  // المنتجات المتاحة
  const AVAILABLE_PRODUCTS = [
    'تمويل شخصي',
    'تمويل عقاري',
    'تمويل التأجيري',
    'تمويل استهلاكي',
    'شراء مديونية تمويل شخصي',
    'شراء مديونية تمويل عقاري'
  ];
  
  // الأسئلة القابلة للتحكم
  const CONTROLLABLE_QUESTIONS = [
    { id: 'wantSpecificAmount', label: 'هل تريد تمويل محدد؟', defaultEnabled: true },
    { id: 'downPayment', label: 'كم الدفعة التي تملكها؟', defaultEnabled: true },
    { id: 'mortgageAmount', label: 'كم الرهن؟', defaultEnabled: true },
    { id: 'hasCommitments', label: 'هل لديك التزامات؟', defaultEnabled: true },
    { id: 'wantFlexibleInstallment', label: 'هل ترغب في القسط المرن؟', defaultEnabled: true },
    { id: 'extendAfterRetirement', label: 'هل ترغب بالتمديد بعد التقاعد؟', defaultEnabled: true },
    { id: 'militaryRank', label: 'الرتبة العسكرية', defaultEnabled: true },
    { id: 'employer', label: 'جهة العمل', defaultEnabled: true }
  ];
  
  // تحميل إعدادات الأسئلة
  function loadQuestionSettings() {
    try {
      const data = localStorage.getItem(QUESTION_SETTINGS_KEY);
      if (data) {
        return JSON.parse(data);
      }
    } catch (e) {
      console.error('خطأ في تحميل إعدادات الأسئلة:', e);
    }
    // الإعدادات الافتراضية - جميع الأسئلة مفعلة لجميع المنتجات
    const defaultSettings = {};
    CONTROLLABLE_QUESTIONS.forEach(q => {
      defaultSettings[q.id] = {
        enabledForAll: q.defaultEnabled,
        enabledProducts: [] // فارغة يعني كل المنتجات إذا enabledForAll = true
      };
    });
    return defaultSettings;
  }
  
  // حفظ إعدادات الأسئلة
  function saveQuestionSettings(settings) {
    localStorage.setItem(QUESTION_SETTINGS_KEY, JSON.stringify(settings));
    console.log('تم حفظ إعدادات الأسئلة:', settings);
  }
  
  // فحص إذا كان السؤال مفعلاً لمنتج معين
  function isQuestionEnabledForProduct(questionId, productName) {
    const settings = loadQuestionSettings();
    const questionSetting = settings[questionId];
    
    if (!questionSetting) {
      // السؤال غير موجود في الإعدادات - افتراضياً مفعل
      return true;
    }
    
    // إذا كان مفعلاً لكل المنتجات
    if (questionSetting.enabledForAll) {
      return true;
    }
    
    // إذا كان مفعلاً لمنتجات محددة
    if (questionSetting.enabledProducts && questionSetting.enabledProducts.length > 0) {
      return questionSetting.enabledProducts.includes(productName);
    }
    
    // غير مفعل
    return false;
  }
  
  // دالة مخصصة لسؤال التمويل المحدد
  function isSpecificAmountEnabledForProduct(productName) {
    return isQuestionEnabledForProduct('wantSpecificAmount', productName);
  }
  
  // عرض سؤال التمويل المحدد
  
  // دالة حساب الحد الأقصى للتمويل للعرض في سؤال التمويل المحدد
  function calculateMaxFinanceForDisplay() {
    const salary = parseFloat(answers.salary) || 0;
    const months = parseInt(answers.months) || 60;
    const financeType = answers.financeType || '';
    
    // الحصول على النسبة من البنك المرشح أو المختار
    let margin = 5; // نسبة افتراضية
    
    // إذا كان هناك بنك مرشح مختار، استخدم نسبته
    if (answers.recommendedBank && answers.recommendedBank.margin) {
      margin = parseFloat(answers.recommendedBank.margin);
    } else if (answers.profitMargin) {
      margin = parseFloat(answers.profitMargin);
    } else if (answers.calcMode === 'ترشيح بنك مناسب تلقائياً') {
      // الحصول على أفضل بنك مطابق
      const matchingBanks = getMatchingBanksForAnswers();
      if (matchingBanks && matchingBanks.length > 0) {
        margin = parseFloat(matchingBanks[0].margin);
        // حفظ البنك المرشح لاستخدامه لاحقاً
        answers.recommendedBank = matchingBanks[0];
        answers.profitMargin = margin;
      }
    }
    
    // نسبة الاستقطاع حسب نوع التمويل
    let dbr = 0.33; // التمويل الشخصي
    if (financeType.includes('عقاري')) {
      dbr = 0.55; // التمويل العقاري
    }
    
    // خصم الالتزامات الحالية
    let totalCommitments = 0;
    if (answers.commitments && answers.commitments.length > 0) {
      answers.commitments.forEach(c => {
        totalCommitments += parseFloat(c.installment) || 0;
      });
    }
    
    // القسط الشهري المتاح
    const availableInstallment = (salary * dbr) - totalCommitments;
    if (availableInstallment <= 0) return 0;
    
    // حساب الحد الأقصى باستخدام معادلة APR الهرمي
    const monthlyRate = margin / 100 / 12;
    if (monthlyRate === 0) return availableInstallment * months;
    
    // PV = PMT * [(1 - (1+r)^-n) / r]
    const maxFinance = availableInstallment * ((1 - Math.pow(1 + monthlyRate, -months)) / monthlyRate);
    
    return Math.max(0, maxFinance);
  }

function showSpecificAmountQuestion() {
    const div = document.getElementById('question');
    document.getElementById('nextButton').style.display = 'none';
    
    // حساب الحد الأقصى للتمويل
    const maxFinance = calculateMaxFinanceForDisplay();
    const formattedMax = maxFinance.toLocaleString('ar-SA', {maximumFractionDigits: 0});
    
    // حفظ المبلغ الأقصى لاستخدامه لاحقاً
    window._maxFinanceForConfirm = maxFinance;
    
    div.innerHTML = `
      <div class="question-card fade-in" style="text-align:center;">
        <h3 style="color:#1e293b; margin-bottom:20px;">💵 هل تريد تمويل محدد؟</h3>
        <div style="background:linear-gradient(135deg, #10b981 0%, #059669 100%); color:#fff; padding:20px; border-radius:16px; margin-bottom:20px; box-shadow:0 4px 15px rgba(16,185,129,0.3);">
          <p style="font-size:14px; margin-bottom:8px; opacity:0.9;">الحد الأقصى للتمويل المتاح لك</p>
          <p style="font-size:32px; font-weight:bold; margin:0;">${formattedMax} ريال</p>
        </div>
        <p style="color:#64748b; font-size:14px; margin-bottom:20px;">يمكنك تحديد مبلغ تمويل أقل من الحد الأقصى الممنوح لك أو اختيار تأكيد للحصول على المبلغ الأقصى</p>
        <div style="display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">
          <button onclick="handleSpecificAmountAnswer('no')" style="background:#6b7280; color:#fff; border:none; padding:15px 30px; border-radius:12px; font-size:16px; font-weight:bold; cursor:pointer; min-width:100px;">لا</button>
          <button onclick="handleSpecificAmountAnswer('yes')" style="background:#3b82f6; color:#fff; border:none; padding:15px 30px; border-radius:12px; font-size:16px; font-weight:bold; cursor:pointer; min-width:100px;">نعم (تحديد مبلغ)</button>
          <button onclick="handleSpecificAmountAnswer('confirm')" style="background:#10b981; color:#fff; border:none; padding:15px 30px; border-radius:12px; font-size:16px; font-weight:bold; cursor:pointer; min-width:100px;">✅ تأكيد (المبلغ الأقصى)</button>
        </div>
      </div>
    `;
  }
  
  // معالجة إجابة سؤال التمويل المحدد
  function handleSpecificAmountAnswer(answer) {
    if (answer === 'no' || answer === 'لا') {
      // المستخدم لا يريد تمويل محدد - انتقل للنتيجة
      answers.wantSpecificAmount = 'لا';
      document.getElementById('nextButton').style.display = 'none';
      calculate();
    } else if (answer === 'confirm' || answer === 'تأكيد') {
      // المستخدم يريد المبلغ الأقصى - استخدم المبلغ الأقصى وانتقل للنتيجة
      answers.wantSpecificAmount = 'نعم';
      answers.specificFinanceAmount = window._maxFinanceForConfirm || calculateMaxFinanceForDisplay();
      answers._specificAmountApproved = true;
      document.getElementById('nextButton').style.display = 'none';
      calculate();
    } else {
      // المستخدم يريد تحديد مبلغ مخصص
      answers.wantSpecificAmount = 'نعم';
      showSpecificAmountInput();
    }
  }
  
  // عرض حقل إدخال مبلغ التمويل المحدد
  function showSpecificAmountInput() {
    const div = document.getElementById('question');
    
    div.innerHTML = `
      <div class="question-card fade-in" style="text-align:center;">
        <h3 style="color:#1e293b; margin-bottom:20px;">💰 أدخل مبلغ التمويل الذي تريده</h3>
        <p style="color:#64748b; font-size:14px; margin-bottom:20px;">أدخل المبلغ بالريال السعودي</p>
        <div style="margin-bottom:20px;">
          <input type="number" id="specificAmountInput" placeholder="مثال: 500000" 
            style="width:100%; max-width:300px; padding:15px; border:2px solid #e2e8f0; border-radius:12px; font-size:18px; text-align:center; direction:ltr;"
            oninput="formatSpecificAmount(this)">
          <div id="specificAmountError" style="color:#ef4444; font-size:13px; margin-top:10px; display:none;"></div>
        </div>
        <button onclick="confirmSpecificAmount()" style="background:#22c55e; color:#fff; border:none; padding:15px 50px; border-radius:12px; font-size:18px; font-weight:bold; cursor:pointer; box-shadow:0 4px 15px rgba(34,197,94,0.4);">
          ✅ بالتأكيد
        </button>
      </div>
    `;
  }
  
  // تنسيق مبلغ التمويل
  function formatSpecificAmount(input) {
    // إزالة الأحرف غير الرقمية
    let value = input.value.replace(/[^0-9]/g, '');
    input.value = value;
  }
  
  // تأكيد مبلغ التمويل المحدد
  function confirmSpecificAmount() {
    const input = document.getElementById('specificAmountInput');
    const errorDiv = document.getElementById('specificAmountError');
    const amount = parseFloat(input.value);
    
    if (!amount || amount <= 0) {
      errorDiv.textContent = 'يرجى إدخال مبلغ صحيح';
      errorDiv.style.display = 'block';
      return;
    }
    
    // حفظ المبلغ المحدد
    answers.specificFinanceAmount = amount;
    answers._specificAmountApproved = true;
    
    // الانتقال للنتيجة فوراً
    document.getElementById('nextButton').style.display = 'none';
    calculate();
  }
  
  // ====== إعدادات سؤال التمويل المحدد (قديم - للتوافق) ======
  const SPECIFIC_AMOUNT_KEY = 'finoSpecificAmountVisibility';
  
  function loadSpecificAmountVisibility() {
    try {
      const data = localStorage.getItem(SPECIFIC_AMOUNT_KEY);
      return data ? data : 'show'; // الافتراضي ظاهر
    } catch (e) {
      return 'show';
    }
  }
  
  function saveSpecificAmountVisibility() {
    const select = document.getElementById('specificAmountQuestionVisibility');
    if (select) {
      localStorage.setItem(SPECIFIC_AMOUNT_KEY, select.value);
      console.log('تم حفظ حالة سؤال التمويل المحدد:', select.value);
    }
  }
  
  function initSpecificAmountVisibility() {
    const select = document.getElementById('specificAmountQuestionVisibility');
    if (select) {
      select.value = loadSpecificAmountVisibility();
    }
  }
  
  function isSpecificAmountQuestionVisible() {
    return loadSpecificAmountVisibility() === 'show';
  }
  
  // ====== واجهة المسؤول للتحكم في الأسئلة ======
  function renderQuestionSettingsUI() {
    const container = document.getElementById('questionSettingsContainer');
    if (!container) return;
    
    const settings = loadQuestionSettings();
    
    let html = '';
    CONTROLLABLE_QUESTIONS.forEach(q => {
      const qSetting = settings[q.id] || { enabledForAll: true, enabledProducts: [] };
      const isEnabled = qSetting.enabledForAll || (qSetting.enabledProducts && qSetting.enabledProducts.length > 0);
      
      html += `
        <div style="background:#fff; padding:12px; border-radius:10px; border:1px solid #e2e8f0;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span style="font-weight:bold; color:#1e293b;">${q.label}</span>
            <select id="qSetting_${q.id}_mode" onchange="toggleQuestionProducts('${q.id}')" style="padding:8px 15px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;">
              <option value="all" ${qSetting.enabledForAll ? 'selected' : ''}>✅ مفعل لكل المنتجات</option>
              <option value="specific" ${!qSetting.enabledForAll && qSetting.enabledProducts && qSetting.enabledProducts.length > 0 ? 'selected' : ''}>🎯 مفعل لمنتجات محددة</option>
              <option value="disabled" ${!qSetting.enabledForAll && (!qSetting.enabledProducts || qSetting.enabledProducts.length === 0) ? 'selected' : ''}>❌ موقف لكل المنتجات</option>
            </select>
          </div>
          <div id="qProducts_${q.id}" style="display:${!qSetting.enabledForAll && qSetting.enabledProducts && qSetting.enabledProducts.length > 0 ? 'block' : 'none'}; margin-top:10px; padding:10px; background:#f8fafc; border-radius:8px;">
            <div style="font-size:12px; color:#64748b; margin-bottom:8px;">اختر المنتجات:</div>
            <div style="display:flex; flex-wrap:wrap; gap:8px;">
              ${AVAILABLE_PRODUCTS.map(p => `
                <label style="display:flex; align-items:center; gap:5px; background:#fff; padding:6px 10px; border-radius:6px; border:1px solid #e2e8f0; cursor:pointer; font-size:12px;">
                  <input type="checkbox" id="qProd_${q.id}_${p.replace(/\s/g, '_')}" 
                    ${qSetting.enabledProducts && qSetting.enabledProducts.includes(p) ? 'checked' : ''}
                    style="cursor:pointer;">
                  ${p}
                </label>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = html;
  }
  
  // إظهار/إخفاء قائمة المنتجات حسب الاختيار
  function toggleQuestionProducts(questionId) {
    const modeSelect = document.getElementById(`qSetting_${questionId}_mode`);
    const productsDiv = document.getElementById(`qProducts_${questionId}`);
    
    if (modeSelect && productsDiv) {
      productsDiv.style.display = modeSelect.value === 'specific' ? 'block' : 'none';
    }
  }
  
  // حفظ جميع إعدادات الأسئلة
  function saveAllQuestionSettings() {
    const settings = {};
    
    CONTROLLABLE_QUESTIONS.forEach(q => {
      const modeSelect = document.getElementById(`qSetting_${q.id}_mode`);
      if (!modeSelect) return;
      
      const mode = modeSelect.value;
      
      if (mode === 'all') {
        settings[q.id] = { enabledForAll: true, enabledProducts: [] };
      } else if (mode === 'disabled') {
        settings[q.id] = { enabledForAll: false, enabledProducts: [] };
      } else {
        // منتجات محددة
        const enabledProducts = [];
        AVAILABLE_PRODUCTS.forEach(p => {
          const checkbox = document.getElementById(`qProd_${q.id}_${p.replace(/\s/g, '_')}`);
          if (checkbox && checkbox.checked) {
            enabledProducts.push(p);
          }
        });
        settings[q.id] = { enabledForAll: false, enabledProducts: enabledProducts };
      }
    });
    
    saveQuestionSettings(settings);
    
    if (typeof showToast === 'function') {
      showToast('تم حفظ إعدادات الأسئلة بنجاح', 'success');
    } else {
      alert('تم حفظ إعدادات الأسئلة بنجاح');
    }
  }
    
  function renderQuestionsList() {  
    const container = document.getElementById('questionsList');  
    if (!container) return;  
      
    const customQ = loadCustomQuestions();  
      
    // دمج الأسئلة العامة وأسئلة الالتزامات  
    const allQuestions = [  
      ...generalQuestions.map((q, i) => ({ ...q, originalIndex: i, category: 'general' })),  
      ...commitmentQuestions.map((q, i) => ({ ...q, originalIndex: i, category: 'commitment' }))  
    ];  
      
    let html = '<h4 style="margin-bottom:10px; color:#1f2937;">📋 الأسئلة الأساسية</h4>';  
      
    generalQuestions.forEach((q, i) => {  
      const isHidden = customQ.hidden.includes('general_' + i);  
      const customLabel = customQ.labels['general_' + i] || q.label;  
        
      html += `  
        <div class="question-item ${isHidden ? 'question-hidden' : ''}" data-index="general_${i}">  
          <span class="question-drag-handle">☰</span>  
          <span class="question-text">${i + 1}. ${customLabel}</span>  
          <div class="question-actions">  
            <button class="question-btn" onclick="moveQuestionUp('general', ${i})" style="padding:4px 8px; font-size:11px;" ${i === 0 ? 'disabled' : ''}>⬆️</button>  
            <button class="question-btn" onclick="moveQuestionDown('general', ${i})" style="padding:4px 8px; font-size:11px;" ${i === generalQuestions.length - 1 ? 'disabled' : ''}>⬇️</button>  
            <button class="question-btn question-btn-edit" onclick="editQuestionLabel('general_${i}')">تعديل</button>  
            <button class="question-btn question-btn-hide" onclick="toggleQuestionVisibility('general_${i}')">${isHidden ? 'إظهار' : 'إخفاء'}</button>  
          </div>  
        </div>  
      `;  
    });  
      
    html += '<h4 style="margin:20px 0 10px 0; color:#1f2937;">📋 أسئلة الالتزامات</h4>';  
      
    commitmentQuestions.forEach((q, i) => {  
      const isHidden = customQ.hidden.includes('commitment_' + i);  
      const customLabel = customQ.labels['commitment_' + i] || q.label;  
        
      html += `  
        <div class="question-item ${isHidden ? 'question-hidden' : ''}" data-index="commitment_${i}">  
          <span class="question-drag-handle">☰</span>  
          <span class="question-text">${i + 1}. ${customLabel}</span>  
          <div class="question-actions">  
            <button class="question-btn" onclick="moveQuestionUp('commitment', ${i})" style="padding:4px 8px; font-size:11px;" ${i === 0 ? 'disabled' : ''}>⬆️</button>  
            <button class="question-btn" onclick="moveQuestionDown('commitment', ${i})" style="padding:4px 8px; font-size:11px;" ${i === commitmentQuestions.length - 1 ? 'disabled' : ''}>⬇️</button>  
            <button class="question-btn question-btn-edit" onclick="editQuestionLabel('commitment_${i}')">تعديل</button>  
            <button class="question-btn question-btn-hide" onclick="toggleQuestionVisibility('commitment_${i}')">${isHidden ? 'إظهار' : 'إخفاء'}</button>  
          </div>  
        </div>  
      `;  
    });  
      
    container.innerHTML = html;  
  }  
    
  function editQuestionLabel(index) {  
    const customQ = loadCustomQuestions();  
      
    // تحديد السؤال الصحيح بناءً على الفهرس  
    let currentLabel;  
    if (typeof index === 'string' && index.startsWith('general_')) {  
      const i = parseInt(index.replace('general_', ''));  
      currentLabel = customQ.labels[index] || generalQuestions[i].label;  
    } else if (typeof index === 'string' && index.startsWith('commitment_')) {  
      const i = parseInt(index.replace('commitment_', ''));  
      currentLabel = customQ.labels[index] || commitmentQuestions[i].label;  
    } else {  
      currentLabel = customQ.labels[index] || '';  
    }  
    const newLabel = prompt('أدخل نص السؤال الجديد:', currentLabel);  
      
    if (newLabel && newLabel.trim()) {  
      customQ.labels[index] = newLabel.trim();  
      saveCustomQuestions(customQ);  
      renderQuestionsList();  
    }  
  }  
    
  function toggleQuestionVisibility(index) {  
    const customQ = loadCustomQuestions();  
      
    if (customQ.hidden.includes(index)) {  
      customQ.hidden = customQ.hidden.filter(i => i !== index);  
    } else {  
      customQ.hidden.push(index);  
    }  
      
    saveCustomQuestions(customQ);  
    renderQuestionsList();  
    showToast('تم حفظ التغييرات! ✅');  
  }  
    
  // دالة تحريك السؤال لأعلى  
  function moveQuestionUp(category, index) {  
    if (index <= 0) return;  
      
    const questions = category === 'general' ? generalQuestions : commitmentQuestions;  
      
    // تبديل السؤال مع السؤال الذي قبله  
    const temp = questions[index];  
    questions[index] = questions[index - 1];  
    questions[index - 1] = temp;  
      
    // حفظ الترتيب الجديد  
    saveQuestionsOrder(category, questions);  
    renderQuestionsList();  
    showToast('تم تحريك السؤال لأعلى ⬆️');  
  }  
    
  // دالة تحريك السؤال لأسفل  
  function moveQuestionDown(category, index) {  
    const questions = category === 'general' ? generalQuestions : commitmentQuestions;  
      
    if (index >= questions.length - 1) return;  
      
    // تبديل السؤال مع السؤال الذي بعده  
    const temp = questions[index];  
    questions[index] = questions[index + 1];  
    questions[index + 1] = temp;  
      
    // حفظ الترتيب الجديد  
    saveQuestionsOrder(category, questions);  
    renderQuestionsList();  
    showToast('تم تحريك السؤال لأسفل ⬇️');  
  }  
    
  // حفظ ترتيب الأسئلة  
  function saveQuestionsOrder(category, questions) {  
    const orderKey = category === 'general' ? 'finoGeneralQuestionsOrder' : 'finoCommitmentQuestionsOrder';  
    const order = questions.map(q => q.id);  
    localStorage.setItem(orderKey, JSON.stringify(order));  
  }  
    
  // ====== نظام الأسئلة المخصصة للمنتجات ======  
  const PRODUCT_QUESTIONS_KEY = 'finoProductQuestions';  
    
  function loadProductQuestions() {  
    try {  
      const data = localStorage.getItem(PRODUCT_QUESTIONS_KEY);  
      return data ? JSON.parse(data) : [];  
    } catch (e) {  
      return [];  
    }  
  }  
    
  function saveProductQuestions(data) {  
    localStorage.setItem(PRODUCT_QUESTIONS_KEY, JSON.stringify(data));  
  }  
    
  function toggleProductQuestionOptions() {  
    const type = document.getElementById('newProductQuestionType').value;  
    const optionsDiv = document.getElementById('productQuestionOptionsDiv');  
    if (optionsDiv) {  
      optionsDiv.style.display = type === 'select' ? 'block' : 'none';  
    }  
  }  
    
  function addProductQuestion() {  
    const text = document.getElementById('newProductQuestionText').value.trim();  
    const type = document.getElementById('newProductQuestionType').value;  
    const product = document.getElementById('newProductQuestionProduct').value;  
    const optionsInput = document.getElementById('newProductQuestionOptions').value;  
    const target = document.getElementById('newProductQuestionTarget')?.value || 'all';  
    const visibility = document.getElementById('newProductQuestionVisibility')?.value || 'show';  
    const showInResult = document.getElementById('newProductQuestionShowInResult')?.value || 'yes';  
    const jobType = document.getElementById('newProductQuestionJobType')?.value || 'all';  
      
    if (!text) {  
      showToast('يرجى إدخال نص السؤال', 'error');  
      return;  
    }  
      
    const questions = loadProductQuestions();  
    const newQuestion = {  
      id: 'pq_' + Date.now(),  
      text: text,  
      type: type,  
      product: product,  
      options: type === 'select' ? optionsInput.split(',').map(o => o.trim()).filter(o => o) : [],  
      target: target,  
      visibility: visibility,  
      showInResult: showInResult,  
      jobType: jobType,  
      enabled: visibility === 'show'  
    };  
      
    questions.push(newQuestion);  
    saveProductQuestions(questions);  
      
    // إعادة تعيين الحقول  
    document.getElementById('newProductQuestionText').value = '';  
    document.getElementById('newProductQuestionOptions').value = '';  
    if (document.getElementById('newProductQuestionTarget')) document.getElementById('newProductQuestionTarget').value = 'all';  
    if (document.getElementById('newProductQuestionVisibility')) document.getElementById('newProductQuestionVisibility').value = 'show';  
    if (document.getElementById('newProductQuestionShowInResult')) document.getElementById('newProductQuestionShowInResult').value = 'yes';  
    if (document.getElementById('newProductQuestionJobType')) document.getElementById('newProductQuestionJobType').value = 'all';  
      
    renderProductQuestionsList();  
    showToast('تم إضافة السؤال بنجاح! ✅');  
  }  
    
  // دالة تحميل جهات التمويل في القائمة المنسدلة للأسئلة  
  function loadFinanceEntitiesForQuestions() {  
    const select = document.getElementById('newProductQuestionTarget');  
    if (!select) return;  
      
    // قائمة كاملة بجميع البنوك وشركات التمويل  
    const allFinanceEntities = [  
      // البنوك المحلية  
      'البنك الأهلي السعودي', 'مصرف الراجحي', 'بنك الرياض', 'البنك السعودي الأول',  
      'البنك العربي الوطني', 'مصرف الإنماء', 'البنك السعودي الفرنسي',  
      'البنك السعودي للاستثمار', 'بنك البلاد', 'بنك الجزيرة', 'بنك الخليج الدولي',  
      'بنك ساب',  
      // البنوك الرقمية  
      'بنك STC', 'بنك D360', 'بنك فيجن',  
      // فروع البنوك الأجنبية  
      'بنك الإمارات دبي الوطني', 'بنك المشرق', 'بنك البحرين الوطني',  
      'البنك الأول (FAB)', 'بنك HSBC', 'بنك Citibank',  
      // شركات التمويل العقاري  
      'أملاك العالمية للتمويل', 'شركة دار التمليك', 'شركة سهل للتمويل',  
      'شركة مسار النمو للتمويل', 'شركة عبداللطيف جميل للتمويل العقاري',  
      'شركة بداية للتمويل', 'الشركة السعودية لإعادة التمويل العقاري',  
      // شركات التمويل الاستهلاكي والإيجار  
      'شركة النايفات للتمويل', 'شركة ينال للتمويل', 'شركة اليسر للإجارة والتمويل',  
      'شركة آجل للخدمات التمويلية', 'الشركة الوطنية للتمويل', 'شركة المرابحة المرنة للتمويل',  
      'شركة كرناف للتمويل', 'شركة الجاسرية للتمويل', 'شركة متاجر للتمويل',  
      'شركة تسهيل للتمويل', 'شركة السعودي الفرنسي للتأجير التمويلي',  
      'شركة الأولى للتمويل', 'شركة الجبر للتمويل', 'شركة موني للتمويل',  
      'شركة كوارا للتمويل', 'شركة إمكان للتمويل', 'شركة الأمثل للتمويل',  
      'شركة دويتشه الخليج للتمويل', 'شركة الراجحي للتمويل', 'شركة الأهلي للتمويل',  
      'شركة التسهيلات المالية', 'شركة رسن للتمويل', 'شركة لندو للتمويل',  
      // شركات التمويل الجماعي والتقنية المالية  
      'شركة فندينغ سوق للتمويل', 'شركة منافع للتمويل', 'شركة سلفة للتمويل',  
      'شركة تمارا للتمويل', 'شركة تابي للتمويل', 'شركة سبوتي للتمويل',  
      'شركة بوست باي للتمويل', 'شركة قسطها للتمويل', 'شركة حصيل للتمويل',  
      'شركة ليندا للتمويل', 'شركة فرصة للتمويل', 'شركة سكوبير للتمويل'  
    ];  
      
    // دمج البنوك المخزنة في bankConfigs مع القائمة الكاملة  
    const banksFromConfigs = [...new Set(bankConfigs.map(cfg => cfg.bankName))];  
    const uniqueBanks = [...new Set([...allFinanceEntities, ...banksFromConfigs])];  
      
    // إعادة بناء القائمة  
    select.innerHTML = '<option value="all">جميع الجهات</option>';  
    uniqueBanks.forEach(bank => {  
      select.innerHTML += `<option value="${bank}">${bank}</option>`;  
    });  
  }  
  
  // دالة تحميل المنتجات في القائمة المنسدلة للأسئلة  
  function loadProductsForQuestions() {  
    const select = document.getElementById('newProductQuestionProduct');  
    if (!select) return;  
      
    // الحصول على المنتجات الديناميكية  
    const products = (typeof loadDynamicProducts === 'function') ? loadDynamicProducts() : [];  
      
    // إعادة بناء القائمة  
    select.innerHTML = '<option value="all">جميع المنتجات</option>';  
      
    // إضافة المنتجات الافتراضية  
    const defaultProducts = ['تمويل شخصي', 'تمويل استهلاكي', 'تمويل تأجيري', 'تمويل عقاري', 'شراء مديونية'];  
      
    // دمج المنتجات الديناميكية مع الافتراضية  
    const productNames = products.map(p => p.name);  
    const allProducts = [...new Set([...defaultProducts, ...productNames])];  
      
    allProducts.forEach(name => {  
      select.innerHTML += `<option value="${name}">${name}</option>`;  
    });  
  }  
  
  function renderProductQuestionsList() {  
    const container = document.getElementById('productQuestionsList');  
    if (!container) return;  
      
    const questions = loadProductQuestions();  
      
    if (questions.length === 0) {  
      container.innerHTML = '<p style="color:#6b7280; font-size:13px; text-align:center;">لا توجد أسئلة مخصصة بعد</p>';  
      return;  
    }  
      
    let html = '';  
    questions.forEach((q, i) => {  
      const targetLabel = q.target === 'all' ? 'جميع الجهات' : q.target;  
      const showInResultLabel = q.showInResult === 'yes' ? '✅ تظهر في النتيجة' : '❌ لا تظهر';  
      const jobTypeLabel = q.jobType === 'all' || !q.jobType ? 'جميع الوظائف' : q.jobType;  
      html += `  
        <div class="question-item ${!q.enabled ? 'question-hidden' : ''}" style="margin-bottom:8px;">  
          <span class="question-text" style="flex:1;">  
            ${q.text}  
            <span style="font-size:11px; color:#6b7280; display:block;">  
              المنتج: ${q.product === 'all' ? 'الكل' : q.product} | النوع: ${q.type === 'text' ? 'نص' : q.type === 'number' ? 'رقم' : 'قائمة'}  
            </span>  
            <span style="font-size:11px; color:#3b82f6; display:block;">  
              🎯 المستهدف: ${targetLabel} | 👷 الوظيفة: ${jobTypeLabel} | ${showInResultLabel}  
            </span>  
          </span>  
          <div class="question-actions">  
            <button class="question-btn question-btn-edit" onclick="editProductQuestion(${i})">تعديل</button>  
            <button class="question-btn question-btn-hide" onclick="toggleProductQuestion(${i})">${q.enabled ? 'إخفاء' : 'إظهار'}</button>  
            <button class="question-btn question-btn-delete" onclick="deleteProductQuestion(${i})">حذف</button>  
          </div>  
        </div>  
      `;  
    });  
      
    container.innerHTML = html;  
  }  
    
  function editProductQuestion(index) {  
    const questions = loadProductQuestions();  
    const q = questions[index];  
      
    const newText = prompt('أدخل نص السؤال الجديد:', q.text);  
    if (newText && newText.trim()) {  
      questions[index].text = newText.trim();  
      saveProductQuestions(questions);  
      renderProductQuestionsList();  
      showToast('تم تعديل السؤال بنجاح! ✅');  
    }  
  }  
    
  function toggleProductQuestion(index) {  
    const questions = loadProductQuestions();  
    questions[index].enabled = !questions[index].enabled;  
    saveProductQuestions(questions);  
    renderProductQuestionsList();  
    showToast('تم حفظ التغييرات! ✅');  
  }  
    
  function deleteProductQuestion(index) {  
    if (confirm('هل أنت متأكد من حذف هذا السؤال؟')) {  
      const questions = loadProductQuestions();  
      questions.splice(index, 1);  
      saveProductQuestions(questions);  
      renderProductQuestionsList();  
      showToast('تم حذف السؤال! 🗑️');  
    }  
  }  
    
  // تحديث renderQuestionsList لعرض الأسئلة المخصصة أيضاً  
  const originalRenderQuestionsList = renderQuestionsList;  
  renderQuestionsList = function() {  
    originalRenderQuestionsList();  
    renderProductQuestionsList();  
  };  
    
  // ====== إعدادات المنصة ======  
  const PLATFORM_SETTINGS_KEY = 'finoPlatformSettings';  
    
  function loadPlatformSettings() {  
    try {  
      const data = localStorage.getItem(PLATFORM_SETTINGS_KEY);  
      return data ? JSON.parse(data) : getDefaultPlatformSettings();  
    } catch (e) {  
      return getDefaultPlatformSettings();  
    }  
  }  
    
  function getDefaultPlatformSettings() {  
    return {  
      platformName: 'منصة FINO',  
      platformSubtitle: 'منصة ذكية تحسب لك التمويل',  
      welcomeMessage: 'نورت المنصة يا {name}',  
      endDateMessage: 'الله يطول بعمرنا ويبارك لنا',  
      showWeather: false,  
      showSplash: true,  
      showRetirementFormula: false,  
      showEndDate: true,  
      bgAllPages: true,  
      globalImage: '',  
      cardTransparent: true  
    };  
  }  
    
  function savePlatformSettings(settings) {  
    localStorage.setItem(PLATFORM_SETTINGS_KEY, JSON.stringify(settings));  
  }  
    
  function loadPlatformSettingsToUI() {  
    const settings = loadPlatformSettings();  
      
    const el1 = document.getElementById('settingsPlatformName');  
    const el2 = document.getElementById('settingsPlatformSubtitle');  
    const el3 = document.getElementById('settingsWelcomeMessage');  
    const el4 = document.getElementById('settingsEndDateMessage');  
    const el5 = document.getElementById('settingsShowWeather');  
    const el6 = document.getElementById('settingsShowSplash');  
    const el7 = document.getElementById('settingsShowRetirementFormula');  
    const el8 = document.getElementById('settingsShowEndDate');  
    const el9 = document.getElementById('settingsShowEarlySettlement');  
    const el10 = document.getElementById('settingsSplashDuration');  
    const el11 = document.getElementById('settingsSplashImage');  
    const el12 = document.getElementById('settingsSplashVideo');  
    const el13 = document.getElementById('settingsGlobalImage');  
    const el14 = document.getElementById('settingsHomeImage');  
    const el15 = document.getElementById('settingsResultImage');  
    const el16 = document.getElementById('settingsCalcImage');  
    const el17 = document.getElementById('settingsEarlySettlementWarning');  
    const el18 = document.getElementById('settingsEarlySettlementFormula');  
    const el19 = document.getElementById('settingsShowEarlyWarning');  
      
    if (el1) el1.value = settings.platformName;  
    if (el2) el2.value = settings.platformSubtitle;  
    if (el3) el3.value = settings.welcomeMessage;  
    if (el4) el4.value = settings.endDateMessage;  
    if (el5) el5.checked = settings.showWeather;  
    if (el6) el6.checked = settings.showSplash;  
    if (el7) el7.checked = settings.showRetirementFormula;  
    if (el8) el8.checked = settings.showEndDate;  
    if (el9) el9.checked = settings.showEarlySettlement !== false;  
    if (el10) el10.value = settings.splashDuration || 2500;  
    if (el11) el11.value = settings.splashImage || '';  
    if (el12) el12.value = settings.splashVideo || '';  
    if (el13) el13.value = settings.globalImage || '';  
    if (el14) el14.value = settings.homeImage || '';  
    if (el15) el15.value = settings.resultImage || '';  
    if (el16) el16.value = settings.calcImage || '';  
      
    // تحميل إعداد الخلفية لكافة الصفحات  
    const elBgAllPages = document.getElementById('settingsBgAllPages');  
    if (elBgAllPages) elBgAllPages.checked = settings.bgAllPages || false;  
    if (el17) el17.value = settings.earlySettlementWarning || 'أكثر جهات التمويل يشترطون انتهاء سنتين من الأقساط للسماح بالسداد المبكر. راجع العقد.';  
    if (el18) el18.value = settings.earlySettlementFormula || 'أرباح سنتين + أرباح 3 أشهر (رسوم إدارية)';  
    if (el19) el19.checked = settings.showEarlyWarning !== false;  
      
    // تحميل إعدادات PWA والتسويق  
    const el20 = document.getElementById('settingsShowPWABanner');  
    const el21 = document.getElementById('settingsShowMarketing');  
    if (el20) el20.checked = settings.showPWABanner !== false;  
    if (el21) el21.checked = settings.showMarketing !== false;  
      
    // تطبيق الإعدادات  
    applyPlatformSettings(settings);  
      
    // تحميل قائمة أنواع الوظائف  
    renderJobTypesList();  
  }  
    
  function savePlatformSettingsFromUI() {  
    const settings = {  
      platformName: document.getElementById('settingsPlatformName')?.value || 'منصة FINO',  
      platformSubtitle: document.getElementById('settingsPlatformSubtitle')?.value || '',  
      welcomeMessage: document.getElementById('settingsWelcomeMessage')?.value || '',  
      endDateMessage: document.getElementById('settingsEndDateMessage')?.value || '',  
      showWeather: document.getElementById('settingsShowWeather')?.checked || false,  
      showSplash: document.getElementById('settingsShowSplash')?.checked || false,  
      showRetirementFormula: document.getElementById('settingsShowRetirementFormula')?.checked || false,  
      showEndDate: document.getElementById('settingsShowEndDate')?.checked || false,  
      showEarlySettlement: document.getElementById('settingsShowEarlySettlement')?.checked !== false,  
      showPWABanner: document.getElementById('settingsShowPWABanner')?.checked !== false,  
      showMarketing: document.getElementById('settingsShowMarketing')?.checked !== false,  
      // إعدادات شاشة البداية (بالثواني)  
      splashDuration: parseInt(document.getElementById('settingsSplashDuration')?.value) || 3,  
      splashImage: document.getElementById('settingsSplashImage')?.value || '',  
      splashVideo: document.getElementById('settingsSplashVideo')?.value || '',  
      // الصور المتحركة للصفحات  
      bgAllPages: document.getElementById('settingsBgAllPages')?.checked || false,  
      globalImage: document.getElementById('settingsGlobalImage')?.value || '',  
      homeImage: document.getElementById('settingsHomeImage')?.value || '',  
      resultImage: document.getElementById('settingsResultImage')?.value || '',  
      calcImage: document.getElementById('settingsCalcImage')?.value || '',  
      // إعدادات السداد المبكر  
      earlySettlementWarning: document.getElementById('settingsEarlySettlementWarning')?.value || '',  
      earlySettlementFormula: document.getElementById('settingsEarlySettlementFormula')?.value || '',  
      showEarlyWarning: document.getElementById('settingsShowEarlyWarning')?.checked !== false,  
      // إعدادات الصفحة الرئيسية الجديدة  
      showBestBadge: document.getElementById('settingsShowBestBadge')?.checked !== false,  
      bestBadgeText: document.getElementById('settingsBestBadgeText')?.value || 'الأفضل في المملكة',  
      showFeatures: document.getElementById('settingsShowFeatures')?.checked !== false,  
      feature1: document.getElementById('settingsFeature1')?.value || 'مقارنة البنوك',  
      feature2: document.getElementById('settingsFeature2')?.value || 'حساب دقيق',  
      feature3: document.getElementById('settingsFeature3')?.value || 'نتيجة فورية',  
      cardBgColor: document.getElementById('settingsCardBgColor')?.value || '#ffffff',  
      cardOpacity: parseInt(document.getElementById('settingsCardOpacity')?.value) || 95,  
      cardBlur: parseInt(document.getElementById('settingsCardBlur')?.value) || 10,  
      cardTransparent: document.getElementById('settingsCardTransparent')?.checked || false,
      // إعدادات الخط ولون النص
      textColor: document.getElementById('settingsTextColor')?.value || '#111827',
      secondaryTextColor: document.getElementById('settingsSecondaryTextColor')?.value || '#6b7280',
      fontFamily: document.getElementById('settingsFontFamily')?.value || "'Tajawal', sans-serif",
      fontSize: parseInt(document.getElementById('settingsFontSize')?.value) || 16,
      // إعدادات الخط من صفحة الثيمات
      fontMain: document.getElementById('fontMain')?.value || 'Tajawal',
      fontTitle: document.getElementById('fontTitle')?.value || 'Cairo'
    };  
      
    savePlatformSettings(settings);  
    applyPlatformSettings(settings);  
      
    // حفظ إعدادات شاشة البداية  
    saveSplashSettings({  
      enabled: settings.showSplash,  
      duration: settings.splashDuration,  
      customImage: settings.splashImage,  
      customVideo: settings.splashVideo  
    });  
      
    // إظهار رسالة تأكيد بصرية  
    showSaveConfirmation('✅ تم حفظ جميع الإعدادات بنجاح!', 'سيتم تطبيق التغييرات فوراً');  
  }  
    
  // دالة عرض رسالة تأكيد الحفظ بشكل بصري  
  function showSaveConfirmation(title, message) {  
    // إنشاء عنصر التأكيد  
    const overlay = document.createElement('div');  
    overlay.id = 'saveConfirmOverlay';  
    overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:99999; animation:fadeIn 0.3s;';  
      
    overlay.innerHTML = `  
      <div style="background:#fff; padding:30px 40px; border-radius:20px; text-align:center; animation:scaleIn 0.3s; max-width:90%;">  
        <div style="font-size:60px; margin-bottom:15px;">✅</div>  
        <h3 style="color:#28a745; margin-bottom:10px; font-size:20px;">${title}</h3>  
        <p style="color:#666; margin-bottom:20px;">${message}</p>  
        <button onclick="this.closest('#saveConfirmOverlay').remove()" style="background:linear-gradient(135deg, #28a745, #20c997); color:#fff; border:none; padding:12px 40px; border-radius:10px; font-size:16px; cursor:pointer;">حسناً</button>  
      </div>  
    `;  
      
    document.body.appendChild(overlay);  
      
    // إغلاق تلقائي بعد 3 ثواني  
    setTimeout(() => {  
      if (document.getElementById('saveConfirmOverlay')) {  
        document.getElementById('saveConfirmOverlay').remove();  
      }  
    }, 3000);  
  }  
    
  function applyPlatformSettings(settings) {  
    // تحديث اسم المنصة  
    const titleEl = document.getElementById('platformTitle');  
    if (titleEl && settings.platformName) {  
      titleEl.textContent = settings.platformName;  
    }  
      
    // تحديث عنوان الصفحة  
    if (settings.platformName) {  
      document.title = settings.platformName + ' - حاسبة التمويل الذكية';  
    }  
      
    // إخفاء/إظهار حاسبة السداد المبكر  
    const earlySettlementBtn = document.getElementById('earlySettlementBtn');  
    if (earlySettlementBtn) {  
      earlySettlementBtn.style.display = settings.showEarlySettlement !== false ? 'inline-flex' : 'none';  
    }  
      
    // تحديث تنبيه السداد المبكر للعقاري  
    const warningBox = document.getElementById('earlySettlementWarningBox');  
    const warningText = document.getElementById('earlySettlementWarningText');  
    const formulaText = document.getElementById('earlySettlementFormulaText');  
      
    if (warningBox) {  
      warningBox.style.display = settings.showEarlyWarning !== false ? 'block' : 'none';  
    }  
    if (warningText && settings.earlySettlementWarning) {  
      warningText.textContent = settings.earlySettlementWarning;  
    }  
    if (formulaText && settings.earlySettlementFormula) {  
      formulaText.textContent = settings.earlySettlementFormula;  
    }  
      
    // إخفاء/إظهار شعار PWA  
    const pwaBanner = document.getElementById('pwaInstallBanner');  
    if (pwaBanner) {  
      if (settings.showPWABanner === false) {  
        pwaBanner.style.display = 'none';  
      } else {  
        pwaBanner.style.display = 'block';  
      }  
    }  
      
    // إخفاء/إظهار قسم التسويق  
    const marketingSection = document.getElementById('marketingSection');  
    if (marketingSection) {  
      marketingSection.style.display = settings.showMarketing !== false ? 'block' : 'none';  
    }  
      
    // إعدادات الصفحة الرئيسية الجديدة  
    // وسام الأفضل في المملكة  
    const bestBadge = document.getElementById('bestBadge');  
    if (bestBadge) {  
      bestBadge.style.display = settings.showBestBadge !== false ? 'inline-flex' : 'none';  
      const badgeText = bestBadge.querySelector('span');  
      if (badgeText && settings.bestBadgeText) {  
        badgeText.textContent = settings.bestBadgeText;  
      }  
    }  
      
    // المميزات  
    const featuresContainer = document.getElementById('featuresContainer');  
    if (featuresContainer) {  
      featuresContainer.style.display = settings.showFeatures !== false ? 'flex' : 'none';  
    }  
    const feature1El = document.getElementById('feature1Text');  
    const feature2El = document.getElementById('feature2Text');  
    const feature3El = document.getElementById('feature3Text');  
    if (feature1El && settings.feature1) feature1El.textContent = settings.feature1;  
    if (feature2El && settings.feature2) feature2El.textContent = settings.feature2;  
    if (feature3El && settings.feature3) feature3El.textContent = settings.feature3;  
      
    // خلفية البطاقة الرئيسية - شفافة افتراضياً  
    const landingCard = document.querySelector('.landing-card');  
    if (landingCard) {  
      // افتراضياً شفاف تماماً إلا إذا تم تعيين قيمة أخرى  
      if (settings.cardTransparent !== false) {  
        landingCard.style.background = 'transparent';  
        landingCard.style.backdropFilter = 'none';  
        landingCard.style.boxShadow = 'none';  
      } else {  
        const opacity = (settings.cardOpacity || 0) / 100;  
        const color = settings.cardBgColor || '#ffffff';  
        const r = parseInt(color.slice(1,3), 16);  
        const g = parseInt(color.slice(3,5), 16);  
        const b = parseInt(color.slice(5,7), 16);  
        landingCard.style.background = `rgba(${r}, ${g}, ${b}, ${opacity})`;  
        landingCard.style.backdropFilter = `blur(${settings.cardBlur || 0}px)`;  
      }  
    }  
      
    // تطبيق الخلفية العامة على كامل الصفحة  
    applyGlobalBackground(settings);
    
    // تطبيق إعدادات الخط ولون النص
    if (settings.textColor) {
      document.documentElement.style.setProperty('--text-color', settings.textColor);
      document.body.style.color = settings.textColor;
    }
    if (settings.secondaryTextColor) {
      document.documentElement.style.setProperty('--secondary-text-color', settings.secondaryTextColor);
    }
    if (settings.fontFamily) {
      document.documentElement.style.setProperty('--font-family', settings.fontFamily);
      document.body.style.fontFamily = settings.fontFamily;
    }
    if (settings.fontSize) {
      document.documentElement.style.setProperty('--font-size', settings.fontSize + 'px');
      document.body.style.fontSize = settings.fontSize + 'px';
    }
    if (settings.fontMain) {
      document.documentElement.style.setProperty('--font-main', `'${settings.fontMain}', sans-serif`);
    }
    if (settings.fontTitle) {
      document.documentElement.style.setProperty('--font-title', `'${settings.fontTitle}', sans-serif`);
    }
  }  
    
  // دالة تطبيق الخلفية العامة على كامل الصفحة  
  function applyGlobalBackground(settings) {  
    const globalImage = settings?.globalImage || '';  
    const bgAllPages = settings?.bgAllPages || false;  
      
    console.log('جاري تطبيق الخلفية العامة:', { globalImage, bgAllPages });  
      
    // إزالة الخلفية السابقة  
    document.body.classList.remove('has-global-bg');  
    document.body.style.removeProperty('--global-bg-image');  
    document.body.style.backgroundImage = '';  
      
    // إذا كان هناك صورة عامة وتم تفعيل الخيار  
    if (globalImage && bgAllPages) {  
      document.body.style.setProperty('--global-bg-image', `url(${globalImage})`);  
      document.body.style.backgroundImage = `url(${globalImage})`;  
      document.body.style.backgroundSize = 'cover';  
      document.body.style.backgroundPosition = 'center';  
      document.body.style.backgroundRepeat = 'no-repeat';  
      document.body.style.backgroundAttachment = 'fixed';  
      document.body.classList.add('has-global-bg');  
      console.log('✅ تم تطبيق الخلفية العامة على كافة الصفحات:', globalImage);  
    } else if (globalImage && !bgAllPages) {  
      // إذا كانت الصورة موجودة لكن الخيار غير مفعل، طبقها على الصفحة الرئيسية فقط  
      const landingPage = document.getElementById('landingPage');  
      if (landingPage) {  
        landingPage.style.backgroundImage = `url(${globalImage})`;  
        landingPage.style.backgroundSize = 'cover';  
        landingPage.style.backgroundPosition = 'center';  
      }  
      console.log('✅ تم تطبيق الخلفية على الصفحة الرئيسية فقط:', globalImage);  
    } else {  
      console.log('ℹ️ لا توجد خلفية عامة للتطبيق');  
    }  
  }  
    
  // ====== دوال التحكم بالنصوص والبطاقات ======  
  function updateTextStyles() {  
    const textColor = document.getElementById('settingsTextColor')?.value || '#111827';  
    const secondaryColor = document.getElementById('settingsSecondaryTextColor')?.value || '#6b7280';  
    const fontFamily = document.getElementById('settingsFontFamily')?.value || "'Tajawal', sans-serif";  
    const fontSize = document.getElementById('settingsFontSize')?.value || '16';  
      
    document.documentElement.style.setProperty('--text-color', textColor);  
    document.documentElement.style.setProperty('--secondary-text-color', secondaryColor);  
    document.documentElement.style.setProperty('--font-family', fontFamily);  
    document.documentElement.style.setProperty('--font-size', fontSize + 'px');  
      
    document.body.style.color = textColor;  
    document.body.style.fontFamily = fontFamily;  
    document.body.style.fontSize = fontSize + 'px';  
      
    // تحديث عرض القيمة  
    const fontSizeValue = document.getElementById('fontSizeValue');  
    if (fontSizeValue) fontSizeValue.textContent = fontSize + 'px';  
      
    savePlatformSettingsFromUI();  
  }  
    
  function toggleCardsVisibility() {  
    const hideCards = document.getElementById('settingsHideCards')?.checked || false;  
    if (hideCards) {  
      document.body.classList.add('hide-cards');  
    } else {  
      document.body.classList.remove('hide-cards');  
    }  
    savePlatformSettingsFromUI();  
  }  
    
  // ====== إدارة عناصر صفحة النتيجة ======  
  const RESULT_ELEMENTS_KEY = 'finoResultElements';  
    
  function saveResultElementsSettings() {  
    const settings = {  
      showType: document.getElementById('resultShowType')?.checked ?? true,  
      showBank: document.getElementById('resultShowBank')?.checked ?? true,  
      showAmount: document.getElementById('resultShowAmount')?.checked ?? true,  
      showInstallment: document.getElementById('resultShowInstallment')?.checked ?? true,  
      showDuration: document.getElementById('resultShowDuration')?.checked ?? true,  
      showRate: document.getElementById('resultShowRate')?.checked ?? true,  
      showProfit: document.getElementById('resultShowProfit')?.checked ?? true,  
      showTotal: document.getElementById('resultShowTotal')?.checked ?? true,  
      showEndDate: document.getElementById('resultShowEndDate')?.checked ?? true,  
      showRetirement: document.getElementById('resultShowRetirement')?.checked ?? true,  
      showSalaryDetails: document.getElementById('resultShowSalaryDetails')?.checked ?? true,  
      showCommitments: document.getElementById('resultShowCommitments')?.checked ?? true,  
      showButtons: document.getElementById('resultShowButtons')?.checked ?? true  
    };  
    localStorage.setItem(RESULT_ELEMENTS_KEY, JSON.stringify(settings));  
    applyResultElementsSettings(settings);  
  }  
    
  function loadResultElementsSettings() {  
    try {  
      const saved = localStorage.getItem(RESULT_ELEMENTS_KEY);  
      if (saved) {  
        const settings = JSON.parse(saved);  
        // تحميل الإعدادات للحقول  
        if (document.getElementById('resultShowType')) document.getElementById('resultShowType').checked = settings.showType ?? true;  
        if (document.getElementById('resultShowBank')) document.getElementById('resultShowBank').checked = settings.showBank ?? true;  
        if (document.getElementById('resultShowAmount')) document.getElementById('resultShowAmount').checked = settings.showAmount ?? true;  
        if (document.getElementById('resultShowInstallment')) document.getElementById('resultShowInstallment').checked = settings.showInstallment ?? true;  
        if (document.getElementById('resultShowDuration')) document.getElementById('resultShowDuration').checked = settings.showDuration ?? true;  
        if (document.getElementById('resultShowRate')) document.getElementById('resultShowRate').checked = settings.showRate ?? true;  
        if (document.getElementById('resultShowProfit')) document.getElementById('resultShowProfit').checked = settings.showProfit ?? true;  
        if (document.getElementById('resultShowTotal')) document.getElementById('resultShowTotal').checked = settings.showTotal ?? true;  
        if (document.getElementById('resultShowEndDate')) document.getElementById('resultShowEndDate').checked = settings.showEndDate ?? true;  
        if (document.getElementById('resultShowRetirement')) document.getElementById('resultShowRetirement').checked = settings.showRetirement ?? true;  
        if (document.getElementById('resultShowSalaryDetails')) document.getElementById('resultShowSalaryDetails').checked = settings.showSalaryDetails ?? true;  
        if (document.getElementById('resultShowCommitments')) document.getElementById('resultShowCommitments').checked = settings.showCommitments ?? true;  
        if (document.getElementById('resultShowButtons')) document.getElementById('resultShowButtons').checked = settings.showButtons ?? true;  
        return settings;  
      }  
    } catch (e) {  
      console.error('خطأ في تحميل إعدادات عناصر النتيجة:', e);  
    }  
    return null;  
  }  
    
  function applyResultElementsSettings(settings) {  
    if (!settings) return;  
    // سيتم تطبيق الإعدادات عند عرض النتيجة  
    console.log('تم حفظ إعدادات عناصر النتيجة:', settings);  
  }  
    
  // ====== التصاميم الجاهزة ======  
  function applyPresetTheme(theme) {  
    const themes = {  
      classic: {  
        textColor: '#111827',  
        secondaryColor: '#6b7280',  
        cardOpacity: 0.95,  
        cardBlur: 10,  
        hideCards: false  
      },  
      dark: {  
        textColor: '#f9fafb',  
        secondaryColor: '#9ca3af',  
        cardOpacity: 0.9,  
        cardBlur: 15,  
        hideCards: false  
      },  
      gold: {  
        textColor: '#78350f',  
        secondaryColor: '#92400e',  
        cardOpacity: 0.85,  
        cardBlur: 8,  
        hideCards: false  
      },  
      green: {  
        textColor: '#064e3b',  
        secondaryColor: '#065f46',  
        cardOpacity: 0.88,  
        cardBlur: 10,  
        hideCards: false  
      },  
      blue: {  
        textColor: '#1e3a8a',  
        secondaryColor: '#1e40af',  
        cardOpacity: 0.9,  
        cardBlur: 12,  
        hideCards: false  
      },  
      transparent: {  
        textColor: '#ffffff',  
        secondaryColor: '#e5e7eb',  
        cardOpacity: 0.3,  
        cardBlur: 20,  
        hideCards: true  
      }  
    };  
      
    const preset = themes[theme];  
    if (!preset) return;  
      
    // تطبيق التصميم  
    if (document.getElementById('settingsTextColor')) document.getElementById('settingsTextColor').value = preset.textColor;  
    if (document.getElementById('settingsSecondaryTextColor')) document.getElementById('settingsSecondaryTextColor').value = preset.secondaryColor;  
    if (document.getElementById('settingsCardOpacity')) document.getElementById('settingsCardOpacity').value = preset.cardOpacity * 100;  
    if (document.getElementById('settingsCardBlur')) document.getElementById('settingsCardBlur').value = preset.cardBlur;  
    if (document.getElementById('settingsHideCards')) document.getElementById('settingsHideCards').checked = preset.hideCards;  
      
    // تطبيق التغييرات  
    document.documentElement.style.setProperty('--card-opacity', preset.cardOpacity);  
    document.documentElement.style.setProperty('--card-blur', preset.cardBlur + 'px');  
    document.body.style.color = preset.textColor;  
      
    if (preset.hideCards) {  
      document.body.classList.add('hide-cards');  
    } else {  
      document.body.classList.remove('hide-cards');  
    }  
      
    updateTextStyles();  
    updateCardBackground();  
      
    showSaveConfirmation('تم تطبيق التصميم: ' + theme);  
  }  
    
  // ====== محرر النصوص ======  
  const CUSTOM_TEXTS_KEY = 'finoCustomTexts';  
  let customPageMessages = [];  
    
  function loadCustomTexts() {  
    try {  
      const saved = localStorage.getItem(CUSTOM_TEXTS_KEY);  
      if (saved) {  
        const data = JSON.parse(saved);  
        // تحميل النصوص إلى الحقول  
        if (data.welcome && document.getElementById('textWelcome')) document.getElementById('textWelcome').value = data.welcome;  
        if (data.resultGreeting && document.getElementById('textResultGreeting')) document.getElementById('textResultGreeting').value = data.resultGreeting;  
        if (data.financeEnd && document.getElementById('textFinanceEnd')) document.getElementById('textFinanceEnd').value = data.financeEnd;  
        if (data.deficit && document.getElementById('textDeficit')) document.getElementById('textDeficit').value = data.deficit;  
        if (data.retirement && document.getElementById('textRetirement')) document.getElementById('textRetirement').value = data.retirement;  
        if (data.contact && document.getElementById('textContact')) document.getElementById('textContact').value = data.contact;  
        if (data.disclaimer && document.getElementById('textDisclaimer')) document.getElementById('textDisclaimer').value = data.disclaimer;  
        if (data.privateSector && document.getElementById('textPrivateSector')) document.getElementById('textPrivateSector').value = data.privateSector;  
        if (data.pageMessages) customPageMessages = data.pageMessages;  
        renderCustomPageMessages();  
      }  
    } catch(e) { console.error('خطأ في تحميل النصوص:', e); }  
  }  
    
  function saveCustomTexts() {  
    const data = {  
      welcome: document.getElementById('textWelcome')?.value || '',  
      resultGreeting: document.getElementById('textResultGreeting')?.value || '',  
      financeEnd: document.getElementById('textFinanceEnd')?.value || '',  
      deficit: document.getElementById('textDeficit')?.value || '',  
      retirement: document.getElementById('textRetirement')?.value || '',  
      contact: document.getElementById('textContact')?.value || '',  
      disclaimer: document.getElementById('textDisclaimer')?.value || '',  
      privateSector: document.getElementById('textPrivateSector')?.value || '',  
      pageMessages: customPageMessages  
    };  
    localStorage.setItem(CUSTOM_TEXTS_KEY, JSON.stringify(data));  
    alert('تم حفظ النصوص.');  
  }  
    
  function addCustomPageMessage() {  
    customPageMessages.push({  
      id: 'msg_' + Date.now(),  
      page: 'landing',  
      text: 'رسالة جديدة',  
      enabled: true  
    });  
    renderCustomPageMessages();  
  }  
    
  function deleteCustomPageMessage(id) {  
    customPageMessages = customPageMessages.filter(m => m.id !== id);  
    renderCustomPageMessages();  
  }  
    
  function renderCustomPageMessages() {  
    const container = document.getElementById('customPageMessages');  
    if (!container) return;  
      
    if (customPageMessages.length === 0) {  
      container.innerHTML = '<p style="font-size:13px; color:#6b7280;">لا توجد رسائل مخصصة بعد.</p>';  
      return;  
    }  
      
    container.innerHTML = customPageMessages.map((msg, idx) => `  
      <div style="display:flex; gap:10px; align-items:center; padding:10px; background:rgba(255,255,255,0.7); border-radius:8px; margin-bottom:8px;">  
        <select onchange="customPageMessages[${idx}].page = this.value" style="flex:0 0 120px;">  
          <option value="landing" ${msg.page === 'landing' ? 'selected' : ''}>الرئيسية</option>  
          <option value="calculator" ${msg.page === 'calculator' ? 'selected' : ''}>الحاسبة</option>  
          <option value="result" ${msg.page === 'result' ? 'selected' : ''}>النتيجة</option>  
        </select>  
        <input type="text" value="${escapeHtml(msg.text)}" onchange="customPageMessages[${idx}].text = this.value" style="flex:1;">  
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">  
          <input type="checkbox" ${msg.enabled ? 'checked' : ''} onchange="customPageMessages[${idx}].enabled = this.checked">  
          <span style="font-size:12px;">مفعل</span>  
        </label>  
        <button onclick="deleteCustomPageMessage('${msg.id}')" style="background:#ef4444; color:#fff; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">🗑️</button>  
      </div>  
    `).join('');  
  }  
    
  // ====== إدارة أنواع الوظائف ======  
  const JOB_TYPES_KEY = 'finoJobTypes';  
  let customJobTypes = [];  
    
  // أنواع الوظائف الأساسية  
  const defaultJobTypes = [  
    { id: 'government', name: 'حكومي', logo: '', canDelete: false },  
    { id: 'military', name: 'عسكري', logo: '', canDelete: false },  
    { id: 'private', name: 'قطاع خاص', logo: '', canDelete: false },  
    { id: 'retired', name: 'متقاعد', logo: '', canDelete: false }  
  ];  
    
  function loadJobTypes() {  
    try {  
      const saved = localStorage.getItem(JOB_TYPES_KEY);  
      if (saved) customJobTypes = JSON.parse(saved);  
    } catch(e) { console.error('خطأ في تحميل أنواع الوظائف:', e); }  
  }  
    
  function saveJobTypes() {  
    localStorage.setItem(JOB_TYPES_KEY, JSON.stringify(customJobTypes));  
  }  
    
  function getAllJobTypes() {  
    return [...defaultJobTypes, ...customJobTypes];  
  }  
    
  function getJobTypeOptions() {  
    // إرجاع قائمة أسماء الوظائف للعميل  
    loadJobTypes();  
    const allTypes = getAllJobTypes();  
    return allTypes.map(job => job.name);  
  }  
    
  function addJobType() {  
    const nameEl = document.getElementById('newJobTypeName');  
    const logoEl = document.getElementById('newJobTypeLogo');  
    const name = nameEl?.value?.trim();  
    const logo = logoEl?.value?.trim() || '';  
      
    if (!name) {  
      alert('يرجى إدخال اسم نوع الوظيفة');  
      return;  
    }  
      
    const id = 'custom_' + Date.now();  
    customJobTypes.push({ id, name, logo, canDelete: true });  
    saveJobTypes();  
    renderJobTypesList();  
      
    if (nameEl) nameEl.value = '';  
    if (logoEl) logoEl.value = '';  
      
    alert('تم إضافة نوع الوظيفة: ' + name);  
  }  
    
  function deleteJobType(id) {  
    if (!confirm('هل أنت متأكد من حذف هذا النوع؟')) return;  
    customJobTypes = customJobTypes.filter(j => j.id !== id);  
    saveJobTypes();  
    renderJobTypesList();  
  }  
    
  function renderJobTypesList() {  
    const container = document.getElementById('jobTypesList');  
    if (!container) return;  
      
    const allTypes = getAllJobTypes();  
    container.innerHTML = allTypes.map(job => `  
      <div style="display:flex; align-items:center; gap:10px; padding:8px; background:rgba(255,255,255,0.5); border-radius:8px; margin-bottom:5px;">  
        ${job.logo ? `<img src="${escapeHtml(job.logo)}" style="width:24px; height:24px; border-radius:4px;">` : '<span style="width:24px; height:24px; background:#e5e7eb; border-radius:4px; display:flex; align-items:center; justify-content:center;">👤</span>'}  
        <span style="flex:1; font-size:14px;">${escapeHtml(job.name)}</span>  
        ${job.canDelete ? `<button onclick="deleteJobType('${job.id}')" style="background:#ef4444; color:#fff; border:none; border-radius:4px; padding:4px 8px; font-size:12px; cursor:pointer;">🗑️ حذف</button>` : '<span style="font-size:11px; color:#6b7280;">أساسي</span>'}  
      </div>  
    `).join('');  
      
    // تحديث قائمة الوظائف في صفحة تعديل النسب  
    updateAdminJobTypeSelect();  
  }  
    
  function updateAdminJobTypeSelect() {  
    const select = document.getElementById('adminJobType');  
    if (!select) return;  
      
    const currentValue = select.value;  
    const allTypes = getAllJobTypes();  
      
    select.innerHTML = '<option value="">الكل</option>' +   
      allTypes.map(job => `<option value="${escapeHtml(job.name)}">${escapeHtml(job.name)}</option>`).join('');  
      
    if (currentValue) select.value = currentValue;  
  }  
    
  // تحميل أنواع الوظائف عند بدء التطبيق  
  loadJobTypes();  
    
  // ====== حساب تاريخ انتهاء التمويل ======  
  function calculateFinanceEndDate(months) {  
    const now = new Date();  
    const endDate = new Date(now.getFullYear(), now.getMonth() + parseInt(months), now.getDate());  
      
    // التاريخ الميلادي - بالتقويم الميلادي الصحيح  
    const gregorianYear = endDate.getFullYear();  
    const gregorianMonth = endDate.getMonth();  
    const gregorianDay = endDate.getDate();  
      
    const arabicMonths = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];  
    const gregorianDate = `${gregorianDay} ${arabicMonths[gregorianMonth]} ${gregorianYear}م`;  
      
    // التاريخ الهجري  
    let hijriDate = '';  
    try {  
      hijriDate = endDate.toLocaleDateString('ar-SA-u-ca-islamic-umalqura', {  
        year: 'numeric',  
        month: 'long',  
        day: 'numeric'  
      });  
    } catch (e) {  
      // حساب تقريبي للهجري  
      const hijriYear = Math.round((gregorianYear - 622) * (33/32));  
      hijriDate = `تقريباً ${hijriYear} هـ`;  
    }  
      
    return {   
      gregorian: gregorianDate,   
      hijri: hijriDate,  
      year: gregorianYear,  
      hijriYear: hijriDate.match(/\d+/) ? hijriDate.match(/\d+/)[0] : ''  
    };  
  }  
    
  // ====== PWA - دعم كامل لجميع المتصفحات ======  
  let deferredPrompt;  
  let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;  
  let isAndroid = /Android/.test(navigator.userAgent);  
  let isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;  
    
  // التحقق من حالة التثبيت  
  function checkPWAInstallState() {  
    const banner = document.getElementById('pwaInstallBanner');  
    if (!banner) return;  
      
    // إذا كان التطبيق مثبت بالفعل  
    if (isStandalone) {  
      banner.style.display = 'none';  
      return;  
    }  
      
    // إذا رفض المستخدم التثبيت سابقاً  
    if (localStorage.getItem('pwaPromptDismissed')) {  
      banner.style.display = 'none';  
      return;  
    }  
      
    // عرض البانر مع تعليمات مخصصة حسب الجهاز  
    if (isIOS) {  
      showIOSInstallInstructions();  
    } else {  
      banner.style.display = 'block';  
    }  
  }  
    
  // تعليمات تثبيت iOS  
  function showIOSInstallInstructions() {  
    const banner = document.getElementById('pwaInstallBanner');  
    if (!banner) return;  
      
    banner.innerHTML = `  
      <div style="font-size:15px; font-weight:700; margin-bottom:8px;">📱 أضف المنصة لشاشتك الرئيسية</div>  
      <div style="font-size:13px; opacity:0.95; margin-bottom:10px; line-height:1.6;">  
        1️⃣ اضغط على زر المشاركة <span style="font-size:18px;">⬆️</span> في الأسفل<br>  
        2️⃣ اختر "إضافة إلى الشاشة الرئيسية" <span style="font-size:18px;">➕</span><br>  
        3️⃣ اضغط "إضافة" وسيظهر التطبيق كأيقونة  
      </div>  
      <button onclick="dismissInstallPrompt()" style="background:rgba(255,255,255,0.2); color:#fff; border:none; padding:8px 20px; border-radius:20px; font-size:13px; cursor:pointer;">فهمت، لاحقاً</button>  
    `;  
    banner.style.display = 'block';  
  }  
    
  // استماع لحدث التثبيت (Android/Chrome)  
  window.addEventListener('beforeinstallprompt', (e) => {  
    e.preventDefault();  
    deferredPrompt = e;  
    const banner = document.getElementById('pwaInstallBanner');  
    if (banner && !localStorage.getItem('pwaPromptDismissed') && !isStandalone) {  
      banner.style.display = 'block';  
    }  
  });  
    
  // دالة تثبيت PWA  
  function installPWA() {  
    if (deferredPrompt) {  
      // Android/Chrome - استخدام الـ prompt الأصلي  
      deferredPrompt.prompt();  
      deferredPrompt.userChoice.then((choiceResult) => {  
        if (choiceResult.outcome === 'accepted') {  
          console.log('FINO: تم تثبيت التطبيق');  
          showNotification('تم تثبيت التطبيق بنجاح! 🎉', 'success');  
        }  
        deferredPrompt = null;  
        document.getElementById('pwaInstallBanner').style.display = 'none';  
      });  
    } else if (isIOS) {  
      // iOS - عرض التعليمات  
      showIOSInstallInstructions();  
    } else {  
      // متصفحات أخرى - عرض تعليمات عامة  
      showNotification('اضغط على قائمة المتصفح واختر "إضافة إلى الشاشة الرئيسية"', 'info');  
    }  
  }  
    
  function dismissInstallPrompt() {  
    document.getElementById('pwaInstallBanner').style.display = 'none';  
    localStorage.setItem('pwaPromptDismissed', 'true');  
  }  
    
  // استماع لحدث اكتمال التثبيت  
  window.addEventListener('appinstalled', (evt) => {  
    console.log('FINO: تم تثبيت التطبيق بنجاح');  
    document.getElementById('pwaInstallBanner').style.display = 'none';  
    deferredPrompt = null;  
  });  
    
  // تسجيل Service Worker  
  if ('serviceWorker' in navigator) {  
    window.addEventListener('load', () => {  
      navigator.serviceWorker.register('/sw.js')  
        .then(reg => {  
          console.log('FINO SW: تم التسجيل');  
          reg.addEventListener('updatefound', () => {  
            const newWorker = reg.installing;  
            newWorker.addEventListener('statechange', () => {  
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {  
                showNotification('يوجد تحديث جديد! أعد تحميل الصفحة للتحديث.', 'info');  
              }  
            });  
          });  
        })  
        .catch(err => console.log('FINO SW: فشل التسجيل', err));  
      setTimeout(checkPWAInstallState, 1000);  
    });  
  }  
    
  // ====== نظام الدفع والباقات ======  
  const PAYMENT_STORAGE_KEY = 'fino_payment_settings';  
  const USER_USAGE_KEY = 'fino_user_usage';  
  const PAID_USERS_KEY = 'fino_paid_users';  
    
  // الإعدادات الافتراضية  
  const defaultPaymentSettings = {  
    enabled: false,  
    freeTrials: 3,  
    singlePrice: 10,  
    packages: [  
      { name: 'باقة أساسية', uses: 10, price: 50 },  
      { name: 'باقة متوسطة', uses: 25, price: 100 },  
      { name: 'باقة متقدمة', uses: 50, price: 150 }  
    ],  
    storeEnabled: false,  
    storeUrl: '',  
    storeButtonText: '🛒 ادفع عبر المتجر',  
    bankEnabled: false,  
    bankDetails: '',  
    customEnabled: false,  
    customUrl: '',  
    customButtonText: '💳 ادفع الآن',  
    expiredMessage: 'انتهت مراتك المجانية! اختر باقة للمتابعة.',  
    successMessage: 'شكراً لك! تم تفعيل حسابك بنجاح.'  
  };  
    
  function getPaymentSettings() {  
    try {  
      const saved = localStorage.getItem(PAYMENT_STORAGE_KEY);  
      return saved ? { ...defaultPaymentSettings, ...JSON.parse(saved) } : defaultPaymentSettings;  
    } catch (e) {  
      return defaultPaymentSettings;  
    }  
  }  
    
  function savePaymentSettings() {  
    const settings = {  
      enabled: document.getElementById('paymentSystemEnabled')?.checked || false,  
      freeTrials: parseInt(document.getElementById('paymentFreeTrials')?.value) || 3,  
      singlePrice: parseFloat(document.getElementById('paymentSinglePrice')?.value) || 10,  
      packages: getPaymentSettings().packages,  
      storeEnabled: document.getElementById('paymentStoreEnabled')?.checked || false,  
      storeUrl: document.getElementById('paymentStoreUrl')?.value || '',  
      storeButtonText: document.getElementById('paymentStoreButtonText')?.value || '🛒 ادفع عبر المتجر',  
      bankEnabled: document.getElementById('paymentBankEnabled')?.checked || false,  
      bankDetails: document.getElementById('paymentBankDetails')?.value || '',  
      customEnabled: document.getElementById('paymentCustomEnabled')?.checked || false,  
      customUrl: document.getElementById('paymentCustomUrl')?.value || '',  
      customButtonText: document.getElementById('paymentCustomButtonText')?.value || '💳 ادفع الآن',  
      expiredMessage: document.getElementById('paymentExpiredMessage')?.value || defaultPaymentSettings.expiredMessage,  
      successMessage: document.getElementById('paymentSuccessMessage')?.value || defaultPaymentSettings.successMessage  
    };  
    localStorage.setItem(PAYMENT_STORAGE_KEY, JSON.stringify(settings));  
    updatePaymentUI();  
    showNotification('تم حفظ إعدادات الدفع', 'success');  
  }  
    
  function loadPaymentSettingsToUI() {  
    const settings = getPaymentSettings();  
    const el = (id) => document.getElementById(id);  
    if (el('paymentSystemEnabled')) el('paymentSystemEnabled').checked = settings.enabled;  
    if (el('paymentFreeTrials')) el('paymentFreeTrials').value = settings.freeTrials;  
    if (el('paymentSinglePrice')) el('paymentSinglePrice').value = settings.singlePrice;  
    if (el('paymentStoreEnabled')) el('paymentStoreEnabled').checked = settings.storeEnabled;  
    if (el('paymentStoreUrl')) el('paymentStoreUrl').value = settings.storeUrl;  
    if (el('paymentStoreButtonText')) el('paymentStoreButtonText').value = settings.storeButtonText;  
    if (el('paymentBankEnabled')) el('paymentBankEnabled').checked = settings.bankEnabled;  
    if (el('paymentBankDetails')) el('paymentBankDetails').value = settings.bankDetails;  
    if (el('paymentCustomEnabled')) el('paymentCustomEnabled').checked = settings.customEnabled;  
    if (el('paymentCustomUrl')) el('paymentCustomUrl').value = settings.customUrl;  
    if (el('paymentCustomButtonText')) el('paymentCustomButtonText').value = settings.customButtonText;  
    if (el('paymentExpiredMessage')) el('paymentExpiredMessage').value = settings.expiredMessage;  
    if (el('paymentSuccessMessage')) el('paymentSuccessMessage').value = settings.successMessage;  
    renderPaymentPackages();  
    renderPaidUsers();  
    updatePaymentUI();  
  }  
    
  function updatePaymentUI() {  
    const settings = getPaymentSettings();  
    const container = document.getElementById('paymentSettingsContainer');  
    if (container) {  
      container.style.opacity = settings.enabled ? '1' : '0.5';  
      container.style.pointerEvents = settings.enabled ? 'auto' : 'none';  
    }  
  }  
    
  function renderPaymentPackages() {  
    const settings = getPaymentSettings();  
    const container = document.getElementById('paymentPackagesList');  
    if (!container) return;  
      
    if (!settings.packages || settings.packages.length === 0) {  
      container.innerHTML = '<div style="color:#6b7280; font-size:13px;">لا توجد باقات مضافة</div>';  
      return;  
    }  
      
    container.innerHTML = settings.packages.map((pkg, idx) => `  
      <div style="display:flex; align-items:center; gap:8px; padding:8px; background:#f3f4f6; border-radius:6px; margin-bottom:5px;">  
        <span style="flex:1; font-weight:600;">${escapeHtml(pkg.name)}</span>  
        <span style="color:#6b7280;">${pkg.uses} استخدام</span>  
        <span style="color:#059669; font-weight:700;">${pkg.price} ر.س</span>  
        <button class="secondary small" onclick="deletePaymentPackage(${idx})" style="padding:4px 8px;">🗑️</button>  
      </div>  
    `).join('');  
  }  
    
  function addPaymentPackage() {  
    const name = document.getElementById('newPackageName')?.value?.trim();  
    const uses = parseInt(document.getElementById('newPackageUses')?.value);  
    const price = parseFloat(document.getElementById('newPackagePrice')?.value);  
      
    if (!name || !uses || !price) {  
      showNotification('أدخل جميع بيانات الباقة', 'error');  
      return;  
    }  
      
    const settings = getPaymentSettings();  
    settings.packages = settings.packages || [];  
    settings.packages.push({ name, uses, price });  
    localStorage.setItem(PAYMENT_STORAGE_KEY, JSON.stringify(settings));  
      
    document.getElementById('newPackageName').value = '';  
    document.getElementById('newPackageUses').value = '';  
    document.getElementById('newPackagePrice').value = '';  
      
    renderPaymentPackages();  
    showNotification('تم إضافة الباقة', 'success');  
  }  
    
  function deletePaymentPackage(idx) {  
    const settings = getPaymentSettings();  
    settings.packages.splice(idx, 1);  
    localStorage.setItem(PAYMENT_STORAGE_KEY, JSON.stringify(settings));  
    renderPaymentPackages();  
    showNotification('تم حذف الباقة', 'success');  
  }  
    
  // إدارة استخدام العميل  
  function getUserUsage() {  
    try {  
      const saved = localStorage.getItem(USER_USAGE_KEY);  
      return saved ? JSON.parse(saved) : { count: 0, paidUses: 0 };  
    } catch (e) {  
      return { count: 0, paidUses: 0 };  
    }  
  }  
    
  function incrementUserUsage() {  
    const usage = getUserUsage();  
    usage.count++;  
    localStorage.setItem(USER_USAGE_KEY, JSON.stringify(usage));  
    return usage;  
  }  
    
  function canUserCalculate() {  
    const settings = getPaymentSettings();  
    if (!settings.enabled) return true;  
      
    const usage = getUserUsage();  
    const totalAllowed = settings.freeTrials + usage.paidUses;  
    return usage.count < totalAllowed;  
  }  
    
  function getRemainingUses() {  
    const settings = getPaymentSettings();  
    const usage = getUserUsage();  
    const totalAllowed = settings.freeTrials + usage.paidUses;  
    return Math.max(0, totalAllowed - usage.count);  
  }  
    
  // إدارة المستخدمين المدفوعين  
  function getPaidUsers() {  
    try {  
      const saved = localStorage.getItem(PAID_USERS_KEY);  
      return saved ? JSON.parse(saved) : [];  
    } catch (e) {  
      return [];  
    }  
  }  
    
  function activatePaidUser() {  
    const phone = document.getElementById('activateUserPhone')?.value?.trim();  
    const uses = parseInt(document.getElementById('activateUserUses')?.value) || 10;  
      
    if (!phone) {  
      showNotification('أدخل رقم الجوال أو المعرف', 'error');  
      return;  
    }  
      
    const users = getPaidUsers();  
    const existingIdx = users.findIndex(u => u.phone === phone);  
      
    if (existingIdx >= 0) {  
      users[existingIdx].uses += uses;  
      users[existingIdx].activatedAt = new Date().toISOString();  
    } else {  
      users.push({ phone, uses, activatedAt: new Date().toISOString() });  
    }  
      
    localStorage.setItem(PAID_USERS_KEY, JSON.stringify(users));  
    document.getElementById('activateUserPhone').value = '';  
      
    renderPaidUsers();  
    showNotification(`تم تفعيل ${uses} استخدام للمستخدم ${phone}`, 'success');  
  }  
    
  function renderPaidUsers() {  
    const container = document.getElementById('paidUsersList');  
    if (!container) return;  
      
    const users = getPaidUsers();  
    if (users.length === 0) {  
      container.innerHTML = '<div style="color:#6b7280; font-size:12px;">لا يوجد مستخدمين مفعلين</div>';  
      return;  
    }  
      
    container.innerHTML = users.map((user, idx) => `  
      <div style="display:flex; align-items:center; gap:8px; padding:6px; background:#d1fae5; border-radius:4px; margin-bottom:4px; font-size:12px;">  
        <span style="flex:1;">${escapeHtml(user.phone)}</span>  
        <span style="color:#059669;">${user.uses} استخدام</span>  
        <button onclick="deletePaidUser(${idx})" style="background:none; border:none; cursor:pointer;">❌</button>  
      </div>  
    `).join('');  
  }  
    
  function deletePaidUser(idx) {  
    const users = getPaidUsers();  
    users.splice(idx, 1);  
    localStorage.setItem(PAID_USERS_KEY, JSON.stringify(users));  
    renderPaidUsers();  
  }  
    
  // عرض نافذة الدفع  
  function showPaymentModal() {  
    const settings = getPaymentSettings();  
    const remaining = getRemainingUses();  
      
    let paymentOptions = '';  
      
    if (settings.storeEnabled && settings.storeUrl) {  
      paymentOptions += `<a href="${escapeHtml(settings.storeUrl)}" target="_blank" class="primary" style="display:block; text-align:center; padding:12px; margin-bottom:8px; text-decoration:none;">${escapeHtml(settings.storeButtonText)}</a>`;  
    }  
      
    if (settings.bankEnabled && settings.bankDetails) {  
      paymentOptions += `  
        <div style="background:#f3f4f6; padding:12px; border-radius:8px; margin-bottom:8px;">  
          <div style="font-weight:700; margin-bottom:8px;">🏦 التحويل البنكي</div>  
          <pre style="white-space:pre-wrap; font-size:12px; margin:0;">${escapeHtml(settings.bankDetails)}</pre>  
          <div style="margin-top:8px; font-size:11px; color:#6b7280;">بعد التحويل، تواصل معنا لتفعيل حسابك</div>  
        </div>  
      `;  
    }  
      
    if (settings.customEnabled && settings.customUrl) {  
      paymentOptions += `<a href="${escapeHtml(settings.customUrl)}" target="_blank" class="secondary" style="display:block; text-align:center; padding:12px; margin-bottom:8px; text-decoration:none;">${escapeHtml(settings.customButtonText)}</a>`;  
    }  
      
    // عرض الباقات  
    let packagesHtml = '';  
    if (settings.packages && settings.packages.length > 0) {  
      packagesHtml = '<div style="margin-top:15px;"><h4 style="margin:0 0 10px;">🎁 الباقات المتاحة</h4>';  
      packagesHtml += settings.packages.map(pkg => `  
        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:#fef3c7; border-radius:8px; margin-bottom:6px;">  
          <div>  
            <div style="font-weight:700;">${escapeHtml(pkg.name)}</div>  
            <div style="font-size:12px; color:#6b7280;">${pkg.uses} استخدام</div>  
          </div>  
          <div style="font-size:18px; font-weight:700; color:#059669;">${pkg.price} ر.س</div>  
        </div>  
      `).join('');  
      packagesHtml += '</div>';  
    }  
      
    const modalHtml = `  
      <div id="paymentModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:10000; display:flex; align-items:center; justify-content:center; padding:20px;">  
        <div style="background:#fff; border-radius:16px; max-width:450px; width:100%; padding:20px; max-height:90vh; overflow-y:auto;">  
          <div style="text-align:center; margin-bottom:15px;">  
            <div style="font-size:50px;">💳</div>  
            <h3 style="margin:10px 0 5px;">${escapeHtml(settings.expiredMessage)}</h3>  
            <p style="color:#6b7280; font-size:14px;">المتبقي: ${remaining} استخدام</p>  
          </div>  
          ${paymentOptions}  
          ${packagesHtml}  
          <button onclick="closePaymentModal()" class="secondary" style="width:100%; margin-top:15px;">إغلاق</button>  
        </div>  
      </div>  
    `;  
      
    document.body.insertAdjacentHTML('beforeend', modalHtml);  
  }  
    
  function closePaymentModal() {  
    const modal = document.getElementById('paymentModal');  
    if (modal) modal.remove();  
  }  
    
  // ====== نظام الرقم السري ======  
  const PIN_SETTINGS_KEY = 'fino_pin_settings';  
    
  const defaultPinSettings = {  
    platformPinEnabled: false,  
    resultPinEnabled: false,  
    platformPinCode: '',  
    resultPinCode: ''  
  };  
    
  function getPinSettings() {  
    try {  
      const saved = localStorage.getItem(PIN_SETTINGS_KEY);  
      return saved ? { ...defaultPinSettings, ...JSON.parse(saved) } : defaultPinSettings;  
    } catch (e) {  
      return defaultPinSettings;  
    }  
  }  
    
  function savePinSettings() {  
    const settings = {  
      platformPinEnabled: document.getElementById('platformPinEnabled')?.checked || false,  
      resultPinEnabled: document.getElementById('resultPinEnabled')?.checked || false,  
      platformPinCode: document.getElementById('platformPinCode')?.value || '',  
      resultPinCode: document.getElementById('resultPinCode')?.value || ''  
    };  
    localStorage.setItem(PIN_SETTINGS_KEY, JSON.stringify(settings));  
    showNotification('تم حفظ إعدادات الرقم السري', 'success');  
  }  
    
  function loadPinSettingsToUI() {  
    const settings = getPinSettings();  
    const el = (id) => document.getElementById(id);  
    if (el('platformPinEnabled')) el('platformPinEnabled').checked = settings.platformPinEnabled;  
    if (el('resultPinEnabled')) el('resultPinEnabled').checked = settings.resultPinEnabled;  
    if (el('platformPinCode')) el('platformPinCode').value = settings.platformPinCode;  
    if (el('resultPinCode')) el('resultPinCode').value = settings.resultPinCode;  
  }  
    
  function checkPlatformPin() {  
    const settings = getPinSettings();  
    if (!settings.platformPinEnabled || !settings.platformPinCode) return true;  
    if (sessionStorage.getItem('platformPinVerified')) return true;  
      
    showPinModal('platform');  
    return false;  
  }  
    
  function checkResultPin() {  
    const settings = getPinSettings();  
    if (!settings.resultPinEnabled || !settings.resultPinCode) return true;  
    if (sessionStorage.getItem('resultPinVerified')) return true;  
      
    showPinModal('result');  
    return false;  
  }  
    
  function showPinModal(type) {  
    const title = type === 'platform' ? '🔐 أدخل الرقم السري للدخول' : '🔐 أدخل الرقم السري لعرض النتيجة';  
      
    const modalHtml = `  
      <div id="pinModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:10001; display:flex; align-items:center; justify-content:center; padding:20px;">  
        <div style="background:#fff; border-radius:16px; max-width:350px; width:100%; padding:25px; text-align:center;">  
          <div style="font-size:50px; margin-bottom:15px;">🔒</div>  
          <h3 style="margin:0 0 20px;">${title}</h3>  
          <input type="password" id="pinInput" placeholder="الرقم السري" style="width:100%; padding:12px; font-size:18px; text-align:center; border:2px solid #e5e7eb; border-radius:8px;" onkeypress="if(event.key==='Enter')verifyPin('${type}')">  
          <div id="pinError" style="color:#ef4444; font-size:13px; margin-top:8px; display:none;">الرقم السري غير صحيح</div>  
          <button onclick="verifyPin('${type}')" class="primary" style="width:100%; margin-top:15px;">دخول</button>  
        </div>  
      </div>  
    `;  
      
    document.body.insertAdjacentHTML('beforeend', modalHtml);  
    document.getElementById('pinInput')?.focus();  
  }  
    
  function verifyPin(type) {  
    const settings = getPinSettings();  
    const input = document.getElementById('pinInput')?.value;  
    const correctPin = type === 'platform' ? settings.platformPinCode : settings.resultPinCode;  
      
    if (input === correctPin) {  
      sessionStorage.setItem(type + 'PinVerified', 'true');  
      document.getElementById('pinModal')?.remove();  
        
      if (type === 'result') {  
        // إعادة عرض النتيجة  
        showPage('result');  
      }  
    } else {  
      document.getElementById('pinError').style.display = 'block';  
      document.getElementById('pinInput').value = '';  
      document.getElementById('pinInput')?.focus();  
    }  
  }  
    
  // تحميل الإعدادات عند بدء التطبيق  
  document.addEventListener('DOMContentLoaded', () => {  
    loadPaymentSettingsToUI();  
    loadPinSettingsToUI();  
      
    // التحقق من الرقم السري للمنصة  
    setTimeout(() => {  
      checkPlatformPin();  
    }, 100);  
      
    // تحميل الواجهات المحفوظة بعد تحميل كل الدوال  
    setTimeout(() => {  
      if (typeof loadSavedInterfaceImages === 'function') {  
        loadSavedInterfaceImages();  
        console.log('Interface images loaded from end of file');  
      }  
      // تحميل إعدادات الخطوط والألوان  
      loadFontSettings();  
      loadAdvancedColors();  
    }, 200);  
  });  
    
  // ====== نظام البحث عن العروض ======  
  function openOffersSearchModal() {  
    document.getElementById('offersSearchModal').style.display = 'block';  
    document.getElementById('searchOfferEmployer').value = '';  
    document.getElementById('offersSearchResults').innerHTML = `  
      <div style="text-align:center; color:#9ca3af; padding:30px;">  
        <div style="font-size:40px; margin-bottom:10px;">🔍</div>  
        <p>اختر جهة عملك لعرض العروض المتاحة</p>  
      </div>  
    `;  
  }  
    
  function closeOffersSearchModal() {  
    document.getElementById('offersSearchModal').style.display = 'none';  
  }  
    
  function searchOffersForEmployer() {  
    const employer = document.getElementById('searchOfferEmployer').value;  
    const resultsDiv = document.getElementById('offersSearchResults');  
      
    if (!employer) {  
      resultsDiv.innerHTML = `  
        <div style="text-align:center; color:#9ca3af; padding:30px;">  
          <div style="font-size:40px; margin-bottom:10px;">🔍</div>  
          <p>اختر جهة عملك لعرض العروض المتاحة</p>  
        </div>  
      `;  
      return;  
    }  
      
    // البحث عن العروض المطابقة لجهة العمل  
    const matchingOffers = getOffersForEmployer(employer);  
      
    if (matchingOffers.length === 0) {  
      resultsDiv.innerHTML = `  
        <div style="text-align:center; color:#9ca3af; padding:30px;">  
          <div style="font-size:40px; margin-bottom:10px;">😔</div>  
          <p>لا توجد عروض حالياً لموظفي <strong>${employer}</strong></p>  
          <p style="font-size:12px; color:#6b7280;">يمكنك متابعة الحساب بالنسب العادية</p>  
        </div>  
      `;  
      return;  
    }  
      
    let html = `<div style="font-weight:600; color:#059669; margin-bottom:10px;">🎉 وجدنا ${matchingOffers.length} عروض لموظفي ${employer}!</div>`;  
      
    matchingOffers.forEach(offer => {  
      const expiryInfo = getOfferExpiryInfo(offer);  
      html += `  
        <div style="background:#fff; border:2px solid ${expiryInfo.urgent ? '#ef4444' : '#10b981'}; border-radius:12px; padding:15px; margin-bottom:10px;">  
          <div style="display:flex; justify-content:space-between; align-items:flex-start;">  
            <div style="font-weight:700; color:#111827; font-size:16px;">🎁 ${escapeHtml(offer.title)}</div>  
            ${offer.specialRate ? `<div style="background:#10b981; color:#fff; padding:4px 10px; border-radius:20px; font-size:12px; font-weight:600;">${offer.specialRate}%</div>` : ''}  
          </div>  
          <p style="color:#4b5563; margin:8px 0; font-size:14px;">${escapeHtml(offer.text)}</p>  
          ${offer.linkedBank ? `<div style="color:#3b82f6; font-size:13px;">🏦 ${offer.linkedBank}</div>` : ''}  
          ${offer.notes ? `<div style="color:#6b7280; font-size:12px; margin-top:5px;">📝 ${escapeHtml(offer.notes)}</div>` : ''}  
          ${expiryInfo.text ? `<div style="color:${expiryInfo.urgent ? '#ef4444' : '#f59e0b'}; font-size:12px; margin-top:8px; font-weight:600;">⏰ ${expiryInfo.text}</div>` : ''}  
          ${offer.link ? `<a href="${offer.link}" target="_blank" style="display:inline-block; margin-top:10px; background:#3b82f6; color:#fff; padding:8px 15px; border-radius:8px; text-decoration:none; font-size:13px;">🔗 تفاصيل العرض</a>` : ''}  
          <button onclick="selectOffer(${JSON.stringify(offer).replace(/"/g, '&quot;')})" style="display:inline-block; margin-top:10px; margin-right:5px; background:#10b981; color:#fff; padding:8px 15px; border-radius:8px; border:none; cursor:pointer; font-size:13px;">✅ اختيار هذا العرض</button>  
        </div>  
      `;  
    });  
      
    resultsDiv.innerHTML = html;  
  }  
    
  function getOffersForEmployer(employer) {  
    const now = new Date();  
    return offers.filter(o => {  
      if (!o.enabled) return false;  
        
      // فلترة جهة العمل  
      const targetEmployer = o.customEmployer || o.targetEmployer;  
      if (targetEmployer && targetEmployer !== employer && targetEmployer !== '') return false;  
      if (!targetEmployer && !o.customEmployer) return true; // عرض للجميع  
        
      // فلترة التاريخ  
      if (o.startDate && new Date(o.startDate) > now) return false;  
      if (o.endDate && new Date(o.endDate) < now) return false;  
        
      return true;  
    });  
  }  
    
  function getOfferExpiryInfo(offer) {  
    if (!offer.endDate || !offer.showExpiry) return { text: '', urgent: false };  
      
    const now = new Date();  
    const endDate = new Date(offer.endDate);  
    const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));  
      
    if (daysLeft <= 0) return { text: 'انتهى العرض', urgent: true };  
    if (daysLeft <= 10) return { text: `باقي ${daysLeft} يوم على انتهاء العرض - ربما لا تمدد الجهة التمويلية هذا العرض`, urgent: true };  
    return { text: `ساري حتى ${offer.endDate}`, urgent: false };  
  }  
    
  function selectOffer(offer) {  
    // حفظ العرض المختار  
    window.selectedOffer = offer;  
      
    // إذا كان العرض يحتوي على نسبة خاصة، احفظها  
    if (offer.specialRate) {  
      answers.selectedOfferRate = offer.specialRate;  
      answers.selectedOfferTitle = offer.title;  
    }  
      
    closeOffersSearchModal();  
    showToast(`تم اختيار عرض: ${offer.title}`, 'success');  
  }  
    
  // دالة تحميل العروض تحت سؤال اختيار النسبة  
  function loadCalcModeOffers() {  
    const container = document.getElementById('calcModeOffersList');  
    if (!container) return;  
      
    const clientJobType = answers.jobType || '';  
    const clientEmployer = answers.employer || '';  
    const clientFinanceType = answers.financeType || '';  
      
    // البحث عن العروض المناسبة  
    const now = new Date();  
    const matchingOffers = offers.filter(o => {  
      if (!o.enabled) return false;  
        
      // فلترة نوع الوظيفة  
      if (o.targetJobType && o.targetJobType !== '' && o.targetJobType !== clientJobType) return false;  
        
      // فلترة جهة العمل  
      const targetEmployer = o.customEmployer || o.targetEmployer;  
      if (targetEmployer && targetEmployer !== '' && targetEmployer !== clientEmployer) return false;  
        
      // فلترة نوع التمويل  
      if (o.targetFinanceType && o.targetFinanceType !== '' && o.targetFinanceType !== 'الكل' && o.targetFinanceType !== clientFinanceType) return false;  
        
      // فلترة التاريخ  
      if (o.startDate && new Date(o.startDate) > now) return false;  
      if (o.endDate && new Date(o.endDate) < now) return false;  
        
      return true;  
    });  
      
    if (matchingOffers.length === 0) {  
      // إخفاء قسم العروض بالكامل إذا لم تكن هناك عروض
      const offersContainer = document.getElementById('calcModeOffersContainer');
      if (offersContainer) offersContainer.style.display = 'none';
      return;  
    }  
    // إظهار قسم العروض إذا كانت هناك عروض
    const offersContainerShow = document.getElementById('calcModeOffersContainer');
    if (offersContainerShow) offersContainerShow.style.display = 'block';  
      
    let html = '';  
    matchingOffers.forEach((offer, index) => {  
      const expiryInfo = getOfferExpiryInfo(offer);  
      html += `  
        <div style="display:flex; align-items:center; padding:10px; margin:8px 0; background:#fff; border-radius:8px; cursor:pointer; border:2px solid transparent; transition:all 0.2s;"   
             onmouseover="this.style.borderColor='#f59e0b'"   
             onmouseout="this.style.borderColor='transparent'"  
             onclick="selectOfferFromCalcMode(${index})">  
          <div style="flex:1;">  
            <strong style="color:#92400e; font-size:13px;">${offer.title}</strong>  
            ${offer.specialRate ? `<span style="background:#10b981; color:#fff; padding:2px 8px; border-radius:10px; font-size:11px; margin-right:8px;">${offer.specialRate}%</span>` : ''}  
            ${expiryInfo.text ? `<span style="color:${expiryInfo.urgent ? '#ef4444' : '#6b7280'}; font-size:10px; display:block; margin-top:3px;">${expiryInfo.text}</span>` : ''}  
          </div>  
          <button style="background:#f59e0b; color:#fff; border:none; padding:6px 12px; border-radius:6px; font-size:11px; cursor:pointer;">✅ اختيار</button>  
        </div>  
      `;  
    });  
      
    container.innerHTML = html;  
  }  
    
  // اختيار عرض من سؤال النسبة - الانتقال التلقائي  
  window.selectOfferFromCalcMode = function(offerIndex) {  
    const clientJobType = answers.jobType || '';  
    const clientEmployer = answers.employer || '';  
    const clientFinanceType = answers.financeType || '';  
    const now = new Date();  
      
    const matchingOffers = offers.filter(o => {  
      if (!o.enabled) return false;  
      if (o.targetJobType && o.targetJobType !== '' && o.targetJobType !== clientJobType) return false;  
      const targetEmployer = o.customEmployer || o.targetEmployer;  
      if (targetEmployer && targetEmployer !== '' && targetEmployer !== clientEmployer) return false;  
      if (o.targetFinanceType && o.targetFinanceType !== '' && o.targetFinanceType !== 'الكل' && o.targetFinanceType !== clientFinanceType) return false;  
      if (o.startDate && new Date(o.startDate) > now) return false;  
      if (o.endDate && new Date(o.endDate) < now) return false;  
      return true;  
    });  
      
    const offer = matchingOffers[offerIndex];  
    if (!offer) return;  
      
    // حفظ العرض المختار  
    window.selectedOffer = offer;  
    answers.selectedOfferRate = offer.specialRate || '';  
    answers.selectedOfferTitle = offer.title;  
    answers.calcMode = 'عرض خاص';  
      
    // تعيين النسبة من العرض  
    if (offer.specialRate) {  
      answers.profitMargin = offer.specialRate;  
    }  
      
    // تحديد المدة - الحد الأقصى للعميل أو الحد الأقصى للعرض (أيهما أقل)  
    const maxClientMonths = getMaxAllowedMonths();  
    const offerMaxMonths = offer.maxMonths || 360;  
    answers.months = Math.min(maxClientMonths, offerMaxMonths);  
      
    // حفظ الحالة للرجوع  
    saveQuestionState();  
      
    // تخطي سؤال النسبة والمدة والانتقال لسؤال الالتزامات  
    // البحث عن سؤال hasCommitments  
    for (let i = step; i < generalQuestions.length; i++) {  
      if (generalQuestions[i].id === 'hasCommitments') {  
        step = i;  
        break;  
      }  
    }  
      
    showToast(`تم اختيار عرض: ${offer.title} - النسبة: ${offer.specialRate || 'حسب البنك'}%`, 'success');  
    showQuestion();  
  };  
    
  // ====== نظام التصاميم الجاهزة ======  
  const fullDesigns = {  
    modern: {  
      name: 'عصري',  
      theme: 'default',  
      font: { main: 'Tajawal', title: 'Tajawal', size: 16, weight: 500 },  
      colors: {  
        primary: '#3b82f6', secondary: '#1d4ed8', accent: '#60a5fa',  
        splash1: '#3b82f6', splash2: '#1d4ed8', splash3: '#60a5fa',  
        home1: '#eff6ff', home2: '#dbeafe', home3: '#bfdbfe', home4: '#93c5fd',  
        result1: '#f0f9ff', result2: '#e0f2fe', resultCard: '#ffffff'  
      }  
    },  
    elegant: {  
      name: 'أنيق',  
      theme: 'purple',  
      font: { main: 'Cairo', title: 'Cairo', size: 16, weight: 500 },  
      colors: {  
        primary: '#8b5cf6', secondary: '#6d28d9', accent: '#a78bfa',  
        splash1: '#8b5cf6', splash2: '#6d28d9', splash3: '#a78bfa',  
        home1: '#f5f3ff', home2: '#ede9fe', home3: '#ddd6fe', home4: '#c4b5fd',  
        result1: '#faf5ff', result2: '#f3e8ff', resultCard: '#ffffff'  
      }  
    },  
    nature: {  
      name: 'طبيعي',  
      theme: 'green',  
      font: { main: 'Almarai', title: 'Almarai', size: 16, weight: 400 },  
      colors: {  
        primary: '#10b981', secondary: '#047857', accent: '#34d399',  
        splash1: '#10b981', splash2: '#047857', splash3: '#34d399',  
        home1: '#ecfdf5', home2: '#d1fae5', home3: '#a7f3d0', home4: '#6ee7b7',  
        result1: '#f0fdf4', result2: '#dcfce7', resultCard: '#ffffff'  
      }  
    },  
    luxury: {  
      name: 'فاخر',  
      theme: 'gold',  
      font: { main: 'Changa', title: 'Changa', size: 16, weight: 500 },  
      colors: {  
        primary: '#f59e0b', secondary: '#b45309', accent: '#fbbf24',  
        splash1: '#f59e0b', splash2: '#b45309', splash3: '#fbbf24',  
        home1: '#fffbeb', home2: '#fef3c7', home3: '#fde68a', home4: '#fcd34d',  
        result1: '#fefce8', result2: '#fef9c3', resultCard: '#ffffff'  
      }  
    },  
    dark: {  
      name: 'داكن',  
      theme: 'dark',  
      font: { main: 'El Messiri', title: 'El Messiri', size: 16, weight: 500 },  
      colors: {  
        primary: '#64748b', secondary: '#334155', accent: '#94a3b8',  
        splash1: '#1e293b', splash2: '#0f172a', splash3: '#334155',  
        home1: '#1e293b', home2: '#0f172a', home3: '#334155', home4: '#475569',  
        result1: '#1e293b', result2: '#0f172a', resultCard: '#334155',  
        textDark: '#f8fafc', textMedium: '#e2e8f0', textLight: '#cbd5e1'  
      }  
    },  
    professional: {  
      name: 'احترافي',  
      theme: 'default',  
      font: { main: 'Tajawal', title: 'Tajawal', size: 15, weight: 400 },  
      colors: {  
        primary: '#64748b', secondary: '#334155', accent: '#94a3b8',  
        splash1: '#64748b', splash2: '#334155', splash3: '#94a3b8',  
        home1: '#f8fafc', home2: '#f1f5f9', home3: '#e2e8f0', home4: '#cbd5e1',  
        result1: '#f8fafc', result2: '#f1f5f9', resultCard: '#ffffff'  
      }  
    },  
    warm: {  
      name: 'دافئ',  
      theme: 'default',  
      font: { main: 'Cairo', title: 'Cairo', size: 16, weight: 500 },  
      colors: {  
        primary: '#ef4444', secondary: '#b91c1c', accent: '#f87171',  
        splash1: '#ef4444', splash2: '#b91c1c', splash3: '#f87171',  
        home1: '#fef2f2', home2: '#fee2e2', home3: '#fecaca', home4: '#fca5a5',  
        result1: '#fff1f2', result2: '#ffe4e6', resultCard: '#ffffff'  
      }  
    },  
    ocean: {  
      name: 'محيطي',  
      theme: 'default',  
      font: { main: 'Almarai', title: 'Almarai', size: 16, weight: 400 },  
      colors: {  
        primary: '#06b6d4', secondary: '#0891b2', accent: '#22d3ee',  
        splash1: '#06b6d4', splash2: '#0891b2', splash3: '#22d3ee',  
        home1: '#ecfeff', home2: '#cffafe', home3: '#a5f3fc', home4: '#67e8f9',  
        result1: '#f0fdfa', result2: '#ccfbf1', resultCard: '#ffffff'  
      }  
    }  
  };  
    
  function applyFullDesign(designName) {  
    const design = fullDesigns[designName];  
    if (!design) return;  
      
    // تطبيق الثيم  
    applyTheme(design.theme);  
      
    // تطبيق الخطوط  
    const fontSettings = design.font;  
    document.documentElement.style.setProperty('--font-main', `'${fontSettings.main}', sans-serif`);  
    document.documentElement.style.setProperty('--font-title', `'${fontSettings.title}', sans-serif`);  
    document.body.style.fontFamily = `'${fontSettings.main}', sans-serif`;  
    document.body.style.fontSize = fontSettings.size + 'px';  
    document.body.style.fontWeight = fontSettings.weight;  
      
    // حفظ إعدادات الخطوط  
    localStorage.setItem(FONT_SETTINGS_KEY, JSON.stringify(fontSettings));  
      
    // تطبيق الألوان  
    const colors = design.colors;  
    document.documentElement.style.setProperty('--primary-color', colors.primary);  
    document.documentElement.style.setProperty('--secondary-color', colors.secondary);  
    document.documentElement.style.setProperty('--accent-color', colors.accent);  
      
    // ألوان شاشة البداية  
    document.documentElement.style.setProperty('--splash-color-1', colors.splash1);  
    document.documentElement.style.setProperty('--splash-color-2', colors.splash2);  
    document.documentElement.style.setProperty('--splash-color-3', colors.splash3);  
      
    // ألوان الصفحة الرئيسية  
    document.documentElement.style.setProperty('--home-color-1', colors.home1);  
    document.documentElement.style.setProperty('--home-color-2', colors.home2);  
    document.documentElement.style.setProperty('--home-color-3', colors.home3);  
    document.documentElement.style.setProperty('--home-color-4', colors.home4);  
      
    // ألوان صفحة النتيجة  
    document.documentElement.style.setProperty('--result-color-1', colors.result1);  
    document.documentElement.style.setProperty('--result-color-2', colors.result2);  
    document.documentElement.style.setProperty('--result-card-bg', colors.resultCard);  
      
    // ألوان النصوص (للوضع الداكن)  
    if (colors.textDark) {  
      document.documentElement.style.setProperty('--text-dark', colors.textDark);  
      document.documentElement.style.setProperty('--text-medium', colors.textMedium);  
      document.documentElement.style.setProperty('--text-light', colors.textLight);  
    } else {  
      document.documentElement.style.setProperty('--text-dark', '#111827');  
      document.documentElement.style.setProperty('--text-medium', '#6b7280');  
      document.documentElement.style.setProperty('--text-light', '#9ca3af');  
    }  
      
    // حفظ الألوان  
    localStorage.setItem(ADVANCED_COLORS_KEY, JSON.stringify(colors));  
    localStorage.setItem('fino_full_design', designName);  
      
    showToast(`تم تطبيق التصميم: ${design.name}`, 'success');  
  }  
    
  // ====== نظام إدارة الخطوط ======  
  const FONT_SETTINGS_KEY = 'fino_font_settings';  
  const defaultFontSettings = {  
    main: 'Tajawal',  
    title: 'Cairo',  
    size: 18,  
    weight: 400  
  };  
    
  function updateFont(type, fontName) {  
    const previewId = type === 'main' ? 'fontMainPreview' : 'fontTitlePreview';  
    const preview = document.getElementById(previewId);  
    if (preview) {  
      preview.style.fontFamily = `'${fontName}', sans-serif`;  
    }  
      
    // تطبيق الخط مباشرة  
    if (type === 'main') {  
      document.documentElement.style.setProperty('--font-main', `'${fontName}', sans-serif`);  
      document.body.style.fontFamily = `'${fontName}', sans-serif`;  
    } else {  
      document.documentElement.style.setProperty('--font-title', `'${fontName}', sans-serif`);  
    }  
  }  
    
  function updateFontSize(size) {  
    document.getElementById('fontSizeValue').textContent = size + 'px';  
    document.body.style.fontSize = size + 'px';  
  }  
    
  function updateFontWeight(weight) {  
    document.body.style.fontWeight = weight;  
  }  
    
  function saveFontSettings() {  
    const settings = {  
      main: document.getElementById('fontMain')?.value || 'Tajawal',  
      title: document.getElementById('fontTitle')?.value || 'Cairo',  
      size: document.getElementById('fontSizeRange')?.value || 18,  
      weight: document.getElementById('fontWeight')?.value || 400  
    };  
    localStorage.setItem(FONT_SETTINGS_KEY, JSON.stringify(settings));  
    showToast('تم حفظ إعدادات الخطوط بنجاح', 'success');  
  }  
    
  function loadFontSettings() {  
    const saved = localStorage.getItem(FONT_SETTINGS_KEY);  
    const settings = saved ? JSON.parse(saved) : defaultFontSettings;  
      
    // تطبيق الإعدادات  
    document.documentElement.style.setProperty('--font-main', `'${settings.main}', sans-serif`);  
    document.documentElement.style.setProperty('--font-title', `'${settings.title}', sans-serif`);  
    document.body.style.fontFamily = `'${settings.main}', sans-serif`;  
    document.body.style.fontSize = settings.size + 'px';  
    document.body.style.fontWeight = settings.weight;  
      
    // تحديث الواجهة  
    const fontMain = document.getElementById('fontMain');  
    const fontTitle = document.getElementById('fontTitle');  
    const fontSizeRange = document.getElementById('fontSizeRange');  
    const fontWeight = document.getElementById('fontWeight');  
    const fontSizeValue = document.getElementById('fontSizeValue');  
      
    if (fontMain) fontMain.value = settings.main;  
    if (fontTitle) fontTitle.value = settings.title;  
    if (fontSizeRange) fontSizeRange.value = settings.size;  
    if (fontWeight) fontWeight.value = settings.weight;  
    if (fontSizeValue) fontSizeValue.textContent = settings.size + 'px';  
      
    // تحديث المعاينات  
    const mainPreview = document.getElementById('fontMainPreview');  
    const titlePreview = document.getElementById('fontTitlePreview');  
    if (mainPreview) mainPreview.style.fontFamily = `'${settings.main}', sans-serif`;  
    if (titlePreview) titlePreview.style.fontFamily = `'${settings.title}', sans-serif`;  
  }  
    
  function resetFontSettings() {  
    localStorage.removeItem(FONT_SETTINGS_KEY);  
    loadFontSettings();  
    showToast('تم إعادة تعيين الخطوط للافتراضي', 'info');  
  }  
    
  // ====== نظام الألوان المتقدم ======  
  const ADVANCED_COLORS_KEY = 'fino_advanced_colors';  
  const defaultAdvancedColors = {  
    primary: '#3b82f6',  
    secondary: '#f59e0b',  
    accent: '#10b981',  
    bgDark: '#0f172a',  
    bgMedium: '#1e3a8a',  
    bgLight: '#3b82f6',  
    splashBg1: '#0f172a',  
    splashBg2: '#1e3a8a',  
    splashBg3: '#3b82f6',  
    landingBg1: '#0f172a',  
    landingBg2: '#1e3a8a',  
    landingBg3: '#1e40af',  
    landingBg4: '#3b82f6',  
    resultBg1: '#0f172a',  
    resultBg2: '#1e3a8a',  
    cardColor: '#ffffff',  
    textDark: '#111827',  
    textMedium: '#374151',  
    textLight: '#6b7280'  
  };  
    
  function applyAdvancedColors() {  
    const colors = {  
      primary: document.getElementById('customPrimaryColor')?.value || defaultAdvancedColors.primary,  
      secondary: document.getElementById('customSecondaryColor')?.value || defaultAdvancedColors.secondary,  
      accent: document.getElementById('customAccentColor')?.value || defaultAdvancedColors.accent,  
      bgDark: document.getElementById('customBgDark')?.value || defaultAdvancedColors.bgDark,  
      bgMedium: document.getElementById('customBgMedium')?.value || defaultAdvancedColors.bgMedium,  
      bgLight: document.getElementById('customBgLight')?.value || defaultAdvancedColors.bgLight,  
      splashBg1: document.getElementById('splashBg1')?.value || defaultAdvancedColors.splashBg1,  
      splashBg2: document.getElementById('splashBg2')?.value || defaultAdvancedColors.splashBg2,  
      splashBg3: document.getElementById('splashBg3')?.value || defaultAdvancedColors.splashBg3,  
      landingBg1: document.getElementById('landingBg1')?.value || defaultAdvancedColors.landingBg1,  
      landingBg2: document.getElementById('landingBg2')?.value || defaultAdvancedColors.landingBg2,  
      landingBg3: document.getElementById('landingBg3')?.value || defaultAdvancedColors.landingBg3,  
      landingBg4: document.getElementById('landingBg4')?.value || defaultAdvancedColors.landingBg4,  
      resultBg1: document.getElementById('resultBg1')?.value || defaultAdvancedColors.resultBg1,  
      resultBg2: document.getElementById('resultBg2')?.value || defaultAdvancedColors.resultBg2,  
      cardColor: document.getElementById('customCardColor')?.value || defaultAdvancedColors.cardColor,  
      textDark: document.getElementById('textDark')?.value || defaultAdvancedColors.textDark,  
      textMedium: document.getElementById('textMedium')?.value || defaultAdvancedColors.textMedium,  
      textLight: document.getElementById('textLight')?.value || defaultAdvancedColors.textLight  
    };  
      
    // حفظ الألوان  
    localStorage.setItem(ADVANCED_COLORS_KEY, JSON.stringify(colors));  
      
    // تطبيق الألوان  
    applyColorsToCSS(colors);  
      
    showToast('تم تطبيق الألوان بنجاح', 'success');  
  }  
    
  function applyColorsToCSS(colors) {  
    const root = document.documentElement;  
      
    // الألوان الرئيسية  
    root.style.setProperty('--color-primary', colors.primary);  
    root.style.setProperty('--color-secondary', colors.secondary);  
    root.style.setProperty('--color-accent', colors.accent);  
    root.style.setProperty('--bg-dark', colors.bgDark);  
    root.style.setProperty('--bg-medium', colors.bgMedium);  
    root.style.setProperty('--bg-light', colors.bgLight);  
      
    // ألوان شاشة البداية  
    root.style.setProperty('--splash-bg-1', colors.splashBg1);  
    root.style.setProperty('--splash-bg-2', colors.splashBg2);  
    root.style.setProperty('--splash-bg-3', colors.splashBg3);  
      
    // ألوان الصفحة الرئيسية  
    root.style.setProperty('--landing-bg-1', colors.landingBg1);  
    root.style.setProperty('--landing-bg-2', colors.landingBg2);  
    root.style.setProperty('--landing-bg-3', colors.landingBg3);  
    root.style.setProperty('--landing-bg-4', colors.landingBg4);  
      
    // ألوان صفحة النتيجة  
    root.style.setProperty('--result-bg-1', colors.resultBg1);  
    root.style.setProperty('--result-bg-2', colors.resultBg2);  
    root.style.setProperty('--bg-card', colors.cardColor);  
      
    // ألوان النصوص  
    root.style.setProperty('--text-dark', colors.textDark);  
    root.style.setProperty('--text-medium', colors.textMedium);  
    root.style.setProperty('--text-light', colors.textLight);  
      
    // تحديث خلفية الصفحة  
    document.body.style.background = `linear-gradient(-45deg, ${colors.bgDark}, ${colors.bgMedium}, ${colors.primary}, ${colors.bgLight})`;  
    document.body.style.backgroundSize = '400% 400%';  
  }  
    
  function loadAdvancedColors() {  
    const saved = localStorage.getItem(ADVANCED_COLORS_KEY);  
    const colors = saved ? JSON.parse(saved) : defaultAdvancedColors;  
      
    // تطبيق الألوان  
    applyColorsToCSS(colors);  
      
    // تحديث الواجهة  
    const inputs = {  
      'customPrimaryColor': colors.primary,  
      'customSecondaryColor': colors.secondary,  
      'customAccentColor': colors.accent,  
      'customBgDark': colors.bgDark,  
      'customBgMedium': colors.bgMedium,  
      'customBgLight': colors.bgLight,  
      'splashBg1': colors.splashBg1,  
      'splashBg2': colors.splashBg2,  
      'splashBg3': colors.splashBg3,  
      'landingBg1': colors.landingBg1,  
      'landingBg2': colors.landingBg2,  
      'landingBg3': colors.landingBg3,  
      'landingBg4': colors.landingBg4,  
      'resultBg1': colors.resultBg1,  
      'resultBg2': colors.resultBg2,  
      'customCardColor': colors.cardColor,  
      'textDark': colors.textDark,  
      'textMedium': colors.textMedium,  
      'textLight': colors.textLight  
    };  
      
    Object.entries(inputs).forEach(([id, value]) => {  
      const el = document.getElementById(id);  
      if (el) el.value = value;  
    });  
  }  
    
  function resetAdvancedColors() {  
    localStorage.removeItem(ADVANCED_COLORS_KEY);  
    loadAdvancedColors();  
    showToast('تم إعادة تعيين الألوان للافتراضي', 'info');  
  }  
    
  // دالة لتحميل شعارات البنوك في الصفحة الرئيسية  
  function loadBankLogosToLanding() {  
    const container = document.getElementById('banksLogosContainer');  
    if (!container) return;  
      
    const logos = getBankLogos();  
    const mainBanks = ['مصرف الراجحي', 'البنك الأهلي السعودي', 'بنك الرياض', 'مصرف الإنماء', 'بنك البلاد'];  
      
    // شعارات احتياطية بالنص إذا لم تتوفر الصور  
    const bankTextLogos = {  
      'مصرف الراجحي': '🏦 الراجحي',  
      'البنك الأهلي السعودي': '🏦 SNB',  
      'بنك الرياض': '🏦 الرياض',  
      'مصرف الإنماء': '🏦 الإنماء',  
      'بنك البلاد': '🏦 البلاد'  
    };  
      
    container.innerHTML = '';  
    mainBanks.forEach(bank => {  
      const logo = logos[bank];  
      if (logo && logo.startsWith('http')) {  
        const img = document.createElement('img');  
        img.src = logo;  
        img.alt = bank;  
        img.title = bank;  
        img.style.cssText = 'height:30px; width:auto; opacity:0.85; filter:brightness(1.1); transition:all 0.3s; background:rgba(255,255,255,0.9); padding:5px 10px; border-radius:8px;';  
        img.onmouseover = function() { this.style.opacity = '1'; this.style.transform = 'scale(1.1)'; };  
        img.onmouseout = function() { this.style.opacity = '0.85'; this.style.transform = 'scale(1)'; };  
        img.onerror = function() {  
          // إذا فشل تحميل الصورة، استخدم النص  
          const span = document.createElement('span');  
          span.textContent = bankTextLogos[bank] || bank;  
          span.style.cssText = 'background:rgba(255,255,255,0.9); padding:8px 12px; border-radius:8px; font-size:12px; font-weight:bold; color:#1e3a8a;';  
          this.replaceWith(span);  
        };  
        container.appendChild(img);  
      } else {  
        // عرض اسم البنك كنص إذا لم يكن هناك شعار  
        const span = document.createElement('span');  
        span.textContent = bankTextLogos[bank] || bank;  
        span.style.cssText = 'background:rgba(255,255,255,0.9); padding:8px 12px; border-radius:8px; font-size:12px; font-weight:bold; color:#1e3a8a; transition:all 0.3s;';  
        span.onmouseover = function() { this.style.transform = 'scale(1.05)'; this.style.background = 'rgba(255,255,255,1)'; };  
        span.onmouseout = function() { this.style.transform = 'scale(1)'; this.style.background = 'rgba(255,255,255,0.9)'; };  
        container.appendChild(span);  
      }  
    });  
  }  
    
  // تحميل شعارات البنوك عند بدء التشغيل  
  setTimeout(loadBankLogosToLanding, 300);  
    
  // ====== نظام إدارة الشعارات ======  
  // المتغيرات معرفة مسبقاً في بداية السكريبت  
    
  // معاينة شعار المنصة  
  function previewLogo(type) {  
    const input = document.getElementById(type + 'LogoUpload');  
    const preview = document.getElementById(type + 'LogoPreview');  
    if (input.files && input.files[0] && preview) {  
      const reader = new FileReader();  
      reader.onload = function(e) {  
        preview.innerHTML = `<img src="${e.target.result}" style="max-width:100%; max-height:100%; object-fit:contain;">`;  
      };  
      reader.readAsDataURL(input.files[0]);  
    }  
  }  
    
  // رفع شعار بنك  
  function uploadBankLogo() {  
    const bankSelect = document.getElementById('bankLogoSelect');  
    const fileInput = document.getElementById('bankLogoUpload');  
    const bank = bankSelect?.value;  
      
    if (!bank) {  
      showToast('اختر البنك أولاً', 'error');  
      return;  
    }  
      
    if (!fileInput.files || !fileInput.files[0]) {  
      showToast('اختر صورة الشعار', 'error');  
      return;  
    }  
      
    const reader = new FileReader();  
    reader.onload = function(e) {  
      const logos = JSON.parse(localStorage.getItem(CUSTOM_LOGOS_KEY) || '{}');  
      logos[bank] = e.target.result;  
      localStorage.setItem(CUSTOM_LOGOS_KEY, JSON.stringify(logos));  
      showToast(`تم رفع شعار ${bank}`, 'success');  
      loadBankLogosGrid();  
      bankSelect.value = '';  
      fileInput.value = '';  
    };  
    reader.readAsDataURL(fileInput.files[0]);  
  }  
    
  // عرض شبكة شعارات البنوك  
  function loadBankLogosGrid() {  
    const grid = document.getElementById('bankLogosGrid');  
    if (!grid) return;  
      
    const customLogos = JSON.parse(localStorage.getItem(CUSTOM_LOGOS_KEY) || '{}');  
    const defaultLogos = getBankLogos();  
    const allLogos = {...defaultLogos, ...customLogos};  
      
    grid.innerHTML = '';  
    Object.entries(allLogos).forEach(([bank, logo]) => {  
      if (logo) {  
        const div = document.createElement('div');  
        div.style.cssText = 'text-align:center; padding:10px; background:#f8fafc; border-radius:8px;';  
        div.innerHTML = `  
          <img src="${logo}" style="height:30px; width:auto; margin-bottom:5px;" alt="${bank}">  
          <div style="font-size:10px; color:#6b7280; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${bank}</div>  
          ${customLogos[bank] ? `<button onclick="removeBankLogo('${bank}')" style="margin-top:5px; padding:3px 8px; font-size:10px; background:#ef4444; color:#fff; border:none; border-radius:4px; cursor:pointer;">حذف</button>` : ''}  
        `;  
        grid.appendChild(div);  
      }  
    });  
  }  
    
  // حذف شعار بنك مخصص  
  function removeBankLogo(bank) {  
    const logos = JSON.parse(localStorage.getItem(CUSTOM_LOGOS_KEY) || '{}');  
    delete logos[bank];  
    localStorage.setItem(CUSTOM_LOGOS_KEY, JSON.stringify(logos));  
    loadBankLogosGrid();  
    showToast(`تم حذف شعار ${bank}`, 'info');  
  }  
    
  // إضافة شعار جهة عمل  
  function addEmployerLogo() {  
    const nameInput = document.getElementById('employerNameInput');  
    const fileInput = document.getElementById('employerLogoUpload');  
    const name = nameInput?.value?.trim();  
      
    if (!name) {  
      showToast('أدخل اسم جهة العمل', 'error');  
      return;  
    }  
      
    if (!fileInput.files || !fileInput.files[0]) {  
      showToast('اختر صورة الشعار', 'error');  
      return;  
    }  
      
    const reader = new FileReader();  
    reader.onload = function(e) {  
      const logos = JSON.parse(localStorage.getItem(EMPLOYER_LOGOS_KEY) || '{}');  
      logos[name] = e.target.result;  
      localStorage.setItem(EMPLOYER_LOGOS_KEY, JSON.stringify(logos));  
      showToast(`تم إضافة جهة العمل: ${name}`, 'success');  
      loadEmployerLogosGrid();  
      nameInput.value = '';  
      fileInput.value = '';  
    };  
    reader.readAsDataURL(fileInput.files[0]);  
  }  
    
  // عرض شبكة شعارات جهات العمل  
  function loadEmployerLogosGrid() {  
    const grid = document.getElementById('employerLogosGrid');  
    if (!grid) return;  
      
    const logos = JSON.parse(localStorage.getItem(EMPLOYER_LOGOS_KEY) || '{}');  
      
    grid.innerHTML = '';  
    Object.entries(logos).forEach(([name, logo]) => {  
      const div = document.createElement('div');  
      div.style.cssText = 'text-align:center; padding:10px; background:#f8fafc; border-radius:8px;';  
      div.innerHTML = `  
        <img src="${logo}" style="height:35px; width:auto; margin-bottom:5px;" alt="${name}">  
        <div style="font-size:10px; color:#6b7280; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${name}</div>  
        <button onclick="removeEmployerLogo('${name}')" style="margin-top:5px; padding:3px 8px; font-size:10px; background:#ef4444; color:#fff; border:none; border-radius:4px; cursor:pointer;">حذف</button>  
      `;  
      grid.appendChild(div);  
    });  
  }  
    
  // حذف شعار جهة عمل  
  function removeEmployerLogo(name) {  
    const logos = JSON.parse(localStorage.getItem(EMPLOYER_LOGOS_KEY) || '{}');  
    delete logos[name];  
    localStorage.setItem(EMPLOYER_LOGOS_KEY, JSON.stringify(logos));  
    loadEmployerLogosGrid();  
    showToast(`تم حذف جهة العمل: ${name}`, 'info');  
  }  
    
  // رفع شعار منتج  
  function uploadProductLogo() {  
    const productSelect = document.getElementById('productLogoSelect');  
    const fileInput = document.getElementById('productLogoUpload');  
    const product = productSelect?.value;  
      
    if (!product) {  
      showToast('اختر المنتج أولاً', 'error');  
      return;  
    }  
      
    if (!fileInput.files || !fileInput.files[0]) {  
      showToast('اختر صورة الشعار', 'error');  
      return;  
    }  
      
    const reader = new FileReader();  
    reader.onload = function(e) {  
      const logos = JSON.parse(localStorage.getItem(PRODUCT_LOGOS_KEY) || '{}');  
      logos[product] = e.target.result;  
      localStorage.setItem(PRODUCT_LOGOS_KEY, JSON.stringify(logos));  
      showToast(`تم رفع شعار ${product}`, 'success');  
      loadProductLogosGrid();  
      productSelect.value = '';  
      fileInput.value = '';  
    };  
    reader.readAsDataURL(fileInput.files[0]);  
  }  
    
  // عرض شبكة شعارات المنتجات  
  function loadProductLogosGrid() {  
    const grid = document.getElementById('productLogosGrid');  
    if (!grid) return;  
      
    const logos = JSON.parse(localStorage.getItem(PRODUCT_LOGOS_KEY) || '{}');  
      
    grid.innerHTML = '';  
    Object.entries(logos).forEach(([product, logo]) => {  
      const div = document.createElement('div');  
      div.style.cssText = 'text-align:center; padding:10px; background:#f8fafc; border-radius:8px;';  
      div.innerHTML = `  
        <img src="${logo}" style="height:35px; width:auto; margin-bottom:5px;" alt="${product}">  
        <div style="font-size:10px; color:#6b7280; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${product}</div>  
        <button onclick="removeProductLogo('${product}')" style="margin-top:5px; padding:3px 8px; font-size:10px; background:#ef4444; color:#fff; border:none; border-radius:4px; cursor:pointer;">حذف</button>  
      `;  
      grid.appendChild(div);  
    });  
  }  
    
  // حذف شعار منتج  
  function removeProductLogo(product) {  
    const logos = JSON.parse(localStorage.getItem(PRODUCT_LOGOS_KEY) || '{}');  
    delete logos[product];  
    localStorage.setItem(PRODUCT_LOGOS_KEY, JSON.stringify(logos));  
    loadProductLogosGrid();  
    showToast(`تم حذف شعار ${product}`, 'info');  
  }  
    
  // حفظ جميع الشعارات  
  function saveAllLogos() {  
    // حفظ شعار المنصة  
    const platformInput = document.getElementById('platformLogoUpload');  
    if (platformInput?.files && platformInput.files[0]) {  
      const reader = new FileReader();  
      reader.onload = function(e) {  
        localStorage.setItem(PLATFORM_LOGO_KEY, e.target.result);  
      };  
      reader.readAsDataURL(platformInput.files[0]);  
    }  
      
    showToast('تم حفظ جميع الشعارات بنجاح', 'success');  
    loadBankLogosToLanding();  
  }  
    
  // إعادة تعيين جميع الشعارات  
  function resetAllLogos() {  
    if (confirm('هل أنت متأكد من إعادة تعيين جميع الشعارات؟')) {  
      localStorage.removeItem(CUSTOM_LOGOS_KEY);  
      localStorage.removeItem(EMPLOYER_LOGOS_KEY);  
      localStorage.removeItem(PRODUCT_LOGOS_KEY);  
      localStorage.removeItem(PLATFORM_LOGO_KEY);  
      loadBankLogosGrid();  
      loadEmployerLogosGrid();  
      loadProductLogosGrid();  
      loadBankLogosToLanding();  
      showToast('تم إعادة تعيين جميع الشعارات', 'info');  
    }  
  }  
    
  // تحميل شبكات الشعارات عند فتح صفحة الثيمات  
  setTimeout(() => {  
    loadBankLogosGrid();  
    loadEmployerLogosGrid();  
    loadProductLogosGrid();  
  }, 500);  
    
  // ====== نظام تعديلات النسب حسب وضع العميل ======  
  const RATE_ADJUSTMENTS_KEY = 'fino_rate_adjustments';  

  // تعديلات النسب الافتراضية للبنك الأهلي
  const defaultRateAdjustments = [
    {
      bankName: 'البنك الأهلي السعودي',
      financeType: 'mortgage',
      type: 'personalLoan',
      name: 'التزام شخصي قائم (الأهلي)',
      value: 0.90,
      startDate: '',
      endDate: '',
      note: '+90 نقطة إذا كان على العميل التزام/قرض شخصي',
      enabled: true,
      createdAt: new Date().toISOString()
    },
    {
      bankName: 'البنك الأهلي السعودي',
      financeType: 'mortgage',
      type: 'supportAdvance',
      name: 'الدعم المقدم (الأهلي)',
      value: 0.90,
      startDate: '',
      endDate: '',
      note: '+90 نقطة إذا كان العميل يبغى الدعم المقدم',
      enabled: true,
      createdAt: new Date().toISOString()
    }
  ];

  // تهيئة تعديلات النسب الافتراضية
  (function initDefaultRateAdjustments() {
    const existingAdjustments = JSON.parse(localStorage.getItem(RATE_ADJUSTMENTS_KEY) || '[]');
    if (existingAdjustments.length === 0) {
      localStorage.setItem(RATE_ADJUSTMENTS_KEY, JSON.stringify(defaultRateAdjustments));
    }
  })();
    
  // أنواع التعديلات  
  const adjustmentTypes = {  
    supportAdvance: 'الدعم المقدم',  
    personalLoan: 'التزام شخصي قائم',  
    mortgageLoan: 'التزام عقاري قائم',  
    creditCard: 'بطاقة ائتمانية',  
    newCustomer: 'عميل جديد',  
    salaryTransfer: 'تحويل راتب',  
    noSalaryTransfer: 'بدون تحويل راتب',  
    custom: 'تعديل مخصص'  
  };  
    
  // تحديث اسم التعديل عند اختيار النوع  
  function updateAdjustmentOptions() {  
    const type = document.getElementById('adjType')?.value;  
    const nameInput = document.getElementById('adjName');  
    if (type && adjustmentTypes[type] && nameInput) {  
      nameInput.value = adjustmentTypes[type];  
    }  
  }  
    
  // حفظ تعديل النسبة  
  function saveRateAdjustment(e) {  
    e.preventDefault();  
      
    const adj = {  
      bankName: document.getElementById('adjBankName')?.value || '',  
      financeType: document.getElementById('adjFinanceType')?.value || 'الكل',  
      type: document.getElementById('adjType')?.value || '',  
      name: document.getElementById('adjName')?.value || '',  
      value: parseFloat(document.getElementById('adjValue')?.value) || 0,  
      startDate: document.getElementById('adjStartDate')?.value || '',  
      endDate: document.getElementById('adjEndDate')?.value || '',  
      note: document.getElementById('adjNote')?.value || '',
      includeEtezaaz: document.getElementById('adjIncludeEtezaaz')?.checked || false,  
      enabled: true,  
      createdAt: new Date().toISOString()  
    };  
      
    if (!adj.bankName || !adj.type || adj.value === 0) {  
      showToast('يرجى ملء جميع الحقول المطلوبة', 'error');  
      return;  
    }  
      
    const adjustments = JSON.parse(localStorage.getItem(RATE_ADJUSTMENTS_KEY) || '[]');  
    const editIndex = document.getElementById('adjEditIndex')?.value;  
      
    if (editIndex !== '' && editIndex !== undefined) {  
      adjustments[parseInt(editIndex)] = adj;  
    } else {  
      adjustments.push(adj);  
    }  
      
    localStorage.setItem(RATE_ADJUSTMENTS_KEY, JSON.stringify(adjustments));  
    showToast('تم حفظ تعديل النسبة بنجاح', 'success');  
    clearAdjustmentForm();  
    loadRateAdjustmentsTable();  
  }  
    
  // مسح نموذج التعديل  
  function clearAdjustmentForm() {  
    document.getElementById('adjBankName').value = '';  
    document.getElementById('adjFinanceType').value = 'الكل';  
    document.getElementById('adjType').value = '';  
    document.getElementById('adjName').value = '';  
    document.getElementById('adjValue').value = '';  
    document.getElementById('adjStartDate').value = '';  
    document.getElementById('adjEndDate').value = '';  
    document.getElementById('adjNote').value = '';
    if (document.getElementById('adjIncludeEtezaaz')) document.getElementById('adjIncludeEtezaaz').checked = false;  
    document.getElementById('adjEditIndex').value = '';  
  }  
    
  // تحميل جدول تعديلات النسب  
  function loadRateAdjustmentsTable() {  
    const tbody = document.getElementById('rateAdjustmentsBody');  
    if (!tbody) return;  
      
    const adjustments = JSON.parse(localStorage.getItem(RATE_ADJUSTMENTS_KEY) || '[]');  
      
    if (adjustments.length === 0) {  
      tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:#9ca3af; padding:20px;">لا توجد تعديلات محفوظة</td></tr>';  
      return;  
    }  
      
    tbody.innerHTML = adjustments.map((adj, i) => {  
      const financeTypeNames = {  
        'الكل': 'الكل',  
        'personal': 'شخصي',  
        'mortgage': 'عقاري',  
        'buyoutPersonal': 'شراء مديونية شخصي',  
        'buyoutMortgage': 'شراء مديونية عقاري'  
      };  
      const valueColor = adj.value > 0 ? '#ef4444' : '#10b981';  
      const valueSign = adj.value > 0 ? '+' : '';  
      return `  
        <tr>  
          <td>${adj.bankName}</td>  
          <td>${financeTypeNames[adj.financeType] || adj.financeType}</td>  
          <td>${adjustmentTypes[adj.type] || adj.type}</td>  
          <td>${adj.name}</td>  
          <td style="color:${valueColor}; font-weight:700;">${valueSign}${adj.value}%</td>  
          <td>${adj.startDate || '-'}</td>  
          <td>${adj.endDate || '-'}</td>  
          <td style="font-size:11px;">${adj.note || '-'}</td>  
          <td>  
            <button onclick="editRateAdjustment(${i})" style="padding:3px 8px; font-size:11px; background:#3b82f6; color:#fff; border:none; border-radius:4px; cursor:pointer; margin-left:4px;">تعديل</button>  
            <button onclick="deleteRateAdjustment(${i})" style="padding:3px 8px; font-size:11px; background:#ef4444; color:#fff; border:none; border-radius:4px; cursor:pointer;">حذف</button>  
          </td>  
        </tr>  
      `;  
    }).join('');  
  }  
    
  // تعديل تعديل النسبة  
  function editRateAdjustment(index) {  
    const adjustments = JSON.parse(localStorage.getItem(RATE_ADJUSTMENTS_KEY) || '[]');  
    const adj = adjustments[index];  
    if (!adj) return;  
      
    document.getElementById('adjBankName').value = adj.bankName;  
    document.getElementById('adjFinanceType').value = adj.financeType;  
    document.getElementById('adjType').value = adj.type;  
    document.getElementById('adjName').value = adj.name;  
    document.getElementById('adjValue').value = adj.value;  
    document.getElementById('adjStartDate').value = adj.startDate;  
    document.getElementById('adjEndDate').value = adj.endDate;  
    document.getElementById('adjNote').value = adj.note;
    if (document.getElementById('adjIncludeEtezaaz')) document.getElementById('adjIncludeEtezaaz').checked = adj.includeEtezaaz || false;  
    document.getElementById('adjEditIndex').value = index;  
  }  
    
  // حذف تعديل النسبة  
  function deleteRateAdjustment(index) {  
    if (!confirm('هل أنت متأكد من حذف هذا التعديل؟')) return;  
      
    const adjustments = JSON.parse(localStorage.getItem(RATE_ADJUSTMENTS_KEY) || '[]');  
    adjustments.splice(index, 1);  
    localStorage.setItem(RATE_ADJUSTMENTS_KEY, JSON.stringify(adjustments));  
    loadRateAdjustmentsTable();  
    showToast('تم حذف التعديل', 'info');  
  }  
    
  // الحصول على تعديلات النسبة المطبقة على عميل معين  
  // ملاحظة: نسب اعتزاز لا تُطبق عليها التعديلات التراكمية إلا إذا فعّلها المسؤول بإضافة includeEtezaaz: true
  function getApplicableRateAdjustments(bankName, financeType, clientConditions, isEtezaazRate = false) {  
    const adjustments = JSON.parse(localStorage.getItem(RATE_ADJUSTMENTS_KEY) || '[]');  
    const now = new Date();  
      
    return adjustments.filter(adj => {  
      if (!adj.enabled) return false;  
        
      // ✅ إذا كانت النسبة من نوع اعتزاز، لا تطبق التعديلات إلا إذا كان التعديل يشمل اعتزاز
      if (isEtezaazRate && !adj.includeEtezaaz) return false;
        
      // فلترة الجهة  
      if (adj.bankName !== 'الكل' && adj.bankName !== bankName) return false;  
        
      // فلترة نوع التمويل  
      if (adj.financeType !== 'الكل' && adj.financeType !== financeType) return false;  
        
      // فلترة التاريخ  
      if (adj.startDate && new Date(adj.startDate) > now) return false;  
      if (adj.endDate && new Date(adj.endDate) < now) return false;  
        
      // فلترة حالة العميل  
      if (clientConditions) {  
        if (adj.type === 'supportAdvance' && !clientConditions.supportAdvance) return false;  
        if (adj.type === 'personalLoan' && !clientConditions.hasPersonalLoan) return false;  
        if (adj.type === 'mortgageLoan' && !clientConditions.hasMortgageLoan) return false;  
        if (adj.type === 'creditCard' && !clientConditions.hasCreditCard) return false;  
        if (adj.type === 'newCustomer' && !clientConditions.isNewCustomer) return false;  
        if (adj.type === 'salaryTransfer' && !clientConditions.salaryTransfer) return false;  
        if (adj.type === 'noSalaryTransfer' && clientConditions.salaryTransfer) return false;  
      }  
        
      return true;  
    });  
  }  
    
  // حساب النسبة النهائية بعد التعديلات  
  // isEtezaazRate: إذا كانت النسبة من نوع اعتزاز، لا تطبق التعديلات التراكمية
  function calculateAdjustedRate(baseRate, bankName, financeType, clientConditions, isEtezaazRate = false) {  
    const applicableAdjustments = getApplicableRateAdjustments(bankName, financeType, clientConditions, isEtezaazRate);  
    let totalAdjustment = 0;  
    const appliedAdjustments = [];  
      
    applicableAdjustments.forEach(adj => {  
      totalAdjustment += adj.value;  
      appliedAdjustments.push({  
        name: adj.name,  
        value: adj.value,  
        note: adj.note,  
        endDate: adj.endDate  
      });  
    });  
      
    return {  
      originalRate: baseRate,  
      adjustedRate: baseRate + totalAdjustment,  
      totalAdjustment: totalAdjustment,  
      appliedAdjustments: appliedAdjustments  
    };  
  }  
    
  // تحديث قائمة البنوك في نموذج التعديلات  
  function updateAdjustmentBanksList() {  
    const select = document.getElementById('adjBankName');  
    if (!select) return;  
      
    // الحصول على البنوك من قائمة adminBankName  
    const adminBankSelect = document.getElementById('adminBankName');  
    if (adminBankSelect) {  
      const currentValue = select.value;  
      select.innerHTML = '<option value="">اختر الجهة...</option><option value="الكل">جميع الجهات</option>';  
        
      Array.from(adminBankSelect.options).forEach(opt => {  
        if (opt.value && opt.value !== '' && opt.value !== 'بنك آخر') {  
          const option = document.createElement('option');  
          option.value = opt.text;  
          option.textContent = opt.text;  
          select.appendChild(option);  
        }  
      });  
        
      // إضافة الجهات المضافة من المسؤول  
      const customBanks = JSON.parse(localStorage.getItem('fino_custom_banks') || '[]');  
      customBanks.forEach(bank => {  
        const option = document.createElement('option');  
        option.value = bank.name;  
        option.textContent = bank.name;  
        select.appendChild(option);  
      });  
        
      select.value = currentValue;  
    }  
  }  
    
  // تحميل جدول التعديلات عند فتح صفحة الإعدادات  
  setTimeout(() => {  
    loadRateAdjustmentsTable();  
    updateAdjustmentBanksList();  
  }, 600);  
    
  // إظهار حقل الجهة الجديدة عند اختيارها  
  document.addEventListener('DOMContentLoaded', function() {  
    const entitySelect = document.getElementById('fpFinanceEntity');  
    const newEntityInput = document.getElementById('fpNewEntityName');  
      
    if (entitySelect && newEntityInput) {  
      entitySelect.addEventListener('change', function() {  
        if (this.value === 'جهة جديدة') {  
          newEntityInput.style.display = 'block';  
          newEntityInput.focus();  
        } else {  
          newEntityInput.style.display = 'none';  
          newEntityInput.value = '';  
        }  
      });  
    }  
      
    // تحديث قائمة جهات التمويل بالجهات المخصصة  
    updateFinanceEntityDropdown();  
      
    // إظهار حقل التاريخ المخصص عند اختيار "تاريخ مخصص"  
    const rateExpirySelect = document.getElementById('adminRateExpiry');  
    const rateExpiryCustom = document.getElementById('adminRateExpiryCustom');  
    if (rateExpirySelect && rateExpiryCustom) {  
      rateExpirySelect.addEventListener('change', function() {  
        if (this.value === 'custom') {  
          rateExpiryCustom.style.display = 'block';  
          rateExpiryCustom.focus();  
        } else {  
          rateExpiryCustom.style.display = 'none';  
          rateExpiryCustom.value = '';  
        }  
      });  
    }  
  });  
    
  // ====== دالة الحصول على جهات التمويل لواجهة العميل ======  
  // تستخدم الدالة المركزية getMasterFinanceEntitiesList()  
  function getAllFinanceEntities() {  
    // استخدام الدالة المركزية للحصول على نفس قائمة المسؤول  
    const allEntities = getMasterFinanceEntitiesList();  
    return allEntities.map(e => e.name);  
  }  
  
  function updateFinanceEntityDropdown() {  
    const entitySelect = document.getElementById('fpFinanceEntity');  
    if (!entitySelect) return;  
      
    const allEntities = getAllFinanceEntities();  
    const lastOption = entitySelect.lastElementChild;  
      
    // إزالة الخيارات الحالية باستثناء الأول والأخير (إضافة جهة جديدة)  
    const firstOption = entitySelect.firstElementChild;  
    const allOptions = Array.from(entitySelect.options);  
      
    // الاحتفاظ بـ "اختر جهة التمويل" و "الكل" و "إضافة جهة جديدة"  
    entitySelect.innerHTML = '';  
    entitySelect.appendChild(firstOption);  
      
    const allOpt = document.createElement('option');  
    allOpt.value = 'الكل';  
    allOpt.textContent = '✅ الكل (جميع جهات التمويل)';  
    allOpt.style.background = '#dcfce7';  
    allOpt.style.fontWeight = 'bold';  
    entitySelect.appendChild(allOpt);  
      
    allEntities.forEach(name => {  
      if (name !== 'الكل') {  
        const opt = document.createElement('option');  
        opt.value = name;  
        opt.textContent = name;  
        entitySelect.appendChild(opt);  
      }  
    });  
      
    const newOpt = document.createElement('option');  
    newOpt.value = 'جهة جديدة';  
    newOpt.textContent = '➕ إضافة جهة جديدة';  
    entitySelect.appendChild(newOpt);  
  }  
    
  // دالة تحديث جميع قوائم البنوك وجهات التمويل  
  function updateAllBankDropdowns() {  
    // تحديث قائمة جهات التمويل في صفحة المنتجات  
    updateFinanceEntityDropdown();  
      
    // تحديث قائمة البنوك في صفحة النسب  
    if (typeof updateAdjustmentBanksList === 'function') {  
      updateAdjustmentBanksList();  
    }  
      
    // تحديث قائمة البنوك في صفحة تعديل النسب  
    const bankSelect = document.getElementById('bankSelect');  
    if (bankSelect) {  
      const currentValue = bankSelect.value;  
      const customBanks = JSON.parse(localStorage.getItem('fino_custom_banks') || '[]');  
        
      // إزالة البنوك المخصصة السابقة  
      const customOptions = bankSelect.querySelectorAll('option[data-custom="true"]');  
      customOptions.forEach(opt => opt.remove());  
        
      // إضافة البنوك المخصصة  
      customBanks.forEach(bank => {  
        const opt = document.createElement('option');  
        opt.value = bank.name;  
        opt.textContent = bank.name;  
        opt.dataset.custom = 'true';  
        bankSelect.appendChild(opt);  
      });  
        
      bankSelect.value = currentValue;  
    }  
      
    console.log('تم تحديث جميع قوائم البنوك وجهات التمويل');  
  }  
    
  // دالة تحديث خلفية البطاقة الرئيسية  
  function updateCardBackground() {  
    const color = document.getElementById('settingsCardBgColor')?.value || '#ffffff';  
    const opacity = parseInt(document.getElementById('settingsCardOpacity')?.value) || 95;  
    const blur = parseInt(document.getElementById('settingsCardBlur')?.value) || 10;  
    const transparent = document.getElementById('settingsCardTransparent')?.checked || false;  
      
    // تحديث العرض  
    const opacityValue = document.getElementById('cardOpacityValue');  
    const blurValue = document.getElementById('cardBlurValue');  
    if (opacityValue) opacityValue.textContent = opacity + '%';  
    if (blurValue) blurValue.textContent = blur + 'px';  
      
    // تطبيق على البطاقة  
    const landingCard = document.querySelector('.landing-card');  
    if (landingCard) {  
      if (transparent) {  
        landingCard.style.background = 'transparent';  
        landingCard.style.backdropFilter = 'none';  
      } else {  
        const r = parseInt(color.slice(1,3), 16);  
        const g = parseInt(color.slice(3,5), 16);  
        const b = parseInt(color.slice(5,7), 16);  
        landingCard.style.background = `rgba(${r}, ${g}, ${b}, ${opacity / 100})`;  
        landingCard.style.backdropFilter = `blur(${blur}px)`;  
      }  
    }  
  }  
  window.updateCardBackground = updateCardBackground;  
    
  // تصدير الدوال الرئيسية إلى window لتكون متاحة للأزرار  
  window.showPage = showPage;  
  // window.startClientFlow معرّفة مسبقاً  
  window.backToLanding = backToLanding;  
  window.openMiniAdminTools = openMiniAdminTools;  
  window.resetCalc = resetCalc;  
  window.showQuestion = showQuestion;  
  window.nextStep = nextStep;  
  window.prevStep = prevStep;  
  window.showResult = showResult;  
  window.backToFinanceType = backToFinanceType;  
  window.hideSplashScreen = hideSplashScreen;  
  window.testSplashScreen = testSplashScreen;  
    
  // دالة سرية للوصول للوحة المسؤول (5 ضغطات على الشعار)  
  window._logoClickCount = 0;  
  window._logoClickTimer = null;  
  window.handleLogoClick = function() {  
    window._logoClickCount++;  
    clearTimeout(window._logoClickTimer);  
    window._logoClickTimer = setTimeout(function() { window._logoClickCount = 0; }, 2000);  
      
    if (window._logoClickCount >= 5) {  
      window._logoClickCount = 0;  
      if (typeof window.openMiniAdminTools === 'function') {  
        window.openMiniAdminTools();  
      }  
    }  
  };  
    
  console.log('[FINO] تم تصدير الدوال الرئيسية إلى window');  
  
  // ====== إدارة جهات الوظيفة ======  
  window.EMPLOYERS_LIST_KEY = 'fino_employers_list';  
  window.defaultEmployers = [  
    { name: 'أرامكو', icon: '🛢️' },  
    { name: 'سابك', icon: '🏭' },  
    { name: 'ستك', icon: '📞' },  
    { name: 'الاتصالات السعودية', icon: '📱' },  
    { name: 'موبايلي', icon: '📲' },  
    { name: 'زين', icon: '📶' },  
    { name: 'الكهرباء السعودية', icon: '⚡' },  
    { name: 'الخطوط السعودية', icon: '✈️' },  
    { name: 'وزارة الصحة', icon: '🏥' },  
    { name: 'وزارة التعليم', icon: '🏫' },  
    { name: 'وزارة الدفاع', icon: '🏛️' },  
    { name: 'وزارة الداخلية', icon: '🚨' },  
    { name: 'الحرس الوطني', icon: '🛡️' },  
    { name: 'الأمن العام', icon: '👮' },  
    { name: 'الجوازات', icon: '🛂' },  
    { name: 'الدفاع المدني', icon: '🚒' },  
    { name: 'الصحة القابضة', icon: '🏥' },  
    { name: 'وزارة العدل', icon: '⚖️' },  
    { name: 'وزارة المالية', icon: '💰' },  
    { name: 'وزارة الإسكان', icon: '🏠' }  
  ];  
    
  window.getEmployersList = function() {  
    try {  
      const saved = localStorage.getItem(window.EMPLOYERS_LIST_KEY);  
      return saved ? JSON.parse(saved) : [...window.defaultEmployers];  
    } catch (e) {  
      return [...window.defaultEmployers];  
    }  
  }  
    
  window.loadEmployersList = function() {  
    const container = document.getElementById('employersList');  
    if (!container) return;  
      
    const employers = window.getEmployersList();  
    container.innerHTML = '';  
      
    employers.forEach((emp, index) => {  
      const div = document.createElement('div');  
      div.style.cssText = 'display:flex; align-items:center; gap:10px; padding:10px; background:#fff; border-radius:8px; border:1px solid #e5e7eb;';  
      div.innerHTML = `  
        <span style="font-size:20px;">${emp.icon || '🏢'}</span>  
        <input type="text" value="${emp.name}" onchange="updateEmployerName(${index}, this.value)" style="flex:1; padding:8px; border:1px solid #d1d5db; border-radius:6px;">  
        <input type="text" value="${emp.icon || ''}" onchange="updateEmployerIcon(${index}, this.value)" placeholder="🏢" style="width:50px; padding:8px; border:1px solid #d1d5db; border-radius:6px; text-align:center;">  
        <button onclick="deleteEmployer(${index})" style="background:#ef4444; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">🗑️</button>  
      `;  
      container.appendChild(div);  
    });  
  }  
    
  window.addNewEmployer = function() {  
    const nameInput = document.getElementById('newEmployerName');  
    const iconInput = document.getElementById('newEmployerIcon');  
    const name = nameInput?.value?.trim();  
    const icon = iconInput?.value?.trim() || '🏢';  
      
    if (!name) {  
      showToast('أدخل اسم الجهة', 'error');  
      return;  
    }  
      
    const employers = window.getEmployersList();  
    if (employers.find(e => e.name === name)) {  
      showToast('هذه الجهة موجودة بالفعل', 'error');  
      return;  
    }  
      
    employers.push({ name, icon });  
    localStorage.setItem(window.EMPLOYERS_LIST_KEY, JSON.stringify(employers));  
    window.loadEmployersList();  
    window.updateAllEmployerDropdowns();  
    nameInput.value = '';  
    iconInput.value = '';  
    showToast(`تم إضافة الجهة: ${name}`, 'success');  
  };  
    
  window.updateEmployerName = function(index, newName) {  
    const employers = window.getEmployersList();  
    if (employers[index]) {  
      employers[index].name = newName;  
      localStorage.setItem(window.EMPLOYERS_LIST_KEY, JSON.stringify(employers));  
      window.updateAllEmployerDropdowns();  
    }  
  };  
    
  window.updateEmployerIcon = function(index, newIcon) {  
    const employers = window.getEmployersList();  
    if (employers[index]) {  
      employers[index].icon = newIcon;  
      localStorage.setItem(window.EMPLOYERS_LIST_KEY, JSON.stringify(employers));  
      window.loadEmployersList();  
    }  
  };  
    
  window.deleteEmployer = function(index) {  
    const employers = window.getEmployersList();  
    const deleted = employers.splice(index, 1);  
    localStorage.setItem(window.EMPLOYERS_LIST_KEY, JSON.stringify(employers));  
    window.loadEmployersList();  
    window.updateAllEmployerDropdowns();  
    showToast(`تم حذف الجهة: ${deleted[0]?.name}`, 'info');  
  };  
    
  window.saveEmployersList = function() {  
    showSaveConfirmation('تم حفظ جهات الوظيفة بنجاح');  
    window.updateAllEmployerDropdowns();  
  };  
    
  window.resetEmployersList = function() {  
    if (confirm('هل تريد إعادة تعيين جهات الوظيفة للقيم الافتراضية؟')) {  
      localStorage.setItem(window.EMPLOYERS_LIST_KEY, JSON.stringify(window.defaultEmployers));  
      window.loadEmployersList();  
      window.updateAllEmployerDropdowns();  
      showToast('تم إعادة تعيين جهات الوظيفة', 'info');  
    }  
  };  
    
  window.updateAllEmployerDropdowns = function() {  
    const employers = window.getEmployersList();  
      
    // تحديث قائمة العروض  
    const offerSelect = document.getElementById('offerTargetEmployer');  
    if (offerSelect) {  
      const currentValue = offerSelect.value;  
      offerSelect.innerHTML = '<option value="">الكل</option>';  
      employers.forEach(emp => {  
        offerSelect.innerHTML += `<option value="${emp.name}">${emp.icon} ${emp.name}</option>`;  
      });  
      offerSelect.value = currentValue;  
    }  
      
    // تحديث قائمة البحث عن العروض  
    const searchSelect = document.getElementById('searchOfferEmployer');  
    if (searchSelect) {  
      const currentValue = searchSelect.value;  
      searchSelect.innerHTML = '<option value="">اختر جهة العمل...</option>';  
      employers.forEach(emp => {  
        searchSelect.innerHTML += `<option value="${emp.name}">${emp.icon} ${emp.name}</option>`;  
      });  
      searchSelect.value = currentValue;  
    }  
  }  
    
  // ====== إدارة جهات التمويل ======  
  const FINANCE_ENTITIES_KEY = 'fino_finance_entities';  
    
  function getFinanceEntitiesList() {  
    try {  
      const saved = localStorage.getItem(FINANCE_ENTITIES_KEY);  
      if (saved) return JSON.parse(saved);  
      // استخدام القائمة المركزية الموجودة  
      return getMasterFinanceEntitiesList().map(e => ({  
        name: e.name,  
        type: e.category.includes('بنك') ? 'بنك' : e.category.includes('شركة') ? 'شركة تمويل' : 'تقنية مالية',  
        icon: e.icon  
      }));  
    } catch (e) {  
      return [];  
    }  
  }  
    
  function loadFinanceEntitiesList() {  
    const container = document.getElementById('financeEntitiesList');  
    if (!container) return;  
      
    const entities = getFinanceEntitiesList();  
    container.innerHTML = '';  
      
    entities.forEach((entity, index) => {  
      const div = document.createElement('div');  
      div.style.cssText = 'display:flex; align-items:center; gap:10px; padding:10px; background:#fff; border-radius:8px; border:1px solid #e5e7eb;';  
      div.innerHTML = `  
        <span style="font-size:20px;">${entity.icon || '🏦'}</span>  
        <input type="text" value="${entity.name}" onchange="updateFinanceEntityName(${index}, this.value)" style="flex:1; padding:8px; border:1px solid #d1d5db; border-radius:6px;">  
        <select onchange="updateFinanceEntityType(${index}, this.value)" style="padding:8px; border:1px solid #d1d5db; border-radius:6px;">  
          <option value="بنك" ${entity.type === 'بنك' ? 'selected' : ''}>🏦 بنك</option>  
          <option value="شركة تمويل" ${entity.type === 'شركة تمويل' ? 'selected' : ''}>🏢 شركة تمويل</option>  
          <option value="تقنية مالية" ${entity.type === 'تقنية مالية' ? 'selected' : ''}>📱 تقنية مالية</option>  
        </select>  
        <input type="text" value="${entity.icon || ''}" onchange="updateFinanceEntityIcon(${index}, this.value)" placeholder="🏦" style="width:50px; padding:8px; border:1px solid #d1d5db; border-radius:6px; text-align:center;">  
        <button onclick="deleteFinanceEntity(${index})" style="background:#ef4444; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">🗑️</button>  
      `;  
      container.appendChild(div);  
    });  
  }  
    
  window.addNewFinanceEntity = function() {  
    const nameInput = document.getElementById('newFinanceEntityName');  
    const typeSelect = document.getElementById('newFinanceEntityType');  
    const iconInput = document.getElementById('newFinanceEntityIcon');  
    const name = nameInput?.value?.trim();  
    const type = typeSelect?.value || 'بنك';  
    const icon = iconInput?.value?.trim() || '🏦';  
      
    if (!name) {  
      showToast('أدخل اسم جهة التمويل', 'error');  
      return;  
    }  
      
    const entities = getFinanceEntitiesList();  
    if (entities.find(e => e.name === name)) {  
      showToast('هذه الجهة موجودة بالفعل', 'error');  
      return;  
    }  
      
    entities.push({ name, type, icon });  
    localStorage.setItem(FINANCE_ENTITIES_KEY, JSON.stringify(entities));  
    loadFinanceEntitiesList();  
    nameInput.value = '';  
    iconInput.value = '';  
    showToast(`تم إضافة جهة التمويل: ${name}`, 'success');  
  };  
    
  window.updateFinanceEntityName = function(index, newName) {  
    const entities = getFinanceEntitiesList();  
    if (entities[index]) {  
      entities[index].name = newName;  
      localStorage.setItem(FINANCE_ENTITIES_KEY, JSON.stringify(entities));  
    }  
  };  
    
  window.updateFinanceEntityType = function(index, newType) {  
    const entities = getFinanceEntitiesList();  
    if (entities[index]) {  
      entities[index].type = newType;  
      localStorage.setItem(FINANCE_ENTITIES_KEY, JSON.stringify(entities));  
    }  
  };  
    
  window.updateFinanceEntityIcon = function(index, newIcon) {  
    const entities = getFinanceEntitiesList();  
    if (entities[index]) {  
      entities[index].icon = newIcon;  
      localStorage.setItem(FINANCE_ENTITIES_KEY, JSON.stringify(entities));  
      loadFinanceEntitiesList();  
    }  
  };  
    
  window.deleteFinanceEntity = function(index) {  
    const entities = getFinanceEntitiesList();  
    const deleted = entities.splice(index, 1);  
    localStorage.setItem(FINANCE_ENTITIES_KEY, JSON.stringify(entities));  
    loadFinanceEntitiesList();  
    showToast(`تم حذف جهة التمويل: ${deleted[0]?.name}`, 'info');  
  };  
    
  window.saveFinanceEntitiesList = function() {  
    showSaveConfirmation('تم حفظ جهات التمويل بنجاح');  
  };  
    
  window.resetFinanceEntitiesList = function() {  
    if (confirm('هل تريد إعادة تعيين جهات التمويل للقيم الافتراضية؟')) {  
      localStorage.removeItem(FINANCE_ENTITIES_KEY);  
      loadFinanceEntitiesList();  
      showToast('تم إعادة تعيين جهات التمويل', 'info');  
    }  
  };  
    
  // تحميل القوائم عند فتح الصفحات  
  const originalShowPage = window.showPage;  
  window.showPage = function(name) {  
    originalShowPage(name);  
    setTimeout(() => {  
      if (name === 'adminEmployers') {  
        window.loadEmployersList();  
      } else if (name === 'adminFinanceEntities') {  
        window.loadFinanceEntitiesList();  
      }  
    }, 100);  
  };  
</script>

<!-- زر التنفيذ الثابت لصفحات المسؤول -->
<button id="adminExecuteBtn" class="admin-execute-btn" onclick="executeAllAdminChanges()">
  ✅ تنفيذ التغييرات
</button>

<script>
// دالة إظهار/إخفاء زر التنفيذ حسب الصفحة الحالية
function updateExecuteButtonVisibility() {
  const btn = document.getElementById('adminExecuteBtn');
  if (!btn) return;
  
  // البحث عن أي صفحة مسؤول مفعلة
  const allPages = document.querySelectorAll('.page');
  let isAdminPage = false;
  
  allPages.forEach(page => {
    if (page.classList.contains('active') && page.id && page.id.startsWith('admin') && page.id !== 'adminLoginPage' && page.id !== 'adminHubPage') {
      isAdminPage = true;
    }
  });
  
  if (isAdminPage) {
    btn.classList.add('show');
  } else {
    btn.classList.remove('show');
  }
}

// دالة تنفيذ جميع التغييرات
function executeAllAdminChanges() {
  // حفظ جميع الإعدادات الحالية
  try {
    // حفظ إعدادات البنوك
    if (typeof saveBankConfigs === 'function') saveBankConfigs();
    
    // حفظ إعدادات الأسئلة
    if (typeof saveCustomQuestions === 'function') saveCustomQuestions();
    
    // حفظ إعدادات الثيمات
    if (typeof saveThemeSettings === 'function') saveThemeSettings();
    
    // حفظ إعدادات النصوص
    if (typeof saveCustomTexts === 'function') saveCustomTexts();
    
    // حفظ إعدادات النتيجة
    if (typeof saveResultSettings === 'function') saveResultSettings();
    
    // حفظ صيغ النتيجة
    if (typeof saveResultTexts === 'function') saveResultTexts();
    
    // حفظ أنواع الوظائف
    if (typeof saveJobTypesList === 'function') saveJobTypesList();
    
    // حفظ جهات الوظيفة
    if (typeof saveEmployersList === 'function') saveEmployersList();
    
    // حفظ جهات التمويل
    if (typeof saveFinanceEntitiesList === 'function') saveFinanceEntitiesList();
    
    // حفظ إعدادات التسويق
    if (typeof saveMarketingSettings === 'function') saveMarketingSettings();
    
    // حفظ العروض
    if (typeof saveOffers === 'function') saveOffers();
    
    // عرض رسالة نجاح
    const btn = document.getElementById('adminExecuteBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '✅ تم التنفيذ بنجاح!';
    btn.style.background = 'linear-gradient(135deg, #059669 0%, #047857 100%)';
    
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.style.background = '';
      // إعادة تحميل الصفحة لتطبيق التغييرات
      location.reload();
    }, 1500);
    
  } catch (e) {
    console.error('خطأ في تنفيذ التغييرات:', e);
    alert('حدث خطأ أثناء التنفيذ. يرجى المحاولة مرة أخرى.');
  }
}

// تحديث ظهور الزر عند تغيير الصفحة
var _origShowPageForBtn = window.showPage;
window.showPage = function(pageId) {
  if (typeof _origShowPageForBtn === 'function') {
    _origShowPageForBtn(pageId);
  }
  setTimeout(updateExecuteButtonVisibility, 100);
};

// تحديث عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(updateExecuteButtonVisibility, 500);
});
</script>

</body>  
</html  
